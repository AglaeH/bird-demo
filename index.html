<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Bird Builder AR Demo</title>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
  <style>
    :root{
      --bg:#0b1220; --panel:#f4ecd8; --panel2:#efe3c6; --ink:#2b2b2b;
      --accent:#f0c14b; --good:#2e7d32; --bad:#c62828; --shadow: 0 18px 40px rgba(0,0,0,.35);
      --neon-green: #39FF14; --neon-red: #FF3131;
    }
    *{box-sizing:border-box;font-family: system-ui, -apple-system, sans-serif;}
    body{margin:0;background:var(--bg);color:#fff;overflow:hidden;}
    #app{position:relative;height:100dvh;width:100vw;background:#000;}
    video#camera{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;z-index:1;}
    
    #overlay{position:absolute;inset:0;display:flex;flex-direction:column;justify-content:space-between;padding:14px;pointer-events:none;z-index:10;}
    .pill{pointer-events:auto;background:rgba(20,20,20,.7);backdrop-filter:blur(10px);padding:8px 12px;border-radius:999px;font-size:14px;border:1px solid rgba(255,255,255,0.15);}
    .birdCard{pointer-events:none;width:min(500px,92vw);background:rgba(20,20,20,0.5);backdrop-filter:blur(12px);border-radius:26px;padding:20px;margin:0 auto;border:1px solid rgba(255,255,255,0.15);text-align:center;}
    .hintRow{display:flex;gap:6px;flex-wrap:wrap;justify-content:center;margin-top:10px;}
    .chip{background:rgba(255,255,255,0.1);padding:5px 10px;border-radius:999px;font-size:11px;}
    .chip.done{background:var(--good);}
    .chip.pending{background:var(--accent);color:#000;}

    /* é¤µé£Ÿç¨®å­å‹•ç•« */
    .feedOverlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:100;background:rgba(0,0,0,.25);backdrop-filter:blur(4px);}
    .feedOverlay.show{display:flex;}
    .feedCard{width:min(360px, 90vw);background:rgba(255,255,255,.95);border-radius:24px;padding:24px;text-align:center;color:#111;box-shadow:var(--shadow);}
    .feedAnim{position:relative;height: 120px;margin: 10px auto;width: 200px;}
    .bowl{position:absolute;left:50%;bottom: 10px;width: 130px;height: 40px;transform: translateX(-50%);border-radius: 0 0 60px 60px;border: 3px solid rgba(163,58,42,.7);border-top: 0;background: rgba(163,58,42,0.1);}
    .seed{position:absolute;width: 10px; height: 10px;border-radius: 999px;background: rgba(163,58,42,.9);top: 0px;left: 50%;transform: translateX(-50%);animation: fall 0.8s ease-in infinite;opacity:0;}
    .seed.s1{ left: 35%; animation-delay: .00s; }
    .seed.s2{ left: 50%; animation-delay: .12s; }
    .seed.s3{ left: 62%; animation-delay: .22s; }
    .seed.s4{ left: 45%; animation-delay: .32s; }
    @keyframes fall{
      0%{ transform: translate(-50%, 0) scale(.9); opacity: 0; }
      20%{ opacity: 1; }
      70%{ transform: translate(-50%, 90px) scale(1); opacity: 1; }
      100%{ transform: translate(-50%, 90px) scale(.4); opacity: 0; }
    }

    /* AI å¼•å° Modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,0.75);display:flex;align-items:center;justify-content:center;z-index:200;padding:20px;pointer-events:auto;}
    .hidden{display:none !important;}
    .box{background:var(--panel);color:#111;width:100%;max-width:420px;border-radius:26px;overflow:hidden;box-shadow:var(--shadow);}
    .boxContent{padding:26px;display:flex;flex-direction:column;gap:18px;}
    .aiText{font-size:16px;line-height:1.5;font-weight:600;min-height:80px;}
    .optBtn{width:100%;padding:14px;border-radius:14px;border:2px solid #ccc;background:#fff;font-weight:bold;cursor:pointer;text-align:left;transition:0.2s;}
    .optBtn:hover{border-color:var(--accent);background:#fffdfa;}
    .optBtn.correct{border-color:var(--good);background:#e8f5e9;}

    /* æƒæå¼·åŒ–è¦–è¦º */
    .scanBox{position:absolute;border:5px solid var(--neon-green);border-radius:15px;pointer-events:none;z-index:5;display:none;box-shadow: 0 0 15px var(--neon-green);}
    .scanBox.error{border-color:var(--neon-red);box-shadow: 0 0 15px var(--neon-red);}
    canvas#scanPreview{width:100%;border-radius:18px;background:#000;}

    .bottom{pointer-events:auto;display:flex;gap:10px;justify-content:center;padding-bottom:env(safe-area-inset-bottom);}
    button{border:0;border-radius:16px;padding:12px 20px;font-size:15px;background:#fff;color:#111;font-weight:bold;cursor:pointer;box-shadow:0 4px 10px rgba(0,0,0,0.3);}
    button:disabled{opacity:0.3;}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:130px;background:rgba(0,0,0,0.85);color:#fff;padding:12px 24px;border-radius:999px;opacity:0;transition:0.3s;z-index:1000;}
    .toast.show{opacity:1;}
  </style>
</head>
<body>
<div id="app">
  <video id="camera" autoplay playsinline muted></video>
  <div id="overlay">
    <div style="display:flex;justify-content:space-between;">
      <div class="pill">ğŸ” <strong id="birdNameDisplay">ç¥ç¥•é³¥</strong></div>
      <div class="pill">ç·šç´¢ <strong id="clueCount">0</strong>/5</div>
    </div>
    <div class="birdCard">
      <div id="birdBase" style="height:120px;display:flex;align-items:center;justify-content:center;">
        <svg viewBox="0 0 100 60" width="140">
          <circle cx="50" cy="30" r="25" fill="none" stroke="white" stroke-width="2" stroke-dasharray="6 4" style="opacity:0.4" />
          <text x="50" y="34" font-size="6" text-anchor="middle" fill="white" style="opacity:0.6">? ç¥ç¥•é³¥ ?</text>
        </svg>
      </div>
      <div id="clueChips" class="hintRow"></div>
      <div id="instructionText" style="font-size:13px;color:var(--accent);margin-top:12px;font-weight:bold;">é»æ“Šé¤µé³¥é–‹å§‹è§£è¬æ¢ç©¶</div>
    </div>
    <div class="bottom">
      <button id="btnFeed">é¤µé³¥ (å•Ÿå‹• AI å¼•å°)</button>
      <button id="btnQuiz" disabled style="background:#222;color:#fff;">é–‹å§‹è¾¨èª (0/5)</button>
      <button onclick="location.reload()" style="background:#444;color:#fff;font-size:12px;padding:8px;">é‡æ–°é–‹å§‹</button>
    </div>
  </div>

  <div class="feedOverlay" id="feedOverlay">
    <div class="feedCard">
      <div style="font-weight:900; font-size:18px; margin-bottom:10px;">é¤µé£Ÿä¸­...</div>
      <div class="feedAnim">
        <div class="seed s1"></div><div class="seed s2"></div><div class="seed s3"></div><div class="seed s4"></div>
        <div class="bowl"></div>
      </div>
      <div style="color:rgba(0,0,0,.6); font-size:14px;">ç™¼ç¾äº†æ–°çš„ç‰¹å¾µï¼</div>
    </div>
  </div>

  <div class="modal hidden" id="guidanceModal">
    <div class="box">
      <div class="boxContent">
        <div style="font-size:12px;color:#7a5200;font-weight:bold">âœ¨ AI åŠ©æ•™è§£è¬å¼•å°</div>
        <div id="aiText" class="aiText"></div>
        <div id="aiOptions" style="display:flex;flex-direction:column;gap:10px;"></div>
        <div id="aiClueBox" class="hidden" style="background:#fff8e1;padding:15px;border-radius:12px;border:1px solid #ffe082;margin-top:10px;font-weight:bold;color:#333;"></div>
        <button id="btnGoScan" class="hidden" style="width:100%;background:#111;color:#fff;padding:15px;border-radius:14px;border:0;font-weight:bold;">çŸ¥é“äº†ï¼Œå»æƒæå¡ç‰‡ï¼</button>
      </div>
    </div>
  </div>

  <div class="modal hidden" id="scanModal">
    <div class="box" style="max-width:720px;">
      <div class="boxContent">
        <h3 style="margin:0">æƒæç‰¹å¾µç·šç´¢å¡</h3>
        <div style="position:relative;">
          <div id="scanFocusBox" class="scanBox"></div>
          <canvas id="scanPreview"></canvas>
        </div>
        <div id="scanPersistHint" style="background:#fff;padding:12px;border-radius:12px;border:1px solid #ddd;font-size:14px;color:#333;"></div>
        <button onclick="closeScan()" style="background:#eee;border:0;padding:12px;border-radius:12px;width:100%;margin-top:10px;">æš«æ™‚è¿”å›</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>
</div>

<script>
/** ===========================
 * BIRDS è³‡æ–™ç‰©ä»¶ (å« Induction è…³æœ¬)
 * =========================== */
const BIRDS = {
  sparrow: {
    key: "sparrow", name: "éº»é›€",
    induction: {
      legs: { 
        q: "é€™éš»é³¥è¦æ‰è½ã€è…³ã€çš„ç·šç´¢äº†ï¼ä½ è¦ºå¾—è§€å¯Ÿé€™éš»é³¥çš„è…³æ™‚ï¼Œä»€éº¼ç‰¹å¾µæœ€æœ‰è¾¨è­˜åº¦ï¼Ÿ",
        options: [
          { t: "è…³çš„é¡è‰² (è¤è‰²)", isBest: true, feedback: "æ²’éŒ¯ï¼é¡è‰²æ˜¯é—œéµï¼Œå°æ–¼é€™éš»å°é³¥ä¾†èªªï¼Œè¤è‰²çš„ç´°è…³å¾ˆç‰¹åˆ¥ã€‚", clue: "è…³çŸ­çŸ­ã€åè¤è‰²" },
          { t: "è…³çš„é•·åº¦", isBest: false, feedback: "è§€å¯Ÿé•·çŸ­ä¹Ÿä¸éŒ¯ï¼ä½†é€™éš»é³¥çš„é¡è‰²æ›´æœ‰ç‰¹è‰²å–”ï¼Œå»æ‰¾æ‰¾è¤è‰²çš„ç·šç´¢å§ï¼", clue: "è…³çŸ­çŸ­ã€åè¤è‰²" }
        ]
      },
      body: {
        q: "æˆ‘å€‘è¦çœ‹ã€èº«é«”ã€äº†ï¼ä½ è¦ºå¾—æ‡‰è©²æ³¨æ„ç¾½æ¯›çš„æ¢ç´‹ï¼Œé‚„æ˜¯é³¥çš„é‡é‡ï¼Ÿ",
        options: [
          { t: "èƒŒéƒ¨çš„æ¢ç´‹", isBest: true, feedback: "å°ˆæ¥­ï¼é€™éš»é³¥èƒŒéƒ¨æœ‰æ˜é¡¯çš„é»‘è‰²æ¢ç´‹ï¼Œæ˜¯é‡è¦çš„ç‰¹å¾µã€‚", clue: "èº«é«”è¤è‰²ï¼ŒèƒŒä¸Šæœ‰æ·±è‰²æ¢ç´‹" },
          { t: "é³¥çš„é‡é‡", isBest: false, feedback: "é‡é‡å¾ˆé›£çœ‹å‡ºä¾†å–”ï¼è§€å¯Ÿç¾½æ¯›çš„è¤è‰²æ¢ç´‹æœƒæ›´æ˜é¡¯ï¼Œå»æ‰¾æ‰¾çœ‹å§ï¼", clue: "èº«é«”è¤è‰²ï¼ŒèƒŒä¸Šæœ‰æ·±è‰²æ¢ç´‹" }
        ]
      },
      wing: {
        q: "é€™å¼µæ˜¯ã€ç¿…è†€ã€ç·šç´¢ï¼ä½ è¦ºå¾—è¦çœ‹ç¿…è†€æœ‰æ²’æœ‰ç™½é»ï¼Œé‚„æ˜¯çœ‹ç¾½æ¯›é•·åº¦ï¼Ÿ",
        options: [
          { t: "ç¿…è†€ä¸Šçš„æ–‘ç´‹", isBest: true, feedback: "æ­£ç¢ºï¼å®ƒçš„ç¿…è†€ä¸Šæœ‰å…©æ¢æ·¡è‰²çš„ç¿¼å¸¶ï¼Œæ˜¯è¾¨èªé‡é»ã€‚", clue: "ç¿…è†€çŸ­åœ“ï¼Œæœ‰æ·¡è‰²ç¿¼å¸¶" },
          { t: "ç¾½æ¯›çš„æ•¸é‡", isBest: false, feedback: "æ•¸ç¾½æ¯›å¤ªè¾›è‹¦å•¦ï¼è§€å¯Ÿç¿…è†€ä¸Šçš„æ·¡è‰²æ–‘ç´‹ï¼ˆç¿¼å¸¶ï¼‰æœƒæ›´å¿«èªå‡ºå®ƒå–”ï¼", clue: "ç¿…è†€çŸ­åœ“ï¼Œæœ‰æ·¡è‰²ç¿¼å¸¶" }
        ]
      },
      tail: {
        q: "æ‰¾ã€å°¾å·´ã€ç·šç´¢æ™‚ï¼Œä½ è¦ºå¾—è¦çœ‹æœ«ç«¯å¹³ä¸å¹³ï¼Œé‚„æ˜¯çœ‹æœƒä¸æœƒç¿¹èµ·ä¾†ï¼Ÿ",
        options: [
          { t: "æœ«ç«¯çš„å½¢ç‹€", isBest: true, feedback: "æ²’éŒ¯ï¼å®ƒçš„å°¾å·´æœ«ç«¯å¹³å¹³çš„ï¼Œåƒå€‹å°æ‰‡å­ï¼ˆæ–¹å°¾ï¼‰ã€‚", clue: "å°¾å·´ä¸­ç­‰é•·åº¦ï¼Œæœ«ç«¯åå¹³" },
          { t: "æ“ºå‹•çš„é€Ÿåº¦", isBest: false, feedback: "è§€å¯Ÿå‹•ä½œå¾ˆç´°å¿ƒï¼ä½†æœ«ç«¯å¹³å¹³çš„å½¢ç‹€æ‰æ˜¯é€™éš»é³¥çš„ç§‘å­¸ç‰¹å¾µå–”ï¼", clue: "å°¾å·´ä¸­ç­‰é•·åº¦ï¼Œæœ«ç«¯åå¹³" }
        ]
      },
      head: {
        q: "æœ€å¾Œæ˜¯ã€é ­éƒ¨ã€ï¼ä½ è¦ºå¾—è¦çœ‹æœ‰æ²’æœ‰ç™½çœ¼åœˆï¼Œé‚„æ˜¯å˜´å·´çš„é•·çŸ­ï¼Ÿ",
        options: [
          { t: "çœ¼å‘¨çš„è¨˜è™Ÿ", isBest: true, feedback: "æ²’éŒ¯ï¼é€™éš»é³¥æ²’æœ‰ç™½çœ¼åœˆï¼Œä½†è‡‰é °ä¸Šæœ‰å€‹å°é»‘æ–‘ã€‚", clue: "é ­éƒ¨ç´ è‰²æ£•ï¼Œç„¡ç™½çœ¼åœˆï¼Œè‡‰é °æœ‰é»‘æ–‘" },
          { t: "å˜´å·´çš„é•·çŸ­", isBest: false, feedback: "å˜´å·´å¤§å®¶éƒ½å·®ä¸å¤šï½è§€å¯Ÿå®ƒçœ¼ç›å‘¨åœæœ‰æ²’æœ‰ç™½åœˆæœƒæ›´æ˜é¡¯å–”ï¼", clue: "é ­éƒ¨ç´ è‰²æ£•ï¼Œç„¡ç™½çœ¼åœˆï¼Œè‡‰é °æœ‰é»‘æ–‘" }
        ]
      }
    }
  },
  bulbul: {
    key: "bulbul", name: "ç™½é ­ç¿",
    induction: {
      legs: { q: "é€™éš»é³¥çš„ã€è…³ã€æœ‰ä»€éº¼ç‰¹å¾µï¼Ÿè¦çœ‹é¡è‰²é‚„æ˜¯çœ‹æœ‰æ²’æœ‰æ¯›ï¼Ÿ", options: [
        { t: "è…³çš„é¡è‰²", isBest: true, feedback: "æ²’éŒ¯ï¼å®ƒçš„è…³æ˜¯é»‘è‰²çš„ã€‚", clue: "è…³åé»‘ï¼ŒæŠ“æå¾ˆç©©" },
        { t: "æœ‰æ²’æœ‰ç¾½æ¯›", isBest: false, feedback: "å¤§å¤šæ•¸é³¥è…³éƒ½æ²’æ¯›å–”ï¼çœ‹é»‘è‰²çš„é¡è‰²æ‰æ˜¯é—œéµã€‚", clue: "è…³åé»‘ï¼ŒæŠ“æå¾ˆç©©" }
      ]},
      head: { q: "é€™éš»é³¥çš„ã€é ­éƒ¨ã€æœ€æ˜é¡¯çš„æ˜¯ä»€éº¼ï¼Ÿ", options: [
        { t: "é ­é ‚çš„é¡è‰²", isBest: true, feedback: "æ­£ç¢ºï¼ç™½è‰²çš„é ­é ‚æ˜¯å®ƒåå­—çš„ç”±ä¾†ã€‚", clue: "é ­é ‚åç™½ï¼Œè‡‰å´è¼ƒæ·±" },
        { t: "çœ¼ç›çš„å¤§å°", isBest: false, feedback: "çœ¼ç›å¤§å°å¾ˆé›£æ¯”è¼ƒï½çœ‹é ­é ‚é‚£å¡Šç™½è‰²ç¾½æ¯›å°±å°äº†ï¼", clue: "é ­é ‚åç™½ï¼Œè‡‰å´è¼ƒæ·±" }
      ]},
      body: { q: "ã€èº«é«”ã€è¦å‡ºç¾äº†ï¼è¦çœ‹ä»€éº¼ï¼Ÿ", options: [{t:"èº«é«”è‰²èª¿", isBest:true, feedback:"å°ï¼ç°è¤è‰²çš„èº«é«”é…ä¸Šé»ƒç¶ è‰²ç¿…è†€ã€‚", clue:"èº«é«”ç°è¤è‰²ï¼Œè…¹éƒ¨è¼ƒæ·¡"}]},
      wing: { q: "ã€ç¿…è†€ã€çš„ç·šç´¢ï¼è¦çœ‹é¡è‰²å—ï¼Ÿ", options: [{t:"ç¿…è†€é‚Šç·£é¡è‰²", isBest:true, feedback:"æ²’éŒ¯ï¼å¸¶é»é»ƒç¶ è‰²ã€‚", clue:"ç¿…è†€æ·±è‰²ã€é‚Šç·£å¸¶é»ƒç¶ è‰²"}]},
      tail: { q: "ã€å°¾å·´ã€çš„é•·åº¦é‡è¦å—ï¼Ÿ", options: [{t:"å°¾å·´å½¢ç‹€", isBest:true, feedback:"æ˜¯çš„ï¼Œä¸­é•·å¹³å°¾ã€‚", clue:"å°¾å·´ä¸­é•·ï¼Œæœ«ç«¯åæ–¹"}]}
    }
  }
};

/** ===========================
 * æ ¸å¿ƒéŠæˆ²ç‹€æ…‹
 * =========================== */
let state = {
  bird: null, // ç¥ç¥•é³¥å°è±¡
  clues: new Set(),
  pendingPart: null,
  solved: 0,
  cameraOn: false
};

const $ = (id) => document.getElementById(id);

// éš¨æ©Ÿåˆå§‹åŒ–ç¥ç¥•é³¥
function initMysteryBird() {
  const keys = Object.keys(BIRDS);
  const randomKey = keys[Math.floor(Math.random() * keys.length)];
  state.bird = BIRDS[randomKey];
  console.log("ç¥ç§˜é³¥é–å®šç‚ºï¼š" + state.bird.name);
  
  // éš±è—åç¨±
  $("birdNameDisplay").innerText = "ç¥ç¥•é³¥";
  updateUI();
}

function showToast(msg) {
  const t = $("toast"); t.innerText = msg; t.classList.add("show");
  setTimeout(() => t.classList.remove("show"), 2500);
}

function updateUI() {
  $("clueCount").innerText = state.clues.size;
  $("btnQuiz").disabled = (state.clues.size < 5);
  $("btnQuiz").innerText = `é–‹å§‹è¾¨èª (${state.solved}/5)`;
  
  const chipBox = $("clueChips");
  chipBox.innerHTML = "";
  ["legs", "body", "wing", "tail", "head"].forEach(p => {
    const c = document.createElement("div");
    const labels = { legs:"è…³", body:"èº«é«”", wing:"ç¿…è†€", tail:"å°¾å·´", head:"é ­éƒ¨" };
    c.className = `chip ${state.clues.has(p) ? 'done' : (state.pendingPart === p ? 'pending' : '')}`;
    c.innerText = `${state.clues.has(p) ? 'âœ…' : ''} ${labels[p]}`;
    chipBox.appendChild(c);
  });
}

/** ===========================
 * é¤µé³¥æµç¨‹ (æ””æˆªèˆ‡ AI å°è©±)
 * =========================== */
$("btnFeed").onclick = () => {
  if (state.pendingPart) return showToast(`è«‹å…ˆæƒæç›®å‰çš„ç·šç´¢ï¼`);
  const parts = ["legs", "body", "wing", "tail", "head"];
  const missing = parts.filter(p => !state.clues.has(p));
  if (missing.length === 0) return showToast("ç·šç´¢å·²é›†æ»¿ï¼");
  
  const part = missing[Math.floor(Math.random() * missing.length)];
  state.pendingPart = part;
  
  // æ’­æ”¾å‹•ç•«
  $("feedOverlay").classList.add("show");
  setTimeout(() => {
    $("feedOverlay").classList.remove("show");
    showInductionModal(part); // é€²å…¥æå•éšæ®µ
  }, 1200);
};

function showInductionModal(part) {
  const modal = $("guidanceModal");
  const script = state.bird.induction[part];
  
  modal.classList.remove("hidden");
  $("aiClueBox").classList.add("hidden");
  $("btnGoScan").classList.add("hidden");
  $("aiText").innerText = script.q;
  $("aiOptions").innerHTML = "";

  script.options.forEach(opt => {
    const btn = document.createElement("button");
    btn.className = "optBtn";
    btn.innerText = opt.t;
    btn.onclick = () => {
      // é¡¯ç¤ºå›é¥‹
      $("aiText").innerText = opt.feedback;
      
      if (opt.isBest) {
        // é¸å°ï¼šæ­ç¤ºç·šç´¢
        $("aiClueBox").innerHTML = `ğŸ ç²å¾—ç·šç´¢ï¼š<br/>${opt.clue}`;
        $("aiClueBox").classList.remove("hidden");
        $("aiOptions").innerHTML = ""; // éš±è—é¸é …
        $("btnGoScan").classList.remove("hidden");
        $("btnGoScan").onclick = () => {
          modal.classList.add("hidden");
          openScan(opt.clue);
        };
      } else {
        // é¸éŒ¯ï¼šæŒçºŒå¼•å°ï¼Œä¸éš±è—é¸é …
        showToast("å†æƒ³ä¸€ä¸‹ä¸‹...");
      }
    };
    $("aiOptions").appendChild(btn);
  });
}

/** ===========================
 * æƒæåŠŸèƒ½ (éœ“è™¹åé¥‹)
 * =========================== */
function openScan(clueText) {
  if(!state.cameraOn) startCamera();
  $("scanModal").classList.remove("hidden");
  $("scanPersistHint").innerText = `ğŸ’¡ ç·šç´¢æŒ‡å¼•ï¼š${clueText}`;
  updateUI();
  requestAnimationFrame(scanLoop);
}

function closeScan() { $("scanModal").classList.add("hidden"); }

function scanLoop() {
  const video = $("camera");
  const canvas = $("scanPreview");
  const focus = $("scanFocusBox");
  const ctx = canvas.getContext("2d");

  if (video.readyState === video.HAVE_ENOUGH_DATA) {
    canvas.height = 480; canvas.width = 640;
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const code = jsQR(imgData.data, imgData.width, imgData.height);

    if (code) {
      focus.style.display = "block";
      const loc = code.location;
      focus.style.left = (loc.topLeftCorner.x / 640 * 100) + "%";
      focus.style.top = (loc.topLeftCorner.y / 480 * 100) + "%";
      focus.style.width = (loc.topRightCorner.x - loc.topLeftCorner.x) / 640 * 100 + "%";
      focus.style.height = (loc.bottomLeftCorner.y - loc.topLeftCorner.y) / 480 * 100 + "%";

      if (code.data.toLowerCase().includes(state.pendingPart)) {
        // äº®ç¶ è‰²
        focus.classList.remove("error");
        state.clues.add(state.pendingPart);
        state.pendingPart = null;
        showToast("âœ… æƒææ­£ç¢ºï¼");
        setTimeout(closeScan, 800);
        updateUI();
        return;
      } else {
        // äº®ç´…è‰²
        focus.classList.add("error");
        const clue = state.bird.induction[state.pendingPart].options.find(o=>o.isBest).clue;
        showToast(`âŒ æƒéŒ¯éƒ¨ä½å›‰ï¼\næ‰¾ä¸€ä¸‹ç¥ç¥•é³¥ã€Œ${state.pendingPart}ã€çš„ç‰¹å¾µï¼š${clue}`);
      }
    } else {
      focus.style.display = "none";
    }
  }
  if (!$("scanModal").classList.contains("hidden")) requestAnimationFrame(scanLoop);
}

/** ===========================
 * è¾¨èªæ´»å‹•
 * =========================== */
$("btnQuiz").onclick = () => {
  showToast(`ğŸ” è¾¨èªç³»çµ±å•Ÿå‹•ï¼è«‹æ ¹æ“šç·šç´¢é¸å‡º${state.bird.name}çš„å„éƒ¨ä½ç‰¹å¾µã€‚`);
  // æ­¤è™•å¯æ¥å…¥ä½ åŸæœ¬çš„ Quiz é‚è¼¯...
};

async function startCamera() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
    $("camera").srcObject = stream;
    state.cameraOn = true;
    updateUI();
  } catch (e) { showToast("ç›¸æ©Ÿéœ€è¦æˆæ¬Šå–”ï¼"); }
}

window.onload = initMysteryBird;
</script>
</body>
</html>
