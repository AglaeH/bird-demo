<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Bird Builder AR Demo</title>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
  <style>
    :root{
      --bg:#0b1220; --panel:#f4ecd8; --panel2:#efe3c6; --ink:#2b2b2b;
      --accent:#f0c14b; --good:#2e7d32; --bad:#c62828; --shadow: 0 18px 40px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box;font-family: system-ui, sans-serif;}
    body{margin:0;background:var(--bg);color:#fff;overflow:hidden;}
    #app{position:relative;height:100dvh;width:100vw;background:#000;}
    video#camera{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;z-index:1;}
    
    /* UI Overlay */
    #overlay{position:absolute;inset:0;display:flex;flex-direction:column;justify-content:space-between;padding:14px;pointer-events:none;z-index:10;}
    .pill{pointer-events:auto;background:rgba(20,20,20,.65);backdrop-filter:blur(10px);padding:8px 12px;border-radius:999px;font-size:14px;border:1px solid rgba(255,255,255,0.15);}
    .birdCard{pointer-events:none;width:min(500px,92vw);background:rgba(20,20,20,0.45);backdrop-filter:blur(12px);border-radius:26px;padding:20px;margin:0 auto;border:1px solid rgba(255,255,255,0.15);text-align:center;}
    .hintRow{display:flex;gap:6px;flex-wrap:wrap;justify-content:center;margin-top:10px;}
    .chip{background:rgba(255,255,255,0.1);padding:5px 10px;border-radius:999px;font-size:11px;}
    .chip.done{background:var(--good);}
    .chip.pending{background:var(--accent);color:#000;}

    /* é¤µé£Ÿç¨®å­å‹•ç•« */
    .feedOverlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:100;background:rgba(0,0,0,.18);backdrop-filter:blur(3px);}
    .feedOverlay.show{display:flex;}
    .feedCard{width:min(360px, calc(100% - 32px));background:rgba(255,255,255,.92);border-radius:22px;padding:14px;text-align:center;color:#111;box-shadow:var(--shadow);}
    .feedAnim{position:relative;height: 140px;margin: 6px auto 0;width: 220px;}
    .bowl{position:absolute;left:50%;bottom: 10px;width: 140px;height: 44px;transform: translateX(-50%);border-radius: 0 0 50px 50px;border: 3px solid rgba(163,58,42,.65);border-top: 0;background: rgba(163,58,42,.08);}
    .seed{position:absolute;width: 10px; height: 10px;border-radius: 999px;background: rgba(163,58,42,.9);top: 0px;left: 50%;transform: translateX(-50%);animation: fall 0.8s ease-in infinite;opacity:0;}
    .seed.s1{ left: 35%; animation-delay: .00s; }
    .seed.s2{ left: 50%; animation-delay: .12s; }
    .seed.s3{ left: 62%; animation-delay: .22s; }
    .seed.s4{ left: 45%; animation-delay: .32s; }
    @keyframes fall{
      0%{ transform: translate(-50%, 0) scale(.9); opacity: 0; }
      15%{ opacity: 1; }
      70%{ transform: translate(-50%, 106px) scale(1); opacity: 1; }
      100%{ transform: translate(-50%, 106px) scale(.4); opacity: 0; }
    }

    /* Modal Styles */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:200;padding:20px;}
    .hidden{display:none !important;}
    .box{background:var(--panel);color:#111;width:100%;max-width:420px;border-radius:26px;overflow:hidden;box-shadow:var(--shadow);}
    .boxContent{padding:26px;display:flex;flex-direction:column;gap:15px;}
    .optBtn{width:100%;padding:14px;border-radius:14px;border:2px solid #ddd;background:#fff;font-weight:bold;cursor:pointer;text-align:left;}
    .optBtn.correct{border-color:var(--good);background:#e8f5e9;}
    .optBtn.wrong{border-color:var(--bad);background:#ffebee;}

    /* æƒæç•«é¢ */
    .scanBox{position:absolute;border:4px solid var(--good);border-radius:10px;pointer-events:none;z-index:5;display:none;}
    canvas#scanPreview{width:100%;border-radius:18px;background:#000;}

    .bottom{pointer-events:auto;display:flex;gap:10px;justify-content:center;padding-bottom:env(safe-area-inset-bottom);}
    button{border:0;border-radius:16px;padding:12px 20px;font-size:15px;background:#fff;color:#111;font-weight:bold;cursor:pointer;}
    button:disabled{opacity:0.3;}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:130px;background:rgba(0,0,0,0.85);color:#fff;padding:12px 24px;border-radius:999px;opacity:0;transition:0.3s;z-index:1000;}
    .toast.show{opacity:1;}
  </style>
</head>
<body>
<div id="app">
  <video id="camera" autoplay playsinline muted></video>
  <div id="overlay">
    <div style="display:flex;justify-content:space-between;">
      <div class="pill"><strong>éº»é›€</strong> è§€å¯Ÿè¨ˆç•«</div>
      <div class="pill">ç·šç´¢ <strong id="clueCount">0</strong>/5</div>
    </div>
    <div class="birdCard">
      <div id="birdCanvas" style="height:100px;display:flex;align-items:center;justify-content:center;color:white;opacity:0.5;">ç­‰å¾…ç·šç´¢...</div>
      <div id="clueChips" class="hintRow"></div>
      <div id="instructionText" style="font-size:13px;color:var(--accent);margin-top:10px;font-weight:bold;">è«‹æŒ‰ä¸‹æ–¹æŒ‰éˆ•ç²å–ç·šç´¢</div>
    </div>
    <div class="bottom">
      <button id="btnFeed">é¤µé³¥ (ç²å–ç·šç´¢)</button>
      <button id="btnQuiz" disabled style="background:#222;color:#fff;">é–‹å§‹è¾¨èª (0/5)</button>
    </div>
  </div>

  <div class="feedOverlay" id="feedOverlay">
    <div class="feedCard">
      <div style="font-weight:850; font-size:16px; margin-bottom:10px;">é¤µé£Ÿä¸­...</div>
      <div class="feedAnim">
        <div class="seed s1"></div><div class="seed s2"></div><div class="seed s3"></div><div class="seed s4"></div>
        <div class="bowl"></div>
      </div>
      <div id="feedSubText" style="color: rgba(0,0,0,.64); font-size:13px; margin-top:10px;">æ‰è½ä¸€å¼µç·šç´¢å¡</div>
    </div>
  </div>

  <div class="modal hidden" id="guidanceModal">
    <div class="box">
      <div class="boxContent">
        <div style="font-size:12px;color:#7a5200;font-weight:bold">âœ¨ AI åŠ©æ•™å¼•å°</div>
        <div id="aiText" style="font-size:16px;line-height:1.5;font-weight:600;"></div>
        <div id="aiOptions" style="display:flex;flex-direction:column;gap:10px;"></div>
        <button id="btnGoScan" class="hidden" style="width:100%;background:#111;color:#fff;padding:14px;border-radius:12px;border:0;">çŸ¥é“äº†ï¼Œå»æƒæï¼</button>
      </div>
    </div>
  </div>

  <div class="modal hidden" id="scanModal">
    <div class="box" style="max-width:720px;">
      <div class="boxContent">
        <h3 style="margin:0">æƒæç·šç´¢å¡</h3>
        <div style="position:relative;">
          <div id="scanFocusBox" class="scanBox"></div>
          <canvas id="scanPreview"></canvas>
        </div>
        <div id="scanPersistHint" style="background:#fff8e1;padding:12px;border-radius:12px;border:1px solid #ffe082;font-size:14px;"></div>
        <button onclick="closeScan()" style="background:#eee;border:0;padding:10px;border-radius:10px;">å–æ¶ˆ</button>
      </div>
    </div>
  </div>

  <div class="modal hidden" id="quizModal">
    <div class="box">
      <div class="boxContent">
        <h3 id="quizTitle" style="margin:0">è¾¨èªé³¥é¡</h3>
        <div id="quizQuestion" style="background:#fff;padding:15px;border-radius:12px;border:1px solid #ddd;"></div>
        <div id="quizOptions" style="display:grid;grid-template-columns:1fr 1fr;gap:10px;"></div>
        <button onclick="document.getElementById('quizModal').classList.add('hidden')" style="background:#eee;border:0;padding:10px;border-radius:10px;">æš«æ™‚é›¢é–‹</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>
</div>

<script>
/** ===========================
 * Data Configuration
 * =========================== */
const BIRD_DATA = {
  sparrow: {
    parts: ["legs", "body", "wing", "tail", "head"],
    labels: { legs:"è…³", body:"èº«é«”", wing:"ç¿…è†€", tail:"å°¾å·´", head:"é ­éƒ¨" },
    clues: {
      legs: "è…³çŸ­çŸ­ã€åè¤è‰²",
      body: "èº«é«”è¤è‰²ï¼ŒèƒŒä¸Šæœ‰æ·±è‰²æ¢ç´‹",
      wing: "ç¿…è†€çŸ­åœ“ï¼Œæœ‰æ·¡è‰²ç¿¼å¸¶",
      tail: "å°¾å·´ä¸­ç­‰é•·åº¦ï¼Œæœ«ç«¯åå¹³",
      head: "é ­éƒ¨ç´ è‰²æ£•ï¼Œç„¡ç™½çœ¼åœˆ"
    },
    guidance: {
      legs: {
        q: "é€™éš»é³¥è¦æ‰è½ã€è…³ã€çš„ç·šç´¢äº†ï¼ä½ è¦ºå¾—è§€å¯Ÿè…³çš„ä»€éº¼ç‰¹å¾µæœ€é‡è¦ï¼Ÿ",
        options: [
          { t: "è…³çš„é¡è‰²", correct: true, feedback: "æ²’éŒ¯ï¼éº»é›€çš„è…³æ˜¯è¤è‰²çš„ã€‚å»æƒæå§ï¼" },
          { t: "è…³çš„é‡é‡", correct: false, feedback: "é‡é‡å¾ˆé›£çœ‹å‡ºä¾†å–”ï¼å†è§€å¯Ÿçœ‹çœ‹é¡è‰²ï¼Ÿ" }
        ]
      },
      // ... å…¶ä»–éƒ¨ä½å¯æ“´å……
    }
  }
};

let state = { clues: new Set(), pending: null, cameraOn: false, solved: 0 };
const bird = BIRD_DATA.sparrow;

/** ===========================
 * UI & Animation Functions
 * =========================== */
function showToast(msg) {
  const t = document.getElementById('toast');
  t.innerText = msg; t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}

function updateUI() {
  document.getElementById('clueCount').innerText = state.clues.size;
  const quizBtn = document.getElementById('btnQuiz');
  quizBtn.disabled = (state.clues.size < 5);
  quizBtn.innerText = `é–‹å§‹è¾¨èª (${state.solved}/5)`;
  
  const chipBox = document.getElementById('clueChips');
  chipBox.innerHTML = "";
  bird.parts.forEach(p => {
    const c = document.createElement('div');
    c.className = `chip ${state.clues.has(p) ? 'done' : (state.pending === p ? 'pending' : '')}`;
    c.innerText = `${state.clues.has(p) ? 'âœ…' : ''} ${bird.labels[p]}`;
    chipBox.appendChild(c);
  });
}

/** ===========================
 * Feed Animation (The Seeds)
 * =========================== */
document.getElementById('btnFeed').onclick = () => {
  if (state.pending) return showToast(`è«‹å…ˆæƒæç›®å‰çš„ç·šç´¢ï¼`);
  const missing = bird.parts.filter(p => !state.clues.has(p));
  if (missing.length === 0) return showToast("ç·šç´¢å·²é›†æ»¿ï¼");
  
  state.pending = missing[Math.floor(Math.random() * missing.length)];
  
  const feedOverlay = document.getElementById('feedOverlay');
  feedOverlay.classList.add('show');
  
  setTimeout(() => {
    feedOverlay.classList.remove('show');
    showAiGuidance(state.pending);
    updateUI();
  }, 1200);
};

/** ===========================
 * AI Assistant Logic (Loop on Wrong)
 * =========================== */
function showAiGuidance(part) {
  const modal = document.getElementById('guidanceModal');
  const textEl = document.getElementById('aiText');
  const optEl = document.getElementById('aiOptions');
  const nextBtn = document.getElementById('btnGoScan');
  const data = bird.guidance[part] || { q: `æº–å‚™å»å°‹æ‰¾${bird.labels[part]}å§ï¼`, options: [{t:"å¥½", correct:true, feedback:"å‡ºç™¼ï¼"}] };

  modal.classList.remove('hidden');
  nextBtn.classList.add('hidden');
  textEl.innerText = data.q;
  optEl.innerHTML = "";

  data.options.forEach(o => {
    const btn = document.createElement('button');
    btn.className = "optBtn";
    btn.innerText = o.t;
    btn.onclick = () => {
      if(o.correct) {
        textEl.innerText = o.feedback;
        optEl.innerHTML = "";
        nextBtn.classList.remove('hidden');
        nextBtn.onclick = () => {
          modal.classList.add('hidden');
          openScan();
        };
      } else {
        // ç­”éŒ¯å¼•å°ï¼šä¸é—œé–‰ï¼Œé¡¯ç¤ºå›é¥‹è®“å­¸ç”Ÿé‡é¸
        showToast("å†è©¦ä¸€æ¬¡ï¼" + o.feedback);
        textEl.innerText = o.feedback;
      }
    };
    optEl.appendChild(btn);
  });
}

/** ===========================
 * Scanning Logic (Green Box & Persistence)
 * =========================== */
function openScan() {
  if(!state.cameraOn) startCamera();
  document.getElementById('scanModal').classList.remove('hidden');
  // ç·šç´¢æŒçºŒå‘ˆç¾ç›´åˆ°æˆåŠŸ
  document.getElementById('scanPersistHint').innerText = `ğŸ’¡ è§€å¯Ÿç·šç´¢ï¼š${bird.clues[state.pending]}`;
  requestAnimationFrame(scanLoop);
}

function closeScan() { document.getElementById('scanModal').classList.add('hidden'); }

function scanLoop() {
  const video = document.getElementById('camera');
  const canvas = document.getElementById('scanPreview');
  const focus = document.getElementById('scanFocusBox');
  const ctx = canvas.getContext('2d');

  if (video.readyState === video.HAVE_ENOUGH_DATA) {
    canvas.height = 480; canvas.width = 640;
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const code = jsQR(imgData.data, imgData.width, imgData.height);

    if (code) {
      // é¡¯ç¤ºç¶ è‰²å°ç„¦æ¡†
      const loc = code.location;
      focus.style.display = 'block';
      focus.style.left = (loc.topLeftCorner.x / 640 * 100) + '%';
      focus.style.top = (loc.topLeftCorner.y / 480 * 100) + '%';
      focus.style.width = (loc.topRightCorner.x - loc.topLeftCorner.x) / 640 * 100 + '%';
      focus.style.height = (loc.bottomLeftCorner.y - loc.topLeftCorner.y) / 480 * 100 + '%';

      if (code.data.toLowerCase().includes(state.pending)) {
        state.clues.add(state.pending);
        state.pending = null;
        showToast("âœ… ç²å–ç·šç´¢æˆåŠŸï¼");
        setTimeout(closeScan, 500);
        updateUI();
        return;
      } else {
        // æƒæéŒ¯èª¤æé†’
        showToast(`âŒ æƒéŒ¯éƒ¨ä½å›‰ï¼ç›®å‰éœ€è¦ï¼š${bird.labels[state.pending]}`);
      }
    } else {
      focus.style.display = 'none';
    }
  }
  if (!document.getElementById('scanModal').classList.contains('hidden')) requestAnimationFrame(scanLoop);
}

/** ===========================
 * Identification Activity (Quiz)
 * =========================== */
document.getElementById('btnQuiz').onclick = () => {
  document.getElementById('quizModal').classList.remove('hidden');
  renderQuiz();
};

function renderQuiz() {
  const part = bird.parts[state.solved];
  document.getElementById('quizTitle').innerText = `é–‹å§‹è¾¨èªï¼š${bird.labels[part]}`;
  document.getElementById('quizQuestion').innerText = `ç·šç´¢ï¼š${bird.clues[part]}\nè«‹é¸å‡ºå°æ‡‰çš„å½¢ç‹€ï¼Ÿ`;
  
  const options = ["æ­£ç¢ºç‰¹å¾µ", "éŒ¯èª¤ç‰¹å¾µA", "éŒ¯èª¤ç‰¹å¾µB"]; // é€™è£¡æ‡‰å¾ä½ çš„ OPTION_LIB æŠ“åœ–ï¼Œç°¡åŒ–ç‚ºæ–‡å­—
  const optGrid = document.getElementById('quizOptions');
  optGrid.innerHTML = "";
  
  options.forEach((o, i) => {
    const b = document.createElement('button');
    b.className = "optBtn";
    b.innerText = o;
    b.onclick = () => {
      if(i === 0) {
        state.solved++;
        showToast("ç­”å°äº†ï¼æ‹¼è£é€²åº¦ +1");
        if(state.solved < 5) renderQuiz();
        else {
          document.getElementById('quizModal').classList.add('hidden');
          showToast("ğŸ‰ æ­å–œï¼ä½ å®Œæˆäº†éº»é›€çš„è¾¨èªï¼");
        }
        updateUI();
      } else {
        showToast(`ä¸å°å–”ï¼å†çœ‹çœ‹ç·šç´¢ï¼š${bird.clues[part]}`);
      }
    };
    optGrid.appendChild(b);
  });
}

async function startCamera() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
    document.getElementById('camera').srcObject = stream;
    state.cameraOn = true;
    updateUI();
  } catch (e) { showToast("ç›¸æ©Ÿéœ€è¦æˆæ¬Šï¼"); }
}

window.onload = startCamera;
</script>
</body>
</html>
