<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Bird Builder AR Demo</title>

  <!-- QR decoder -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

  <style>
    :root{
      --bg:#0b1220;
      --panel:#f4ecd8;
      --panel2:#efe3c6;
      --ink:#2b2b2b;
      --muted:#6b6256;
      --accent:#f0c14b;
      --good:#2e7d32;
      --bad:#c62828;
      --shadow: 0 18px 40px rgba(0,0,0,.35);
      --radius:18px;
    }
    *{box-sizing:border-box;font-family: ui-sans-serif, system-ui, -apple-system, "PingFang TC", "Noto Sans TC", "Microsoft JhengHei", sans-serif;}
    body{margin:0;background:var(--bg);color:#fff;overflow:hidden;}
    #app{position:relative;height:100dvh;width:100vw;background:#000;}
    video#camera{
      position:absolute;inset:0;width:100%;height:100%;object-fit:cover;
      filter:saturate(1.05) contrast(1.05);
      background:#000;
    }
    #overlay{position:absolute;inset:0;display:flex;flex-direction:column;justify-content:space-between;padding:14px;pointer-events:none;}
    .topbar{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;}
    .pill{
      pointer-events:auto;
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;border-radius:999px;
      background:rgba(20,20,20,.55);backdrop-filter: blur(8px);
      border:1px solid rgba(255,255,255,.12);
      font-size:14px;
    }
    .pill strong{font-weight:800;}
    .stage{
      pointer-events:none;
      display:flex;align-items:center;justify-content:center;
      min-height:44vh;
    }
    .birdCard{
      pointer-events:none;
      width:min(520px,92vw);
      background:rgba(20,20,20,.28);
      border:1px solid rgba(255,255,255,.14);
      border-radius:26px;
      padding:14px;
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:10px;
    }
    .birdCanvas{width:100%;display:flex;align-items:center;justify-content:center;}
    .birdCanvas svg{width:min(420px,86vw);height:auto;}
    .hintRow{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
    .chip{
      pointer-events:none;
      background:rgba(255,255,255,.14);
      border:1px solid rgba(255,255,255,.14);
      padding:6px 10px;border-radius:999px;
      font-size:12px;
    }

    .bottom{
      pointer-events:auto;
      display:flex;gap:10px;flex-wrap:wrap;justify-content:center;
      padding-bottom: calc(8px + env(safe-area-inset-bottom));
    }
    button{
      border:0;border-radius:16px;
      padding:12px 14px;font-size:15px;
      background:#ffffff; color:#111;
      box-shadow: 0 10px 18px rgba(0,0,0,.25);
      cursor:pointer;
    }
    button.dark{
      background:rgba(255,255,255,.16);color:#fff;border:1px solid rgba(255,255,255,.18);
      backdrop-filter: blur(8px);
    }
    button:disabled{opacity:.45;cursor:not-allowed;}

    .toast{
      pointer-events:none;
      position:absolute;left:50%;transform:translateX(-50%);
      bottom:118px;
      background:rgba(0,0,0,.70);color:#fff;
      padding:10px 14px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      backdrop-filter: blur(8px);
      font-size:14px;
      opacity:0;transition:opacity .2s;
      max-width:min(92vw,640px);
      text-align:center;
      line-height:1.3;
    }
    .toast.show{opacity:1;}

    /* Modal */
    .modal{
      position:absolute;inset:0;
      background:rgba(0,0,0,.55);
      display:flex;align-items:center;justify-content:center;
      padding:14px;
      z-index:50;
    }
    .hidden{display:none;}
    .box{
      width:min(780px,96vw);
      background:var(--panel);
      color:var(--ink);
      border-radius:22px;
      box-shadow: var(--shadow);
      border:1px solid rgba(0,0,0,.08);
      overflow:hidden;
    }
    .boxHeader{
      display:flex;align-items:center;justify-content:space-between;
      padding:14px 14px 10px 14px;
      background:linear-gradient(180deg, var(--panel), var(--panel2));
      border-bottom:1px solid rgba(0,0,0,.08);
    }
    .title{font-size:18px;font-weight:900;}
    .xbtn{
      width:38px;height:38px;border-radius:12px;border:0;
      background:rgba(0,0,0,.08);cursor:pointer;
      font-size:18px;line-height:1;
    }
    .stepDots{
      display:flex;gap:8px;align-items:center;flex-wrap:wrap;
      padding:10px 14px 0 14px;
    }
    .dot{
      width:34px;height:34px;border-radius:999px;
      display:flex;align-items:center;justify-content:center;
      background:rgba(0,0,0,.06);
      border:1px solid rgba(0,0,0,.10);
      font-weight:900;
      user-select:none;
    }
    .dot.active{background:var(--accent);border-color:rgba(0,0,0,.14);}
    .dot.done{background:rgba(46,125,50,.18);border-color:rgba(46,125,50,.25);color:var(--good);}

    .content{padding:12px 14px 14px 14px;display:flex;flex-direction:column;gap:10px;}
    .clueBox{
      background:rgba(255,255,255,.72);
      border:1px solid rgba(0,0,0,.08);
      border-radius:16px;
      padding:12px;
      line-height:1.35;
    }
    .clueBox small{color:var(--muted);display:block;margin-top:6px;}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;}
    .opt{
      background:#fff;
      border:2px solid rgba(0,0,0,.10);
      border-radius:18px;
      padding:12px;
      cursor:pointer;
      display:flex;gap:10px;align-items:center;
      min-height:88px;
      transition:transform .06s ease, border-color .06s ease;
    }
    .opt:hover{transform:translateY(-1px);}
    .opt svg{width:56px;height:56px;flex:0 0 auto;}
    .opt .lbl{font-weight:900;}
    .opt .desc{font-size:12px;color:var(--muted);margin-top:3px;line-height:1.25;}
    .opt.correct{border-color:rgba(46,125,50,.55);background:rgba(46,125,50,.08);}
    .opt.wrong{border-color:rgba(198,40,40,.55);background:rgba(198,40,40,.08);}

    .footer{
      padding:12px 14px 14px 14px;
      display:flex;gap:10px;justify-content:space-between;align-items:center;
      background:linear-gradient(180deg, var(--panel2), var(--panel));
      border-top:1px solid rgba(0,0,0,.08);
      flex-wrap:wrap;
    }
    .footer .left{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
    .footer .right{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
    .kpi{font-size:13px;color:var(--muted);}

    .btnSmall{padding:10px 12px;border-radius:14px;font-size:14px;}
    .btnPrimary{background:#1b1b1b;color:#fff;}
    .btnGhost{background:#fff;color:#111;border:1px solid rgba(0,0,0,.12);box-shadow:none;}
    .btnWarn{background:#9c1d1d;color:#fff;}

    /* Reveal / Assemble */
    .revealBody{padding:14px;display:flex;flex-direction:column;gap:10px;align-items:center;}
    .revealTag{
      display:inline-flex;align-items:center;gap:8px;
      background:rgba(240,193,75,.25);
      border:1px solid rgba(0,0,0,.10);
      padding:8px 12px;border-radius:999px;
      font-weight:900;
    }
    .summary{
      width:100%;
      background:#fff;border:1px solid rgba(0,0,0,.10);
      border-radius:18px;padding:12px;line-height:1.4;
    }
    .bob{animation:bob 1.8s ease-in-out infinite;transform-origin:center;}
    @keyframes bob{0%,100%{transform:translateY(0px);}50%{transform:translateY(-6px);}}

    /* Scan preview */
    .scanWrap{
      width:100%;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .scanPreviewBox{
      width:100%;
      border-radius:18px;
      overflow:hidden;
      border:1px solid rgba(0,0,0,.10);
      background:#111;
      position:relative;
    }
    canvas#scanPreview{
      width:100%;
      height:auto;
      display:block;
    }
    .scanBadge{
      position:absolute;
      left:12px;top:12px;
      background:rgba(0,0,0,.55);
      color:#fff;
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      border:1px solid rgba(255,255,255,.16);
      backdrop-filter: blur(8px);
    }

    /* Feed animation */
    #feedAnim{
      position:absolute;
      left:50%;
      bottom:110px;
      transform:translateX(-50%);
      z-index:20;
      pointer-events:none;
      opacity:0;
      font-size:28px;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.35));
    }
    #feedAnim.show{
      animation:feed 900ms ease-out 1;
      opacity:1;
    }
    @keyframes feed{
      0%{transform:translateX(-50%) translateY(18px) scale(.9);opacity:0;}
      25%{opacity:1;}
      70%{transform:translateX(-50%) translateY(-32px) scale(1.05);opacity:1;}
      100%{transform:translateX(-50%) translateY(-48px) scale(1.02);opacity:0;}
    }

    /* AI hint modal typing */
    .aiBox{
      background:#fff;
      border:1px solid rgba(0,0,0,.10);
      border-radius:18px;
      padding:12px;
      line-height:1.45;
      width:100%;
      min-height:120px;
      white-space:pre-wrap;
    }
  </style>
</head>

<body>
<div id="app">
  <video id="camera" autoplay playsinline muted></video>

  <div id="overlay">
    <div class="topbar">
      <div class="pill"><strong id="birdName">é³¥</strong> <span id="birdSub" style="opacity:.85"></span></div>
      <div class="pill">
        ç·šç´¢ <strong id="clueCount">0</strong>/5
        <span style="opacity:.6">|</span>
        å¾…æƒ <strong id="pendingText">â€”</strong>
        <span style="opacity:.6">|</span>
        AI æç¤º <strong id="hintLeft">2</strong>/2
      </div>
    </div>

    <div class="stage">
      <div class="birdCard">
        <div class="birdCanvas" id="birdCanvas"></div>
        <div class="hintRow" id="clueChips"></div>
        <div style="font-size:12px;opacity:.92;text-align:center;line-height:1.35">
          æµç¨‹ï¼š<strong>é¤µé³¥</strong> â†’ ç³»çµ±æŒ‡å®šè¦æƒå“ªå¼µç·šç´¢å¡ â†’ <strong>æƒæç·šç´¢å¡</strong>ï¼ˆæœƒé¡¯ç¤ºæƒæç•«é¢ï¼‰â†’ é›†æ»¿ 5 å¼µç·šç´¢ â†’ <strong>é–‹å§‹è¾¨èªï¼ˆ1â€“5ï¼‰</strong><br/>
          ç­”å°ä¸€é¡Œï¼šæœƒå…ˆçœ‹åˆ°<strong>æ‹¼è£çµæœ</strong>ï¼Œå†æŒ‰ã€Œä¸‹ä¸€æ­¥ã€é€²å…¥ä¸‹ä¸€é¡Œã€‚
        </div>
      </div>

      <div class="toast" id="toast"></div>
      <div id="feedAnim">ğŸâœ¨</div>
    </div>

    <div class="bottom">
      <button class="dark" id="btnCamera">å•Ÿå‹•ç›¸æ©Ÿ</button>
      <button id="btnFeed">é¤µé³¥ï¼ˆæ‰è½ç·šç´¢ï¼‰</button>
      <button class="dark" id="btnScan" disabled>æƒæç·šç´¢å¡</button>
      <button class="btnPrimary" id="btnQuiz" disabled>é–‹å§‹è¾¨èªï¼ˆ1/5ï¼‰</button>
      <button class="dark" id="btnReset">é‡ç½®æœ¬é³¥</button>
    </div>
  </div>

  <!-- QUIZ MODAL -->
  <div class="modal hidden" id="quizModal">
    <div class="box">
      <div class="boxHeader">
        <div class="title" id="quizTitle">è¾¨èªé³¥é¡</div>
        <button class="xbtn" id="closeQuiz">Ã—</button>
      </div>

      <div class="stepDots" id="stepDots"></div>

      <div class="content">
        <div class="clueBox" id="clueBox"></div>
        <div class="grid" id="optionsGrid"></div>
      </div>

      <div class="footer">
        <div class="left">
          <div class="kpi" id="kpiText">AI æç¤ºï¼šä¸çˆ†é›·ï¼ŒåªæŠŠç·šç´¢æ‹†æˆå¯è§€å¯Ÿçš„é‡é»ã€‚</div>
          <button class="btnSmall btnGhost" id="btnHintQuiz">AI æç¤º</button>
        </div>
        <div class="right">
          <button class="btnSmall btnGhost" id="btnCloseQuiz2">é—œé–‰</button>
        </div>
      </div>
    </div>
  </div>

  <!-- AI HINT MODAL -->
  <div class="modal hidden" id="aiModal">
    <div class="box" style="max-width:700px;">
      <div class="boxHeader">
        <div class="title">AI åŠ©æ•™æç¤º</div>
        <button class="xbtn" id="closeAi">Ã—</button>
      </div>
      <div class="content">
        <div class="aiBox" id="aiText"></div>
        <div style="display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap">
          <button class="btnSmall btnGhost" id="aiOk">çŸ¥é“äº†</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ASSEMBLE MODAL -->
  <div class="modal hidden" id="assembleModal">
    <div class="box">
      <div class="boxHeader">
        <div class="title" id="assembleTitle">å·²æ‹¼ä¸Šéƒ¨ä½</div>
        <button class="xbtn" id="closeAssemble">Ã—</button>
      </div>
      <div class="revealBody">
        <div class="revealTag" id="assembleTag">â€”</div>
        <div id="assembleBird"></div>
        <div class="summary" id="assembleSummary"></div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:center">
          <button class="btnPrimary" id="btnAssembleNext">ä¸‹ä¸€æ­¥</button>
        </div>
      </div>
    </div>
  </div>

  <!-- REVEAL MODAL -->
  <div class="modal hidden" id="revealModal">
    <div class="box">
      <div class="boxHeader">
        <div class="title">å®Œæˆï¼</div>
        <button class="xbtn" id="closeReveal">Ã—</button>
      </div>
      <div class="revealBody">
        <div class="revealTag" id="revealName">é³¥å</div>
        <div id="revealBird"></div>
        <div class="summary" id="revealSummary"></div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:center">
          <button class="btnPrimary" id="btnReplay">å†ç©ä¸€æ¬¡</button>
          <button class="btnGhost" id="btnCopyLink">è¤‡è£½æ­¤é³¥é€£çµ</button>
        </div>
      </div>
    </div>
  </div>

  <!-- START CAMERA OVERLAY (iOS needs user gesture) -->
  <div class="modal hidden" id="startOverlay">
    <div class="box" style="max-width:560px;">
      <div class="boxHeader">
        <div class="title">éœ€è¦å•Ÿç”¨ç›¸æ©Ÿ</div>
        <button class="xbtn" id="closeStartOverlay">Ã—</button>
      </div>
      <div class="content">
        <div style="font-weight:900;font-size:16px">iPhone/Safari è¦å‰‡ï¼šç›¸æ©Ÿå¿…é ˆç”±é»æ“Šè§¸ç™¼</div>
        <div style="color:var(--muted);line-height:1.45">
          è«‹é»ä¸‹æ–¹æŒ‰éˆ•å•Ÿå‹•ä¸€æ¬¡ç›¸æ©Ÿã€‚ä¹‹å¾Œä½ å°±ä¸éœ€è¦å†æŒ‰ã€Œå•Ÿå‹•ç›¸æ©Ÿã€äº†ã€‚
        </div>
        <button class="btnSmall btnPrimary" id="btnStartCameraNow">é»ä¸€ä¸‹é–‹å•Ÿç›¸æ©Ÿ</button>
      </div>
    </div>
  </div>

  <!-- SCAN CLUE CARD OVERLAY -->
  <div class="modal hidden" id="scanOverlay">
    <div class="box" style="max-width:720px;">
      <div class="boxHeader">
        <div class="title">æƒæç·šç´¢å¡</div>
        <button class="xbtn" id="btnStopScan">Ã—</button>
      </div>
      <div class="content">
        <div class="scanWrap">
          <div class="scanPreviewBox">
            <div class="scanBadge" id="scanBadge">æƒæä¸­â€¦</div>
            <canvas id="scanPreview" width="960" height="540"></canvas>
          </div>

          <div class="clueBox" id="scanHintText"></div>

          <div style="font-size:13px;color:var(--muted);line-height:1.45">
            ç›®å‰éœ€è¦æƒæï¼š<strong id="scanNeedText">â€”</strong><br/>
            å»ºè­°ï¼šQR ä½”ç•«é¢ 1/4 ä»¥ä¸Šã€ä¿æŒç©©å®š 1 ç§’ã€é¿å…åå…‰ã€‚
          </div>

          <div style="display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap">
            <button class="btnSmall btnGhost" id="btnStopScan2">å–æ¶ˆæƒæ</button>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>

<script>
/** ===========================
 *  0) Query params / storage
 * =========================== */
const qs = new URLSearchParams(location.search);
const CLAIM = qs.get("claim");                 // fallback: if external scanner opens link
const START = qs.get("start") === "1";
const BIRD_PARAM = qs.get("bird") || localStorage.getItem("bbdemo:lastBird") || "sparrow";
localStorage.setItem("bbdemo:lastBird", BIRD_PARAM);

const STORAGE_KEY = (birdKey)=>`bbdemo:state:${birdKey}`;
const deepClone = (o)=>JSON.parse(JSON.stringify(o));

/** ===========================
 *  1) Steps fixed 1â€“5
 * =========================== */
const STEPS = [
  { key:"legs", label:"è…³" },
  { key:"body", label:"èº«é«”" },
  { key:"wing", label:"ç¿…è†€" },
  { key:"tail", label:"å°¾å·´" },
  { key:"head", label:"é ­/è¨˜è™Ÿ" },
];

/** ===========================
 *  2) Option SVG library
 * =========================== */
function svgWrap(inner){ return `
<svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
  ${inner}
</svg>`; }

const OPTION_LIB = {
  legs: {
    pink:  { label:"ç²‰ç´…è…³", desc:"åç²‰ç´…ã€çŸ­è…¿", svg: svgWrap(`<path d="M24 12c3 8 1 14-4 20" stroke="#e17b86" stroke-width="4" fill="none" stroke-linecap="round"/>
      <path d="M40 12c-3 8-1 14 4 20" stroke="#e17b86" stroke-width="4" fill="none" stroke-linecap="round"/>
      <path d="M18 34h10" stroke="#e17b86" stroke-width="4" stroke-linecap="round"/>
      <path d="M36 34h10" stroke="#e17b86" stroke-width="4" stroke-linecap="round"/>`) },
    black: { label:"é»‘è‰²è…³", desc:"åé»‘ã€æŠ“æç©©", svg: svgWrap(`<path d="M24 12c3 10 1 16-4 24" stroke="#1d2330" stroke-width="4" fill="none" stroke-linecap="round"/>
      <path d="M40 12c-3 10-1 16 4 24" stroke="#1d2330" stroke-width="4" fill="none" stroke-linecap="round"/>
      <path d="M16 40h14" stroke="#1d2330" stroke-width="4" stroke-linecap="round"/>
      <path d="M34 40h14" stroke="#1d2330" stroke-width="4" stroke-linecap="round"/>`) },
    brown: { label:"è¤è‰²è…³", desc:"åè¤ã€çŸ­è€Œç´°", svg: svgWrap(`<path d="M24 12c3 9 1 15-4 22" stroke="#6b4a2f" stroke-width="4" fill="none" stroke-linecap="round"/>
      <path d="M40 12c-3 9-1 15 4 22" stroke="#6b4a2f" stroke-width="4" fill="none" stroke-linecap="round"/>
      <path d="M16 38h14" stroke="#6b4a2f" stroke-width="4" stroke-linecap="round"/>
      <path d="M34 38h14" stroke="#6b4a2f" stroke-width="4" stroke-linecap="round"/>`) },
    long:  { label:"é•·è…¿", desc:"è…¿æ˜é¡¯è¼ƒé•·", svg: svgWrap(`<path d="M24 8c2 14 0 22-4 34" stroke="#303a4a" stroke-width="4" fill="none" stroke-linecap="round"/>
      <path d="M40 8c-2 14 0 22 4 34" stroke="#303a4a" stroke-width="4" fill="none" stroke-linecap="round"/>
      <path d="M14 44h18" stroke="#303a4a" stroke-width="4" stroke-linecap="round"/>
      <path d="M32 44h18" stroke="#303a4a" stroke-width="4" stroke-linecap="round"/>`) },
  },
  body: {
    sparrow: { label:"è¤è‰²å¸¶ç´‹", desc:"èƒŒéƒ¨æœ‰æ·±è‰²æ¢ç´‹æ„Ÿ", svg: svgWrap(`
      <ellipse cx="32" cy="34" rx="20" ry="14" fill="#b07a45"/>
      <path d="M18 28c6 2 12 2 20 0" stroke="#6a4529" stroke-width="3" opacity=".8"/>
      <path d="M18 34c6 2 12 2 20 0" stroke="#6a4529" stroke-width="3" opacity=".8"/>
      <path d="M18 40c6 2 12 2 20 0" stroke="#6a4529" stroke-width="3" opacity=".8"/>`) },
    bulbul:  { label:"ç°è¤èº«é«”", desc:"ç°è¤ã€è…¹éƒ¨è¼ƒæ·¡", svg: svgWrap(`
      <ellipse cx="32" cy="34" rx="20" ry="14" fill="#9d8f86"/>
      <ellipse cx="34" cy="38" rx="16" ry="10" fill="#c6bbb4" opacity=".9"/>`) },
    dove:    { label:"åœŸè¤åç²‰", desc:"æ¨¸ç´ æº«å’Œçš„åœŸè¤è‰²", svg: svgWrap(`
      <ellipse cx="32" cy="34" rx="20" ry="14" fill="#c08e78"/>
      <ellipse cx="35" cy="38" rx="15" ry="9" fill="#d8b1a1" opacity=".85"/>`) },
    drongo:  { label:"äº®é»‘èº«é«”", desc:"åé»‘ã€ç•¥æœ‰é‡‘å±¬æ„Ÿ", svg: svgWrap(`
      <ellipse cx="32" cy="34" rx="20" ry="14" fill="#1b1f27"/>
      <path d="M18 30c6-4 24-4 30 0" stroke="#4a5a78" stroke-width="3" opacity=".35"/>`) },
    whiteeye:{ label:"ç¶ é»ƒèº«é«”", desc:"ç¶ é»ƒã€è…¹éƒ¨è¼ƒæ·¡", svg: svgWrap(`
      <ellipse cx="32" cy="34" rx="20" ry="14" fill="#8dbb3e"/>
      <ellipse cx="34" cy="38" rx="16" ry="10" fill="#d8e58b" opacity=".9"/>`) },
  },
  wing: {
    roundBar:{ label:"åœ“ç¿¼ï¼‹æ·¡ç¿¼å¸¶", desc:"çŸ­åœ“ã€å¸¸è¦‹æ·¡è‰²ç¿¼å¸¶", svg: svgWrap(`
      <path d="M14 44c10-22 28-28 36-10-4 14-18 24-36 10z" fill="#6a4a2f" opacity=".85"/>
      <path d="M18 38c10-8 18-9 26-2" stroke="#f3e7c8" stroke-width="4" stroke-linecap="round" opacity=".9"/>`) },
    shortRound:{ label:"çŸ­åœ“ç¿¼", desc:"æ•´é«”åœ“éˆã€ä¸å°–", svg: svgWrap(`
      <path d="M14 44c10-22 28-28 36-10-4 14-18 24-36 10z" fill="#a87956"/>
      <path d="M18 38c10-8 18-9 26-2" stroke="#7b5a45" stroke-width="3" stroke-linecap="round" opacity=".7"/>`) },
    longPoint:{ label:"é•·å°–ç¿¼", desc:"è¼ƒé•·ã€ç¿¼ç«¯å°–", svg: svgWrap(`
      <path d="M12 46c18-30 34-30 40-14-8 18-24 26-40 14z" fill="#1b1f27"/>
      <path d="M18 40c12-10 22-10 30-2" stroke="#4a5a78" stroke-width="3" stroke-linecap="round" opacity=".45"/>`) },
    greenSmall:{ label:"å°å·§ç¶ ç¿¼", desc:"åå°ã€èˆ‡èº«é«”åŒè‰²ç³»", svg: svgWrap(`
      <path d="M16 46c10-18 26-22 34-8-6 12-18 18-34 8z" fill="#7aa62f"/>
      <path d="M20 40c8-6 14-6 20-1" stroke="#d8e58b" stroke-width="3" stroke-linecap="round" opacity=".8"/>`) },
  },
  tail: {
    shortRound:{ label:"çŸ­åœ“å°¾", desc:"å°¾çŸ­ã€æœ«ç«¯åœ“", svg: svgWrap(`<path d="M18 40c8-8 20-8 28 0-10 12-18 12-28 0z" fill="#8dbb3e"/>`) },
    square:   { label:"ä¸­é•·æ–¹å°¾", desc:"æœ«ç«¯åå¹³", svg: svgWrap(`<path d="M18 42h28v10c-10 4-18 4-28 0z" fill="#9d8f86"/>`) },
    longRound:{ label:"é•·åœ“å°¾", desc:"å°¾è¼ƒé•·ã€æœ«ç«¯åœ“", svg: svgWrap(`<path d="M20 34c8-10 16-10 24 0v22c-10 6-14 6-24 0z" fill="#c08e78"/>`) },
    fork:     { label:"æ·±å‰å°¾", desc:"åƒå‰ªåˆ€ï¼Œå°¾ç«¯åˆ†å‰", svg: svgWrap(`
      <path d="M32 22c-6 10-10 22-10 34 6-6 10-10 10-10s4 4 10 10c0-12-4-24-10-34z" fill="#1b1f27"/>
      <path d="M32 46l-10 10" stroke="#4a5a78" stroke-width="3" opacity=".35"/>
      <path d="M32 46l10 10" stroke="#4a5a78" stroke-width="3" opacity=".35"/>`) },
  },
  head: {
    plainBrown:{ label:"ç´ è‰²æ£•é ­", desc:"æ²’æœ‰ç™½çœ¼åœˆ/ç™½é ­/é …éŠæ–‘", svg: svgWrap(`
      <circle cx="28" cy="30" r="10" fill="#b07a45"/>
      <path d="M36 30l14-6-14 0z" fill="#c89c4a"/>`) },
    whiteHead:{ label:"ç™½é ­é»‘è‡‰", desc:"é ­é ‚åç™½ã€è‡‰å´è¼ƒæ·±", svg: svgWrap(`
      <circle cx="28" cy="30" r="10" fill="#e9e3d8"/>
      <path d="M22 26c6 0 12 8 12 12-10 2-14-2-18-8z" fill="#2a2f3a" opacity=".85"/>
      <path d="M36 30l14-6-14 0z" fill="#c89c4a"/>`) },
    spottedNeck:{ label:"ç é ¸æ–‘é»", desc:"é ¸å´é»‘ç™½æ–‘åƒé …éŠ", svg: svgWrap(`
      <circle cx="28" cy="28" r="10" fill="#c08e78"/>
      <path d="M24 38c6-2 12-2 18 2" stroke="#1b1f27" stroke-width="3" stroke-dasharray="2 4" opacity=".85"/>
      <path d="M36 28l14-6-14 0z" fill="#c89c4a"/>`) },
    blackHead:{ label:"å…¨é»‘é ­", desc:"é ­éƒ¨ä¹Ÿåé»‘", svg: svgWrap(`
      <circle cx="28" cy="30" r="10" fill="#1b1f27"/>
      <path d="M36 30l14-6-14 0z" fill="#303a4a"/>`) },
    whiteEyeRing:{ label:"ç™½è‰²çœ¼åœˆ", desc:"çœ¼å‘¨æœ‰æ˜é¡¯ç™½åœˆ", svg: svgWrap(`
      <circle cx="28" cy="30" r="10" fill="#8dbb3e"/>
      <circle cx="28" cy="30" r="5.5" fill="none" stroke="#ffffff" stroke-width="3"/>
      <path d="M36 30l14-6-14 0z" fill="#1b1f27"/>`) },
  }
};

/** ===========================
 *  3) Bird content (5 birds)
 * =========================== */
const BIRDS = {
  sparrow: {
    name:"éº»é›€", sub:"demo",
    summary:"éº»é›€å¸¸è¦‹æ–¼äººé¡å±…ä½ç’°å¢ƒï¼Œèº«é«”è¤è‰²å¸¶ç´‹ï¼Œç¿…çŸ­åœ“ï¼Œæ•´é«”å°å·§ã€‚è§€å¯Ÿé‡é»ï¼šèƒŒéƒ¨æ¢ç´‹ã€ç¿¼å¸¶ã€å°¾ç«¯å½¢ç‹€ã€‚",
    palette:{ body:"#b07a45", belly:"#e6d3b2", wing:"#6a4529", tail:"#7a5637", head:"#b07a45", legs:"#6b4a2f", beak:"#c89c4a" },
    cluePool:{
      legs:["è…³çŸ­çŸ­ã€åè¤è‰²ï¼Œèµ°è·³å¾ˆéˆæ´»ã€‚","è…³ä¸ç²‰ç´…ä¹Ÿä¸ç‰¹åˆ¥é•·ï¼Œåè¤è‰²ã€‚"],
      body:["èº«é«”è¤è‰²ï¼ŒèƒŒä¸Šæœ‰æ·±è‰²æ¢ç´‹æ„Ÿã€‚","æ•´é«”æ˜¯æ¨¸ç´ çš„è¤è‰²èª¿ï¼Œæ–‘ç´‹æ˜é¡¯ã€‚"],
      wing:["ç¿…è†€çŸ­åœ“ï¼Œå¸¸è¦‹æ·¡è‰²ç¿¼å¸¶ã€‚","ç¿¼å‹ä¸å°–ï¼Œå¸¶ä¸€æ¢æ·¡è‰²ç·šã€‚"],
      tail:["å°¾å·´ä¸­ç­‰é•·åº¦ï¼Œæœ«ç«¯åå¹³ã€‚","å°¾ç«¯ä¸æ·±å‰ï¼Œè¼ƒåƒæ–¹å°¾ã€‚"],
      head:["é ­éƒ¨ç´ è‰²æ£•ï¼Œæ²’æœ‰ç™½çœ¼åœˆæˆ–ç™½é ­ã€‚","é ­é ¸æ²’æœ‰é …éŠæ–‘é»ï¼Œæ•´é«”å¾ˆæ¨¸ç´ ã€‚"],
    },
    quiz:{
      legs:{ prompt:"æ­¥é©Ÿ 1ï¼ˆè…³ï¼‰ï¼šé¸æœ€ç¬¦åˆæ•˜è¿°çš„è…³å‹ã€‚", options:["pink","brown","black","long"], correct:"brown" },
      body:{ prompt:"æ­¥é©Ÿ 2ï¼ˆèº«é«”ï¼‰ï¼šé¸æœ€ç¬¦åˆæ•˜è¿°çš„èº«é«”ã€‚", options:["sparrow","dove","bulbul","whiteeye"], correct:"sparrow" },
      wing:{ prompt:"æ­¥é©Ÿ 3ï¼ˆç¿…è†€ï¼‰ï¼šé¸æœ€ç¬¦åˆæ•˜è¿°çš„ç¿…è†€ã€‚", options:["roundBar","shortRound","greenSmall","longPoint"], correct:"roundBar" },
      tail:{ prompt:"æ­¥é©Ÿ 4ï¼ˆå°¾å·´ï¼‰ï¼šé¸æœ€ç¬¦åˆæ•˜è¿°çš„å°¾å·´ã€‚", options:["square","shortRound","fork","longRound"], correct:"square" },
      head:{ prompt:"æ­¥é©Ÿ 5ï¼ˆé ­/è¨˜è™Ÿï¼‰ï¼šé¸æœ€ç¬¦åˆæ•˜è¿°çš„é ­éƒ¨/è¨˜è™Ÿã€‚", options:["plainBrown","whiteEyeRing","whiteHead","spottedNeck"], correct:"plainBrown" },
    },
    ai:{
      legs:["å…ˆçœ‹é¡è‰²ï¼šåè¤ä¸æ˜¯ç²‰ç´…ã€‚","å†çœ‹æ¯”ä¾‹ï¼šè…¿ä¸é•·ï¼Œç·šæ¢çŸ­è€Œç´°ã€‚"],
      body:["å…ˆæŠ“ã€è¤è‰²ã€ä¸»è‰²ï¼Œå†æ‰¾ã€æ·±è‰²æ¢ç´‹æ„Ÿã€ã€‚","å¦‚æœçœ‹èµ·ä¾†åç¶ æˆ–åç°ï¼Œå°±å…ˆæ’é™¤ã€‚"],
      wing:["å…ˆçœ‹ç¿¼å‹ï¼šçŸ­åœ“ä¸æ˜¯å°–é•·ã€‚","å†æ‰¾ã€æ·¡è‰²ç¿¼å¸¶ã€é‚£æ¢ç·šã€‚"],
      tail:["å…ˆæ’é™¤æ·±å‰å°¾ï¼ˆåƒå‰ªåˆ€ï¼‰ã€‚","æœ«ç«¯åå¹³ã€è¼ƒåƒæ–¹å°¾ã€‚"],
      head:["å…ˆæ’é™¤ç™½çœ¼åœˆã€ç™½é ­ã€é …éŠæ–‘ã€‚","é¸æœ€ã€æ¨¸ç´ çš„æ£•é ­ã€ã€‚"],
    }
  },
  bulbul: {
    name:"ç™½é ­ç¿", sub:"demo",
    summary:"ç™½é ­ç¿é ­é ‚åç™½ã€è‡‰å´è¼ƒæ·±ï¼Œèº«é«”ç°è¤ã€è…¹éƒ¨è¼ƒæ·¡ã€‚è§€å¯Ÿé‡é»ï¼šç™½é ­èˆ‡è‡‰éƒ¨å°æ¯”ã€å°¾å½¢ä¸­é•·ã€‚",
    palette:{ body:"#9d8f86", belly:"#c6bbb4", wing:"#6b6256", tail:"#6b6256", head:"#e9e3d8", legs:"#1d2330", beak:"#c89c4a" },
    cluePool:{
      legs:["è…³åé»‘ï¼ŒæŠ“æå¾ˆç©©ã€‚","è…³è‰²è¼ƒæ·±ï¼Œä¸¦ä¸ç²‰ç´…ã€‚"],
      body:["èº«é«”ç°è¤ï¼Œè…¹éƒ¨è¼ƒæ·¡ã€‚","æ•´é«”ç°è¤ï¼Œä¸æ˜¯ç¶ é»ƒæˆ–äº®é»‘ã€‚"],
      wing:["ç¿…è†€æ·±è‰²ã€é‚Šç·£å¸¶æ·¡è‰²ã€‚","ç¿¼é¢åæ·±ï¼Œç·šæ¢ä¿è½ã€‚"],
      tail:["å°¾å·´ä¸­é•·ï¼Œæœ«ç«¯åæ–¹ã€‚","å°¾ä¸æ·±å‰ï¼Œé•·åº¦ä¸­ç­‰ã€‚"],
      head:["é ­é ‚åç™½ï¼Œè‡‰å´è¼ƒæ·±ã€‚","ç™½é ­æ˜¯æœ€é†’ç›®çš„ç·šç´¢ã€‚"],
    },
    quiz:{
      legs:{ prompt:"æ­¥é©Ÿ 1ï¼ˆè…³ï¼‰ï¼šé¸æœ€ç¬¦åˆæ•˜è¿°çš„è…³å‹ã€‚", options:["black","brown","pink","long"], correct:"black" },
      body:{ prompt:"æ­¥é©Ÿ 2ï¼ˆèº«é«”ï¼‰ï¼šé¸æœ€ç¬¦åˆæ•˜è¿°çš„èº«é«”ã€‚", options:["bulbul","sparrow","whiteeye","drongo"], correct:"bulbul" },
      wing:{ prompt:"æ­¥é©Ÿ 3ï¼ˆç¿…è†€ï¼‰ï¼šé¸æœ€ç¬¦åˆæ•˜è¿°çš„ç¿…è†€ã€‚", options:["roundBar","shortRound","longPoint","greenSmall"], correct:"roundBar" },
      tail:{ prompt:"æ­¥é©Ÿ 4ï¼ˆå°¾å·´ï¼‰ï¼šé¸æœ€ç¬¦åˆæ•˜è¿°çš„å°¾å·´ã€‚", options:["square","fork","longRound","shortRound"], correct:"square" },
      head:{ prompt:"æ­¥é©Ÿ 5ï¼ˆé ­/è¨˜è™Ÿï¼‰ï¼šé¸æœ€ç¬¦åˆæ•˜è¿°çš„é ­éƒ¨/è¨˜è™Ÿã€‚", options:["whiteHead","plainBrown","whiteEyeRing","blackHead"], correct:"whiteHead" },
    },
    ai:{
      legs:["å…ˆæ’é™¤ç²‰ç´…è…³ã€‚","æ·±è‰²è…³é€šå¸¸åé»‘ã€‚"],
      body:["æŠ“ã€ç°è¤ã€ä¸»è‰²ï¼‹ã€è…¹éƒ¨è¼ƒæ·¡ã€ã€‚","å…¨é»‘èˆ‡ç¶ é»ƒå…ˆæ’é™¤ã€‚"],
      wing:["ç¿¼é¢åæ·±ã€å¸¶æ·¡è‰²é‚Šç·£ã€‚","ä¸æ˜¯å°–é•·ç¿¼å‹ã€‚"],
      tail:["æ·±å‰å°¾å…ˆæ’é™¤ã€‚","æœ«ç«¯åå¹³ï¼Œåƒæ–¹å°¾ã€‚"],
      head:["æ‰¾ã€ç™½é ­ã€ï¼‹è‡‰å´è¼ƒæ·±ã€‚","ç™½çœ¼åœˆä¸æ˜¯ç™½é ­ã€‚"],
    }
  },
  dove: {
    name:"ç é ¸æ–‘é³©", sub:"demo",
    summary:"ç é ¸æ–‘é³©èº«é«”åœŸè¤åç²‰ï¼Œè…³åç²‰ç´…ï¼Œé ¸å´æœ‰é»‘ç™½æ–‘é»åƒé …éŠã€‚è§€å¯Ÿé‡é»ï¼šç é ¸æ–‘é»èˆ‡é•·åœ“å°¾ã€‚",
    palette:{ body:"#c08e78", belly:"#d8b1a1", wing:"#a87956", tail:"#c08e78", head:"#c08e78", legs:"#e17b86", beak:"#c89c4a" },
    cluePool:{
      legs:["è…³åç²‰ç´…ï¼Œä¸é•·ã€‚","ç²‰ç´…è…³æ˜¯å¾ˆæ˜é¡¯çš„ç·šç´¢ã€‚"],
      body:["èº«é«”åœŸè¤åç²‰ï¼Œæ•´é«”æ¨¸ç´ ã€‚","é¡è‰²æº«å’Œï¼Œä¸æ˜¯ç°è¤ä¹Ÿä¸æ˜¯äº®é»‘ã€‚"],
      wing:["ç¿…è†€åŒè‰²ç³»ï¼Œæ²’æœ‰é®®è±”è‰²å¡Šã€‚","ç¿¼å‹ååœ“ï¼Œä¸å°–ã€‚"],
      tail:["å°¾å·´è¼ƒé•·ï¼Œæœ«ç«¯åœ“ã€‚","å°¾ä¸æ·±å‰ï¼Œç·šæ¢æŸ”å’Œã€‚"],
      head:["é ¸å´æœ‰é»‘ç™½æ–‘é»åƒé …éŠã€‚","ç é ¸æ–‘é»æ˜¯è¾¨è­˜é‡é»ã€‚"],
    },
    quiz:{
      legs:{ prompt:"æ­¥é©Ÿ 1ï¼ˆè…³ï¼‰ï¼šé¸æœ€ç¬¦åˆæ•˜è¿°çš„è…³å‹ã€‚", options:["pink","brown","black","long"], correct:"pink" },
      body:{ prompt:"æ­¥é©Ÿ 2ï¼ˆèº«é«”ï¼‰ï¼šé¸æœ€ç¬¦åˆæ•˜è¿°çš„èº«é«”ã€‚", options:["dove","sparrow","bulbul","whiteeye"], correct:"dove" },
      wing:{ prompt:"æ­¥é©Ÿ 3ï¼ˆç¿…è†€ï¼‰ï¼šé¸æœ€ç¬¦åˆæ•˜è¿°çš„ç¿…è†€ã€‚", options:["shortRound","roundBar","longPoint","greenSmall"], correct:"shortRound" },
      tail:{ prompt:"æ­¥é©Ÿ 4ï¼ˆå°¾å·´ï¼‰ï¼šé¸æœ€ç¬¦åˆæ•˜è¿°çš„å°¾å·´ã€‚", options:["longRound","square","fork","shortRound"], correct:"longRound" },
      head:{ prompt:"æ­¥é©Ÿ 5ï¼ˆé ­/è¨˜è™Ÿï¼‰ï¼šé¸æœ€ç¬¦åˆæ•˜è¿°çš„é ­éƒ¨/è¨˜è™Ÿã€‚", options:["spottedNeck","plainBrown","whiteHead","whiteEyeRing"], correct:"spottedNeck" },
    },
    ai:{
      legs:["ç²‰ç´…è…³å¾ˆé—œéµï¼Œå…ˆçœ‹é¡è‰²ã€‚","å¦‚æœåƒé»‘è‰²æˆ–è¤è‰²ï¼Œå°±æ’é™¤ã€‚"],
      body:["åœŸè¤åç²‰ï¼Œè‰²èª¿æº«å’Œã€‚","ä¸æ˜¯ç°è¤ä¹Ÿä¸æ˜¯ç¶ é»ƒã€‚"],
      wing:["ç¿¼å‹ååœ“ï¼Œä¸å°–é•·ã€‚","åŒè‰²ç³»ã€ä¸é®®è±”ã€‚"],
      tail:["å°¾è¼ƒé•·ã€æœ«ç«¯åœ“ã€‚","æ·±å‰å°¾å…ˆæ’é™¤ã€‚"],
      head:["æ‰¾ã€é ¸å´é»‘ç™½æ–‘é»ã€åƒé …éŠã€‚","ç™½é ­/ç™½çœ¼åœˆéƒ½ä¸æ˜¯ã€‚"],
    }
  },
  drongo: {
    name:"å¤§å·å°¾", sub:"demo",
    summary:"å¤§å·å°¾å…¨èº«åé»‘å¸¶é‡‘å±¬å…‰æ¾¤ï¼Œå°¾å·´æ·±å‰åƒå‰ªåˆ€ã€‚è§€å¯Ÿé‡é»ï¼šæ·±å‰å°¾èˆ‡é•·å°–ç¿¼ã€‚",
    palette:{ body:"#1b1f27", belly:"#2a3342", wing:"#1b1f27", tail:"#1b1f27", head:"#1b1f27", legs:"#1d2330", beak:"#303a4a" },
    cluePool:{
      legs:["è…³é»‘è‰²ï¼Œç«™ç«‹å¾ˆéˆæ´»ã€‚","æ·±è‰²è…³ã€æŠ“æç©©ã€‚"],
      body:["å…¨èº«åé»‘ï¼Œå¸¶ä¸€é»é‡‘å±¬å…‰æ¾¤ã€‚","èº«é«”é¡è‰²å¾ˆæ·±ï¼Œå¹¾ä¹å…¨é»‘ã€‚"],
      wing:["ç¿…è†€é•·è€Œå°–ï¼Œé£›èµ·ä¾†å¾ˆä¿è½ã€‚","ç¿¼å‹åå°–é•·ã€‚"],
      tail:["å°¾å·´æ·±å‰ï¼Œåƒå‰ªåˆ€ã€‚","æ·±å‰å°¾æ˜¯æœ€é—œéµçš„è¾¨è­˜ç·šç´¢ã€‚"],
      head:["é ­éƒ¨ä¹Ÿåé»‘ï¼Œæ²’æœ‰ç™½æ–‘ã€‚","æ•´é«”æ²’æœ‰ç™½çœ¼åœˆæˆ–ç™½é ­ã€‚"],
    },
    quiz:{
      legs:{ prompt:"æ­¥é©Ÿ 1ï¼ˆè…³ï¼‰ï¼šé¸æœ€ç¬¦åˆæ•˜è¿°çš„è…³å‹ã€‚", options:["black","brown","pink","long"], correct:"black" },
      body:{ prompt:"æ­¥é©Ÿ 2ï¼ˆèº«é«”ï¼‰ï¼šé¸æœ€ç¬¦åˆæ•˜è¿°çš„èº«é«”ã€‚", options:["drongo","bulbul","sparrow","whiteeye"], correct:"drongo" },
      wing:{ prompt:"æ­¥é©Ÿ 3ï¼ˆç¿…è†€ï¼‰ï¼šé¸æœ€ç¬¦åˆæ•˜è¿°çš„ç¿…è†€ã€‚", options:["longPoint","roundBar","shortRound","greenSmall"], correct:"longPoint" },
      tail:{ prompt:"æ­¥é©Ÿ 4ï¼ˆå°¾å·´ï¼‰ï¼šé¸æœ€ç¬¦åˆæ•˜è¿°çš„å°¾å·´ã€‚", options:["fork","square","longRound","shortRound"], correct:"fork" },
      head:{ prompt:"æ­¥é©Ÿ 5ï¼ˆé ­/è¨˜è™Ÿï¼‰ï¼šé¸æœ€ç¬¦åˆæ•˜è¿°çš„é ­éƒ¨/è¨˜è™Ÿã€‚", options:["blackHead","plainBrown","whiteHead","whiteEyeRing"], correct:"blackHead" },
    },
    ai:{
      legs:["ç²‰ç´…è…³å…ˆæ’é™¤ã€‚","æ·±è‰²è…³é€šå¸¸é¸é»‘ã€‚"],
      body:["å…ˆæŠ“ã€å…¨é»‘ã€ï¼Œä¸è¦è¢«èƒŒæ™¯å½±éŸ¿ã€‚","ç°è¤/ç¶ é»ƒå…ˆæ’é™¤ã€‚"],
      wing:["å°–é•·ç¿¼ vs åœ“ç¿¼è¦åˆ†æ¸…æ¥šã€‚","ç¿¼ç«¯æ˜é¡¯è¼ƒå°–ã€‚"],
      tail:["å…ˆæ‰¾æ·±å‰å°¾ï¼ˆå‰ªåˆ€å°¾ï¼‰ã€‚","åªè¦ä¸æ˜¯æ·±å‰ï¼Œå¹¾ä¹éƒ½éŒ¯ã€‚"],
      head:["ç™½é ­/ç™½çœ¼åœˆéƒ½ä¸æ˜¯ã€‚","é¸æœ€ä¹¾æ·¨çš„é»‘é ­ã€‚"],
    }
  },
  whiteeye: {
    name:"ç¶ ç¹¡çœ¼", sub:"demo",
    summary:"ç¶ ç¹¡çœ¼é«”è‰²ç¶ é»ƒï¼Œæœ€é†’ç›®æ˜¯çœ¼å‘¨ç™½è‰²çœ¼åœˆã€‚è§€å¯Ÿé‡é»ï¼šç™½çœ¼åœˆèˆ‡ç¶ é»ƒèº«é«”ã€å°¾çŸ­ã€‚",
    palette:{ body:"#8dbb3e", belly:"#d8e58b", wing:"#7aa62f", tail:"#7aa62f", head:"#8dbb3e", legs:"#1d2330", beak:"#1b1f27" },
    cluePool:{
      legs:["è…³ç´°å°åé»‘ã€‚","æ·±è‰²ç´°è…³ï¼Œä¸æ˜¯ç²‰ç´…ã€‚"],
      body:["èº«é«”ç¶ é»ƒï¼Œè…¹éƒ¨åæ·¡ã€‚","æ•´é«”åç¶ ï¼Œä¸æ˜¯è¤æˆ–ç°ã€‚"],
      wing:["ç¿…è†€å°å·§ã€èˆ‡èº«é«”åŒè‰²ç³»ã€‚","ç¿¼ä¸å°–é•·ï¼Œè‰²åç¶ ã€‚"],
      tail:["å°¾å·´çŸ­ã€‚","å°¾ç«¯ä¸é•·ï¼Œä¹Ÿä¸æ·±å‰ã€‚"],
      head:["çœ¼ç›å‘¨åœæœ‰æ˜é¡¯ç™½è‰²çœ¼åœˆã€‚","ç™½çœ¼åœˆæ˜¯æœ€é—œéµçš„ç·šç´¢ã€‚"],
    },
    quiz:{
      legs:{ prompt:"æ­¥é©Ÿ 1ï¼ˆè…³ï¼‰ï¼šé¸æœ€ç¬¦åˆæ•˜è¿°çš„è…³å‹ã€‚", options:["black","brown","pink","long"], correct:"black" },
      body:{ prompt:"æ­¥é©Ÿ 2ï¼ˆèº«é«”ï¼‰ï¼šé¸æœ€ç¬¦åˆæ•˜è¿°çš„èº«é«”ã€‚", options:["whiteeye","bulbul","sparrow","drongo"], correct:"whiteeye" },
      wing:{ prompt:"æ­¥é©Ÿ 3ï¼ˆç¿…è†€ï¼‰ï¼šé¸æœ€ç¬¦åˆæ•˜è¿°çš„ç¿…è†€ã€‚", options:["greenSmall","roundBar","shortRound","longPoint"], correct:"greenSmall" },
      tail:{ prompt:"æ­¥é©Ÿ 4ï¼ˆå°¾å·´ï¼‰ï¼šé¸æœ€ç¬¦åˆæ•˜è¿°çš„å°¾å·´ã€‚", options:["shortRound","square","fork","longRound"], correct:"shortRound" },
      head:{ prompt:"æ­¥é©Ÿ 5ï¼ˆé ­/è¨˜è™Ÿï¼‰ï¼šé¸æœ€ç¬¦åˆæ•˜è¿°çš„é ­éƒ¨/è¨˜è™Ÿã€‚", options:["whiteEyeRing","plainBrown","whiteHead","blackHead"], correct:"whiteEyeRing" },
    },
    ai:{
      legs:["ç²‰ç´…è…³å…ˆæ’é™¤ã€‚","æ·±è‰²ç´°è…³é€šå¸¸åé»‘ã€‚"],
      body:["ç¶ é»ƒæ˜¯æœ€å¤§ç‰¹å¾µã€‚","ç°è¤èˆ‡å…¨é»‘éƒ½ä¸æ˜¯ã€‚"],
      wing:["æŒ‘æœ€å°å·§ã€åç¶ çš„ç¿…è†€ã€‚","ä¸è¦é¸å°–é•·ç¿¼ã€‚"],
      tail:["å°¾çŸ­ï¼Œæ·±å‰å°¾å…ˆæ’é™¤ã€‚","æ–¹å°¾æ¯”çŸ­åœ“å°¾æ›´ç›´ã€‚"],
      head:["çœ‹åˆ°ç™½çœ¼åœˆå°±é¸å®ƒã€‚","ç™½é ­ä¸æ˜¯ç™½çœ¼åœˆã€‚"],
    }
  }
};

function getBirdByKey(key){ return BIRDS[key] || BIRDS.sparrow; }
const birdKey = BIRD_PARAM;
const bird = getBirdByKey(birdKey);

/** ===========================
 *  4) State + persistence
 * =========================== */
const DEFAULT_STATE = {
  clues: {},
  solved: {},
  currentStep: 0,
  assembledCount: 0,
  hintLeft: 2,
  usedHints: {},
  pendingPart: null,
  cameraOn: false,
};

let state = deepClone(DEFAULT_STATE);

function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY(birdKey));
    if(!raw) return;
    const parsed = JSON.parse(raw);
    state = { ...deepClone(DEFAULT_STATE), ...parsed };
  }catch(e){}
}
function saveState(){
  try{ localStorage.setItem(STORAGE_KEY(birdKey), JSON.stringify(state)); }catch(e){}
}
function resetState(){
  state = deepClone(DEFAULT_STATE);
  saveState();
}

/** ===========================
 *  5) DOM helpers
 * =========================== */
const $ = (id)=>document.getElementById(id);

const elBirdName = $("birdName");
const elBirdSub = $("birdSub");
const elClueCount = $("clueCount");
const elPendingText = $("pendingText");
const elHintLeft = $("hintLeft");
const elBirdCanvas = $("birdCanvas");
const elClueChips = $("clueChips");
const toast = $("toast");
const feedAnim = $("feedAnim");

const btnCamera = $("btnCamera");
const btnFeed = $("btnFeed");
const btnScan = $("btnScan");
const btnQuiz = $("btnQuiz");
const btnReset = $("btnReset");

const quizModal = $("quizModal");
const stepDots = $("stepDots");
const clueBox = $("clueBox");
const optionsGrid = $("optionsGrid");
const closeQuiz = $("closeQuiz");
const btnCloseQuiz2 = $("btnCloseQuiz2");
const quizTitle = $("quizTitle");
const btnHintQuiz = $("btnHintQuiz");

const aiModal = $("aiModal");
const aiText = $("aiText");
const closeAi = $("closeAi");
const aiOk = $("aiOk");

const assembleModal = $("assembleModal");
const assembleTitle = $("assembleTitle");
const assembleTag = $("assembleTag");
const assembleBird = $("assembleBird");
const assembleSummary = $("assembleSummary");
const closeAssemble = $("closeAssemble");
const btnAssembleNext = $("btnAssembleNext");

const revealModal = $("revealModal");
const revealName = $("revealName");
const revealBird = $("revealBird");
const revealSummary = $("revealSummary");
const closeReveal = $("closeReveal");
const btnReplay = $("btnReplay");
const btnCopyLink = $("btnCopyLink");

const startOverlay = $("startOverlay");
const btnStartCameraNow = $("btnStartCameraNow");
const closeStartOverlay = $("closeStartOverlay");

const scanOverlay = $("scanOverlay");
const scanHintText = $("scanHintText");
const scanNeedText = $("scanNeedText");
const scanBadge = $("scanBadge");
const btnStopScan = $("btnStopScan");
const btnStopScan2 = $("btnStopScan2");
const scanPreview = $("scanPreview");
const scanPctx = scanPreview.getContext("2d", { willReadFrequently:true });

/** ===========================
 *  6) Toast
 * =========================== */
let toastTimer = 0;
function showToast(msg, ms=2600){
  toast.textContent = msg;
  toast.classList.add("show");
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=>toast.classList.remove("show"), ms);
}

/** ===========================
 *  7) Camera
 * =========================== */
async function startCamera(silent=false){
  try{
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { ideal:"environment" } },
      audio:false
    });
    $("camera").srcObject = stream;
    state.cameraOn = true;
    saveState();
    if(!silent) showToast("ç›¸æ©Ÿå·²å•Ÿå‹•");
    btnCamera.textContent = "ç›¸æ©Ÿå·²å•Ÿå‹•";
    btnCamera.disabled = true;
    return true;
  }catch(e){
    if(!silent) showToast("ç›¸æ©Ÿéœ€è¦é»æ“Šæˆæ¬Šï¼šè«‹é»ä¸€ä¸‹ã€é»ä¸€ä¸‹é–‹å•Ÿç›¸æ©Ÿã€");
    return false;
  }
}

/** ===========================
 *  8) Render chips / counters
 * =========================== */
function renderChips(){
  elClueChips.innerHTML = "";
  STEPS.forEach(s=>{
    const has = !!state.clues[s.key];
    const pending = (state.pendingPart === s.key);
    const chip = document.createElement("div");
    chip.className = "chip";
    chip.textContent = has ? `âœ… ${s.label}` : (pending ? `ğŸ”¶ ${s.label}ï¼ˆå¾…æƒï¼‰` : `â¬š ${s.label}`);
    elClueChips.appendChild(chip);
  });
}

function renderCounters(){
  const count = Object.keys(state.clues).length;
  elClueCount.textContent = String(count);
  elHintLeft.textContent = String(state.hintLeft);
  elPendingText.textContent = state.pendingPart ? STEPS.find(s=>s.key===state.pendingPart).label : "â€”";

  btnQuiz.disabled = (count < 5) || !!state.pendingPart;
  btnScan.disabled = !state.pendingPart;

  const nextIdx = Math.max(0, STEPS.findIndex(s=>!state.solved[s.key]));
  btnQuiz.textContent = `é–‹å§‹è¾¨èªï¼ˆ${Math.min(nextIdx+1,5)}/5ï¼‰`;
}

/** ===========================
 *  9) Bird render + assemble animation
 * =========================== */
function renderBird(assembled){
  const pal = bird.palette;
  const showLegs = assembled >= 1;
  const showBody = assembled >= 2;
  const showWing = assembled >= 3;
  const showTail = assembled >= 4;
  const showHead = assembled >= 5;

  const svg = `
  <svg viewBox="0 0 520 260" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="bird">
    <defs>
      <filter id="soft" x="-20%" y="-20%" width="140%" height="140%">
        <feGaussianBlur stdDeviation="1.2"/>
      </filter>
    </defs>
    <ellipse cx="260" cy="210" rx="120" ry="18" fill="rgba(0,0,0,.22)" filter="url(#soft)"/>

    <g class="${assembled===5 ? "bob" : ""}">
      ${showTail ? tailShape(pal.tail) : ""}

      ${showBody ? `
        <ellipse cx="270" cy="135" rx="120" ry="70" fill="${pal.body}"/>
        <ellipse cx="290" cy="155" rx="95" ry="52" fill="${pal.belly}" opacity=".92"/>
      ` : ""}

      ${showWing ? `
        <path d="M210 165c35-78 124-98 165-40-20 70-86 110-165 40z"
              fill="${pal.wing}" opacity=".95"/>
        <path d="M230 150c60-40 105-35 130 5"
              stroke="rgba(255,255,255,.35)" stroke-width="7" stroke-linecap="round" opacity=".45"/>
      ` : ""}

      ${showLegs ? `
        <path d="M250 185c8 18 2 30-8 44" stroke="${pal.legs}" stroke-width="8" stroke-linecap="round"/>
        <path d="M290 185c-8 18-2 30 8 44" stroke="${pal.legs}" stroke-width="8" stroke-linecap="round"/>
        <path d="M222 232h40" stroke="${pal.legs}" stroke-width="8" stroke-linecap="round"/>
        <path d="M278 232h40" stroke="${pal.legs}" stroke-width="8" stroke-linecap="round"/>
      ` : ""}

      ${showHead ? headShape(pal) : ""}
    </g>
  </svg>`;
  elBirdCanvas.innerHTML = svg;
}

function animateAssemble(from, to){
  if(to <= from){
    renderBird(to);
    return;
  }
  let cur = from;
  const tick = () => {
    cur += 1;
    renderBird(cur);
    if(cur < to) setTimeout(tick, 260);
  };
  setTimeout(tick, 120);
}

function tailShape(color){
  const isFork = (bird.name === "å¤§å·å°¾");
  const isLong = (bird.name === "ç é ¸æ–‘é³©");
  const isShort = (bird.name === "ç¶ ç¹¡çœ¼");
  if(isFork){
    return `
      <path d="M156 108c30 26 60 52 82 78-24 4-46-2-66-18 6 22 18 42 36 60-30-8-56-28-76-58-10 30-30 54-58 70 18-24 28-50 32-78-18 18-38 26-60 24 22-24 46-48 70-78z"
            fill="${color}" opacity=".96"/>`;
  }
  if(isLong){
    return `<path d="M150 120c55-55 88-55 130 0v110c-55 28-75 28-130 0z" fill="${color}" opacity=".96"/>`;
  }
  if(isShort){
    return `<path d="M160 150c40-36 92-36 132 0-48 58-84 58-132 0z" fill="${color}" opacity=".96"/>`;
  }
  return `<path d="M160 145h150v65c-54 24-96 24-150 0z" fill="${color}" opacity=".96"/>`;
}

function headShape(pal){
  let mark = "";
  if(bird.name === "ç¶ ç¹¡çœ¼"){
    mark = `<circle cx="360" cy="104" r="18" fill="none" stroke="#ffffff" stroke-width="8" opacity=".95"/>`;
  }else if(bird.name === "ç™½é ­ç¿"){
    mark = `
      <ellipse cx="352" cy="96" rx="34" ry="28" fill="#e9e3d8" opacity=".95"/>
      <path d="M330 94c22 0 40 22 38 40-30 6-46-8-58-26z" fill="rgba(0,0,0,.55)" opacity=".75"/>`;
  }else if(bird.name === "ç é ¸æ–‘é³©"){
    mark = `<path d="M330 132c30-10 60-6 82 10" stroke="rgba(0,0,0,.65)" stroke-width="8" stroke-dasharray="6 10" opacity=".7"/>`;
  }
  const beak = `<path d="M392 104l54-20-54 4z" fill="${pal.beak}" opacity=".98"/>`;
  return `
    <circle cx="352" cy="104" r="34" fill="${pal.head}" opacity=".98"/>
    ${mark}
    ${beak}
    <circle cx="350" cy="104" r="6" fill="rgba(0,0,0,.7)"/>
  `;
}

/** ===========================
 * 10) Feed animation
 * =========================== */
function playFeedAnim(){
  feedAnim.classList.remove("show");
  void feedAnim.offsetWidth;
  feedAnim.classList.add("show");
  setTimeout(()=>feedAnim.classList.remove("show"), 950);
}

/** ===========================
 * 11) Scan guidance text (use bird feature)
 * =========================== */
function getGuideText(partKey){
  // ç”¨è©²éƒ¨ä½ç·šç´¢çš„ç¬¬ä¸€å¥ç•¶ã€Œè©²é³¥ç‰¹å¾µã€ï¼Œç¬¦åˆä½ çš„éœ€æ±‚
  const pool = bird.cluePool[partKey] || [];
  return pool[0] || "è«‹ä¾ç·šç´¢è§€å¯Ÿåœ–å¡ç‰¹å¾µã€‚";
}

/** ===========================
 * 12) Grant clue
 * =========================== */
function grantClue(part){
  const pool = bird.cluePool[part];
  const clue = pool[Math.floor(Math.random()*pool.length)];
  state.clues[part] = { text: clue };
  state.pendingPart = null;
  saveState();
  renderChips();
  renderCounters();
}

/** ===========================
 * 13) Feed bird (drop => pendingPart)
 * =========================== */
function feedBird(){
  playFeedAnim();

  if(state.pendingPart){
    openScan(); // å·²æœ‰å¾…æƒå°±ç›´æ¥é–‹æƒæ
    return;
  }
  const missing = STEPS.map(s=>s.key).filter(k=>!state.clues[k]);
  if(missing.length === 0){
    showToast("ç·šç´¢å·²é›†æ»¿ï¼Œå¯é–‹å§‹è¾¨èª");
    return;
  }
  const part = missing[Math.floor(Math.random()*missing.length)];
  state.pendingPart = part;
  saveState();
  renderChips();
  renderCounters();

  // æƒææç¤ºè¦æ˜¯è©²é³¥ç‰¹å¾µï¼ˆä½ è¦æ±‚çš„ï¼‰
  const targetLabel = STEPS.find(s=>s.key===part).label;
  const guide = getGuideText(part);
  showToast(`æ‰è½ç·šç´¢ï¼šè«‹æ‰¾ã€Œ${bird.name}ï½œ${targetLabel}ã€ç·šç´¢å¡`);

  openScan();
  setScanMessage(`è«‹æ‰¾ç·šç´¢å¡ä¸­ç¬¦åˆã€Œ${guide}ã€çš„å°é³¥ï¼Œä¸¦æƒèƒŒé¢ QRã€‚`, "info");
}

/** ===========================
 * 14) In-page QR scanning + preview
 * =========================== */
let scanning = false;
let scanRaf = 0;
let scanCooldownUntil = 0;
let lastScanMsgAt = 0;

const offCanvas = document.createElement("canvas");
const offCtx = offCanvas.getContext("2d", { willReadFrequently: true });

function setScanMessage(text, type="info"){
  // type: info / ok / bad
  const color = (type==="ok") ? "rgba(46,125,50,.10)" : (type==="bad") ? "rgba(198,40,40,.10)" : "rgba(255,255,255,.72)";
  scanHintText.style.background = color;
  scanHintText.textContent = text;
  lastScanMsgAt = Date.now();
}

function openScan(){
  if(!state.cameraOn){
    startOverlay.classList.remove("hidden");
    showToast("è«‹å…ˆé»ä¸€ä¸‹é–‹å•Ÿç›¸æ©Ÿ");
    return;
  }
  if(!state.pendingPart){
    showToast("ç›®å‰æ²’æœ‰å¾…æƒéƒ¨ä½ï¼šè«‹å…ˆé¤µé³¥");
    return;
  }
  if(typeof jsQR !== "function"){
    showToast("æƒæåŠŸèƒ½è¼‰å…¥å¤±æ•—ï¼šè«‹é‡æ–°æ•´ç†ï¼ˆæŠŠç¶²å€æœ€å¾Œçš„ v= æ”¹å¤§ï¼‰");
    return;
  }

  const targetLabel = STEPS.find(s=>s.key===state.pendingPart).label;
  scanNeedText.textContent = `${bird.name}ï½œ${targetLabel}`;
  scanBadge.textContent = "æƒæä¸­â€¦";

  // åˆå§‹åŒ–è¨Šæ¯ï¼šè©²é³¥ç‰¹å¾µæç¤º
  const guide = getGuideText(state.pendingPart);
  setScanMessage(`è«‹æ‰¾ç·šç´¢å¡ä¸­ç¬¦åˆã€Œ${guide}ã€çš„å°é³¥ï¼Œä¸¦æƒèƒŒé¢ QRã€‚`, "info");

  scanOverlay.classList.remove("hidden");
  scanning = true;
  scanCooldownUntil = 0;
  scanLoop();
}

function closeScan(){
  scanning = false;
  scanOverlay.classList.add("hidden");
  if(scanRaf) cancelAnimationFrame(scanRaf);
}

function drawReticle(ctx, w, h, color="rgba(240,193,75,.9)"){
  // ç½®ä¸­æƒææ¡†
  const boxW = Math.round(w * 0.62);
  const boxH = Math.round(h * 0.52);
  const x = Math.round((w - boxW)/2);
  const y = Math.round((h - boxH)/2);
  const r = 16;

  ctx.save();
  ctx.strokeStyle = color;
  ctx.lineWidth = 4;

  // è§’è½æ¡†
  function corner(x1,y1,dirX,dirY){
    ctx.beginPath();
    ctx.moveTo(x1, y1 + dirY*r);
    ctx.lineTo(x1, y1);
    ctx.lineTo(x1 + dirX*r, y1);
    ctx.stroke();
  }
  corner(x, y, 1, 1);
  corner(x+boxW, y, -1, 1);
  corner(x, y+boxH, 1, -1);
  corner(x+boxW, y+boxH, -1, -1);

  // æ·¡æ·¡é®ç½©
  ctx.fillStyle = "rgba(0,0,0,.15)";
  ctx.fillRect(0,0,w,h);
  ctx.clearRect(x,y,boxW,boxH);

  // æ‰«æçº¿
  const t = (Date.now()%1200)/1200;
  const lineY = y + Math.round(t * boxH);
  ctx.fillStyle = "rgba(240,193,75,.45)";
  ctx.fillRect(x, lineY, boxW, 3);

  ctx.restore();
}

function drawQrBox(ctx, loc){
  if(!loc) return;
  ctx.save();
  ctx.strokeStyle = "rgba(46,125,50,.95)";
  ctx.lineWidth = 5;
  ctx.beginPath();
  ctx.moveTo(loc.topLeftCorner.x, loc.topLeftCorner.y);
  ctx.lineTo(loc.topRightCorner.x, loc.topRightCorner.y);
  ctx.lineTo(loc.bottomRightCorner.x, loc.bottomRightCorner.y);
  ctx.lineTo(loc.bottomLeftCorner.x, loc.bottomLeftCorner.y);
  ctx.closePath();
  ctx.stroke();
  ctx.restore();
}

function scanLoop(){
  if(!scanning) return;

  const video = $("camera");
  const vw = video.videoWidth || 0;
  const vh = video.videoHeight || 0;

  if(video.readyState >= 2 && vw > 0 && vh > 0){
    // ç”¨ 16:9 çš„è¼¸å‡ºï¼Œè®“ scanPreview å¥½çœ‹
    const outW = 960;
    const outH = 540;

    // å– video ä¸­é–“å€åŸŸè£æˆ 16:9
    const srcAspect = vw / vh;
    const dstAspect = outW / outH;
    let sx=0, sy=0, sw=vw, sh=vh;
    if(srcAspect > dstAspect){
      // å¤ªå¯¬ï¼Œè£å·¦å³
      sh = vh;
      sw = Math.round(vh * dstAspect);
      sx = Math.round((vw - sw)/2);
      sy = 0;
    }else{
      // å¤ªé«˜ï¼Œè£ä¸Šä¸‹
      sw = vw;
      sh = Math.round(vw / dstAspect);
      sx = 0;
      sy = Math.round((vh - sh)/2);
    }

    // ç•«åˆ°é è¦½ canvas
    scanPctx.drawImage(video, sx, sy, sw, sh, 0, 0, outW, outH);

    // åŒæ­¥ç•«åˆ° offCanvas ä¾› jsQR
    offCanvas.width = outW;
    offCanvas.height = outH;
    offCtx.drawImage(scanPreview, 0, 0);

    // reticle ç–ŠåŠ ï¼ˆåœ¨é è¦½ä¸Šï¼‰
    drawReticle(scanPctx, outW, outH);

    const now = Date.now();
    if(now >= scanCooldownUntil){
      const img = offCtx.getImageData(0, 0, outW, outH);
      const code = jsQR(img.data, outW, outH, { inversionAttempts: "dontInvert" });

      if(code && code.data){
        // ç•«å‡ºåµæ¸¬åˆ°çš„ QR æ¡†ï¼ˆè®“äººæ„Ÿè¦ºã€ŒçœŸçš„åœ¨æƒã€ï¼‰
        drawQrBox(scanPctx, code.location);

        const result = handleScannedText(code.data);
        if(result === "success"){
          scanBadge.textContent = "è®€å–æˆåŠŸ";
          setTimeout(()=>closeScan(), 500);
          return;
        }else if(result === "wrong"){
          scanBadge.textContent = "æƒæåˆ° QRï¼Œä½†ä¸ç¬¦åˆ";
          scanCooldownUntil = now + 1200; // éŒ¯èª¤å†·å»ï¼Œé¿å…ä¸€ç›´è·³
        }
      }else{
        // æ²’æƒåˆ° QR æ™‚ï¼Œç¶­æŒæƒæä¸­
        scanBadge.textContent = "æƒæä¸­â€¦";
      }
    }
  }

  // è‹¥æƒæè¨Šæ¯å¤ªä¹…æœªæ›´æ–°ï¼Œè‡ªå‹•å›åˆ°ã€ŒæŒ‡å¼•ã€è¨Šæ¯ï¼ˆé¿å…å¡åœ¨éŒ¯èª¤è¨Šæ¯ï¼‰
  if(state.pendingPart && Date.now() - lastScanMsgAt > 5200){
    const guide = getGuideText(state.pendingPart);
    setScanMessage(`è«‹æ‰¾ç·šç´¢å¡ä¸­ç¬¦åˆã€Œ${guide}ã€çš„å°é³¥ï¼Œä¸¦æƒèƒŒé¢ QRã€‚`, "info");
  }

  scanRaf = requestAnimationFrame(scanLoop);
}

function handleScannedText(text){
  let url;
  try{ url = new URL(text); }catch(e){ return "ignore"; }

  const b = url.searchParams.get("bird");
  const claim = url.searchParams.get("claim");

  if(!claim){
    setScanMessage("é€™å¼µå¡ä¸æ˜¯ç·šç´¢å¡ï¼ˆæ‰¾ä¸åˆ° claimï¼‰ï¼Œè«‹å†è§€å¯Ÿçœ‹çœ‹ã€‚", "bad");
    showToast("ä¸æ˜¯ç·šç´¢å¡ QRï¼Œè«‹å†è§€å¯Ÿçœ‹çœ‹ã€‚");
    return "wrong";
  }

  const targetPart = state.pendingPart;
  const targetLabel = STEPS.find(s=>s.key===targetPart).label;
  const guide = getGuideText(targetPart);

  // 1) é³¥ä¸å°ï¼šä¸è¦èªªã€Œä½ æƒåˆ°å“ªéš»ã€ï¼Œåªèªªã€Œä¸æ˜¯æœ¬é³¥ã€
  if(b && b !== birdKey){
    const msg = `é€™ä¸æ˜¯ã€Œ${bird.name}ã€çš„ç·šç´¢å¡å–”ï¼Œå†è§€å¯Ÿçœ‹çœ‹ã€‚\n\nã€Œ${bird.name}ï½œ${targetLabel}ã€çš„ç‰¹å¾µæ˜¯ï¼š\nã€Œ${guide}ã€`;
    setScanMessage(msg, "bad");
    showToast(`ä¸æ˜¯ã€Œ${bird.name}ã€çš„ç·šç´¢å¡ï¼Œå†è©¦ä¸€æ¬¡ã€‚`, 3200);
    return "wrong";
  }

  // 2) æ²’æœ‰å¾…æƒ
  if(!targetPart){
    const msg = "è«‹å…ˆæŒ‰ã€Œé¤µé³¥ï¼ˆæ‰è½ç·šç´¢ï¼‰ã€è®“ç³»çµ±æŒ‡å®šè¦æƒçš„éƒ¨ä½ã€‚";
    setScanMessage(msg, "bad");
    showToast("è«‹å…ˆé¤µé³¥è®“ç³»çµ±æŒ‡å®šå¾…æƒéƒ¨ä½ã€‚", 2600);
    return "wrong";
  }

  // 3) éƒ¨ä½ä¸å°ï¼šä¸è¦èªªä½ æƒåˆ°ä»€éº¼ï¼Œåªèªªã€Œä¸æ˜¯æœ¬é³¥çš„é€™å€‹éƒ¨ä½ã€
  if(claim !== targetPart){
    const msg = `é€™ä¸æ˜¯ã€Œ${bird.name}ã€çš„ã€Œ${targetLabel}ã€å–”ï¼Œå†è§€å¯Ÿçœ‹çœ‹ã€‚\n\nã€Œ${bird.name}ï½œ${targetLabel}ã€çš„ç‰¹å¾µæ˜¯ï¼š\nã€Œ${guide}ã€`;
    setScanMessage(msg, "bad");
    showToast(`ä¸æ˜¯ã€Œ${bird.name}ã€çš„ã€Œ${targetLabel}ã€ï¼Œå†è©¦ä¸€æ¬¡ã€‚`, 3200);
    return "wrong";
  }

  // success
  grantClue(claim);
  setScanMessage(`âœ… ç²å¾—ç·šç´¢ï¼šã€Œ${bird.name}ï½œ${targetLabel}ã€`, "ok");
  showToast(`ç²å¾—ç·šç´¢ï¼š${targetLabel}`);
  return "success";
}

/** ===========================
 * 15) Fallback: claim from URL (external scanner)
 * =========================== */
function handleClaimFromURLIfAny(){
  if(!CLAIM) return false;
  if(!state.pendingPart){
    showToast("å°šæœªæ‰è½ç·šç´¢ï¼šè«‹å…ˆæŒ‰é¤µé³¥å†æƒå¡", 3000);
    setTimeout(()=>location.replace(`${location.pathname}?bird=${encodeURIComponent(birdKey)}`), 900);
    return true;
  }
  if(CLAIM !== state.pendingPart){
    const targetLabel = STEPS.find(s=>s.key===state.pendingPart).label;
    showToast(`ä¸æ˜¯ã€Œ${bird.name}ã€çš„ã€Œ${targetLabel}ã€ï¼Œå†è§€å¯Ÿçœ‹çœ‹`, 3000);
    setTimeout(()=>location.replace(`${location.pathname}?bird=${encodeURIComponent(birdKey)}`), 900);
    return true;
  }
  grantClue(CLAIM);
  showToast(`ç²å¾—ç·šç´¢ï¼š${STEPS.find(s=>s.key===CLAIM).label}`);
  setTimeout(()=>location.replace(`${location.pathname}?bird=${encodeURIComponent(birdKey)}`), 900);
  return true;
}

/** ===========================
 * 16) Quiz flow (answer -> show assemble -> next)
 * =========================== */
function openQuiz(){
  if(Object.keys(state.clues).length < 5){
    showToast("è«‹å…ˆæ”¶é›†æ»¿ 5 å¼µç·šç´¢");
    return;
  }
  if(state.pendingPart){
    showToast("å°šæœ‰å¾…æƒç·šç´¢å¡ï¼šè«‹å…ˆæƒå¡å®Œæˆæ”¶é›†", 3200);
    return;
  }
  quizModal.classList.remove("hidden");
  quizTitle.textContent = `è¾¨èªé³¥é¡ï¼š${bird.name}`;
  buildStepDots();

  const idx = STEPS.findIndex(s=>!state.solved[s.key]);
  state.currentStep = (idx>=0)?idx:0;
  saveState();
  renderStep();
}

function closeQuizModal(){ quizModal.classList.add("hidden"); }

function buildStepDots(){
  stepDots.innerHTML = "";
  STEPS.forEach((s, idx)=>{
    const d = document.createElement("div");
    d.className = "dot";
    d.textContent = String(idx+1);
    stepDots.appendChild(d);
  });
}

function renderStep(){
  const part = STEPS[state.currentStep].key;

  [...stepDots.children].forEach((el, idx)=>{
    el.classList.remove("active","done");
    const k = STEPS[idx].key;
    if(state.solved[k]) el.classList.add("done");
    if(idx === state.currentStep) el.classList.add("active");
  });

  const q = bird.quiz[part];
  const collected = state.clues[part]?.text || "ï¼ˆå°šæœªæ”¶é›†åˆ°æ­¤éƒ¨ä½ç·šç´¢ï¼‰";

  // ä¾ä½ çš„è¦æ±‚æ”¹ UI æ–‡æ¡ˆ
  clueBox.innerHTML = `
    <div style="font-weight:900;font-size:16px;margin-bottom:6px">${q.prompt}</div>
    <div>ä½ æ”¶é›†åˆ°çš„ç·šç´¢ï¼š<strong>${escapeHtml(collected)}</strong></div>
  `;

  // options
  optionsGrid.innerHTML = "";
  q.options.forEach(optKey=>{
    const opt = OPTION_LIB[part][optKey];
    const card = document.createElement("div");
    card.className = "opt";
    card.innerHTML = `
      ${opt.svg}
      <div>
        <div class="lbl">${opt.label}</div>
        <div class="desc">${opt.desc}</div>
      </div>
    `;
    card.addEventListener("click", ()=> chooseOption(part, optKey, card));
    optionsGrid.appendChild(card);
  });

  btnHintQuiz.disabled = (state.hintLeft <= 0);
}

function chooseOption(part, optKey, cardEl){
  if(state.solved[part]) return;

  const correct = bird.quiz[part].correct;
  [...optionsGrid.children].forEach(el=>el.style.pointerEvents="none");

  if(optKey === correct){
    cardEl.classList.add("correct");
    state.solved[part] = true;

    const prev = state.assembledCount;
    state.assembledCount = Math.min(5, Object.keys(state.solved).length);
    saveState();

    // å…ˆåœ¨ä¸»ç•«é¢æ‹¼è£ï¼ˆä½†ç©å®¶æœƒåœ¨ä¸‹ä¸€å€‹ modal çœ‹å¾—åˆ°çµæœï¼‰
    animateAssemble(prev, state.assembledCount);

    // ç­”å°ï¼šé—œé–‰é¡Œç›® -> é¡¯ç¤ºæ‹¼è£çµæœ -> ä¸‹ä¸€æ­¥å†å›é¡Œç›®
    setTimeout(()=>{
      closeQuizModal();
      openAssembleModal(part);
    }, 250);

  }else{
    cardEl.classList.add("wrong");

    // ç­”éŒ¯ï¼šè‡ªå‹•é‡ç½®ï¼ˆä½ è¦æ±‚ï¼‰
    showToast("ç­”éŒ¯ï¼šå·²é‡ç½®ï¼Œè«‹é‡æ–°æ”¶é›† 5 å¼µç·šç´¢", 3600);

    setTimeout(()=>{
      closeQuizModal();
      resetState();
      loadState();
      renderBird(0);
      renderChips();
      renderCounters();
    }, 550);
  }
}

function openAssembleModal(partJustSolved){
  const label = STEPS.find(s=>s.key===partJustSolved).label;
  assembleTitle.textContent = "ç­”å°ï¼å·²æ‹¼ä¸Šéƒ¨ä½";
  assembleTag.textContent = `${bird.name}ï½œ${label}`;
  assembleBird.innerHTML = `<div style="width:min(520px,92vw)">${renderAssembleBirdSVG()}</div>`;

  // æ‹¼è£çµæœèªªæ˜ï¼šä¹Ÿç”¨è©²éƒ¨ä½ç·šç´¢ç¬¬ä¸€å¥ï¼ˆç¬¦åˆä½ ã€Œç‰¹å¾µã€çš„æ¦‚å¿µï¼‰
  assembleSummary.textContent = `ä½ å®Œæˆäº†ã€Œ${label}ã€ã€‚è§€å¯Ÿé‡é»ï¼š${getGuideText(partJustSolved)}`;

  const doneCount = Object.keys(state.solved).length;
  btnAssembleNext.textContent = (doneCount >= 5) ? "å®Œæˆ" : "ä¸‹ä¸€æ­¥";
  assembleModal.classList.remove("hidden");
}

function closeAssembleModal(){ assembleModal.classList.add("hidden"); }

function assembleNext(){
  closeAssembleModal();
  const doneCount = Object.keys(state.solved).length;
  if(doneCount >= 5){
    openReveal();
    return;
  }
  // ä¸‹ä¸€é¡Œ
  const nextIdx = STEPS.findIndex(s=>!state.solved[s.key]);
  state.currentStep = (nextIdx>=0)?nextIdx:0;
  saveState();
  openQuiz();
}

function renderAssembleBirdSVG(){
  // ç”¨è·Ÿä¸»ç•«é¢åŒä¸€å¥— renderBird çš„çµæœï¼Œä½†åœ¨ modal ä¸­é¡¯ç¤ºå®Œæ•´ç›®å‰ assembledCount çš„åœ–
  const pal = bird.palette;
  const assembled = state.assembledCount;
  const showLegs = assembled >= 1;
  const showBody = assembled >= 2;
  const showWing = assembled >= 3;
  const showTail = assembled >= 4;
  const showHead = assembled >= 5;

  return `
  <svg class="${assembled===5 ? "bob" : ""}" viewBox="0 0 520 260" xmlns="http://www.w3.org/2000/svg" aria-label="assemble bird">
    <ellipse cx="260" cy="210" rx="120" ry="18" fill="rgba(0,0,0,.12)"/>
    ${showTail ? tailShape(pal.tail) : ""}
    ${showBody ? `<ellipse cx="270" cy="135" rx="120" ry="70" fill="${pal.body}"/>
      <ellipse cx="290" cy="155" rx="95" ry="52" fill="${pal.belly}" opacity=".92"/>` : ""}
    ${showWing ? `<path d="M210 165c35-78 124-98 165-40-20 70-86 110-165 40z"
          fill="${pal.wing}" opacity=".95"/>
      <path d="M230 150c60-40 105-35 130 5"
          stroke="rgba(255,255,255,.35)" stroke-width="7" stroke-linecap="round" opacity=".45"/>` : ""}
    ${showLegs ? `<path d="M250 185c8 18 2 30-8 44" stroke="${pal.legs}" stroke-width="8" stroke-linecap="round"/>
      <path d="M290 185c-8 18-2 30 8 44" stroke="${pal.legs}" stroke-width="8" stroke-linecap="round"/>
      <path d="M222 232h40" stroke="${pal.legs}" stroke-width="8" stroke-linecap="round"/>
      <path d="M278 232h40" stroke="${pal.legs}" stroke-width="8" stroke-linecap="round"/>` : ""}
    ${showHead ? headShape(pal) : ""}
  </svg>`;
}

/** ===========================
 * 17) AI hint (modal + typing)
 * =========================== */
let typingTimer = 0;

function openAiHint(){
  if(state.hintLeft <= 0){
    showToast("AI æç¤ºå·²ç”¨å®Œ");
    return;
  }
  const part = STEPS[state.currentStep].key;
  const label = STEPS[state.currentStep].label;
  const clue = state.clues[part]?.text || getGuideText(part);
  const bullets = bird.ai?.[part] || ["æŠŠç·šç´¢æ‹†æˆã€é¡è‰²/å½¢ç‹€/æœ‰ç„¡è¨˜è™Ÿã€ä¸‰å€‹è§€å¯Ÿé»ã€‚"];

  // æ‰£æ¬¡æ•¸
  state.hintLeft -= 1;
  saveState();
  renderCounters();

  // çµ„åˆæ›´åƒ AI çš„æç¤ºæ–‡å­—
  const text =
`AI åŠ©æ•™ï¼šæˆ‘å…ˆæŠŠä½ çš„ç·šç´¢æ‹†æˆã€Œå¯ä»¥çœ‹çš„é‡é»ã€â€”â€”

ã€ç›®å‰éƒ¨ä½ã€‘${bird.name}ï½œ${label}
ã€ä½ çš„ç·šç´¢ã€‘ã€Œ${clue}ã€

å»ºè­°è§€å¯Ÿæ­¥é©Ÿï¼š
- ${bullets[0]}
- ${bullets[1] || "å…ˆæ’é™¤æ˜é¡¯ä¸ç¬¦çš„é¸é …ï¼Œå†æ¯”è¼ƒå‰©ä¸‹å…©å€‹ã€‚"}
${bullets[2] ? "- " + bullets[2] : ""}

å°æé†’ï¼šæç¤ºä¸æœƒå‘Šè¨´ä½ æ­£ç¢ºç­”æ¡ˆï¼ŒåªæœƒæŠŠã€Œè¦çœ‹ä»€éº¼ã€èªªæ¸…æ¥šã€‚`;

  aiModal.classList.remove("hidden");
  typeText(aiText, text, 12);
}

function closeAiModal(){
  aiModal.classList.add("hidden");
  clearInterval(typingTimer);
}

function typeText(el, text, speedMs=14){
  clearInterval(typingTimer);
  el.textContent = "";
  let i = 0;
  typingTimer = setInterval(()=>{
    el.textContent += text[i] || "";
    i++;
    if(i >= text.length){
      clearInterval(typingTimer);
    }
  }, speedMs);
}

/** ===========================
 * 18) Reveal
 * =========================== */
function openReveal(){
  revealModal.classList.remove("hidden");
  revealName.textContent = bird.name;
  revealBird.innerHTML = `<div style="width:min(520px,92vw)">${renderFinalBirdSVG()}</div>`;
  revealSummary.textContent = bird.summary;
}
function closeRevealModal(){ revealModal.classList.add("hidden"); }

function renderFinalBirdSVG(){
  const pal = bird.palette;
  return `
  <svg class="bob" viewBox="0 0 520 260" xmlns="http://www.w3.org/2000/svg" aria-label="reveal bird">
    <ellipse cx="260" cy="210" rx="120" ry="18" fill="rgba(0,0,0,.12)"/>
    ${tailShape(pal.tail)}
    <ellipse cx="270" cy="135" rx="120" ry="70" fill="${pal.body}"/>
    <ellipse cx="290" cy="155" rx="95" ry="52" fill="${pal.belly}" opacity=".92"/>
    <path d="M210 165c35-78 124-98 165-40-20 70-86 110-165 40z"
          fill="${pal.wing}" opacity=".95"/>
    <path d="M230 150c60-40 105-35 130 5"
          stroke="rgba(255,255,255,.35)" stroke-width="7" stroke-linecap="round" opacity=".45"/>
    <path d="M250 185c8 18 2 30-8 44" stroke="${pal.legs}" stroke-width="8" stroke-linecap="round"/>
    <path d="M290 185c-8 18-2 30 8 44" stroke="${pal.legs}" stroke-width="8" stroke-linecap="round"/>
    <path d="M222 232h40" stroke="${pal.legs}" stroke-width="8" stroke-linecap="round"/>
    <path d="M278 232h40" stroke="${pal.legs}" stroke-width="8" stroke-linecap="round"/>
    ${headShape(pal)}
  </svg>`;
}

/** ===========================
 * 19) Misc
 * =========================== */
function escapeHtml(s){
  return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
}
function copyLink(){
  const url = location.origin + location.pathname + `?bird=${encodeURIComponent(birdKey)}`;
  navigator.clipboard?.writeText(url)
    .then(()=>showToast("å·²è¤‡è£½é€£çµ"))
    .catch(()=>showToast("è¤‡è£½å¤±æ•—ï¼šè«‹æ‰‹å‹•è¤‡è£½ç¶²å€åˆ—"));
}

/** ===========================
 * 20) Init
 * =========================== */
function init(){
  loadState();

  if(START){
    resetState();
    loadState();
    setTimeout(()=>location.replace(`${location.pathname}?bird=${encodeURIComponent(birdKey)}`), 50);
    return;
  }

  elBirdName.textContent = bird.name;
  elBirdSub.textContent = bird.sub;

  renderBird(state.assembledCount);
  renderChips();
  renderCounters();

  // external scanner fallback
  if(handleClaimFromURLIfAny()) return;

  // Try auto-start camera (iOS will likely block => show overlay)
  startCamera(true).then(ok=>{
    if(!ok) startOverlay.classList.remove("hidden");
  });

  // Manual camera start
  btnCamera.addEventListener("click", async ()=>{
    const ok = await startCamera(false);
    if(ok) startOverlay.classList.add("hidden");
  });
  btnStartCameraNow.addEventListener("click", async ()=>{
    const ok = await startCamera(false);
    if(ok) startOverlay.classList.add("hidden");
  });
  closeStartOverlay.addEventListener("click", ()=> startOverlay.classList.add("hidden"));

  // main actions
  btnFeed.addEventListener("click", feedBird);
  btnScan.addEventListener("click", openScan);
  btnStopScan.addEventListener("click", closeScan);
  btnStopScan2.addEventListener("click", closeScan);

  btnQuiz.addEventListener("click", openQuiz);

  btnReset.addEventListener("click", ()=>{
    resetState();
    loadState();
    renderBird(0);
    renderChips();
    renderCounters();
    showToast("å·²é‡ç½®æœ¬é³¥é€²åº¦");
  });

  // quiz / ai
  closeQuiz.addEventListener("click", closeQuizModal);
  btnCloseQuiz2.addEventListener("click", closeQuizModal);
  btnHintQuiz.addEventListener("click", openAiHint);

  closeAi.addEventListener("click", closeAiModal);
  aiOk.addEventListener("click", closeAiModal);

  // assemble
  closeAssemble.addEventListener("click", closeAssembleModal);
  btnAssembleNext.addEventListener("click", assembleNext);

  // reveal
  closeReveal.addEventListener("click", closeRevealModal);
  btnReplay.addEventListener("click", ()=>{
    closeRevealModal();
    resetState();
    loadState();
    renderBird(0);
    renderChips();
    renderCounters();
  });
  btnCopyLink.addEventListener("click", copyLink);

  showToast(`å·²è¼‰å…¥ï¼š${bird.name}ï¼ˆé¤µé³¥â†’æƒæç·šç´¢å¡ï¼‰`);
}

init();
</script>
</body>
</html>
