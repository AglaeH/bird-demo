<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Bird Builder AR Demo</title>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
  <style>
    :root{
      --bg:#0b1220; --panel:#f4ecd8; --panel2:#efe3c6; --ink:#2b2b2b;
      --accent:#f0c14b; --good:#2e7d32; --bad:#c62828; --shadow: 0 18px 40px rgba(0,0,0,.35);
      --neon-green: #39FF14; --neon-red: #FF3131;
    }
    *{box-sizing:border-box;font-family: system-ui, -apple-system, sans-serif;}
    body{margin:0;background:var(--bg);color:#fff;overflow:hidden;}
    #app{position:relative;height:100dvh;width:100vw;background:#000;}
    video#camera{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;z-index:1;}
    
    #overlay{position:absolute;inset:0;display:flex;flex-direction:column;justify-content:space-between;padding:14px;pointer-events:none;z-index:10;}
    .pill{pointer-events:auto;background:rgba(20,20,20,.7);backdrop-filter:blur(10px);padding:8px 12px;border-radius:999px;font-size:14px;border:1px solid rgba(255,255,255,0.15);}
    .birdCard{pointer-events:none;width:min(500px,92vw);background:rgba(20,20,20,0.5);backdrop-filter:blur(12px);border-radius:26px;padding:20px;margin:0 auto;border:1px solid rgba(255,255,255,0.15);text-align:center;}
    .hintRow{display:flex;gap:6px;flex-wrap:wrap;justify-content:center;margin-top:10px;}
    .chip{background:rgba(255,255,255,0.1);padding:5px 10px;border-radius:999px;font-size:11px;}
    .chip.done{background:var(--good);}
    .chip.pending{background:var(--accent);color:#000;}

    /* é¤µé£Ÿè½å­å‹•ç•« */
    .feedOverlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:100;background:rgba(0,0,0,.25);backdrop-filter:blur(4px);}
    .feedOverlay.show{display:flex;}
    .feedCard{width:min(360px, 90vw);background:rgba(255,255,255,.95);border-radius:24px;padding:24px;text-align:center;color:#111;box-shadow:var(--shadow);}
    .feedAnim{position:relative;height: 120px;margin: 10px auto;width: 200px;}
    .bowl{position:absolute;left:50%;bottom: 10px;width: 130px;height: 40px;transform: translateX(-50%);border-radius: 0 0 60px 60px;border: 3px solid rgba(163,58,42,.7);border-top: 0;background: rgba(163,58,42,0.1);}
    .seed{position:absolute;width: 10px; height: 10px;border-radius: 999px;background: rgba(163,58,42,.9);top: 0px;left: 50%;transform: translateX(-50%);animation: fall 0.8s ease-in infinite;opacity:0;}
    .seed.s1{ left: 35%; animation-delay: .00s; }
    .seed.s2{ left: 50%; animation-delay: .12s; }
    .seed.s3{ left: 62%; animation-delay: .22s; }
    .seed.s4{ left: 45%; animation-delay: .32s; }
    @keyframes fall{
      0%{ transform: translate(-50%, 0) scale(.9); opacity: 0; }
      20%{ opacity: 1; }
      70%{ transform: translate(-50%, 90px) scale(1); opacity: 1; }
      100%{ transform: translate(-50%, 90px) scale(.4); opacity: 0; }
    }

    /* AI å¼•å° Modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,0.75);display:flex;align-items:center;justify-content:center;z-index:200;padding:20px;pointer-events:auto;}
    .hidden{display:none !important;}
    .box{background:var(--panel);color:#111;width:100%;max-width:420px;border-radius:26px;overflow:hidden;box-shadow:var(--shadow);}
    .boxContent{padding:26px;display:flex;flex-direction:column;gap:18px;}
    .aiText{font-size:16px;line-height:1.5;font-weight:600;min-height:80px;white-space:pre-wrap;}
    .optBtn{width:100%;padding:14px;border-radius:14px;border:2px solid #ccc;background:#fff;font-weight:bold;cursor:pointer;text-align:left;transition:0.2s;}
    .optBtn:hover{border-color:var(--accent);background:#fffdfa;}

    /* æƒæå°ç„¦æ¡† */
    .scanBox{position:absolute;border:5px solid var(--neon-green);border-radius:15px;pointer-events:none;z-index:5;display:none;box-shadow: 0 0 15px var(--neon-green);}
    .scanBox.error{border-color:var(--neon-red);box-shadow: 0 0 15px var(--neon-red);}
    canvas#scanPreview{width:100%;border-radius:18px;background:#000;}

    .bottom{pointer-events:auto;display:flex;gap:10px;justify-content:center;padding-bottom:env(safe-area-inset-bottom);}
    button{border:0;border-radius:16px;padding:12px 20px;font-size:15px;background:#fff;color:#111;font-weight:bold;cursor:pointer;}
    button:disabled{opacity:0.3;}
  </style>
</head>
<body>
<div id="app">
  <video id="camera" autoplay playsinline muted></video>
  <div id="overlay">
    <div style="display:flex;justify-content:space-between;">
      <div class="pill">ğŸ” <strong id="birdNameDisplay">ç¥ç¥•é³¥</strong></div>
      <div class="pill">ç·šç´¢ <strong id="clueCount">0</strong>/5</div>
    </div>
    <div class="birdCard">
      <div id="birdBase" style="height:120px;display:flex;align-items:center;justify-content:center;">
        <svg viewBox="0 0 100 60" width="140">
          <circle cx="50" cy="30" r="25" fill="none" stroke="white" stroke-width="2" stroke-dasharray="6 4" style="opacity:0.4" />
          <text x="50" y="34" font-size="6" text-anchor="middle" fill="white" style="opacity:0.6">? ç¥ç¥•é³¥ ?</text>
        </svg>
      </div>
      <div id="clueChips" class="hintRow"></div>
      <div id="instructionText" style="font-size:13px;color:var(--accent);margin-top:12px;font-weight:bold;">é»æ“Šé¤µé³¥é–‹å§‹è§£è¬æ¢ç©¶</div>
    </div>
    <div class="bottom">
      <button id="btnFeed">é¤µé³¥</button>
      <button id="btnQuiz" disabled style="background:#222;color:#fff;">é–‹å§‹è¾¨èª (0/5)</button>
      <button onclick="location.reload()" style="background:#444;color:#fff;font-size:12px;padding:8px;">é‡æ–°é–‹å§‹</button>
    </div>
  </div>

  <div class="feedOverlay" id="feedOverlay">
    <div class="feedCard">
      <div style="font-weight:900; font-size:18px; margin-bottom:10px;">é¤µé£Ÿä¸­...</div>
      <div class="feedAnim">
        <div class="seed s1"></div><div class="seed s2"></div><div class="seed s3"></div><div class="seed s4"></div>
        <div class="bowl"></div>
      </div>
      <div style="color:rgba(0,0,0,.6); font-size:14px;">ç™¼ç¾äº†æ–°çš„ç‰¹å¾µï¼</div>
    </div>
  </div>

  <div class="modal hidden" id="guidanceModal">
    <div class="box">
      <div class="boxContent">
        <div id="aiIcon" style="font-size:12px;color:#7a5200;font-weight:bold">âœ¨ AI åŠ©æ•™è§£è¬å¼•å°</div>
        <div id="aiText" class="aiText"></div>
        <div id="aiOptions" style="display:flex;flex-direction:column;gap:10px;"></div>
        <div id="aiClueBox" class="hidden" style="background:#fff8e1;padding:15px;border-radius:12px;border:1px solid #ffe082;margin-top:10px;font-weight:bold;color:#333;"></div>
        <button id="btnGoScan" class="hidden" style="width:100%;background:#111;color:#fff;padding:15px;border-radius:14px;border:0;font-weight:bold;">çŸ¥é“äº†ï¼Œå»æƒæå¡ç‰‡ï¼</button>
      </div>
    </div>
  </div>

  <div class="modal hidden" id="scanModal">
    <div class="box" style="max-width:720px;">
      <div class="boxContent">
        <h3 style="margin:0">æƒæç‰¹å¾µç·šç´¢å¡</h3>
        <div style="position:relative;">
          <div id="scanFocusBox" class="scanBox"></div>
          <canvas id="scanPreview"></canvas>
        </div>
        <div id="scanPersistHint" style="background:#fff;padding:12px;border-radius:12px;border:1px solid #ddd;font-size:14px;color:#333;"></div>
        <button id="btnScanBack" onclick="closeScan()" style="background:#eee;border:0;padding:12px;border-radius:12px;width:100%;margin-top:10px;">æš«æ™‚è¿”å›</button>
      </div>
    </div>
  </div>
</div>

<script>
/** ===========================
 * BIRDS è³‡æ–™ç‰©ä»¶ (ä¿®æ­£ç ´æ¢—æ–‡å­—èˆ‡é¸é …ç¼ºå¤±)
 * =========================== */
const BIRDS = {
  sparrow: {
    key: "sparrow", name: "éº»é›€",
    induction: {
      legs: { 
        q: "é€™éš»é³¥è¦æ‰è½ã€è…³ã€çš„ç·šç´¢äº†ï¼è§€å¯Ÿæ™‚ï¼Œä»€éº¼ç‰¹å¾µæœ€æœ‰è¾¨è­˜åº¦ï¼Ÿ",
        options: [
          { t: "è…³çš„é¡è‰² (è¤è‰²)", isBest: true, feedback: "æ²’éŒ¯ï¼é¡è‰²æ˜¯é—œéµï¼Œè¤è‰²çš„ç´°è…³å¾ˆç‰¹åˆ¥ã€‚", clue: "è…³çŸ­çŸ­ã€åè¤è‰²" },
          { t: "è…³çš„é‡é‡", isBest: false, feedback: "é‡é‡é›£ä»¥è§€å¯Ÿå–”ï¼Œå°æ–¼é€™éš»é³¥ä¾†èªªé¡è‰²æ›´æ˜é¡¯ï¼Œå†é¸é¸çœ‹å§ï¼", clue: "è…³çŸ­çŸ­ã€åè¤è‰²" }
        ]
      },
      body: {
        q: "æˆ‘å€‘è¦çœ‹ã€èº«é«”ã€äº†ï¼ä½ è¦ºå¾—æ‡‰è©²æ³¨æ„ç¾½æ¯›æ¢ç´‹ï¼Œé‚„æ˜¯é³¥çš„é«”æº«ï¼Ÿ",
        options: [
          { t: "ç¾½æ¯›çš„æ¢ç´‹æ„Ÿ", isBest: true, feedback: "æ­£ç¢ºï¼èƒŒéƒ¨æœ‰æ˜é¡¯é»‘è‰²æ¢ç´‹æ˜¯é€™éš»é³¥çš„ç‰¹å¾µã€‚", clue: "èº«é«”è¤è‰²ï¼ŒèƒŒä¸Šæœ‰æ·±è‰²æ¢ç´‹" },
          { t: "é³¥çš„é«”æº«", isBest: false, feedback: "é«”æº«ç„¡æ³•ç”¨çœ‹çš„æ¸¬é‡å–”ï¼è§€å¯Ÿç¾½æ¯›æ¢ç´‹æ¯”è¼ƒå¯¦éš›ï¼Œé¸å¦ä¸€å€‹è©¦è©¦ï¼", clue: "èº«é«”è¤è‰²ï¼ŒèƒŒä¸Šæœ‰æ·±è‰²æ¢ç´‹" }
        ]
      },
      wing: {
        q: "é€™å¼µæ˜¯ã€ç¿…è†€ã€ç·šç´¢ï¼è¦çœ‹ç¿…è†€ä¸Šçš„é¡è‰²æ–‘ç´‹ï¼Œé‚„æ˜¯çœ‹ç¾½æ¯›çš„é‡é‡ï¼Ÿ",
        options: [
          { t: "æ–‘ç´‹ (ç¿¼å¸¶)", isBest: true, feedback: "æ²’éŒ¯ï¼ç¿…è†€ä¸Šçš„æ·¡è‰²ç¿¼å¸¶æ˜¯è§€å¯Ÿé‡é»ã€‚", clue: "ç¿…è†€çŸ­åœ“ï¼Œæœ‰æ·¡è‰²ç¿¼å¸¶" },
          { t: "ç¾½æ¯›çš„é‡é‡", isBest: false, feedback: "é‡é‡çœ‹ä¸å‡ºä¾†å–”ï¼è§€å¯Ÿç¿…è†€ä¸Šçš„ç¿¼å¸¶æ‰æ˜¯é‡é»ã€‚", clue: "ç¿…è†€çŸ­åœ“ï¼Œæœ‰æ·¡è‰²ç¿¼å¸¶" }
        ]
      },
      tail: {
        q: "é—œæ–¼ã€å°¾å·´ã€ï¼Œä½ è¦ºå¾—è¦çœ‹æœ«ç«¯çš„å½¢ç‹€ï¼Œé‚„æ˜¯å°¾å·´æ“ºå‹•çš„é€Ÿåº¦ï¼Ÿ",
        options: [
          { t: "æœ«ç«¯çš„å½¢ç‹€", isBest: true, feedback: "æ­£ç¢ºï¼å°¾å·´æœ«ç«¯å¹³å¹³çš„æ˜¯é€™éš»é³¥çš„ç‰¹å¾µã€‚", clue: "å°¾å·´ä¸­ç­‰é•·åº¦ï¼Œæœ«ç«¯åå¹³" },
          { t: "æ“ºå‹•çš„é€Ÿåº¦", isBest: false, feedback: "æ“ºå‹•é€Ÿåº¦æœƒè®Šï¼Œçœ‹æœ«ç«¯å½¢ç‹€ï¼ˆæ–¹å°¾ï¼‰æ›´ç§‘å­¸å–”ï¼Œå†é¸ä¸€æ¬¡å§ï¼", clue: "å°¾å·´ä¸­ç­‰é•·åº¦ï¼Œæœ«ç«¯åå¹³" }
        ]
      },
      head: {
        q: "æœ€å¾Œæ˜¯ã€é ­éƒ¨ã€ï¼è§€å¯Ÿé€™éš»é³¥çš„é ­ï¼Œè¦çœ‹æœ‰æ²’æœ‰ç™½åœˆï¼Œé‚„æ˜¯çœ‹å˜´å·´å¯¬åº¦ï¼Ÿ",
        options: [
          { t: "çœ¼ç›å‘¨åœçš„ç‰¹å¾µ", isBest: true, feedback: "å°ï¼é€™éš»é³¥æ²’æœ‰ç™½çœ¼åœˆï¼Œä½†è‡‰ä¸Šæœ‰é»‘æ–‘ã€‚", clue: "é ­éƒ¨ç´ è‰²æ£•ï¼Œç„¡ç™½çœ¼åœˆï¼Œè‡‰é °æœ‰é»‘æ–‘" },
          { t: "å˜´å·´çš„å¯¬åº¦", isBest: false, feedback: "å˜´å·´å¤§å®¶éƒ½å·®ä¸å¤šï½è§€å¯Ÿçœ¼ç›å‘¨åœæœ‰æ²’æœ‰ç‰¹å¾µæ‰æ˜¯é—œéµã€‚", clue: "é ­éƒ¨ç´ è‰²æ£•ï¼Œç„¡ç™½çœ¼åœˆï¼Œè‡‰é °æœ‰é»‘æ–‘" }
        ]
      }
    }
  },
  bulbul: {
    key: "bulbul", name: "ç™½é ­ç¿",
    induction: {
      legs: { 
        q: "é€™éš»é³¥çš„ã€è…³ã€è¦å‡ºç¾äº†ï¼ä½ è¦ºå¾—è¦çœ‹ä»€éº¼ï¼Ÿ",
        options: [
          { t: "è…³çš„é¡è‰² (é»‘è‰²)", isBest: true, feedback: "æ²’éŒ¯ï¼é€™éš»é³¥çš„è…³æ˜¯é»‘è‰²çš„ã€‚", clue: "è…³åé»‘ï¼ŒæŠ“æå¾ˆç©©" },
          { t: "è…³è¶¾çš„æ•¸é‡", isBest: false, feedback: "å¤§å¤šæ•¸é³¥è…³è¶¾æ•¸é‡ä¸€æ¨£å–”ï¼Œçœ‹é¡è‰²æ‰æ˜¯é‡é»ï¼Œå†é¸ä¸€æ¬¡ï¼", clue: "è…³åé»‘ï¼ŒæŠ“æå¾ˆç©©" }
        ]
      },
      head: { 
        q: "é€™éš»é³¥çš„ã€é ­éƒ¨ã€æœ€æ˜é¡¯çš„æ˜¯ä»€éº¼ï¼Ÿ",
        options: [
          { t: "é ­é ‚çš„è‰²å€ (ç™½è‰²)", isBest: true, feedback: "æ­£ç¢ºï¼é ­é ‚é‚£å¡Šç™½è‰²ç¾½æ¯›æ˜¯å®ƒçš„ç‰¹å¾µã€‚", clue: "é ­é ‚åç™½ï¼Œè‡‰å´è¼ƒæ·±" },
          { t: "é ­çš„åœ“æ½¤ç¨‹åº¦", isBest: false, feedback: "åœ“ä¸åœ“å¾ˆä¸»è§€ï½çœ‹é ­é ‚é‚£ä¸€å¡Šé¡è‰²å°±å°äº†ï¼å†è©¦è©¦ï¼", clue: "é ­é ‚åç™½ï¼Œè‡‰å´è¼ƒæ·±" }
        ]
      },
      body: { q: "ã€èº«é«”ã€è¦å‡ºç¾äº†ï¼è¦çœ‹ä»€éº¼ï¼Ÿ", options: [{t:"èº«é«”è‰²èª¿", isBest:true, feedback:"å°ï¼ç°è¤è‰²çš„èº«é«”é…ä¸Šæ·¡è‰²è…¹éƒ¨ã€‚", clue:"èº«é«”ç°è¤è‰²ï¼Œè…¹éƒ¨è¼ƒæ·¡"},{t:"é³¥çš„é«”ç©", isBest:false, feedback:"é«”ç©å¾ˆé›£åœ¨å¡ç‰‡ä¸Šæ¯”å‡ºä¾†ï¼Œçœ‹è‰²èª¿å§ï¼", clue:"èº«é«”ç°è¤è‰²ï¼Œè…¹éƒ¨è¼ƒæ·¡"}]},
      wing: { q: "ã€ç¿…è†€ã€çš„ç·šç´¢ï¼è¦çœ‹é¡è‰²å—ï¼Ÿ", options: [{t:"ç¿…è†€é‚Šç·£çš„è‰²æ¾¤", isBest:true, feedback:"æ²’éŒ¯ï¼å¸¶é»é»ƒç¶ è‰²ã€‚", clue:"ç¿…è†€æ·±è‰²ã€é‚Šç·£å¸¶é»ƒç¶ è‰²"},{t:"ç¾½æ¯›çš„åšåº¦", isBest:false, feedback:"åšåº¦çœ‹ä¸å‡ºä¾†å–”ï¼Œè§€å¯Ÿè‰²æ¾¤å§ï¼", clue:"ç¿…è†€æ·±è‰²ã€é‚Šç·£å¸¶é»ƒç¶ è‰²"}]},
      tail: { q: "ã€å°¾å·´ã€è¦å¦‚ä½•è¾¨èªï¼Ÿ", options: [{t:"æœ«ç«¯çš„å½¢ç‹€", isBest:true, feedback:"æ˜¯çš„ï¼Œä¸­é•·å¹³å°¾ã€‚", clue:"å°¾å·´ä¸­é•·ï¼Œæœ«ç«¯åæ–¹"},{t:"å°¾å·´çš„æŸ”è»Ÿåº¦", isBest:false, feedback:"æŸ”è»Ÿåº¦çœ‹ä¸å‡ºä¾†å‘€ï¼Œçœ‹å½¢ç‹€å§ï¼", clue:"å°¾å·´ä¸­é•·ï¼Œæœ«ç«¯åæ–¹"}]}
    }
  }
};

/** ===========================
 * æ ¸å¿ƒé‚è¼¯
 * =========================== */
let state = {
  bird: null,
  clues: new Set(),
  pendingPart: null,
  cameraOn: false,
  correctionCount: 0
};

const $ = (id) => document.getElementById(id);
const labels = { legs:"è…³", body:"èº«é«”", wing:"ç¿…è†€", tail:"å°¾å·´", head:"é ­éƒ¨" };

function initMysteryBird() {
  const keys = Object.keys(BIRDS);
  state.bird = BIRDS[keys[Math.floor(Math.random() * keys.length)]];
  $("birdNameDisplay").innerText = "ç¥ç¥•é³¥";
  updateUI();
}

function updateUI() {
  $("clueCount").innerText = state.clues.size;
  $("btnQuiz").disabled = (state.clues.size < 5);
  const chipBox = $("clueChips");
  chipBox.innerHTML = "";
  ["legs", "body", "wing", "tail", "head"].forEach(p => {
    const c = document.createElement("div");
    c.className = `chip ${state.clues.has(p) ? 'done' : (state.pendingPart === p ? 'pending' : '')}`;
    c.innerText = `${state.clues.has(p) ? 'âœ…' : ''} ${labels[p]}`;
    chipBox.appendChild(c);
  });
}

$("btnFeed").onclick = () => {
  if (state.pendingPart) return alert(`è«‹å…ˆæƒæç›®å‰çš„ç·šç´¢ï¼`);
  const parts = ["legs", "body", "wing", "tail", "head"];
  const missing = parts.filter(p => !state.clues.has(p));
  if (missing.length === 0) return alert("ç·šç´¢å·²é›†æ»¿ï¼");
  
  state.pendingPart = missing[Math.floor(Math.random() * missing.length)];
  $("feedOverlay").classList.add("show");
  setTimeout(() => {
    $("feedOverlay").classList.remove("show");
    showInductionModal(state.pendingPart);
  }, 1200);
};

function showInductionModal(part) {
  const modal = $("guidanceModal");
  const script = state.bird.induction[part];
  modal.classList.remove("hidden");
  $("aiIcon").innerText = "âœ¨ AI åŠ©æ•™è§£è¬å¼•å°";
  $("aiClueBox").classList.add("hidden");
  $("btnGoScan").classList.add("hidden");
  $("aiText").innerText = script.q;
  $("aiOptions").innerHTML = "";

  script.options.forEach(opt => {
    const btn = document.createElement("button");
    btn.className = "optBtn";
    btn.innerText = opt.t;
    btn.onclick = () => {
      $("aiText").innerText = opt.feedback;
      if (opt.isBest) {
        $("aiClueBox").innerHTML = `ğŸ ç²å¾—ç·šç´¢ï¼š<br/>${opt.clue}`;
        $("aiClueBox").classList.remove("hidden");
        $("aiOptions").innerHTML = ""; 
        $("btnGoScan").classList.remove("hidden");
        $("btnGoScan").onclick = () => {
          modal.classList.add("hidden");
          openScan(opt.clue);
        };
      }
    };
    $("aiOptions").appendChild(btn);
  });
}

function openScan(clueText) {
  if(!state.cameraOn) startCamera();
  $("scanModal").classList.remove("hidden");
  $("scanPersistHint").innerText = `ğŸ’¡ ç·šç´¢æŒ‡å¼•ï¼š${clueText}`;
  updateUI();
  requestAnimationFrame(scanLoop);
}

function closeScan() { $("scanModal").classList.add("hidden"); }

// æ ¸å¿ƒï¼šç‰¹å¾µæ¯”å°èˆ‡ä¿®æ­£å‡è¨­
function handleScannedText(codeData) {
  const focus = $("scanFocusBox");
  const modal = $("guidanceModal");
  let url;
  try { url = new URL(codeData); } catch(e) { return; }

  const scannedBirdKey = url.searchParams.get("bird");
  const scannedPart = url.searchParams.get("claim");

  if (scannedPart === state.pendingPart) {
    if (scannedBirdKey === state.bird.key) {
      focus.classList.remove("error");
      state.clues.add(state.pendingPart);
      state.pendingPart = null;
      alert("âœ… æƒææ­£ç¢ºï¼é€™å°±æ˜¯æˆ‘å€‘è¦æ‰¾çš„ç‰¹å¾µã€‚");
      closeScan();
      updateUI();
    } else {
      // éŒ¯èª¤ï¼šä½¿ç”¨ AI Modal é€²è¡Œç‰¹å¾µæ¯”å°
      state.correctionCount++;
      focus.classList.add("error");
      const scannedBird = BIRDS[scannedBirdKey] || BIRDS.sparrow;
      const targetBird = state.bird;
      const scannedFeature = scannedBird.induction[scannedPart].options.find(o => o.isBest).clue;
      const targetFeature = targetBird.induction[scannedPart].options.find(o => o.isBest).clue;

      closeScan();
      modal.classList.remove("hidden");
      $("aiIcon").innerText = "âŒ è§€å¯Ÿå‡è¨­ä¿®æ­£";
      $("aiOptions").innerHTML = "";
      $("aiClueBox").classList.add("hidden");
      $("btnGoScan").classList.remove("hidden");
      $("btnGoScan").innerText = "é‡æ–°è§€å¯Ÿä¸¦æƒæ";
      $("aiText").innerText = `ä½ æƒåˆ°çš„é€™å¼µå¡ç‰¹å¾µæ˜¯ã€Œ${scannedFeature}ã€ï¼Œ\nä½†æˆ‘å€‘çš„ç¥ç¥•é³¥ã€Œ${labels[scannedPart]}ã€ç·šç´¢æ‡‰è©²æ˜¯ã€Œ${targetFeature}ã€å–”ï¼\n\nå†å»å°‹æ‰¾æ­£ç¢ºçš„å¡ç‰‡å§ã€‚`;
      $("btnGoScan").onclick = () => {
        modal.classList.add("hidden");
        openScan(targetFeature);
      };
    }
  } else {
    alert(`âŒ æƒéŒ¯éƒ¨ä½å›‰ï¼ç¾åœ¨éœ€è¦æƒæã€Œ${labels[state.pendingPart]}ã€ã€‚`);
  }
}

function scanLoop() {
  const video = $("camera");
  const canvas = $("scanPreview");
  const focus = $("scanFocusBox");
  const ctx = canvas.getContext("2d");
  if (video.readyState === video.HAVE_ENOUGH_DATA) {
    canvas.height = 480; canvas.width = 640;
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    const code = jsQR(ctx.getImageData(0,0,640,480).data, 640, 480);
    if (code) {
      focus.style.display = "block";
      const loc = code.location;
      focus.style.left = (loc.topLeftCorner.x / 640 * 100) + "%";
      focus.style.top = (loc.topLeftCorner.y / 480 * 100) + "%";
      focus.style.width = (loc.topRightCorner.x - loc.topLeftCorner.x) / 640 * 100 + "%";
      focus.style.height = (loc.bottomLeftCorner.y - loc.topLeftCorner.y) / 480 * 100 + "%";
      handleScannedText(code.data);
    } else { focus.style.display = "none"; }
  }
  if (!$("scanModal").classList.contains("hidden")) requestAnimationFrame(scanLoop);
}

async function startCamera() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
    $("camera").srcObject = stream;
    state.cameraOn = true;
    updateUI();
  } catch (e) { alert("ç›¸æ©Ÿæˆæ¬Šå¤±æ•—"); }
}

window.onload = initMysteryBird;
</script>
</body>
</html>
