<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Bird Builder AR Demo</title>

  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

  <style>
    :root{
      --bg:#0b1220;
      --panel:#f4ecd8;
      --panel2:#efe3c6;
      --ink:#2b2b2b;
      --muted:#6b6256;
      --accent:#f0c14b;
      --good:#2e7d32;
      --bad:#c62828;
      --shadow: 0 18px 40px rgba(0,0,0,.35);
      --radius:18px;
    }
    *{box-sizing:border-box;font-family: ui-sans-serif, system-ui, -apple-system, "PingFang TC", "Noto Sans TC", "Microsoft JhengHei", sans-serif;}
    body{margin:0;background:var(--bg);color:#fff;overflow:hidden;}
    #app{position:relative;height:100dvh;width:100vw;background:#000;}
    video#camera{
      position:absolute;inset:0;width:100%;height:100%;object-fit:cover;
      filter:saturate(1.05) contrast(1.05);
      background:#000;
    }
    #overlay{position:absolute;inset:0;display:flex;flex-direction:column;justify-content:space-between;padding:14px;pointer-events:none;}
    .topbar{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;}
    .pill{
      pointer-events:auto;
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;border-radius:999px;
      background:rgba(20,20,20,.55);backdrop-filter: blur(8px);
      border:1px solid rgba(255,255,255,.12);
      font-size:14px;
    }
    .pill strong{font-weight:800;}
    .stage{
      pointer-events:none;
      display:flex;align-items:center;justify-content:center;
      min-height:44vh;
    }
    .birdCard{
      pointer-events:none;
      width:min(520px,92vw);
      background:rgba(20,20,20,.28);
      border:1px solid rgba(255,255,255,.14);
      border-radius:26px;
      padding:14px;
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:10px;
    }
    .birdCanvas{width:100%;display:flex;align-items:center;justify-content:center;}
    .birdCanvas svg{width:min(420px,86vw);height:auto;}
    .hintRow{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
    .chip{
      pointer-events:none;
      background:rgba(255,255,255,.14);
      border:1px solid rgba(255,255,255,.14);
      padding:6px 10px;border-radius:999px;
      font-size:12px;
    }

    /* ä¿®æ­£å¾Œçš„æç¤ºæ–‡å­—æ¨£å¼ */
    .dynamicHint{
      font-size:13px; opacity:.92; text-align:center; line-height:1.45;
      background: rgba(0,0,0,.25); padding: 8px 12px; border-radius: 12px;
      margin-top: 5px; color: var(--accent); font-weight: 500;
    }

    .bottom{
      pointer-events:auto;
      display:flex;gap:10px;flex-wrap:wrap;justify-content:center;
      padding-bottom: calc(8px + env(safe-area-inset-bottom));
    }
    button{
      border:0;border-radius:16px;
      padding:12px 14px;font-size:15px;
      background:#ffffff; color:#111;
      box-shadow: 0 10px 18px rgba(0,0,0,.25);
      cursor:pointer;
    }
    button.dark{
      background:rgba(255,255,255,.16);color:#fff;border:1px solid rgba(255,255,255,.18);
      backdrop-filter: blur(8px);
    }
    button:disabled{opacity:.45;cursor:not-allowed;}

    .toast{
      pointer-events:none;
      position:absolute;left:50%;transform:translateX(-50%);
      bottom:118px;
      background:rgba(0,0,0,.70);color:#fff;
      padding:10px 14px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      backdrop-filter: blur(8px);
      font-size:14px;
      opacity:0;transition:opacity .2s;
      max-width:min(92vw,640px);
      text-align:center;
      line-height:1.3;
      z-index: 2000;
    }
    .toast.show{opacity:1;}

    /* Modal */
    .modal{
      position:fixed;inset:0;
      background:rgba(0,0,0,.55);
      display:flex;align-items:center;justify-content:center;
      padding:14px;
      z-index:100;
    }
    .hidden{display:none;}
    .box{
      width:min(780px,96vw);
      background:var(--panel);
      color:var(--ink);
      border-radius:22px;
      box-shadow: var(--shadow);
      border:1px solid rgba(0,0,0,.08);
      overflow:hidden;
    }
    .boxHeader{
      display:flex;align-items:center;justify-content:space-between;
      padding:14px 14px 10px 14px;
      background:linear-gradient(180deg, var(--panel), var(--panel2));
      border-bottom:1px solid rgba(0,0,0,.08);
    }
    .title{font-size:18px;font-weight:900;}
    .xbtn{
      width:38px;height:38px;border-radius:12px;border:0;
      background:rgba(0,0,0,.08);cursor:pointer;
      font-size:18px;line-height:1;
    }
    .stepDots{
      display:flex;gap:8px;align-items:center;flex-wrap:wrap;
      padding:10px 14px 0 14px;
    }
    .dot{
      width:34px;height:34px;border-radius:999px;
      display:flex;align-items:center;justify-content:center;
      background:rgba(0,0,0,.06);
      border:1px solid rgba(0,0,0,.10);
      font-weight:900;
    }
    .dot.active{background:var(--accent);border-color:rgba(0,0,0,.14);}
    .dot.done{background:rgba(46,125,50,.18);border-color:rgba(46,125,50,.25);color:var(--good);}

    .content{padding:12px 14px 14px 14px;display:flex;flex-direction:column;gap:10px;}
    .clueBox{
      background:rgba(255,255,255,.72);
      border:1px solid rgba(0,0,0,.08);
      border-radius:16px;
      padding:12px;
      line-height:1.35;
      white-space:pre-wrap;
    }
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;}
    .opt{
      background:#fff;
      border:2px solid rgba(0,0,0,.10);
      border-radius:18px;
      padding:12px;
      cursor:pointer;
      display:flex;gap:10px;align-items:center;
      min-height:88px;
    }
    .opt svg{width:56px;height:56px;flex:0 0 auto;}
    .opt .lbl{font-weight:900;}
    .opt .desc{font-size:12px;color:var(--muted);margin-top:3px;}
    .opt.correct{border-color:rgba(46,125,50,.55);background:rgba(46,125,50,.08);}
    .opt.wrong{border-color:rgba(198,40,40,.55);background:rgba(198,40,40,.08);}

    .footer{
      padding:12px 14px 14px 14px;
      display:flex;gap:10px;justify-content:space-between;align-items:center;
      background:linear-gradient(180deg, var(--panel2), var(--panel));
      border-top:1px solid rgba(0,0,0,.08);
    }
    .btnSmall{padding:10px 12px;border-radius:14px;font-size:14px;}
    .btnPrimary{background:#1b1b1b;color:#fff;}
    .btnGhost{background:#fff;color:#111;border:1px solid rgba(0,0,0,.12);}

    /* Feed animation overlay */
    #feedAnim{
      position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
      z-index:35; pointer-events:none; opacity:0;
    }
    #feedAnim.show{ animation:feedDrop 1200ms cubic-bezier(.2,.9,.2,1) 1; opacity:1; }
    #feedAnim .card{
      width:min(300px, 82vw); border-radius:18px;
      background:rgba(255,255,255,.92); border:1px solid rgba(0,0,0,.12);
      padding:14px; display:flex; align-items:center; justify-content:space-between; gap:12px;
      backdrop-filter: blur(10px);
    }
    @keyframes feedDrop{
      0%{ transform:translate(-50%,-50%) translateY(-180px) rotate(-6deg); opacity:0; }
      18%{ opacity:1; }
      55%{ transform:translate(-50%,-50%) translateY(0) rotate(0deg); opacity:1; }
      100%{ transform:translate(-50%,-50%) translateY(-90px) opacity:0; }
    }

    /* Scan preview */
    .scanWrap{width:100%;display:flex;flex-direction:column;gap:10px;}
    .scanPreviewBox{
      width:100%; border-radius:18px; overflow:hidden;
      background:#000; position:relative;
    }
    canvas#scanPreview{width:100%;height:auto;display:block;}
    .scanBadge{
      position:absolute; left:12px; top:12px; background:rgba(0,0,0,.55);
      color:#fff; padding:6px 10px; border-radius:999px; font-size:12px;
    }
  </style>
</head>

<body>
<div id="app">
  <video id="camera" autoplay playsinline muted></video>

  <div id="overlay">
    <div class="topbar">
      <div class="pill"><strong id="birdName">é³¥</strong> <span id="birdSub"></span></div>
      <div class="pill">
        ç·šç´¢ <strong id="clueCount">0</strong>/5
        <span style="opacity:.6">|</span>
        å¾…æƒ <strong id="pendingText">â€”</strong>
        <span style="opacity:.6">|</span>
        AI æç¤º <strong id="hintLeft">2</strong>/2
      </div>
    </div>

    <div class="stage">
      <div class="birdCard">
        <div class="birdCanvas" id="birdCanvas"></div>
        <div class="hintRow" id="clueChips"></div>
        <div class="dynamicHint" id="instructionText">è«‹æŒ‰ <strong>é¤µé³¥</strong> é–‹å§‹ç²å–ç·šç´¢</div>
      </div>

      <div class="toast" id="toast"></div>

      <div id="feedAnim" aria-hidden="true">
        <div class="card">
          <div style="display:flex;flex-direction:column;gap:2px;">
            <div style="font-weight:900;font-size:13px;color:#7a5200;">æ‰è½ç·šç´¢å¡</div>
            <div id="feedAnimPart" style="font-weight:900;font-size:18px;">éƒ¨ä½ï¼šâ€”</div>
          </div>
          <div style="font-size:30px;">ğŸª¶</div>
        </div>
      </div>
    </div>

    <div class="bottom">
      <button class="dark" id="btnCamera">å•Ÿå‹•ç›¸æ©Ÿ</button>
      <button id="btnFeed">é¤µé³¥ï¼ˆæ‰è½ç·šç´¢ï¼‰</button>
      <button class="dark" id="btnScan" disabled>æƒæç·šç´¢å¡</button>
      <button class="btnPrimary" id="btnQuiz" disabled>é–‹å§‹è¾¨èªï¼ˆ1/5ï¼‰</button>
      <button class="dark" id="btnReset">é‡ç½®é€²åº¦</button>
    </div>
  </div>

  <div class="modal hidden" id="quizModal">
    <div class="box">
      <div class="boxHeader">
        <div class="title" id="quizTitle">è¾¨èªé³¥é¡</div>
        <button class="xbtn" id="closeQuiz">Ã—</button>
      </div>
      <div class="stepDots" id="stepDots"></div>
      <div class="content">
        <div class="clueBox" id="clueBox"></div>
        <div class="grid" id="optionsGrid"></div>
      </div>
      <div class="footer">
        <button class="btnSmall btnGhost" id="btnHintQuiz">AI æç¤º</button>
        <button class="btnSmall btnGhost" id="btnCloseQuiz2">é—œé–‰</button>
      </div>
    </div>
  </div>

  <div class="modal hidden" id="assembleModal">
    <div class="box">
      <div class="boxHeader"><div class="title">å·²æ‹¼ä¸Šéƒ¨ä½</div></div>
      <div style="padding:20px; text-align:center;">
        <div id="assembleBird"></div>
        <p id="assembleSummary" style="margin:15px 0; line-height:1.4;"></p>
        <button class="btnPrimary" id="btnAssembleNext" style="width:100%; padding:14px; border-radius:14px;">ä¸‹ä¸€æ­¥</button>
      </div>
    </div>
  </div>

  <div class="modal hidden" id="scanOverlay">
    <div class="box" style="max-width:720px;">
      <div class="boxHeader">
        <div class="title">æƒæç·šç´¢å¡</div>
        <button class="xbtn" id="btnStopScan">Ã—</button>
      </div>
      <div class="content">
        <div class="scanWrap">
          <div class="scanPreviewBox">
            <div class="scanBadge">æƒæä¸­â€¦</div>
            <canvas id="scanPreview" width="960" height="540"></canvas>
          </div>
          <div class="clueBox" id="scanHintText" style="font-size:14px;"></div>
          <div style="font-size:13px;color:var(--muted);">ç›®å‰éœ€è¦ï¼š<strong id="scanNeedText">â€”</strong></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/** ===========================
 * Data & State (æ•´åˆ 5 éš»é³¥èˆ‡ AI å›é¥‹é‚è¼¯)
 * =========================== */
const STEPS = [
  { key:"legs", label:"è…³" },
  { key:"body", label:"èº«é«”" },
  { key:"wing", label:"ç¿…è†€" },
  { key:"tail", label:"å°¾å·´" },
  { key:"head", label:"é ­/è¨˜è™Ÿ" },
];

// ... (çœç•¥ OPTION_LIB èˆ‡ BIRDS å®šç¾©ä»¥ç¯€çœç©ºé–“ï¼Œèˆ‡å‰ç‰ˆæœ¬ä¸€è‡´)
// æ­¤è™•æ‡‰åŒ…å«ä½ åœ¨ index.html ä¸­å®Œæ•´çš„ BIRDS è³‡æ–™ï¼Œç‰¹åˆ¥æ˜¯ ai æç¤ºéƒ¨åˆ†
const BIRDS = { /* ... åŒ…å« sparrow, bulbul, dove, drongo, whiteeye ... */ };
const birdKey = new URLSearchParams(location.search).get("bird") || "sparrow";
const bird = BIRDS[birdKey] || BIRDS.sparrow;

let state = {
  clues: {},
  solved: {},
  currentStep: 0,
  assembledCount: 0,
  pendingPart: null,
  cameraOn: false,
  hintLeft: 2
};

const $ = (id)=>document.getElementById(id);

/** ===========================
 * Core Functions (ä¿®æ­£ 6/5 èˆ‡ UI æç¤º)
 * =========================== */
function showToast(msg){
  const t = $("toast");
  t.textContent = msg;
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"), 2500);
}

function renderCounters(){
  const collectedCount = Object.keys(state.clues).length;
  $("clueCount").textContent = collectedCount;
  $("pendingText").textContent = state.pendingPart ? STEPS.find(s=>s.key===state.pendingPart).label : "â€”";
  $("btnScan").disabled = !state.pendingPart;
  
  // ä¿®æ­£ï¼šé›†æ»¿ 5 å€‹ä¸”æ²’æœ‰å¾…æƒéƒ¨ä½æ‰å¯ç­”é¡Œ
  $("btnQuiz").disabled = (collectedCount < 5 || !!state.pendingPart);
  $("hintLeft").textContent = state.hintLeft;

  const nextIdx = STEPS.findIndex(s=>!state.solved[s.key]);
  $("btnQuiz").textContent = `é–‹å§‹è¾¨èªï¼ˆ${(nextIdx===-1?5:nextIdx+1)}/5ï¼‰`;

  // ä¿®å¾© UI å‹•æ…‹æç¤ºæ–‡å­—
  const instText = $("instructionText");
  if (state.pendingPart) {
    instText.innerHTML = `è«‹æ‰¾åˆ° <strong>${bird.name} | ${STEPS.find(s=>s.key===state.pendingPart).label}</strong> ç·šç´¢å¡ä¸¦æƒæ`;
  } else if (collectedCount < 5) {
    instText.innerHTML = `è«‹æŒ‰ <strong>é¤µé³¥</strong> ç²å–éš¨æ©Ÿéƒ¨ä½ç·šç´¢å¡`;
  } else {
    instText.innerHTML = `ç·šç´¢å·²é›†æ»¿ï¼è«‹æŒ‰ <strong>é–‹å§‹è¾¨èª</strong>`;
  }
}

function renderChips(){
  const container = $("clueChips");
  container.innerHTML = "";
  STEPS.forEach(s=>{
    const div = document.createElement("div");
    div.className = "chip";
    const has = !!state.clues[s.key];
    const pending = state.pendingPart === s.key;
    div.innerHTML = has ? `âœ… ${s.label}` : (pending ? `ğŸ”¶ å¾…æƒ` : `â¬š ${s.label}`);
    container.appendChild(div);
  });
}

/** ===========================
 * Feed & Scan (ä¿®æ­£ QR æƒéŒ¯æç¤º)
 * =========================== */
function feedBird(){
  if(state.pendingPart){
    openScan();
    return;
  }
  const missing = STEPS.map(s=>s.key).filter(k=>!state.clues[k]);
  if(missing.length === 0){
    showToast("ç·šç´¢å·²é›†æ»¿ï¼");
    return;
  }
  const part = missing[Math.floor(Math.random()*missing.length)];
  state.pendingPart = part;
  
  // å‹•ç•«
  $("feedAnimPart").textContent = `éƒ¨ä½ï¼š${STEPS.find(s=>s.key===part).label}`;
  $("feedAnim").classList.add("show");
  setTimeout(()=>{$("feedAnim").classList.remove("show");}, 1200);

  renderCounters();
  renderChips();
  openScan();
}

function openScan(){
  if(!state.cameraOn) { startCamera(); return; }
  $("scanOverlay").classList.remove("hidden");
  const partLabel = STEPS.find(s=>s.key===state.pendingPart).label;
  $("scanNeedText").textContent = `${bird.name} | ${partLabel}`;
  $("scanHintText").textContent = bird.cluePool[state.pendingPart][0];
  requestAnimationFrame(scanLoop);
}

function handleScannedText(text){
  let url;
  try { url = new URL(text); } catch(e) { 
    showToast("âŒ éç·šç´¢å¡ QR Codeï¼"); 
    return "wrong"; 
  }
  
  const b = url.searchParams.get("bird");
  const claim = url.searchParams.get("claim");

  // 1. æª¢æŸ¥æ˜¯å¦ç‚ºæ­£ç¢ºçš„é³¥ç¨®
  if(b !== birdKey){
    showToast(`âŒ é€™å¼µæ˜¯ã€Œ${BIRDS[b]?.name || b}ã€çš„å¡ç‰‡ï¼Œä¸æ˜¯ã€Œ${bird.name}ã€çš„å–”ï¼`);
    return "wrong";
  }

  // 2. æª¢æŸ¥æ˜¯å¦ç‚ºæ­£ç¢ºçš„éƒ¨ä½
  if(claim !== state.pendingPart){
    const targetLabel = STEPS.find(s=>s.key===state.pendingPart).label;
    showToast(`âŒ é€™æ˜¯ã€Œ${STEPS.find(s=>s.key===claim).label}ã€å¡ï¼Œç›®å‰éœ€è¦ã€Œ${targetLabel}ã€å–”ï¼`);
    return "wrong";
  }

  // æˆåŠŸç²å–
  grantClue(claim);
  return "success";
}

function grantClue(part){
  // ä¿®æ­£ 6/5 bugï¼šç¢ºèªè©²éƒ¨ä½å°šæœªå­˜åœ¨æ‰åŠ å…¥
  if(!state.clues[part]){
    state.clues[part] = { text: bird.cluePool[part][0] };
  }
  state.pendingPart = null;
  $("scanOverlay").classList.add("hidden");
  showToast("âœ… æƒææˆåŠŸï¼ç²å¾—ç·šç´¢");
  renderCounters();
  renderChips();
}

/** ===========================
 * Quiz Flow (ä¿®å¾©ç­”éŒ¯ AI å›é¥‹)
 * =========================== */
function chooseOption(part, optKey, cardEl){
  const q = bird.quiz[part];
  if(optKey === q.correct){
    cardEl.classList.add("correct");
    state.solved[part] = true;
    state.assembledCount = Object.keys(state.solved).length;
    setTimeout(()=>{
      $("quizModal").classList.add("hidden");
      openAssembleModal(part);
    }, 400);
  } else {
    cardEl.classList.add("wrong");
    // ä¿®æ­£ï¼šç­”éŒ¯çµ¦äºˆè©²éƒ¨ä½çš„ AI å°å¼•æç¤ºï¼Œä¸ç›´æ¥é‡ç½®
    const failHint = bird.ai[part] ? bird.ai[part][0] : "å†è§€å¯Ÿä¸€ä¸‹ç‰¹å¾µå–”ï¼";
    showToast(`âŒ ç­”éŒ¯äº†ï¼AI æç¤ºï¼š${failHint}`);
  }
}

// ... (çœç•¥ renderBird, openQuiz, openAssembleModal ç­‰åŸºç¤åŠŸèƒ½ï¼Œèˆ‡ index.html åŸæ„ä¸€è‡´)

function init(){
  $("birdName").textContent = bird.name;
  renderBird(0);
  renderCounters();
  renderChips();
  
  // ç¶å®šäº‹ä»¶
  $("btnFeed").onclick = feedBird;
  $("btnQuiz").onclick = openQuiz;
  $("btnCamera").onclick = startCamera;
  $("btnReset").onclick = () => location.reload();
  $("closeQuiz").onclick = $("btnCloseQuiz2").onclick = () => $("quizModal").classList.add("hidden");
  $("btnStopScan").onclick = () => $("scanOverlay").classList.add("hidden");
  $("btnAssembleNext").onclick = assembleNext;
}

init();
</script>
</body>
</html>
