<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Bird Builder AR Demo</title>

  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

  <style>
    :root{
      --bg:#0b1220;
      --panel:#f4ecd8;
      --panel2:#efe3c6;
      --ink:#2b2b2b;
      --muted:#6b6256;
      --accent:#f0c14b;
      --good:#2e7d32;
      --bad:#c62828;
      --shadow: 0 18px 40px rgba(0,0,0,.35);
      --radius:18px;
    }
    *{box-sizing:border-box;font-family: ui-sans-serif, system-ui, -apple-system, "PingFang TC", "Noto Sans TC", "Microsoft JhengHei", sans-serif;}
    body{margin:0;background:var(--bg);color:#fff;overflow:hidden;}
    #app{position:relative;height:100dvh;width:100vw;background:#000;}
    video#camera{
      position:absolute;inset:0;width:100%;height:100%;object-fit:cover;
      filter:saturate(1.05) contrast(1.05);
      background:#000;
    }
    #overlay{position:absolute;inset:0;display:flex;flex-direction:column;justify-content:space-between;padding:14px;pointer-events:none;}
    
    /* ä»‹é¢çµ„ä»¶æ¨£å¼ä¿ç•™ */
    .topbar{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;}
    .pill{
      pointer-events:auto;
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;border-radius:999px;
      background:rgba(20,20,20,.55);backdrop-filter: blur(8px);
      border:1px solid rgba(255,255,255,0.12);
      font-size:14px;
    }
    .birdCard{
      pointer-events:none;
      width:min(520px,92vw);
      background:rgba(20,20,20,.28);
      border:1px solid rgba(255,255,255,0.14);
      border-radius:26px;
      padding:14px;
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:10px;
    }
    .birdCanvas svg{width:min(420px,86vw);height:auto;}
    .hintRow{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
    .chip{
      pointer-events:none;
      background:rgba(255,255,255,0.14);
      padding:6px 10px;border-radius:999px;
      font-size:12px;
    }

    .bottom{
      pointer-events:auto;
      display:flex;gap:10px;flex-wrap:wrap;justify-content:center;
      padding-bottom: calc(8px + env(safe-area-inset-bottom));
    }
    button{
      border:0;border-radius:16px;
      padding:12px 14px;font-size:15px;
      background:#ffffff; color:#111;
      box-shadow: 0 10px 18px rgba(0,0,0,.25);
      cursor:pointer;
    }
    button.dark{
      background:rgba(255,255,255,0.16);color:#fff;border:1px solid rgba(255,255,255,0.18);
      backdrop-filter: blur(8px);
    }
    button:disabled{opacity:.45;cursor:not-allowed;}

    /* AI Modal æ¨£å¼å„ªåŒ– */
    .modal{
      position:fixed;inset:0;
      background:rgba(0,0,0,0.65);
      display:flex;align-items:center;justify-content:center;
      padding:14px;
      z-index:100;
    }
    .hidden{display:none !important;}
    .box{
      width:min(480px,96vw);
      background:var(--panel);
      color:var(--ink);
      border-radius:22px;
      box-shadow: var(--shadow);
      border:1px solid rgba(0,0,0,.08);
      overflow:hidden;
    }
    .boxHeader{
      display:flex;align-items:center;justify-content:space-between;
      padding:14px;
      background:linear-gradient(180deg, var(--panel), var(--panel2));
      border-bottom:1px solid rgba(0,0,0,.08);
    }
    .title{font-size:17px;font-weight:900;}
    .content{padding:18px;display:flex;flex-direction:column;gap:14px;}
    .aiText{line-height:1.5; font-size:16px; font-weight:600;}
    .optGrid{display:grid; grid-template-columns: 1fr 1fr; gap:10px;}
    .optBtn{
      background:#fff; border:2px solid rgba(0,0,0,0.1); border-radius:14px;
      padding:12px; font-weight:800; cursor:pointer;
    }
    .optBtn:active{background:var(--accent);}

    /* é¤µé³¥å‹•ç•«ç‰¹æ•ˆ */
    #feedAnim{
      position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
      z-index:35;pointer-events:none;opacity:0;
    }
    #feedAnim.show{animation:feedDrop 1200ms cubic-bezier(.2,.9,.2,1) 1;opacity:1;}
    @keyframes feedDrop{
      0%{ transform:translate(-50%,-50%) translateY(-180px); opacity:0; }
      18%{ opacity:1; }
      55%{ transform:translate(-50%,-50%) translateY(0); opacity:1; }
      100%{ transform:translate(-50%,-50%) translateY(-90px); opacity:0; }
    }

    canvas#scanPreview{width:100%;height:auto;display:block;border-radius:14px;background:#000;}
  </style>
</head>

<body>
<div id="app">
  <video id="camera" autoplay playsinline muted></video>

  <div id="overlay">
    <div class="topbar">
      <div class="pill">ğŸ” <strong id="birdName">ç¥ç¥•é³¥</strong></div>
      <div class="pill">ç·šç´¢ <strong id="clueCount">0</strong>/5 <span style="opacity:.6">|</span> å¾…æƒ <strong id="pendingText">â€”</strong></div>
    </div>

    <div class="stage">
      <div class="birdCard">
        <div class="birdCanvas" id="birdCanvas"></div>
        <div class="hintRow" id="clueChips"></div>
        <div id="dynamicHint" style="font-size:12px;opacity:.92;text-align:center;line-height:1.35;margin-top:8px;">
          è«‹æŒ‰ <strong>é¤µé³¥</strong> é–‹å§‹æ¢ç´¢ç¥ç¥•é³¥çš„ç‰¹å¾µ
        </div>
      </div>
      <div id="feedAnim" aria-hidden="true">âœ¨ æ‰è½ç·šç´¢å¡ âœ¨</div>
    </div>

    <div class="bottom">
      <button class="dark" id="btnCamera">å•Ÿå‹•ç›¸æ©Ÿ</button>
      <button id="btnFeed">é¤µé³¥</button>
      <button class="btnPrimary" id="btnQuiz" disabled>è¾¨èªèº«åˆ† (0/5)</button>
      <button class="dark" id="btnReset">é‡ç½®é€²åº¦</button>
    </div>
  </div>

  <div class="modal hidden" id="aiModal">
    <div class="box">
      <div class="boxHeader">
        <div class="title" id="aiModalTitle">AI åŠ©æ•™å¼•å°</div>
      </div>
      <div class="content">
        <div class="aiText" id="aiModalText"></div>
        <div class="optGrid" id="aiOptGrid"></div>
        <button id="aiNextBtn" class="hidden" style="width:100%; padding:14px; border-radius:14px; background:#1b1b1b; color:#fff;">çŸ¥é“äº†ï¼Œå»æƒæå¡ç‰‡ï¼</button>
        <button id="aiCloseBtn" class="hidden" style="width:100%; padding:14px; border-radius:14px; background:#eee; color:#111;">æˆ‘æœƒå†ä»”ç´°è§€å¯Ÿçœ‹çœ‹</button>
      </div>
    </div>
  </div>

  <div class="modal hidden" id="scanOverlay">
    <div class="box" style="max-width:720px;">
      <div class="boxHeader"><div class="title">æƒæç·šç´¢å¡</div><button onclick="closeScan()" style="border:0;background:none;font-size:24px;">Ã—</button></div>
      <div class="content">
        <div style="width:100%; border-radius:14px; overflow:hidden;"><canvas id="scanPreview"></canvas></div>
        <div id="scanHintBox" style="background:#fff; padding:12px; border-radius:12px; font-size:14px; border:1px solid #ddd;"></div>
      </div>
    </div>
  </div>

</div>

<script>
/** ===========================
 * 1) æ ¸å¿ƒè³‡æ–™çµæ§‹èˆ‡ç¥ç¥•é³¥è…³æœ¬
 * =========================== */
const BIRDS = {
  sparrow: {
    name: "éº»é›€",
    clues: {
      legs: "è…³çŸ­çŸ­ã€åè¤è‰²", body: "èº«é«”è¤è‰²ï¼ŒèƒŒéƒ¨æœ‰æ¢ç´‹",
      wing: "çŸ­åœ“å‹ï¼Œå¸¶æœ‰æ·¡è‰²ç¿¼å¸¶", tail: "ä¸­ç­‰é•·åº¦ï¼Œæœ«ç«¯åå¹³", head: "é ­éƒ¨ç´ è‰²æ£•ï¼Œç„¡ç™½çœ¼åœˆ"
    },
    induction: {
      legs: {
        q: "æˆ‘å€‘è¦è§€å¯Ÿã€è…³ã€äº†ï¼ä½ è¦ºå¾—è…³çš„ã€é¡è‰²ã€é‚„æ˜¯ã€é•·çŸ­ã€æ¯”è¼ƒå®¹æ˜“è®“ä½ èªå‡ºé€™éš»é³¥ï¼Ÿ",
        opt1: { label: "é¡è‰²", feedback: "è§€å¯Ÿé¡è‰²æ˜¯éå¸¸ç§‘å­¸çš„åšæ³•ï¼å°æ–¼é€™éš»é³¥ä¾†èªªï¼Œè…³çš„è‰²å½©å¾ˆæœ‰ç‰¹è‰²ã€‚" },
        opt2: { label: "é•·çŸ­", feedback: "è§€å¯Ÿé•·çŸ­ä¹Ÿå¾ˆå¥½ï¼Œä½†é€™éš»é³¥çš„é¡è‰²å°æ–¼è¾¨è­˜æ›´æœ‰å¹«åŠ©å–”ï¼" }
      },
      head: {
        q: "æœ€å¾Œæ˜¯ã€é ­éƒ¨ã€ï¼ä½ è¦ºå¾—çœ‹ã€çœ¼å‘¨æ˜¯å¦æœ‰åœˆã€é‚„æ˜¯ã€å˜´å·´å¯¬åº¦ã€æ¯”è¼ƒå°ˆæ¥­ï¼Ÿ",
        opt1: { label: "çœ¼å‘¨è¨˜è™Ÿ", feedback: "æ­£ç¢ºï¼çœ¼å‘¨æ˜¯å¦æœ‰ç‰¹æ®Šè¨˜è™Ÿï¼ˆå¦‚çœ¼åœˆæˆ–é»‘æ–‘ï¼‰æ˜¯è¾¨èªé³¥é¡çš„é‡è¦æŒ‡æ¨™ã€‚" },
        opt2: { label: "å˜´å·´å¯¬åº¦", feedback: "çœ‹å˜´å·´ä¹Ÿä¸éŒ¯ï¼Œä½†å°æ–¼é€™éš»é³¥ï¼Œçœ¼ç›å‘¨åœçš„ç‰¹å¾µæœƒæ›´é¡¯çœ¼å–”ï¼" }
      }
      // å…¶ä»–éƒ¨ä½å¯è‡ªè¡Œ Key å…¥...
    }
  },
  bulbul: {
    name: "ç™½é ­ç¿",
    clues: { legs: "è…³åé»‘ï¼ŒæŠ“æå¾ˆç©©", head: "é ­é ‚åç™½ï¼Œè‡‰å´è¼ƒæ·±" /* ... */ },
    induction: {
      legs: { q: "é—œæ–¼é€™éš»é³¥çš„ã€è…³ã€ï¼Œè¦çœ‹ã€æŠ“æ¡åŠ›ã€é‚„æ˜¯ã€é¡è‰²ã€ï¼Ÿ", opt1: { label: "é¡è‰²", feedback: "æ²’éŒ¯ï¼Œæ·±è‰²çš„è…³æ˜¯é€™éš»é³¥çš„ç‰¹å¾µä¹‹ä¸€ï¼" }, opt2: { label: "æŠ“æ¡åŠ›", feedback: "æŠ“æ¡åŠ›å¾ˆé›£è‚‰çœ¼è§€å¯Ÿå–”ï¼Œçœ‹é¡è‰²æœƒæ›´å¿«ï¼" } }
    }
  }
};

const STEPS = ["legs", "body", "wing", "tail", "head"];
const labels = { legs:"è…³", body:"èº«é«”", wing:"ç¿…è†€", tail:"å°¾å·´", head:"é ­éƒ¨" };

/** ===========================
 * 2) éŠæˆ²ç‹€æ…‹èˆ‡ç¥ç¥•é³¥åˆå§‹åŒ–
 * =========================== */
let state = {
  mysteryBirdKey: null,
  clues: {},
  pendingPart: null,
  cameraOn: false,
  scanning: false
};

const $ = (id) => document.getElementById(id);

function initMysteryBird() {
  const keys = Object.keys(BIRDS);
  state.mysteryBirdKey = keys[Math.floor(Math.random() * keys.length)];
  $("birdName").innerText = "ç¥ç¥•é³¥"; // é–å®šç¥ç¥•ç¨±å‘¼
  console.log("ç¥ç§˜é³¥å·²é–å®š");
  renderUI();
}

/** ===========================
 * 3) æ””æˆªå¼é¤µé³¥æµç¨‹
 * =========================== */
$("btnFeed").onclick = () => {
  if (state.pendingPart) return alert("è«‹å…ˆæƒæç›®å‰çš„ç·šç´¢ï¼");
  const missing = STEPS.filter(s => !state.clues[s]);
  if (missing.length === 0) return alert("ç·šç´¢å·²é›†æ»¿ï¼");

  state.pendingPart = missing[Math.floor(Math.random() * missing.length)];
  
  playFeedAnim(); // åŸ·è¡Œé¤µé£Ÿç‰¹æ•ˆ

  setTimeout(() => {
    showInductionModal(state.pendingPart);
  }, 1300);
};

function playFeedAnim() {
  const anim = $("feedAnim");
  anim.classList.add("show");
  setTimeout(() => anim.classList.remove("show"), 1200);
}

function showInductionModal(part) {
  const birdData = BIRDS[state.mysteryBirdKey];
  const script = birdData.induction[part] || { q: `æº–å‚™å»æƒæã€${labels[part]}ã€å§ï¼`, opt1: { label: "å‡ºç™¼", feedback: "å¥½ï¼Œè®“æˆ‘å€‘å»æ‰¾ç·šç´¢ï¼" } };
  
  $("aiModal").classList.remove("hidden");
  $("aiModalTitle").innerText = "âœ¨ AI åŠ©æ•™ï¼šç‰¹å¾µå‡è¨­å¼•å°";
  $("aiModalText").innerText = script.q;
  $("aiOptGrid").innerHTML = "";
  $("aiNextBtn").classList.add("hidden");
  $("aiCloseBtn").classList.add("hidden");

  [script.opt1, script.opt2].forEach(opt => {
    if (!opt) return;
    const btn = document.createElement("button");
    btn.className = "optBtn";
    btn.innerText = opt.label;
    btn.onclick = () => {
      $("aiOptGrid").innerHTML = "";
      $("aiModalText").innerText = opt.feedback + "\n\næ­å–œï¼ä½ ç²å¾—äº†ç·šç´¢ï¼š\nã€Œ" + birdData.clues[part] + "ã€";
      $("aiNextBtn").classList.remove("hidden");
      $("aiNextBtn").onclick = () => {
        $("aiModal").classList.add("hidden");
        openScan();
      };
    };
    $("aiOptGrid").appendChild(btn);
  });
}

/** ===========================
 * 4) ç‰¹å¾µæ¯”å°å›é¥‹ (AR Error Scaffolding)
 * =========================== */
function handleScannedText(text) {
  let url;
  try { url = new URL(text); } catch(e) { return; }
  
  const scannedBirdKey = url.searchParams.get("bird");
  const scannedPart = url.searchParams.get("claim");

  if (scannedPart !== state.pendingPart) {
    alert(`é€™å¼µæ˜¯ã€${labels[scannedPart]}ã€ï¼Œä½†æˆ‘å€‘ç¾åœ¨éœ€è¦çš„æ˜¯ã€${labels[state.pendingPart]}ã€å–”ï¼`);
    return;
  }

  if (scannedBirdKey === state.mysteryBirdKey) {
    // æ­£ç¢ºæƒæ
    state.clues[state.pendingPart] = true;
    state.pendingPart = null;
    closeScan();
    alert("âœ… æƒææ­£ç¢ºï¼ç²å¾—ç·šç´¢æˆåŠŸã€‚");
    renderUI();
  } else {
    // è§¸ç™¼ã€Œç‰¹å¾µæ¯”å°å›é¥‹ã€
    state.scanning = false;
    $("scanOverlay").classList.add("hidden");
    
    const targetClue = BIRDS[state.mysteryBirdKey].clues[state.pendingPart];
    const scannedClue = BIRDS[scannedBirdKey]?.clues[scannedPart] || "å…¶ä»–é³¥é¡çš„ç‰¹å¾µ";
    
    $("aiModal").classList.remove("hidden");
    $("aiModalTitle").innerText = "âŒ è§€å¯Ÿå‡è¨­ä¿®æ­£";
    $("aiOptGrid").innerHTML = "";
    $("aiNextBtn").classList.add("hidden");
    $("aiCloseBtn").classList.remove("hidden");
    
    $("aiModalText").innerHTML = `
      å“å‘€ï¼ä½ æƒåˆ°çš„é€™å¼µå¡ç‰‡å±•ç¤ºçš„æ˜¯ï¼š<br/><strong>ã€Œ${scannedClue}ã€</strong><br/><br/>
      ä½†æˆ‘å€‘çš„ç·šç´¢èªªé€™éš»é³¥çš„ç‰¹å¾µæ‡‰è©²æ˜¯ï¼š<br/><strong>ã€Œ${targetClue}ã€</strong><br/><br/>
      é€™å…©è€…çœ‹èµ·ä¾†ä¸å¤ªä¸€æ¨£å–”ã€‚è«‹å†ä»”ç´°è§€å¯Ÿçœ‹çœ‹ï¼
    `;
    
    $("aiCloseBtn").onclick = () => {
      $("aiModal").classList.add("hidden");
    };
  }
}

/** ===========================
 * 5) æƒæèˆ‡ç›¸æ©ŸåŸºç¤é‚è¼¯
 * =========================== */
function openScan() {
  if (!state.cameraOn) return alert("è«‹å…ˆå•Ÿå‹•ç›¸æ©Ÿï¼");
  $("scanOverlay").classList.remove("hidden");
  $("scanHintBox").innerText = "ğŸ’¡ ç·šç´¢ï¼šã€" + BIRDS[state.mysteryBirdKey].clues[state.pendingPart] + "ã€";
  state.scanning = true;
  requestAnimationFrame(scanLoop);
}

function closeScan() { state.scanning = false; $("scanOverlay").classList.add("hidden"); }

function scanLoop() {
  if (!state.scanning) return;
  const video = $("camera");
  const canvas = $("scanPreview");
  const ctx = canvas.getContext("2d");
  if (video.readyState === video.HAVE_ENOUGH_DATA) {
    canvas.width = 640; canvas.height = 480;
    ctx.drawImage(video, 0, 0, 640, 480);
    const code = jsQR(ctx.getImageData(0,0,640,480).data, 640, 480);
    if (code) handleScannedText(code.data);
  }
  requestAnimationFrame(scanLoop);
}

async function startCamera() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
    $("camera").srcObject = stream;
    state.cameraOn = true;
    $("btnCamera").disabled = true;
    $("btnCamera").innerText = "ç›¸æ©Ÿå·²é–‹å•Ÿ";
  } catch(e) { alert("ç„¡æ³•é–‹å•Ÿç›¸æ©Ÿ"); }
}

function renderUI() {
  const count = Object.keys(state.clues).length;
  $("clueCount").innerText = count;
  $("pendingText").innerText = state.pendingPart ? labels[state.pendingPart] : "â€”";
  $("btnQuiz").disabled = (count < 5);
  
  const chipContainer = $("clueChips");
  chipContainer.innerHTML = "";
  STEPS.forEach(s => {
    const chip = document.createElement("div");
    chip.className = "chip";
    chip.innerText = (state.clues[s] ? "âœ… " : "â¬š ") + labels[s];
    chipContainer.appendChild(chip);
  });
}

$("btnCamera").onclick = startCamera;
$("btnReset").onclick = () => location.reload();
window.onload = initMysteryBird;
</script>
</body>
</html>
