<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Bird Builder AR Demo</title>

  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
  <script type="module">
    import { pipeline } from "https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2";

    // [B2] 免費、免 API 的前端 ML：多語系句向量 embedding（支援中文）
    const MODEL_NAME = "Xenova/distiluse-base-multilingual-cased-v2";
    let extractorPromise = null;

    function getExtractor() {
      if (!extractorPromise) {
        extractorPromise = pipeline("feature-extraction", MODEL_NAME, { device: "wasm" });
      }
      return extractorPromise;
    }

    // [B2] 更貼近鳥類線索的語意維度（可擴充）
    const DIM_LABEL = {
      color:    "色彩維度",
      shape:    "形態維度",
      pattern:  "斑紋維度",
      size:     "大小/比例維度",
      behavior: "行為維度",
    };

    // 以「原型句」表示每個維度（避免自己收集資料訓練；仍保有 ML 推論）
    const PROTOTYPES = {
      color: [
        "這句線索主要描述顏色或色調，例如黑白褐綠、粉紅、明暗、淡深、亮黑。",
        "重點是色彩、色相或明暗對比。"
      ],
      shape: [
        "這句線索主要描述外形結構，例如翅型尾型、長短、尖圓、分叉、方尾、比例形狀。",
        "重點是形態、輪廓、形狀與結構特徵。"
      ],
      pattern: [
        "這句線索主要描述斑紋或標記，例如條紋、翼帶、眼圈、頸側斑點、項鍊斑。",
        "重點是紋理、斑點、條帶等圖樣。"
      ],
      size: [
        "這句線索主要描述大小或比例，例如小巧、較大、偏長、偏短、體型、長度與粗細比例。",
        "重點是尺寸、比例與體型感。"
      ],
      behavior: [
        "這句線索主要描述行為或動作，例如走跳靈活、抓枝、飛行方式、覓食、警戒或叫聲。",
        "重點是活動方式、行為表現或動作特徵。"
      ],
    };

    let protoEmb = null;

    async function embed(text) {
      const extractor = await getExtractor();
      const out = await extractor(text, { pooling: "mean", normalize: true });
      return Array.from(out.data);
    }

    function dot(a, b) {
      let s = 0;
      for (let i = 0; i < a.length; i++) s += a[i] * b[i];
      return s;
    }

    function softmax(scores) {
      const m = Math.max(...scores);
      const exps = scores.map(x => Math.exp(x - m));
      const z = exps.reduce((a,b)=>a+b, 0) || 1;
      return exps.map(e => e / z);
    }

    function meanVec(vecs) {
      const d = vecs[0].length;
      const m = new Array(d).fill(0);
      for (const v of vecs) for (let i = 0; i < d; i++) m[i] += v[i];
      for (let i = 0; i < d; i++) m[i] /= vecs.length;
      return m;
    }

    async function ensurePrototypesReady() {
      if (protoEmb) return;

      const keys = Object.keys(PROTOTYPES);
      const tmp = {};
      for (const k of keys) {
        const vecs = [];
        for (const s of PROTOTYPES[k]) vecs.push(await embed(s));
        tmp[k] = meanVec(vecs);
      }
      protoEmb = tmp;

      window.__ML_MODEL_INFO__ = {
        model: MODEL_NAME,
        device: "wasm",
        method: "prototype cosine + softmax(multi-class)",
        dimensions: DIM_LABEL,
        prototypes: PROTOTYPES
      };
      window.dispatchEvent(new CustomEvent("ml-ready"));
    }

    // 對外：ML 版 analyzeDimension
    window.analyzeDimensionML = async (clueText) => {
      await ensurePrototypesReady();
      const v = await embed(clueText);

      const dimKeys = Object.keys(PROTOTYPES);
      const scores = dimKeys.map(k => dot(v, protoEmb[k])); // cosine similarity（normalize 後）
      const probs = softmax(scores);

      const ranked = dimKeys
        .map((k, i) => ({ key: k, p: probs[i] }))
        .sort((a, b) => b.p - a.p);

      const top1 = ranked[0];
      // 取第二名且確保不重複
      const top2 = ranked.find(x => x.key !== top1.key) || ranked[0];

      return {
        type: top1.key,
        label: DIM_LABEL[top1.key] || top1.key,
        wrong: DIM_LABEL[top2.key] || top2.key,
        confidence: (top1.p).toFixed(2),
        ranked: ranked.slice(0, 3).map(x => ({ key: x.key, label: DIM_LABEL[x.key] || x.key, p: Number(x.p.toFixed(4)) }))
      };
    };
  </script>

  <style>
    :root{
      --bg:#0b1220;
      --panel:#f4ecd8;
      --panel2:#efe3c6;
      --ink:#2b2b2b;
      --muted:#6b6256;
      --accent:#f0c14b;
      --good:#2e7d32;
      --bad:#c62828;
      --shadow: 0 18px 40px rgba(0,0,0,.35);
      --radius:18px;
    }
    *{box-sizing:border-box;font-family: ui-sans-serif, system-ui, -apple-system, "PingFang TC", "Noto Sans TC", "Microsoft JhengHei", sans-serif;}
    body{margin:0;background:var(--bg);color:#fff;overflow:hidden;}
    #app{position:relative;height:100dvh;width:100vw;background:#000;}
    video#camera{
      position:absolute;inset:0;width:100%;height:100%;object-fit:cover;
      filter:saturate(1.05) contrast(1.05);
      background:#000;
    }
    #overlay{position:absolute;inset:0;display:flex;flex-direction:column;justify-content:space-between;padding:14px;pointer-events:none;}
    .topbar{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;}
    .pill{
      pointer-events:auto;
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;border-radius:999px;
      background:rgba(20,20,20,.55);backdrop-filter: blur(8px);
      border:1px solid rgba(255,255,255,.12);
      font-size:14px;
    }
    .pill strong{font-weight:800;}
    .stage{
      pointer-events:none;
      display:flex;align-items:center;justify-content:center;
      min-height:44vh;
    }
    .birdCard{
      pointer-events:none;
      width:min(520px,92vw);
      background:rgba(20,20,20,.28);
      border:1px solid rgba(255,255,255,.14);
      border-radius:26px;
      padding:14px;
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:10px;
    }
    .birdCanvas{width:100%;display:flex;align-items:center;justify-content:center;}
    .birdCanvas svg{width:min(420px,86vw);height:auto;}
    .hintRow{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
    .chip{
      pointer-events:none;
      background:rgba(255,255,255,.14);
      border:1px solid rgba(255,255,255,.14);
      padding:6px 10px;border-radius:999px;
      font-size:12px;
    }

    .bottom{
      pointer-events:auto;
      display:flex;gap:10px;flex-wrap:wrap;justify-content:center;
      padding-bottom: calc(8px + env(safe-area-inset-bottom));
    }
    button{
      border:0;border-radius:16px;
      padding:12px 14px;font-size:15px;
      background:#ffffff; color:#111;
      box-shadow: 0 10px 18px rgba(0,0,0,.25);
      cursor:pointer;
    }
    button.dark{
      background:rgba(255,255,255,.16);color:#fff;border:1px solid rgba(255,255,255,.18);
      backdrop-filter: blur(8px);
    }
    button:disabled{opacity:.45;cursor:not-allowed;}

    .toast{
      pointer-events:none;
      position:absolute;left:50%;transform:translateX(-50%);
      bottom:118px;
      background:rgba(0,0,0,.70);color:#fff;
      padding:10px 14px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      backdrop-filter: blur(8px);
      font-size:14px;
      opacity:0;transition:opacity .2s;
      max-width:min(92vw,640px);
      text-align:center;
      line-height:1.3;
      z-index: 100;
    }
    .toast.show{opacity:1;}

    /* Modal - Default Z-index is 50 */
    .modal{
      position:absolute;inset:0;
      background:rgba(0,0,0,.55);
      display:flex;align-items:center;justify-content:center;
      padding:14px;
      z-index:50;
    }
    
    /* Guide needs to be higher than scan overlay */
    #guideModal { z-index: 60; }

    .hidden{display:none !important;}
    .box{
      width:min(780px,96vw);
      background:var(--panel);
      color:var(--ink);
      border-radius:22px;
      box-shadow: var(--shadow);
      border:1px solid rgba(0,0,0,.08);
      overflow:hidden;
      display:flex; flex-direction:column;
    }
    .boxHeader{
      display:flex;align-items:center;justify-content:space-between;
      padding:14px 14px 10px 14px;
      background:linear-gradient(180deg, var(--panel), var(--panel2));
      border-bottom:1px solid rgba(0,0,0,.08);
    }
    .title{font-size:18px;font-weight:900;}
    .xbtn{
      width:38px;height:38px;border-radius:12px;border:0;
      background:rgba(0,0,0,.08);cursor:pointer;
      font-size:18px;line-height:1;
    }
    .stepDots{
      display:flex;gap:8px;align-items:center;flex-wrap:wrap;
      padding:10px 14px 0 14px;
    }
    .dot{
      width:34px;height:34px;border-radius:999px;
      display:flex;align-items:center;justify-content:center;
      background:rgba(0,0,0,.06);
      border:1px solid rgba(0,0,0,.10);
      font-weight:900;
      user-select:none;
    }
    .dot.active{background:var(--accent);border-color:rgba(0,0,0,.14);}
    .dot.done{background:rgba(46,125,50,.18);border-color:rgba(46,125,50,.25);color:var(--good);}

    .content{padding:12px 14px 14px 14px;display:flex;flex-direction:column;gap:10px;}
    .clueBox{
      background:rgba(255,255,255,.72);
      border:1px solid rgba(0,0,0,.08);
      border-radius:16px;
      padding:12px;
      line-height:1.35;
      white-space:pre-wrap;
    }
    .clueBox small{color:var(--muted);display:block;margin-top:6px;}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;}
    .opt{
      background:#fff;
      border:2px solid rgba(0,0,0,.10);
      border-radius:18px;
      padding:12px;
      cursor:pointer;
      display:flex;gap:10px;align-items:center;
      min-height:88px;
      transition:transform .06s ease, border-color .06s ease;
    }
    .opt:hover{transform:translateY(-1px);}
    .opt svg{width:56px;height:56px;flex:0 0 auto;}
    .opt .lbl{font-weight:900;}
    .opt .desc{font-size:12px;color:var(--muted);margin-top:3px;line-height:1.25;}
    .opt.correct{border-color:rgba(46,125,50,.55);background:rgba(46,125,50,.08);}
    .opt.wrong{border-color:rgba(198,40,40,.55);background:rgba(198,40,40,.08);}

    .footer{
      padding:12px 14px 14px 14px;
      display:flex;gap:10px;justify-content:space-between;align-items:center;
      background:linear-gradient(180deg, var(--panel2), var(--panel));
      border-top:1px solid rgba(0,0,0,.08);
      flex-wrap:wrap;
    }
    .footer .left{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
    .footer .right{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
    .kpi{font-size:13px;color:var(--muted);}

    .btnSmall{padding:10px 12px;border-radius:14px;font-size:14px;}
    .btnPrimary{background:#1b1b1b;color:#fff;}
    .btnGhost{background:#fff;color:#111;border:1px solid rgba(0,0,0,.12);box-shadow:none;}
    .btnWarn{background:#9c1d1d;color:#fff;}

    /* Reveal / Assemble */
    .revealBody{padding:14px;display:flex;flex-direction:column;gap:10px;align-items:center;}
    .revealTag{
      display:inline-flex;align-items:center;gap:8px;
      background:rgba(240,193,75,.25);
      border:1px solid rgba(0,0,0,.10);
      padding:8px 12px;border-radius:999px;
      font-weight:900;
    }
    .summary{
      width:100%;
      background:#fff;border:1px solid rgba(0,0,0,.10);
      border-radius:18px;padding:12px;line-height:1.4;
    }
    .bob{animation:bob 1.8s ease-in-out infinite;transform-origin:center;}
    @keyframes bob{0%,100%{transform:translateY(0px);}50%{transform:translateY(-6px);}}

    /* Scan preview */
    .scanWrap{width:100%;display:flex;flex-direction:column;gap:10px;}
    .scanPreviewBox{
      width:100%;
      border-radius:18px;
      overflow:hidden;
      border:1px solid rgba(0,0,0,.10);
      background:#000;
      position:relative;
      transition: border-color 0.2s;
    }
    .scanPreviewBox.error{
      border:2px solid #c62828; /* Red border on error */
    }
    canvas#scanPreview{width:100%;height:auto;display:block;}
    .scanBadge{
      position:absolute;
      left:12px;top:12px;
      background:rgba(0,0,0,.55);
      color:#fff;
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      border:1px solid rgba(255,255,255,.16);
      backdrop-filter: blur(8px);
    }
    .scanBadge.error{
      background: rgba(198,40,40,.85);
    }

    /* Feed animation */
    #feedAnim{
      position:fixed; inset:0; display:none; align-items:center; justify-content:center;
      z-index:45; background: rgba(0,0,0,.18); backdrop-filter: blur(3px); pointer-events:none;
    }
    #feedAnim.show{ display:flex; }
    #feedAnim .feedCard{
      width: min(360px, calc(100% - 32px));
      background: rgba(255,255,255,.92); border-radius: 22px;
      border: 1px solid rgba(0,0,0,.12); box-shadow: var(--shadow);
      padding: 14px 14px 16px; text-align:center;
    }
    #feedAnim .feedTitle{ font-weight:900; font-size:16px; margin-bottom:10px; }
    #feedAnim .feedSub{ color: rgba(0,0,0,.64); font-size:13px; margin-top:10px; }
    #feedAnim .feedAnim{ position:relative; height:140px; margin: 6px auto 0; width:220px; }
    #feedAnim .bowl{
      position:absolute; left:50%; bottom: 10px; width: 140px; height: 44px;
      transform: translateX(-50%); border-radius: 0 0 50px 50px;
      border: 3px solid rgba(163,58,42,.65); border-top: 0; background: rgba(163,58,42,.08);
    }
    #feedAnim .seed{
      position:absolute; width: 10px; height: 10px; border-radius: 999px;
      background: rgba(163,58,42,.9); top: 0px; left: 50%;
      transform: translateX(-50%); animation: fall 0.8s ease-in infinite;
    }
    #feedAnim .seed.s1{ left: 35%; animation-delay: .00s; }
    #feedAnim .seed.s2{ left: 50%; animation-delay: .12s; }
    #feedAnim .seed.s3{ left: 62%; animation-delay: .22s; }
    #feedAnim .seed.s4{ left: 45%; animation-delay: .32s; }
    @keyframes fall{
      0%{ transform: translate(-50%, 0) scale(.9); opacity: .0; }
      15%{ opacity: .95; }
      70%{ transform: translate(-50%, 106px) scale(1); opacity: .95; }
      100%{ transform: translate(-50%, 106px) scale(.4); opacity: 0; }
    }

    /* AI hint modal typing */
    .aiBox{
      background:#fff; border:1px solid rgba(0,0,0,.10); border-radius:18px;
      padding:12px; line-height:1.45; width:100%; min-height:100px; white-space:pre-wrap;
    }
    /* AI Options Area */
    .aiOptions{ display:grid; grid-template-columns: 1fr; gap:10px; margin-top:12px; }
    .aiOptBtn{
      background:#fff; border:2px solid rgba(0,0,0,.12); border-radius:16px;
      padding:14px; font-weight:900; font-size:15px; color: var(--ink);
      cursor:pointer; text-align:left; transition:transform .1s, background .1s;
      box-shadow: 0 4px 10px rgba(0,0,0,.05);
    }
    .aiOptBtn:active{transform:scale(0.98);}
    .aiOptBtn:hover{background:var(--panel2);}

    /* Guide / Pre-scan Modal Styles */
    .guideBtns{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px; }
    .guideBtn{
      background:#fff; border:2px solid rgba(0,0,0,.10); border-radius:16px;
      padding:16px 12px; font-weight:900; font-size:16px; color: var(--ink);
      cursor:pointer; text-align:center;
    }
    .guideBtn:active{ transform:scale(0.98); }
    .guideBtn.correct{ background:rgba(46,125,50,.1); border-color:var(--good); color:var(--good); }
    .guideBtn.wrong{ opacity:0.5; text-decoration:line-through; }

    /* Confetti Animation */
    #confettiOverlay{
      position:fixed; inset:0; pointer-events:none; z-index:200; overflow:hidden; display:none;
    }
    .confetti{
      position:absolute; width:10px; height:10px; background:#ffd700;
      top:-20px; opacity:0;
    }
    @keyframes drop-confetti{
      0%{ transform:translateY(0) rotate(0deg); opacity:1; }
      100%{ transform:translateY(110vh) rotate(720deg); opacity:0; }
    }
  
    /* [B2] 題目（鳥種）選擇卡片 */
    .birdItem{
      background:#fff;
      border:2px solid rgba(0,0,0,.10);
      border-radius:18px;
      padding:12px;
      cursor:pointer;
      min-height:92px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .birdItem:hover{ border-color: rgba(0,0,0,.22); }
    .birdItem .name{ font-weight:900; font-size:16px; }
    .birdItem .sum{ font-size:12px; color:var(--muted); line-height:1.35; }
    .birdItem .tag{ display:inline-flex; width:max-content; padding:3px 8px; border-radius:999px; background:rgba(240,193,75,.18); border:1px solid rgba(240,193,75,.55); font-size:12px; font-weight:800; }

  </style>
</head>

<body>
<div id="app">
  <video id="camera" autoplay playsinline muted></video>

  <div id="confettiOverlay"></div>

  <div id="overlay">
    <div class="topbar">
      <div class="pill"><strong id="birdName">鳥</strong> <span id="birdSub" style="opacity:.85"></span></div>
      <div class="pill">
        線索 <strong id="clueCount">0</strong>/5
        <span style="opacity:.6">|</span>
        待掃 <strong id="pendingText">—</strong>
        <span style="opacity:.6">|</span>
        AI 提示 <strong id="hintLeft">∞</strong> <span id="mlStatus" style="opacity:.7">（規則）</span>
      </div>
    </div>

    <div class="stage">
      <div class="birdCard">
        <div class="birdCanvas" id="birdCanvas"></div>
        <div class="hintRow" id="clueChips"></div>
        <div style="font-size:12px;opacity:.92;text-align:center;line-height:1.35">
          流程：<strong>餵鳥</strong> → 系統指定部位 → <strong>AI 引導提問</strong> → 掃描線索卡 → 集滿 5 張線索 → <strong>開始辨認</strong><br/>
          答對一題：會先看到<strong>拼裝結果</strong>，再按「下一步」進入下一題。
        </div>
      </div>

      <div class="toast" id="toast"></div>

      <div id="feedAnim" aria-hidden="true">
        <div class="feedCard">
          <div class="feedTitle">餵食中…</div>
          <div class="feedAnim" aria-hidden="true">
            <div class="seed s1"></div>
            <div class="seed s2"></div>
            <div class="seed s3"></div>
            <div class="seed s4"></div>
            <div class="bowl"></div>
          </div>
          <div class="feedSub" id="feedSubText">掉落一張線索卡</div>
          <div class="feedSub" id="feedAnimPart" style="margin-top:6px;">線索：—</div>
        </div>
      </div>
    </div>

    <div class="bottom">
      <button class="dark" id="btnCamera">啟動相機</button>
      <button id="btnFeed">餵鳥（掉落線索）</button>
      <button class="dark" id="btnScan" disabled>掃描線索卡</button>
      <button class="btnPrimary" id="btnQuiz" disabled>開始辨認（1/5）</button>
      <button class="dark" id="btnChooseBird">選題目</button>
      <button class="dark" id="btnExport">匯出紀錄</button>
      <button class="dark" id="btnReset">重置本鳥</button>
    </div>
  </div>

  
  <!-- [B2] 題目（鳥種）選擇 -->
  <div class="modal hidden" id="birdModal">
    <div class="box">
      <div style="padding:14px; font-weight:900; border-bottom:1px solid #ddd;">選擇題目（鳥種）</div>
      <div style="padding:14px;">
        <div style="margin-bottom:10px; color:var(--muted); font-size:13px; line-height:1.4">
          你可以切換不同鳥種作為不同題目。切換後將重置該鳥種進度（不影響其他鳥種紀錄）。
        </div>
        <div class="grid" id="birdGrid"></div>
        <div style="padding-top:10px; text-align:right;">
          <button class="dark" id="closeBird">關閉</button>
        </div>
      </div>
    </div>
  </div>


  <div class="modal hidden" id="guideModal">
    <div class="box" style="max-width:600px;">
      <div class="boxHeader">
        <div class="title" id="guideTitle">AI 觀察引導</div>
        <button class="xbtn" id="closeGuide">×</button>
      </div>
      <div class="content">
        <div class="aiBox" id="guideAiText" style="min-height:80px;">AI 正在分析線索重點...</div>
        <div id="guideActions">
          <div style="text-align:center;font-size:14px;color:var(--muted);margin-bottom:6px;">你覺得哪個觀察維度更關鍵？</div>
          <div class="guideBtns" id="guideBtns"></div>
        </div>
        <div id="guideResult" class="hidden" style="display:flex;flex-direction:column;gap:10px;align-items:center;">
          <div class="clueBox" id="guideRealClue" style="width:100%;text-align:center;font-weight:bold;"></div>
          <button class="btnPrimary" id="btnStartScanFromGuide" style="width:100%;">開啟相機掃描</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal hidden" id="quizModal">
    <div class="box">
      <div class="boxHeader">
        <div class="title" id="quizTitle">辨認鳥類</div>
        <button class="xbtn" id="closeQuiz">×</button>
      </div>
      <div class="stepDots" id="stepDots"></div>
      <div class="content">
        <div class="clueBox" id="clueBox"></div>
        <div class="grid" id="optionsGrid"></div>
      </div>
      <div class="footer">
        <div class="left">
          <div class="kpi" id="kpiText">不知道選哪個？問問 AI 助教</div>
          <button class="btnSmall btnGhost" id="btnHintQuiz">AI 提示</button>
        </div>
        <div class="right">
          <button class="btnSmall btnGhost" id="btnCloseQuiz2">關閉</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal hidden" id="aiModal">
    <div class="box" style="max-width:720px;">
      <div class="boxHeader">
        <div class="title">AI 助教 - 觀點交流</div>
        <button class="xbtn" id="closeAi">×</button>
      </div>
      <div class="content">
        <div class="aiBox" id="aiText"></div>
        <div class="aiOptions" id="aiOptions" style="display:none"></div>
        <div style="display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap;margin-top:10px;">
          <button class="btnSmall btnGhost" id="aiOk">關閉</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal hidden" id="assembleModal">
    <div class="box">
      <div class="boxHeader">
        <div class="title" id="assembleTitle">已拼上部位</div>
        <button class="xbtn" id="closeAssemble">×</button>
      </div>
      <div class="revealBody">
        <div class="revealTag" id="assembleTag">—</div>
        <div id="assembleBird"></div>
        <div class="summary" id="assembleSummary"></div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:center">
          <button class="btnPrimary" id="btnAssembleNext">下一步</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal hidden" id="revealModal">
    <div class="box">
      <div class="boxHeader">
        <div class="title">完成！</div>
        <button class="xbtn" id="closeReveal">×</button>
      </div>
      <div class="revealBody">
        <div class="revealTag" id="revealName">鳥名</div>
        <div id="revealBird"></div>
        <div class="summary" id="revealSummary"></div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:center">
          <button class="btnPrimary" id="btnReplay">再玩一次</button>
          <button class="btnGhost" id="btnCopyLink">複製此鳥連結</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal hidden" id="startOverlay">
    <div class="box" style="max-width:560px;">
      <div class="boxHeader">
        <div class="title">需要啟用相機</div>
        <button class="xbtn" id="closeStartOverlay">×</button>
      </div>
      <div class="content">
        <div style="font-weight:900;font-size:16px">iPhone/Safari 規則：相機必須由點擊觸發</div>
        <div style="color:var(--muted);line-height:1.45">
          請點下方按鈕啟動一次相機。之後你就不需要再按「啟動相機」了。
        </div>
        <button class="btnSmall btnPrimary" id="btnStartCameraNow">點一下開啟相機</button>
      </div>
    </div>
  </div>

  <div class="modal hidden" id="scanOverlay">
    <div class="box" style="max-width:720px;">
      <div class="boxHeader">
        <div class="title">掃描線索卡</div>
        <button class="xbtn" id="btnStopScan">×</button>
      </div>
      <div class="content">
        <div class="scanWrap">
          <div class="scanPreviewBox" id="scanPreviewBox">
            <div class="scanBadge" id="scanBadge">掃描中…</div>
            <canvas id="scanPreview" width="960" height="540"></canvas>
          </div>
          <div class="clueBox" id="scanHintText"></div>
          <div style="font-size:13px;color:var(--muted);line-height:1.45">
            目前需要掃描：<strong id="scanNeedText">—</strong><br/>
            建議：QR 佔畫面 1/4 以上、保持穩定 1 秒、避免反光。
          </div>
          <div style="display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap">
            <button class="btnSmall btnGhost" id="btnStopScan2">取消掃描</button>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>

<script>
const qs = new URLSearchParams(location.search);
const CLAIM = qs.get("claim");
const START = qs.get("start") === "1";
const BIRD_PARAM = qs.get("bird") || localStorage.getItem("bbdemo:lastBird") || "sparrow";
localStorage.setItem("bbdemo:lastBird", BIRD_PARAM);

const MYSTERY_NAME = "神秘鳥";
const STORAGE_KEY = (birdKey)=>`bbdemo:state:${birdKey}`;
const deepClone = (o)=>JSON.parse(JSON.stringify(o));

const STEPS = [
  { key:"legs", label:"腳" },
  { key:"body", label:"身體" },
  { key:"wing", label:"翅膀" },
  { key:"tail", label:"尾巴" },
  { key:"head", label:"頭/記號" },
];

function svgWrap(inner){ return `<svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">${inner}</svg>`; }

const OPTION_LIB = {
  legs: {
    pink:  { label:"粉紅腳", desc:"偏粉紅、短腿", svg: svgWrap(`<path d="M24 12c3 8 1 14-4 20" stroke="#e17b86" stroke-width="4" fill="none" stroke-linecap="round"/><path d="M40 12c-3 8-1 14 4 20" stroke="#e17b86" stroke-width="4" fill="none" stroke-linecap="round"/><path d="M18 34h10" stroke="#e17b86" stroke-width="4" stroke-linecap="round"/><path d="M36 34h10" stroke="#e17b86" stroke-width="4" stroke-linecap="round"/>`) },
    black: { label:"黑色腳", desc:"偏黑、抓枝穩", svg: svgWrap(`<path d="M24 12c3 10 1 16-4 24" stroke="#1d2330" stroke-width="4" fill="none" stroke-linecap="round"/><path d="M40 12c-3 10-1 16 4 24" stroke="#1d2330" stroke-width="4" fill="none" stroke-linecap="round"/><path d="M16 40h14" stroke="#1d2330" stroke-width="4" stroke-linecap="round"/><path d="M34 40h14" stroke="#1d2330" stroke-width="4" stroke-linecap="round"/>`) },
    brown: { label:"褐色腳", desc:"偏褐、短而細", svg: svgWrap(`<path d="M24 12c3 9 1 15-4 22" stroke="#6b4a2f" stroke-width="4" fill="none" stroke-linecap="round"/><path d="M40 12c-3 9-1 15 4 22" stroke="#6b4a2f" stroke-width="4" fill="none" stroke-linecap="round"/><path d="M16 38h14" stroke="#6b4a2f" stroke-width="4" stroke-linecap="round"/><path d="M34 38h14" stroke="#6b4a2f" stroke-width="4" stroke-linecap="round"/>`) },
    long:  { label:"長腿", desc:"腿明顯較長", svg: svgWrap(`<path d="M24 8c2 14 0 22-4 34" stroke="#303a4a" stroke-width="4" fill="none" stroke-linecap="round"/><path d="M40 8c-2 14 0 22 4 34" stroke="#303a4a" stroke-width="4" fill="none" stroke-linecap="round"/><path d="M14 44h18" stroke="#303a4a" stroke-width="4" stroke-linecap="round"/><path d="M32 44h18" stroke="#303a4a" stroke-width="4" stroke-linecap="round"/>`) },
  },
  body: {
    sparrow: { label:"褐色帶紋", desc:"背部有深色條紋感", svg: svgWrap(`<ellipse cx="32" cy="34" rx="20" ry="14" fill="#b07a45"/><path d="M18 28c6 2 12 2 20 0" stroke="#6a4529" stroke-width="3" opacity=".8"/><path d="M18 34c6 2 12 2 20 0" stroke="#6a4529" stroke-width="3" opacity=".8"/><path d="M18 40c6 2 12 2 20 0" stroke="#6a4529" stroke-width="3" opacity=".8"/>`) },
    bulbul:  { label:"灰褐身體", desc:"灰褐、腹部較淡", svg: svgWrap(`<ellipse cx="32" cy="34" rx="20" ry="14" fill="#9d8f86"/><ellipse cx="34" cy="38" rx="16" ry="10" fill="#c6bbb4" opacity=".9"/>`) },
    dove:    { label:"土褐偏粉", desc:"樸素溫和的土褐色", svg: svgWrap(`<ellipse cx="32" cy="34" rx="20" ry="14" fill="#c08e78"/><ellipse cx="35" cy="38" rx="15" ry="9" fill="#d8b1a1" opacity=".85"/>`) },
    drongo:  { label:"亮黑身體", desc:"偏黑、略有金屬感", svg: svgWrap(`<ellipse cx="32" cy="34" rx="20" ry="14" fill="#1b1f27"/><path d="M18 30c6-4 24-4 30 0" stroke="#4a5a78" stroke-width="3" opacity=".35"/>`) },
    whiteeye:{ label:"綠黃身體", desc:"綠黃、腹部較淡", svg: svgWrap(`<ellipse cx="32" cy="34" rx="20" ry="14" fill="#8dbb3e"/><ellipse cx="34" cy="38" rx="16" ry="10" fill="#d8e58b" opacity=".9"/>`) },
  },
  wing: {
    roundBar:{ label:"圓翼＋淡翼帶", desc:"短圓、常見淡色翼帶", svg: svgWrap(`<path d="M14 44c10-22 28-28 36-10-4 14-18 24-36 10z" fill="#6a4a2f" opacity=".85"/><path d="M18 38c10-8 18-9 26-2" stroke="#f3e7c8" stroke-width="4" stroke-linecap="round" opacity=".9"/>`) },
    shortRound:{ label:"短圓翼", desc:"整體圓鈍、不尖", svg: svgWrap(`<path d="M14 44c10-22 28-28 36-10-4 14-18 24-36 10z" fill="#a87956"/><path d="M18 38c10-8 18-9 26-2" stroke="#7b5a45" stroke-width="3" stroke-linecap="round" opacity=".7"/>`) },
    longPoint:{ label:"長尖翼", desc:"較長、翼端尖", svg: svgWrap(`<path d="M12 46c18-30 34-30 40-14-8 18-24 26-40 14z" fill="#1b1f27"/><path d="M18 40c12-10 22-10 30-2" stroke="#4a5a78" stroke-width="3" stroke-linecap="round" opacity=".45"/>`) },
    greenSmall:{ label:"小巧綠翼", desc:"偏小、與身體同色系", svg: svgWrap(`<path d="M16 46c10-18 26-22 34-8-6 12-18 18-34 8z" fill="#7aa62f"/><path d="M20 40c8-6 14-6 20-1" stroke="#d8e58b" stroke-width="3" stroke-linecap="round" opacity=".8"/>`) },
  },
  tail: {
    shortRound:{ label:"短圓尾", desc:"尾短、末端圓", svg: svgWrap(`<path d="M18 40c8-8 20-8 28 0-10 12-18 12-28 0z" fill="#8dbb3e"/>`) },
    square:   { label:"中長方尾", desc:"末端偏平", svg: svgWrap(`<path d="M18 42h28v10c-10 4-18 4-28 0z" fill="#9d8f86"/>`) },
    longRound:{ label:"長圓尾", desc:"尾較長、末端圓", svg: svgWrap(`<path d="M20 34c8-10 16-10 24 0v22c-10 6-14 6-24 0z" fill="#c08e78"/>`) },
    fork:     { label:"深叉尾", desc:"像剪刀，尾端分叉", svg: svgWrap(`<path d="M32 22c-6 10-10 22-10 34 6-6 10-10 10-10s4 4 10 10c0-12-4-24-10-34z" fill="#1b1f27"/><path d="M32 46l-10 10" stroke="#4a5a78" stroke-width="3" opacity=".35"/><path d="M32 46l10 10" stroke="#4a5a78" stroke-width="3" opacity=".35"/>`) },
  },
  head: {
    plainBrown:{ label:"素色棕頭", desc:"沒有白眼圈/白頭/項鍊斑", svg: svgWrap(`<circle cx="28" cy="30" r="10" fill="#b07a45"/><path d="M36 30l14-6-14 0z" fill="#c89c4a"/>`) },
    whiteHead:{ label:"白頭黑臉", desc:"頭頂偏白、臉側較深", svg: svgWrap(`<circle cx="28" cy="30" r="10" fill="#e9e3d8"/><path d="M22 26c6 0 12 8 12 12-10 2-14-2-18-8z" fill="#2a2f3a" opacity=".85"/><path d="M36 30l14-6-14 0z" fill="#c89c4a"/>`) },
    spottedNeck:{ label:"珠頸斑點", desc:"頸側黑白斑像項鍊", svg: svgWrap(`<circle cx="28" cy="28" r="10" fill="#c08e78"/><path d="M24 38c6-2 12-2 18 2" stroke="#1b1f27" stroke-width="3" stroke-dasharray="2 4" opacity=".85"/><path d="M36 28l14-6-14 0z" fill="#c89c4a"/>`) },
    blackHead:{ label:"全黑頭", desc:"頭部也偏黑", svg: svgWrap(`<circle cx="28" cy="30" r="10" fill="#1b1f27"/><path d="M36 30l14-6-14 0z" fill="#303a4a"/>`) },
    whiteEyeRing:{ label:"白色眼圈", desc:"眼周有明顯白圈", svg: svgWrap(`<circle cx="28" cy="30" r="10" fill="#8dbb3e"/><circle cx="28" cy="30" r="5.5" fill="none" stroke="#ffffff" stroke-width="3"/><path d="M36 30l14-6-14 0z" fill="#1b1f27"/>`) },
  }
};

const BIRDS = {
  sparrow: {
    name:"麻雀", sub:"demo",
    summary:"麻雀常見於人類居住環境，身體褐色帶紋，翅短圓，整體小巧。觀察重點：背部條紋、翼帶、尾端形狀。",
    palette:{ body:"#b07a45", belly:"#e6d3b2", wing:"#6a4529", tail:"#7a5637", head:"#b07a45", legs:"#6b4a2f", beak:"#c89c4a" },
    cluePool:{
      legs:["腳短短、偏褐色，走跳很靈活。","腳不粉紅也不特別長，偏褐色。"],
      body:["身體褐色，背上有深色條紋感。","整體是樸素的褐色調，斑紋明顯。"],
      wing:["翅膀短圓，常見淡色翼帶。","翼型不尖，帶一條淡色線。"],
      tail:["尾巴中等長度，末端偏平。","尾端不深叉，較像方尾。"],
      head:["頭部素色棕，沒有白眼圈或白頭。","頭頸沒有項鍊斑點，整體很樸素。"],
    },
    quiz:{
      legs:{ prompt:"步驟 1（腳）：選最符合敘述的腳型。", options:["pink","brown","black","long"], correct:"brown" },
      body:{ prompt:"步驟 2（身體）：選最符合敘述的身體。", options:["sparrow","dove","bulbul","whiteeye"], correct:"sparrow" },
      wing:{ prompt:"步驟 3（翅膀）：選最符合敘述的翅膀。", options:["roundBar","shortRound","greenSmall","longPoint"], correct:"roundBar" },
      tail:{ prompt:"步驟 4（尾巴）：選最符合敘述的尾巴。", options:["square","shortRound","fork","longRound"], correct:"square" },
      head:{ prompt:"步驟 5（頭/記號）：選最符合敘述的頭部/記號。", options:["plainBrown","whiteEyeRing","whiteHead","spottedNeck"], correct:"plainBrown" },
    },
    ai:{
      legs:["先看顏色：偏褐不是粉紅。","再看比例：腿不長，線條短而細。"],
      body:["先抓『褐色』主色，再找『深色條紋感』。","如果看起來偏綠或偏灰，就先排除。"],
      wing:["先看翼型：短圓不是尖長。","再找『淡色翼帶』那條線。"],
      tail:["先排除深叉尾（像剪刀）。","末端偏平、較像方尾。"],
      head:["先排除白眼圈、白頭、項鍊斑。","選最『樸素的棕頭』。"],
    }
  },
  bulbul: {
    name:"白頭翁", sub:"demo",
    summary:"白頭翁頭頂偏白、臉側較深，身體灰褐、腹部較淡。觀察重點：白頭與臉部對比、尾形中長。",
    palette:{ body:"#9d8f86", belly:"#c6bbb4", wing:"#6b6256", tail:"#6b6256", head:"#e9e3d8", legs:"#1d2330", beak:"#c89c4a" },
    cluePool:{
      legs:["腳偏黑，抓枝很穩。","腳色較深，並不粉紅。"],
      body:["身體灰褐，腹部較淡。","整體灰褐，不是綠黃或亮黑。"],
      wing:["翅膀深色、邊緣帶淡色。","翼面偏深，線條俐落。"],
      tail:["尾巴中長，末端偏方。","尾不深叉，長度中等。"],
      head:["頭頂偏白，臉側較深。","白頭是最醒目的線索。"],
    },
    quiz:{
      legs:{ prompt:"步驟 1（腳）：選最符合敘述的腳型。", options:["black","brown","pink","long"], correct:"black" },
      body:{ prompt:"步驟 2（身體）：選最符合敘述的身體。", options:["bulbul","sparrow","whiteeye","drongo"], correct:"bulbul" },
      wing:{ prompt:"步驟 3（翅膀）：選最符合敘述的翅膀。", options:["roundBar","shortRound","longPoint","greenSmall"], correct:"roundBar" },
      tail:{ prompt:"步驟 4（尾巴）：選最符合敘述的尾巴。", options:["square","fork","longRound","shortRound"], correct:"square" },
      head:{ prompt:"步驟 5（頭/記號）：選最符合敘述的頭部/記號。", options:["whiteHead","plainBrown","whiteEyeRing","blackHead"], correct:"whiteHead" },
    },
    ai:{
      legs:["先排除粉紅腳。","深色腳通常偏黑。"],
      body:["抓『灰褐』主色＋『腹部較淡』。","全黑與綠黃先排除。"],
      wing:["翼面偏深、帶淡色邊緣。","不是尖長翼型。"],
      tail:["深叉尾先排除。","末端偏平，像方尾。"],
      head:["找『白頭』＋臉側較深。","白眼圈不是白頭。"],
    }
  },
  dove: {
    name:"珠頸斑鳩", sub:"demo",
    summary:"珠頸斑鳩身體土褐偏粉，腳偏粉紅，頸側有黑白斑點像項鍊。觀察重點：珠頸斑點與長圓尾。",
    palette:{ body:"#c08e78", belly:"#d8b1a1", wing:"#a87956", tail:"#c08e78", head:"#c08e78", legs:"#e17b86", beak:"#c89c4a" },
    cluePool:{
      legs:["腳偏粉紅，不長。","粉紅腳是很明顯的線索。"],
      body:["身體土褐偏粉，整體樸素。","顏色溫和，不是灰褐也不是亮黑。"],
      wing:["翅膀同色系，沒有鮮豔色塊。","翼型偏圓，不尖。"],
      tail:["尾巴較長，末端圓。","尾不深叉，線條柔和。"],
      head:["頸側有黑白斑點像項鍊。","珠頸斑點是辨識重點。"],
    },
    quiz:{
      legs:{ prompt:"步驟 1（腳）：選最符合敘述的腳型。", options:["pink","brown","black","long"], correct:"pink" },
      body:{ prompt:"步驟 2（身體）：選最符合敘述的身體。", options:["dove","sparrow","bulbul","whiteeye"], correct:"dove" },
      wing:{ prompt:"步驟 3（翅膀）：選最符合敘述的翅膀。", options:["shortRound","roundBar","longPoint","greenSmall"], correct:"shortRound" },
      tail:{ prompt:"步驟 4（尾巴）：選最符合敘述的尾巴。", options:["longRound","square","fork","shortRound"], correct:"longRound" },
      head:{ prompt:"步驟 5（頭/記號）：選最符合敘述的頭部/記號。", options:["spottedNeck","plainBrown","whiteHead","whiteEyeRing"], correct:"spottedNeck" },
    },
    ai:{
      legs:["粉紅腳很關鍵，先看顏色。","如果像黑色或褐色，就排除。"],
      body:["土褐偏粉，色調溫和。","不是灰褐也不是綠黃。"],
      wing:["翼型偏圓，不尖長。","同色系、不鮮豔。"],
      tail:["尾較長、末端圓。","深叉尾先排除。"],
      head:["找『頸側黑白斑點』像項鍊。","白頭/白眼圈都不是。"],
    }
  },
  drongo: {
    name:"大卷尾", sub:"demo",
    summary:"大卷尾全身偏黑帶金屬光澤，尾巴深叉像剪刀。觀察重點：深叉尾與長尖翼。",
    palette:{ body:"#1b1f27", belly:"#2a3342", wing:"#1b1f27", tail:"#1b1f27", head:"#1b1f27", legs:"#1d2330", beak:"#303a4a" },
    cluePool:{
      legs:["腳黑色，站立很靈活。","深色腳、抓枝穩。"],
      body:["全身偏黑，帶一點金屬光澤。","身體顏色很深，幾乎全黑。"],
      wing:["翅膀長而尖，飛起來很俐落。","翼型偏尖長。"],
      tail:["尾巴深叉，像剪刀。","深叉尾是最關鍵的辨識線索。"],
      head:["頭部也偏黑，沒有白斑。","整體沒有白眼圈或白頭。"],
    },
    quiz:{
      legs:{ prompt:"步驟 1（腳）：選最符合敘述的腳型。", options:["black","brown","pink","long"], correct:"black" },
      body:{ prompt:"步驟 2（身體）：選最符合敘述的身體。", options:["drongo","bulbul","sparrow","whiteeye"], correct:"drongo" },
      wing:{ prompt:"步驟 3（翅膀）：選最符合敘述的翅膀。", options:["longPoint","roundBar","shortRound","greenSmall"], correct:"longPoint" },
      tail:{ prompt:"步驟 4（尾巴）：選最符合敘述的尾巴。", options:["fork","square","longRound","shortRound"], correct:"fork" },
      head:{ prompt:"步驟 5（頭/記號）：選最符合敘述的頭部/記號。", options:["blackHead","plainBrown","whiteHead","whiteEyeRing"], correct:"blackHead" },
    },
    ai:{
      legs:["粉紅腳先排除。","深色腳通常選黑。"],
      body:["先抓『全黑』，不要被背景影響。","灰褐/綠黃先排除。"],
      wing:["尖長翼 vs 圓翼要分清楚。","翼端明顯較尖。"],
      tail:["先找深叉尾（剪刀尾）。","只要不是深叉，幾乎都錯。"],
      head:["白頭/白眼圈都不是。","選最乾淨的黑頭。"],
    }
  },
  whiteeye: {
    name:"綠繡眼", sub:"demo",
    summary:"綠繡眼體色綠黃，最醒目是眼周白色眼圈。觀察重點：白眼圈與綠黃身體、尾短。",
    palette:{ body:"#8dbb3e", belly:"#d8e58b", wing:"#7aa62f", tail:"#7aa62f", head:"#8dbb3e", legs:"#1d2330", beak:"#1b1f27" },
    cluePool:{
      legs:["腳細小偏黑。","深色細腳，不是粉紅。"],
      body:["身體綠黃，腹部偏淡。","整體偏綠，不是褐或灰。"],
      wing:["翅膀小巧、與身體同色系。","翼不尖長，色偏綠。"],
      tail:["尾巴短。","尾端不長，也不深叉。"],
      head:["眼睛周圍有明顯白色眼圈。","白眼圈是最關鍵的線索。"],
    },
    quiz:{
      legs:{ prompt:"步驟 1（腳）：選最符合敘述的腳型。", options:["black","brown","pink","long"], correct:"black" },
      body:{ prompt:"步驟 2（身體）：選最符合敘述的身體。", options:["whiteeye","bulbul","sparrow","drongo"], correct:"whiteeye" },
      wing:{ prompt:"步驟 3（翅膀）：選最符合敘述的翅膀。", options:["greenSmall","roundBar","shortRound","longPoint"], correct:"greenSmall" },
      tail:{ prompt:"步驟 4（尾巴）：選最符合敘述的尾巴。", options:["shortRound","square","fork","longRound"], correct:"shortRound" },
      head:{ prompt:"步驟 5（頭/記號）：選最符合敘述的頭部/記號。", options:["whiteEyeRing","plainBrown","whiteHead","blackHead"], correct:"whiteEyeRing" },
    },
    ai:{
      legs:["粉紅腳先排除。","深色細腳通常偏黑。"],
      body:["綠黃是最大特徵。","灰褐與全黑都不是。"],
      wing:["挑最小巧、偏綠的翅膀。","不要選尖長翼。"],
      tail:["尾短，深叉尾先排除。","方尾比短圓尾更直。"],
      head:["看到白眼圈就選它。","白頭不是白眼圈。"],
    }
  }
};


// [B2] 確保每題選項不重複、且包含正確答案（避免資料維護時誤複製造成重複）
function uniq(arr){ return [...new Set(arr || [])]; }

function normalizeAllQuizOptions(){
  const birdKeys = Object.keys(BIRDS);
  birdKeys.forEach(bk=>{
    const b = BIRDS[bk];
    if(!b || !b.quiz) return;

    Object.keys(b.quiz).forEach(part=>{
      const q = b.quiz[part];
      if(!q) return;

      let opts = uniq(q.options);
      if(q.correct && !opts.includes(q.correct)) opts.unshift(q.correct);
      opts = uniq(opts);

      const lib = OPTION_LIB[part] ? Object.keys(OPTION_LIB[part]) : [];
      for(const k of lib){
        if(opts.length >= 4) break;
        if(!opts.includes(k)) opts.push(k);
      }

      // 若仍不足 4（理論上不會），就保留現有
      q.options = opts.slice(0, 4);

      // 最後保險：確保 correct 在內
      if(q.correct && !q.options.includes(q.correct)){
        q.options[0] = q.correct;
      }
    });
  });
}
normalizeAllQuizOptions();

function getBirdByKey(key){ return BIRDS[key] || BIRDS.sparrow; }
const birdKey = BIRD_PARAM;
const bird = getBirdByKey(birdKey);

const DEFAULT_STATE = {
  clues: {},
  solved: {},
  currentStep: 0,
  assembledCount: 0,
  hintLeft: 2,
  usedHints: {},
  pendingPart: null,
  cameraOn: false,
};

let state = deepClone(DEFAULT_STATE);

// [B2] 學習歷程紀錄（本地匯出）
const sessionLog = [];
const sessionId = (crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Date.now()) + "-" + Math.random().toString(16).slice(2);

function logEvent(type, payload = {}) {
  const entry = {
    ts: new Date().toISOString(),
    sessionId,
    type,
    payload,
    stateSnap: {
      birdKey,
      pendingPart: state?.pendingPart || null,
      clues: Object.keys(state?.clues || {}),
      solved: Object.keys(state?.solved || {}),
      hintLeft: state?.hintLeft ?? null,
      cameraOn: !!state?.cameraOn
    },
    ml: window.__ML_MODEL_INFO__ ? { ...window.__ML_MODEL_INFO__ } : { model: "rule-based-fallback" }
  };
  sessionLog.push(entry);
}

function exportLog() {
  const data = {
    exportedAt: new Date().toISOString(),
    sessionId,
    app: document.title,
    log: sessionLog
  };
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `birdbuilder_log_${sessionId}.json`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(() => URL.revokeObjectURL(url), 1000);
  showToast("已匯出 JSON 紀錄");
}


function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY(birdKey));
    if(!raw) return;
    const parsed = JSON.parse(raw);
    state = { ...deepClone(DEFAULT_STATE), ...parsed };
  }catch(e){}
}
function saveState(){
  try{ localStorage.setItem(STORAGE_KEY(birdKey), JSON.stringify(state)); }catch(e){}
}
function resetState(){
  state = deepClone(DEFAULT_STATE);
  saveState();
}

const $ = (id)=>document.getElementById(id);

const elBirdName = $("birdName");
const elBirdSub = $("birdSub");
const elClueCount = $("clueCount");
const elPendingText = $("pendingText");
const elHintLeft = $("hintLeft");
const elBirdCanvas = $("birdCanvas");
const elClueChips = $("clueChips");
const toast = $("toast");
const feedAnim = $("feedAnim");

const btnCamera = $("btnCamera");
const btnFeed = $("btnFeed");
const btnScan = $("btnScan");
const btnQuiz = $("btnQuiz");
const btnChooseBird = $("btnChooseBird");
const btnExport = $("btnExport");
const btnReset = $("btnReset");

const quizModal = $("quizModal");
const stepDots = $("stepDots");
const clueBox = $("clueBox");
const optionsGrid = $("optionsGrid");
const closeQuiz = $("closeQuiz");
const btnCloseQuiz2 = $("btnCloseQuiz2");
const quizTitle = $("quizTitle");
const btnHintQuiz = $("btnHintQuiz");

const aiModal = $("aiModal");
const aiText = $("aiText");
const closeAi = $("closeAi");
const aiOk = $("aiOk");
const aiOptions = $("aiOptions");

const guideModal = $("guideModal");
const birdModal = $("birdModal");
const birdGrid = $("birdGrid");
const closeBird = $("closeBird");
const guideTitle = $("guideTitle");
const guideAiText = $("guideAiText");
const guideBtns = $("guideBtns");
const guideResult = $("guideResult");
const guideRealClue = $("guideRealClue");
const btnStartScanFromGuide = $("btnStartScanFromGuide");
const closeGuide = $("closeGuide");
const guideActions = $("guideActions"); 

const assembleModal = $("assembleModal");
const assembleTitle = $("assembleTitle");
const assembleTag = $("assembleTag");
const assembleBird = $("assembleBird");
const assembleSummary = $("assembleSummary");
const closeAssemble = $("closeAssemble");
const btnAssembleNext = $("btnAssembleNext");

const revealModal = $("revealModal");
const revealName = $("revealName");
const revealBird = $("revealBird");
const revealSummary = $("revealSummary");
const closeReveal = $("closeReveal");
const btnReplay = $("btnReplay");
const btnCopyLink = $("btnCopyLink");

const startOverlay = $("startOverlay");
const btnStartCameraNow = $("btnStartCameraNow");
const closeStartOverlay = $("closeStartOverlay");

const scanOverlay = $("scanOverlay");
const scanPreviewBox = $("scanPreviewBox");
const scanHintText = $("scanHintText");
const scanNeedText = $("scanNeedText");
const scanBadge = $("scanBadge");
const btnStopScan = $("btnStopScan");
const btnStopScan2 = $("btnStopScan2");
const scanPreview = $("scanPreview");
const scanPctx = scanPreview.getContext("2d", { willReadFrequently:true });

let toastTimer = 0;
// [B2] 題目（鳥種）選擇
function switchBird(newKey){
  try{ localStorage.setItem("bbdemo:lastBird", newKey); }catch(e){}
  if(typeof logEvent === "function") logEvent("switch_bird", { from: birdKey, to: newKey });
  const url = new URL(location.href);
  url.searchParams.set("bird", newKey);
  url.searchParams.set("start", "1"); // 觸發重置流程
  location.href = url.toString();
}

function buildBirdPicker(){
  if(!birdGrid) return;
  birdGrid.innerHTML = "";
  const keys = Object.keys(BIRDS);

  if(keys.length < 4){
    const warn = document.createElement("div");
    warn.style.gridColumn = "1 / -1";
    warn.style.color = "var(--muted)";
    warn.textContent = "目前鳥種少於 4 種，建議至少準備四題以利研究設計。";
    birdGrid.appendChild(warn);
  }

  keys.forEach(k=>{
    const b = BIRDS[k];
    const item = document.createElement("div");
    item.className = "birdItem";
    item.innerHTML = `
      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
        <div class="name">${b.name}</div>
        ${k === birdKey ? '<div class="tag">目前題目</div>' : ''}
      </div>
      <div class="sum">${b.summary || ""}</div>
    `;
    item.addEventListener("click", ()=> switchBird(k));
    birdGrid.appendChild(item);
  });
}

function openBirdPicker(){
  buildBirdPicker();
  birdModal.classList.remove("hidden");
}

function closeBirdPicker(){
  birdModal.classList.add("hidden");
}

function showToast(msg, ms=2600){
  toast.textContent = msg;
  toast.classList.add("show");
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=>toast.classList.remove("show"), ms);
}

async function startCamera(silent=false){
  try{
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { ideal:"environment" } },
      audio:false
    });
    $("camera").srcObject = stream;
    state.cameraOn = true;
    saveState();
    if(!silent) showToast("相機已啟動");
    btnCamera.textContent = "相機已啟動";
    btnCamera.disabled = true;
    return true;
  }catch(e){
    if(!silent) showToast("相機需要點擊授權：請點一下『點一下開啟相機』");
    return false;
  }
}

function renderChips(){
  elClueChips.innerHTML = "";
  STEPS.forEach(s=>{
    const has = !!state.clues[s.key];
    const pending = (state.pendingPart === s.key);
    const chip = document.createElement("div");
    chip.className = "chip";
    chip.textContent = has ? `✅ ${s.label}` : (pending ? `🔶 ${s.label}（待掃）` : `⬚ ${s.label}`);
    elClueChips.appendChild(chip);
  });
}

function renderCounters(){
  const count = Object.keys(state.clues).length;
  elClueCount.textContent = String(count);
  elHintLeft.textContent = "∞"; 
  elPendingText.textContent = state.pendingPart ? STEPS.find(s=>s.key===state.pendingPart).label : "—";

  btnQuiz.disabled = (count < 5) || !!state.pendingPart;
  btnScan.disabled = !state.pendingPart; 

  const nextIdx = Math.max(0, STEPS.findIndex(s=>!state.solved[s.key]));
  btnQuiz.textContent = `開始辨認（${Math.min(nextIdx+1,5)}/5）`;
}

function renderBird(assembled){
  const pal = bird.palette;
  const showLegs = assembled >= 1;
  const showBody = assembled >= 2;
  const showWing = assembled >= 3;
  const showTail = assembled >= 4;
  const showHead = assembled >= 5;

  const svg = `
  <svg viewBox="0 0 520 260" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="bird">
    <defs>
      <filter id="soft" x="-20%" y="-20%" width="140%" height="140%">
        <feGaussianBlur stdDeviation="1.2"/>
      </filter>
    </defs>
    <ellipse cx="260" cy="210" rx="120" ry="18" fill="rgba(0,0,0,.22)" filter="url(#soft)"/>

    <g class="${assembled===5 ? "bob" : ""}">
      ${showTail ? tailShape(pal.tail) : ""}

      ${showBody ? `
        <ellipse cx="270" cy="135" rx="120" ry="70" fill="${pal.body}"/>
        <ellipse cx="290" cy="155" rx="95" ry="52" fill="${pal.belly}" opacity=".92"/>
      ` : ""}

      ${showWing ? `
        <path d="M210 165c35-78 124-98 165-40-20 70-86 110-165 40z"
              fill="${pal.wing}" opacity=".95"/>
        <path d="M230 150c60-40 105-35 130 5"
              stroke="rgba(255,255,255,.35)" stroke-width="7" stroke-linecap="round" opacity=".45"/>
      ` : ""}

      ${showLegs ? `
        <path d="M250 185c8 18 2 30-8 44" stroke="${pal.legs}" stroke-width="8" stroke-linecap="round"/>
        <path d="M290 185c-8 18-2 30 8 44" stroke="${pal.legs}" stroke-width="8" stroke-linecap="round"/>
        <path d="M222 232h40" stroke="${pal.legs}" stroke-width="8" stroke-linecap="round"/>
        <path d="M278 232h40" stroke="${pal.legs}" stroke-width="8" stroke-linecap="round"/>
      ` : ""}

      ${showHead ? headShape(pal) : ""}
    </g>
  </svg>`;
  elBirdCanvas.innerHTML = svg;
}

function animateAssemble(from, to){
  if(to <= from){
    renderBird(to);
    return;
  }
  let cur = from;
  const tick = () => {
    cur += 1;
    renderBird(cur);
    if(cur < to) setTimeout(tick, 260);
  };
  setTimeout(tick, 120);
}

function tailShape(color){
  const isFork = (bird.name === "大卷尾");
  const isLong = (bird.name === "珠頸斑鳩");
  const isShort = (bird.name === "綠繡眼");
  if(isFork){
    return `<path d="M156 108c30 26 60 52 82 78-24 4-46-2-66-18 6 22 18 42 36 60-30-8-56-28-76-58-10 30-30 54-58 70 18-24 28-50 32-78-18 18-38 26-60 24 22-24 46-48 70-78z" fill="${color}" opacity=".96"/>`;
  }
  if(isLong){
    return `<path d="M150 120c55-55 88-55 130 0v110c-55 28-75 28-130 0z" fill="${color}" opacity=".96"/>`;
  }
  if(isShort){
    return `<path d="M160 150c40-36 92-36 132 0-48 58-84 58-132 0z" fill="${color}" opacity=".96"/>`;
  }
  return `<path d="M160 145h150v65c-54 24-96 24-150 0z" fill="${color}" opacity=".96"/>`;
}

function headShape(pal){
  let mark = "";
  if(bird.name === "綠繡眼"){
    mark = `<circle cx="360" cy="104" r="18" fill="none" stroke="#ffffff" stroke-width="8" opacity=".95"/>`;
  }else if(bird.name === "白頭翁"){
    mark = `
      <ellipse cx="352" cy="96" rx="34" ry="28" fill="#e9e3d8" opacity=".95"/>
      <path d="M330 94c22 0 40 22 38 40-30 6-46-8-58-26z" fill="rgba(0,0,0,.55)" opacity=".75"/>`;
  }else if(bird.name === "珠頸斑鳩"){
    mark = `<path d="M330 132c30-10 60-6 82 10" stroke="rgba(0,0,0,.65)" stroke-width="8" stroke-dasharray="6 10" opacity=".7"/>`;
  }
  const beak = `<path d="M392 104l54-20-54 4z" fill="${pal.beak}" opacity=".98"/>`;
  return `
    <circle cx="352" cy="104" r="34" fill="${pal.head}" opacity=".98"/>
    ${mark}
    ${beak}
    <circle cx="350" cy="104" r="6" fill="rgba(0,0,0,.7)"/>
  `;
}

function playFeedAnim(partKey){
  const step = STEPS.find(s=>s.key===partKey);
  const partLabel = step ? step.label : "—";
  $("feedAnimPart").textContent = `線索：${partLabel}`;
  
  feedAnim.classList.remove("show");
  void feedAnim.offsetWidth;
  feedAnim.classList.add("show");
  
  setTimeout(()=>{
    feedAnim.classList.remove("show");
  }, 950);
}

function getGuideText(partKey){
  const pool = bird.cluePool[partKey] || [];
  return pool[0] || "請依線索觀察圖卡特徵。";
}

function grantClue(part){
  const pool = bird.cluePool[part];
  const clue = pool[Math.floor(Math.random()*pool.length)];
  state.clues[part] = { text: clue };
  state.pendingPart = null;
  saveState();
  renderChips();
  renderCounters();
}

function feedBird(){
  if(state.pendingPart){
    playFeedAnim(state.pendingPart);
    setTimeout(()=>startPreScanGuide(state.pendingPart), 980);
    return;
  }

  const missing = STEPS.map(s=>s.key).filter(k=>!state.clues[k]);
  if(missing.length === 0){
    showToast("線索已集滿，可開始辨認");
    return;
  }

  const part = missing[Math.floor(Math.random()*missing.length)];
  state.pendingPart = part;
  saveState();
  renderChips();
  renderCounters();

  playFeedAnim(part);

  const targetLabel = STEPS.find(s=>s.key===part).label;
  showToast(`掉落線索：請找「${MYSTERY_NAME}｜${targetLabel}」線索卡`);

  setTimeout(()=>{
    startPreScanGuide(part);
  }, 980);
}

function analyzeDimension(clueText) {
  // [B2] 規則式備援：更貼近鳥類線索的維度（避免 ML 尚未就緒時退化成只有顏色/形狀）
  const DIM_LABEL = {
    color:    "色彩維度",
    shape:    "形態維度",
    pattern:  "斑紋維度",
    size:     "大小/比例維度",
    behavior: "行為維度",
  };

  const feats = {
    color:   ["紅","粉","黑","綠","褐","白","亮","淡","暗","棕","深","灰","黃","金屬","偏"],
    shape:   ["圓","尖","叉","方","長","短","細","粗","形","狀","末端","翼型","尾","翅","腿","線條","剪刀"],
    pattern: ["條紋","斑","斑紋","翼帶","眼圈","項鍊","珠頸","點","帶","紋","對比"],
    size:    ["小巧","較大","中等","偏長","偏短","體型","長度","比例","中長","較長","較短"],
    behavior:["走","跳","抓","飛","覓食","活動","靈活","警戒","叫","鳴","群","停","棲"]
  };

  const scores = Object.keys(feats).map(k => {
    let s = 0;
    feats[k].forEach(t => { if (clueText.includes(t)) s += 1; });
    return [k, s];
  });

  scores.sort((a,b)=>b[1]-a[1]);

  const top1 = scores[0];
  let top2 = scores.find(x => x[0] !== top1[0]) || scores[0];

  // 若完全沒有命中，預設以形態作為較常見可觀察向度
  if (top1[1] === 0) {
    return { type: "shape", label: DIM_LABEL.shape, wrong: DIM_LABEL.color, confidence: "0.50" };
  }

  const sum = scores.reduce((acc, x)=>acc + x[1], 0) || 1;
  const conf = (top1[1] / sum).toFixed(2);

  return {
    type: top1[0],
    label: DIM_LABEL[top1[0]] || top1[0],
    wrong: DIM_LABEL[top2[0]] || top2[0],
    confidence: conf
  };
}

async function startPreScanGuide(partKey) {
  const step = STEPS.find(s=>s.key===partKey);
  const label = step.label;
  const clue = getGuideText(partKey);

  // [B2] 優先使用 ML 語意診斷（若載入慢/失敗，退回規則版）
  let dim;
  let used = "rule";
  try{
    if(window.analyzeDimensionML){
      dim = await window.analyzeDimensionML(clue);
      used = "ml";
      const ms = document.getElementById("mlStatus"); if(ms) ms.textContent = "（ML）";
    }else{
      dim = analyzeDimension(clue);
      const ms = document.getElementById("mlStatus"); if(ms) ms.textContent = "（規則）";
    }
  }catch(e){
    dim = analyzeDimension(clue);
    const ms = document.getElementById("mlStatus"); if(ms) ms.textContent = "（規則）";
  }

  if(dim && dim.label === dim.wrong){
    dim.wrong = "形態維度";
  }

  // 記錄：AI 診斷事件
  if(typeof logEvent === "function"){
    logEvent("ai_diag", { partKey, clue, dim, used });
  }

  guideTitle.textContent = `AI 觀察引導：${label}`;
  guideAiText.textContent = `準備尋找「${MYSTERY_NAME}」的${label}囉！`;
  guideBtns.innerHTML = "";
  guideResult.classList.add("hidden");
  guideRealClue.textContent = "";
  guideModal.classList.remove("hidden");
  guideActions.classList.remove("hidden");

  
  setTimeout(() => {
    typeText(guideAiText, `要找${label}了！你覺得觀察「${dim.label}」還是「${dim.wrong}」更有利於辨認？`, 20);
    
    const btnCorrect = document.createElement("div");
    btnCorrect.className = "guideBtn";
    btnCorrect.textContent = dim.label;
    btnCorrect.onclick = () => handleGuideAnswer(true, dim, clue);

    const btnWrong = document.createElement("div");
    btnWrong.className = "guideBtn";
    btnWrong.textContent = dim.wrong; 
    btnWrong.onclick = () => handleGuideAnswer(false, dim, clue);

    const btns = Math.random() > 0.5 ? [btnCorrect, btnWrong] : [btnWrong, btnCorrect];
    btns.forEach(b => guideBtns.appendChild(b));
  }, 600);
}

function handleGuideAnswer(isCorrect, dim, clueText) {
  [...guideBtns.children].forEach(btn => btn.style.pointerEvents = "none");
  
  if(isCorrect) {
    [...guideBtns.children].forEach(btn => {
      if(btn.textContent === dim.label) btn.classList.add("correct");
    });
    typeText(guideAiText, `沒錯！觀察「${dim.label}」是關鍵！\n這是這隻鳥的特徵線索，請記住它並掃描圖卡：`, 15);
  } else {
    [...guideBtns.children].forEach(btn => {
      if(btn.textContent === dim.wrong) btn.classList.add("wrong");
      if(btn.textContent === dim.label) btn.classList.add("correct");
    });
    typeText(guideAiText, `其實「${dim.wrong}」也重要，但這隻鳥的「${dim.label}」特徵更明顯喔！\n請看這個線索，並找出對應的圖卡：`, 15);
  }

  setTimeout(() => {
    guideResult.classList.remove("hidden");
    guideRealClue.textContent = `「${clueText}」`;
  }, 1500);
}

function closeGuideModal() {
  guideModal.classList.add("hidden");
}

let scanning = false;
let scanRaf = 0;
let scanCooldownUntil = 0;
let lastScanMsgAt = 0;
let scanErrorPause = false;

const offCanvas = document.createElement("canvas");
const offCtx = offCanvas.getContext("2d", { willReadFrequently: true });

function setScanMessage(text, type="info"){
  const color = (type==="ok") ? "rgba(46,125,50,.10)" : (type==="bad") ? "rgba(198,40,40,.10)" : "rgba(255,255,255,.72)";
  scanHintText.style.background = color;
  scanHintText.textContent = text;
  lastScanMsgAt = Date.now();
}

function openScan(){
  if(!state.cameraOn){
    startOverlay.classList.remove("hidden");
    showToast("請先點一下開啟相機");
    return;
  }
  if(!state.pendingPart){
    showToast("目前沒有待掃部位：請先餵鳥");
    return;
  }
  
  closeGuideModal();

  if(typeof jsQR !== "function"){
    showToast("掃描功能載入失敗：請重新整理");
    return;
  }

  const targetLabel = STEPS.find(s=>s.key===state.pendingPart).label;
  scanNeedText.textContent = `${MYSTERY_NAME}｜${targetLabel}`;
  scanBadge.textContent = "掃描中…";
  scanBadge.classList.remove("error");
  scanPreviewBox.classList.remove("error");

  const guide = getGuideText(state.pendingPart);
  setScanMessage(`請找線索卡中符合「${guide}」的小鳥，並掃背面 QR。`, "info");

  scanOverlay.classList.remove("hidden");
  scanning = true;
  scanErrorPause = false;
  scanCooldownUntil = 0;
  scanLoop();
}

function closeScan(){
  scanning = false;
  scanOverlay.classList.add("hidden");
  if(scanRaf) cancelAnimationFrame(scanRaf);
}

function drawReticle(ctx, w, h, color="rgba(240,193,75,.9)"){
  const boxW = Math.round(w * 0.62);
  const boxH = Math.round(h * 0.52);
  const x = Math.round((w - boxW)/2);
  const y = Math.round((h - boxH)/2);
  const r = 16;

  ctx.save();
  ctx.strokeStyle = color;
  ctx.lineWidth = 4;

  function corner(x1,y1,dirX,dirY){
    ctx.beginPath();
    ctx.moveTo(x1, y1 + dirY*r);
    ctx.lineTo(x1, y1);
    ctx.lineTo(x1 + dirX*r, y1);
    ctx.stroke();
  }
  corner(x, y, 1, 1);
  corner(x+boxW, y, -1, 1);
  corner(x, y+boxH, 1, -1);
  corner(x+boxW, y+boxH, -1, -1);

  const t = (Date.now()%1200)/1200;
  const lineY = y + Math.round(t * boxH);

  ctx.beginPath();
  ctx.rect(x, y, boxW, boxH);
  ctx.clip();

  ctx.fillStyle = color === "#c62828" ? "rgba(198,40,40,.25)" : "rgba(240,193,75,.45)";
  ctx.fillRect(x, lineY, boxW, 3);

  ctx.restore();
}

function drawQrBox(ctx, loc, color="rgba(46,125,50,.95)"){
  if(!loc) return;
  ctx.save();
  ctx.strokeStyle = color;
  ctx.lineWidth = 5;
  ctx.beginPath();
  ctx.moveTo(loc.topLeftCorner.x, loc.topLeftCorner.y);
  ctx.lineTo(loc.topRightCorner.x, loc.topRightCorner.y);
  ctx.lineTo(loc.bottomRightCorner.x, loc.bottomRightCorner.y);
  ctx.lineTo(loc.bottomLeftCorner.x, loc.bottomLeftCorner.y);
  ctx.closePath();
  ctx.stroke();
  ctx.restore();
}

function scanLoop(){
  if(!scanning) return;
  if(scanErrorPause) {
     scanRaf = requestAnimationFrame(scanLoop);
     return;
  }

  const video = $("camera");
  const vw = video.videoWidth || 0;
  const vh = video.videoHeight || 0;

  if(video.readyState >= 2 && vw > 0 && vh > 0){
    const outW = 960;
    const outH = 540;

    const srcAspect = vw / vh;
    const dstAspect = outW / outH;
    let sx=0, sy=0, sw=vw, sh=vh;
    if(srcAspect > dstAspect){
      sh = vh;
      sw = Math.round(vh * dstAspect);
      sx = Math.round((vw - sw)/2);
      sy = 0;
    }else{
      sw = vw;
      sh = Math.round(vw / dstAspect);
      sx = 0;
      sy = Math.round((vh - sh)/2);
    }

    scanPctx.drawImage(video, sx, sy, sw, sh, 0, 0, outW, outH);

    offCanvas.width = outW;
    offCanvas.height = outH;
    offCtx.drawImage(scanPreview, 0, 0);

    drawReticle(scanPctx, outW, outH);

    const now = Date.now();
    if(now >= scanCooldownUntil){
      const img = offCtx.getImageData(0, 0, outW, outH);
      const code = jsQR(img.data, outW, outH, { inversionAttempts: "dontInvert" });

      if(code && code.data){
        const result = handleScannedText(code.data);
        if(result === "success"){
          drawQrBox(scanPctx, code.location, "rgba(46,125,50,.95)");
          scanBadge.textContent = "讀取成功";
          scanBadge.classList.remove("error");
          setTimeout(()=>closeScan(), 500);
          return;
        }else if(result === "wrong"){
          drawQrBox(scanPctx, code.location, "#c62828");
          drawReticle(scanPctx, outW, outH, "#c62828");
          scanBadge.textContent = "掃描到但錯誤";
          scanBadge.classList.add("error");
          scanPreviewBox.classList.add("error");
          scanCooldownUntil = now + 2000; 
        } else {
           drawQrBox(scanPctx, code.location, "rgba(46,125,50,.95)");
        }
      }else{
        scanBadge.textContent = "掃描中…";
        scanBadge.classList.remove("error");
        scanPreviewBox.classList.remove("error");
      }
    }
  }

  if(state.pendingPart && Date.now() - lastScanMsgAt > 5200){
    const guide = getGuideText(state.pendingPart);
    setScanMessage(`請找線索卡中符合「${guide}」的小鳥，並掃背面 QR。`, "info");
  }

  scanRaf = requestAnimationFrame(scanLoop);
}

function showScanErrorModal(scannedBirdKey, scannedPartKey) {
  scanErrorPause = true;
  
  guideTitle.textContent = "AI 特徵比對（掃錯囉）";
  guideBtns.innerHTML = "";
  guideResult.classList.remove("hidden");
  guideRealClue.textContent = "";
  guideModal.classList.remove("hidden");
  
  guideActions.classList.add("hidden");
  
  const targetPart = state.pendingPart;
  const targetGuide = getGuideText(targetPart);
  const targetLabel = STEPS.find(s=>s.key===targetPart)?.label || "未知部位";
  
  const scannedBird = BIRDS[scannedBirdKey] || {};
  const scannedPool = scannedBird.cluePool?.[scannedPartKey] || [];
  const scannedText = scannedPool[0] || "不明特徵";
  const scannedBirdName = scannedBird.name || "這張卡";
  const scannedPartLabel = STEPS.find(s=>s.key===scannedPartKey)?.label || "不明部位";

  let msg = "";

  if (scannedBirdKey === birdKey && scannedPartKey !== targetPart) {
     msg = `你掃到了「${scannedPartLabel}」！\n但我們現在系統指定要找的是：「${targetLabel}」喔！\n\n這張卡顯示：${scannedText}`;
  } 
  else {
     msg = `這張卡片不是我們要找的喔！\n但我們要找的是「${MYSTERY_NAME}」！\n\n這張卡特徵：${scannedText}`;
  }
  
  msg += `\n\n請再找找符合以下描述的卡片：\n『${targetGuide}』`;
  
  typeText(guideAiText, msg, 10);
  
  btnStartScanFromGuide.textContent = "知道了，繼續掃描";
  btnStartScanFromGuide.onclick = () => {
    guideModal.classList.add("hidden");
    scanErrorPause = false;
    scanPreviewBox.classList.remove("error");
    scanCooldownUntil = Date.now() + 1000;
  };
}

function handleScannedText(text){
  if(!state.pendingPart) return "success";

  let url;
  try{ url = new URL(text); }catch(e){ return "ignore"; }

  const b = url.searchParams.get("bird");
  const claim = url.searchParams.get("claim");

  if(!claim){
    return "ignore"; 
  }

  const targetPart = state.pendingPart;
  
  if((b && b !== birdKey) || (claim !== targetPart)){
     showScanErrorModal(b, claim);
     return "wrong";
  }

  const targetLabel = STEPS.find(s=>s.key===targetPart).label;
  grantClue(claim);
  setScanMessage(`✅ 獲得線索：「${MYSTERY_NAME}｜${targetLabel}」`, "ok");
  showToast(`獲得線索：${targetLabel}`);
  return "success";
}

function handleClaimFromURLIfAny(){
  if(!CLAIM) return false;
  if(!state.pendingPart){
    showToast("尚未掉落線索：請先按餵鳥再掃卡", 3000);
    setTimeout(()=>location.replace(`${location.pathname}?bird=${encodeURIComponent(birdKey)}`), 900);
    return true;
  }
  if(CLAIM !== state.pendingPart){
    const targetLabel = STEPS.find(s=>s.key===state.pendingPart).label;
    showToast(`不是「${MYSTERY_NAME}」的「${targetLabel}」，再觀察看看`, 3000);
    setTimeout(()=>location.replace(`${location.pathname}?bird=${encodeURIComponent(birdKey)}`), 900);
    return true;
  }
  grantClue(CLAIM);
  showToast(`獲得線索：${STEPS.find(s=>s.key===CLAIM).label}`);
  setTimeout(()=>location.replace(`${location.pathname}?bird=${encodeURIComponent(birdKey)}`), 900);
  return true;
}

function openQuiz(){
  if(Object.keys(state.clues).length < 5){
    showToast("請先收集滿 5 張線索");
    return;
  }
  if(state.pendingPart){
    showToast("尚有待掃線索卡：請先掃卡完成收集", 3200);
    return;
  }
  quizModal.classList.remove("hidden");
  quizTitle.textContent = `辨認鳥類：${MYSTERY_NAME}`;
  buildStepDots();

  const idx = STEPS.findIndex(s=>!state.solved[s.key]);
  state.currentStep = (idx>=0)?idx:0;
  saveState();
  renderStep();
}

function closeQuizModal(){ quizModal.classList.add("hidden"); }

function buildStepDots(){
  stepDots.innerHTML = "";
  STEPS.forEach((s, idx)=>{
    const d = document.createElement("div");
    d.className = "dot";
    d.textContent = String(idx+1);
    stepDots.appendChild(d);
  });
}

function renderStep(){
  const part = STEPS[state.currentStep].key;

  [...stepDots.children].forEach((el, idx)=>{
    el.classList.remove("active","done");
    const k = STEPS[idx].key;
    if(state.solved[k]) el.classList.add("done");
    if(idx === state.currentStep) el.classList.add("active");
  });

  const q = bird.quiz[part];
  const collected = state.clues[part]?.text || "（尚未收集到此部位線索）";

  clueBox.innerHTML = `
    <div style="font-weight:900;font-size:16px;margin-bottom:6px">${q.prompt}</div>
    <div>你收集到的線索：<strong>${escapeHtml(collected)}</strong></div>
  `;

  optionsGrid.innerHTML = "";
  q.options.forEach(optKey=>{
    const opt = OPTION_LIB[part][optKey];
    const card = document.createElement("div");
    card.className = "opt";
    card.innerHTML = `
      ${opt.svg}
      <div>
        <div class="lbl">${opt.label}</div>
        <div class="desc">${opt.desc}</div>
      </div>
    `;
    card.addEventListener("click", ()=> chooseOption(part, optKey, card));
    optionsGrid.appendChild(card);
  });

  btnHintQuiz.disabled = false; 
}

function chooseOption(part, optKey, cardEl){
  if(state.solved[part]) return;

  const correct = bird.quiz[part].correct;
  [...optionsGrid.children].forEach(el=>el.style.pointerEvents="none");

  if(optKey === correct){
    cardEl.classList.add("correct");
    state.solved[part] = true;

    const prev = state.assembledCount;
    state.assembledCount = Math.min(5, Object.keys(state.solved).length);
    saveState();

    animateAssemble(prev, state.assembledCount);

    setTimeout(()=>{
      closeQuizModal();
      openAssembleModal(part);
    }, 250);

  }else{
    cardEl.classList.add("wrong");
    showToast("答錯：已重置，請重新收集 5 張線索", 3600);

    setTimeout(()=>{
      closeQuizModal();
      resetState();
      loadState();
      renderBird(0);
      renderChips();
      renderCounters();
    }, 550);
  }
}

function openAssembleModal(partJustSolved){
  const label = STEPS.find(s=>s.key===partJustSolved).label;
  assembleTitle.textContent = "答對！已拼上部位";
  assembleTag.textContent = `${MYSTERY_NAME}｜${label}`;
  assembleBird.innerHTML = `<div style="width:min(520px,92vw)">${renderAssembleBirdSVG()}</div>`;
  assembleSummary.textContent = `你完成了「${label}」。觀察重點：${getGuideText(partJustSolved)}`;

  const doneCount = Object.keys(state.solved).length;
  btnAssembleNext.textContent = (doneCount >= 5) ? "完成" : "下一步";
  btnAssembleNext.style.display = ""; 
  assembleModal.classList.remove("hidden");
}

function closeAssembleModal(){ assembleModal.classList.add("hidden"); }

function triggerCelebration(callback) {
  const container = document.getElementById("confettiOverlay");
  container.style.display = "block";
  container.innerHTML = "";

  const colors = ["#ffd700", "#ff6b6b", "#4ecdc4", "#45b7d1", "#ffffff"];
  for(let i=0; i<60; i++){
    const p = document.createElement("div");
    p.className = "confetti";
    p.style.left = Math.random() * 100 + "%";
    p.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
    p.style.animation = `drop-confetti ${2 + Math.random()}s linear forwards`;
    p.style.animationDelay = Math.random() * 1 + "s";
    container.appendChild(p);
  }

  setTimeout(() => {
    container.style.display = "none";
    container.innerHTML = "";
    if(callback) callback();
  }, 2500);
}

function assembleNext(){
  const doneCount = Object.keys(state.solved).length;
  
  if(doneCount >= 5){
    btnAssembleNext.style.display = "none";
    triggerCelebration(() => {
       closeAssembleModal(); 
       openReveal();
       btnAssembleNext.style.display = "";
    });
    return;
  }

  closeAssembleModal();
  const nextIdx = STEPS.findIndex(s=>!state.solved[s.key]);
  state.currentStep = (nextIdx>=0)?nextIdx:0;
  saveState();
  openQuiz();
}

function renderAssembleBirdSVG(){
  const pal = bird.palette;
  const assembled = state.assembledCount;
  const showLegs = assembled >= 1;
  const showBody = assembled >= 2;
  const showWing = assembled >= 3;
  const showTail = assembled >= 4;
  const showHead = assembled >= 5;

  return `
  <svg class="${assembled===5 ? "bob" : ""}" viewBox="0 0 520 260" xmlns="http://www.w3.org/2000/svg" aria-label="assemble bird">
    <ellipse cx="260" cy="210" rx="120" ry="18" fill="rgba(0,0,0,.12)"/>
    ${showTail ? tailShape(pal.tail) : ""}
    ${showBody ? `<ellipse cx="270" cy="135" rx="120" ry="70" fill="${pal.body}"/>
      <ellipse cx="290" cy="155" rx="95" ry="52" fill="${pal.belly}" opacity=".92"/>` : ""}
    ${showWing ? `<path d="M210 165c35-78 124-98 165-40-20 70-86 110-165 40z"
          fill="${pal.wing}" opacity=".95"/>
      <path d="M230 150c60-40 105-35 130 5"
          stroke="rgba(255,255,255,.35)" stroke-width="7" stroke-linecap="round" opacity=".45"/>` : ""}
    ${showLegs ? `<path d="M250 185c8 18 2 30-8 44" stroke="${pal.legs}" stroke-width="8" stroke-linecap="round"/>
      <path d="M290 185c-8 18-2 30 8 44" stroke="${pal.legs}" stroke-width="8" stroke-linecap="round"/>
      <path d="M222 232h40" stroke="${pal.legs}" stroke-width="8" stroke-linecap="round"/>
      <path d="M278 232h40" stroke="${pal.legs}" stroke-width="8" stroke-linecap="round"/>` : ""}
    ${showHead ? headShape(pal) : ""}
  </svg>`;
}

let typingTimer = 0;

function startAiDialogue(){
  const partKey = STEPS[state.currentStep].key;
  const label = STEPS[state.currentStep].label;
  const collected = Object.keys(state.clues).length;

  const hintData = getInteractiveHintData(partKey);

  aiModal.classList.remove("hidden");
  aiOptions.style.display = "none";
  aiOptions.innerHTML = "";
  aiOk.textContent = "取消";

  const greeting = `我們收集到 ${collected} 個線索了！關於『${label}』的特徵，你剛才觀察到的細節是什麼？`;
  typeText(aiText, greeting, 15);

  setTimeout(() => {
    aiOptions.style.display = "grid";
    hintData.options.sort(() => Math.random() - 0.5);
    
    hintData.options.forEach(opt => {
      const btn = document.createElement("div");
      btn.className = "aiOptBtn";
      btn.textContent = opt.text;
      btn.onclick = () => handleAiChoice(opt, hintData.strategy, partKey);
      aiOptions.appendChild(btn);
    });
  }, 1000);
}

function handleAiChoice(option, strategyLines, partKey){
  aiOptions.style.display = "none";
  
  let msg = "";
  const strategies = strategyLines.join("\n");
  const ecology = getEcologyText(partKey, option.isCorrect);

  if(option.isCorrect){
    msg = `對！「${option.coreFeature}」是關鍵，${ecology}\n\n★ 科學家建議篩選策略：\n${strategies}`;
  } else if(option.isGuide){
    msg = `沒關係，我們一起來看。\n這隻鳥的特徵其實偏向「${option.correctFeature}」。\n\n★ 科學家建議篩選策略：\n${strategies}`;
  } else {
    msg = `那可能是另一種鳥喔，我們再看一次線索卡...\n${MYSTERY_NAME}其實是「${option.correctFeature}」的。\n\n★ 科學家建議篩選策略：\n${strategies}`;
  }

  typeText(aiText, msg, 10);
  aiOk.textContent = "知道了，回去答題";
}

function getEcologyText(part, isCorrect){
  if(!isCorrect) return "";
  if(part === "legs") return "這樣的顏色在樹枝間很顯眼，或者是很好的保護色。";
  if(part === "wing") return "這能幫助牠在飛行時更流暢，或者在林間穿梭。";
  if(part === "tail") return "這能控制飛行方向，或者在求偶時展示。";
  if(part === "head") return "這讓同伴容易辨識，或者能融入背景環境。";
  if(part === "body") return "這是最主要的辨識區塊，通常與棲息環境有關。";
  return "這是很重要的特徵喔。";
}

function getInteractiveHintData(partKey) {
  const correctKey = bird.quiz[partKey].correct;
  const correctLabel = OPTION_LIB[partKey][correctKey].label; 
  
  const allOpts = bird.quiz[partKey].options;
  const wrongKey = allOpts.find(k => k !== correctKey) || allOpts[0];
  const wrongLabel = OPTION_LIB[partKey][wrongKey].label;

  return {
    options: [
      { text: `我記得是「${correctLabel}」`, isCorrect: true, coreFeature: correctLabel },
      { text: `我記得是「${wrongLabel}」`, isCorrect: false, correctFeature: correctLabel },
      { text: "我需要你引導我觀察", isGuide: true, isCorrect: false, correctFeature: correctLabel }
    ],
    strategy: bird.ai[partKey] || ["1. 先看主色", "2. 比對形狀", "3. 排除差異太大的"]
  };
}

btnHintQuiz.addEventListener("click", startAiDialogue);
closeAi.addEventListener("click", closeAiModal);
aiOk.addEventListener("click", closeAiModal);

function closeAiModal(){
  aiModal.classList.add("hidden");
  clearInterval(typingTimer);
  aiText.textContent = "";
}

function typeText(el, text, speedMs=14){
  clearInterval(typingTimer);
  el.textContent = "";
  let i = 0;
  typingTimer = setInterval(()=>{
    el.textContent += text[i] || "";
    i++;
    if(i >= text.length){
      clearInterval(typingTimer);
    }
  }, speedMs);
}

function openReveal(){
  revealModal.classList.remove("hidden");
  revealName.textContent = bird.name;
  revealBird.innerHTML = `<div style="width:min(520px,92vw)">${renderFinalBirdSVG()}</div>`;
  revealSummary.textContent = bird.summary;
}
function closeRevealModal(){ revealModal.classList.add("hidden"); }

function renderFinalBirdSVG(){
  const pal = bird.palette;
  return `
  <svg class="bob" viewBox="0 0 520 260" xmlns="http://www.w3.org/2000/svg" aria-label="reveal bird">
    <ellipse cx="260" cy="210" rx="120" ry="18" fill="rgba(0,0,0,.12)"/>
    ${tailShape(pal.tail)}
    <ellipse cx="270" cy="135" rx="120" ry="70" fill="${pal.body}"/>
    <ellipse cx="290" cy="155" rx="95" ry="52" fill="${pal.belly}" opacity=".92"/>
    <path d="M210 165c35-78 124-98 165-40-20 70-86 110-165 40z"
          fill="${pal.wing}" opacity=".95"/>
    <path d="M230 150c60-40 105-35 130 5"
          stroke="rgba(255,255,255,.35)" stroke-width="7" stroke-linecap="round" opacity=".45"/>
    <path d="M250 185c8 18 2 30-8 44" stroke="${pal.legs}" stroke-width="8" stroke-linecap="round"/>
    <path d="M290 185c-8 18-2 30 8 44" stroke="${pal.legs}" stroke-width="8" stroke-linecap="round"/>
    <path d="M222 232h40" stroke="${pal.legs}" stroke-width="8" stroke-linecap="round"/>
    <path d="M278 232h40" stroke="${pal.legs}" stroke-width="8" stroke-linecap="round"/>
    ${headShape(pal)}
  </svg>`;
}

function escapeHtml(s){
  return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
}
function copyLink(){
  const url = location.origin + location.pathname + `?bird=${encodeURIComponent(birdKey)}`;
  navigator.clipboard?.writeText(url)
    .then(()=>showToast("已複製連結"))
    .catch(()=>showToast("複製失敗：請手動複製網址列"));
}

function init(){
  loadState();

  if(START){
    resetState();
    loadState();
    setTimeout(()=>location.replace(`${location.pathname}?bird=${encodeURIComponent(birdKey)}`), 50);
    return;
  }

  elBirdName.textContent = MYSTERY_NAME; 
  elBirdSub.textContent = bird.sub;

  renderBird(state.assembledCount);
  renderChips();
  renderCounters();

  if(handleClaimFromURLIfAny()) return;

  startCamera(true).then(ok=>{
    if(!ok) startOverlay.classList.remove("hidden");
  });

  btnCamera.addEventListener("click", async ()=>{
    const ok = await startCamera(false);
    if(ok) startOverlay.classList.add("hidden");
  });
  btnStartCameraNow.addEventListener("click", async ()=>{
    const ok = await startCamera(false);
    if(ok) startOverlay.classList.add("hidden");
  });
  closeStartOverlay.addEventListener("click", ()=> startOverlay.classList.add("hidden"));

  btnFeed.addEventListener("click", feedBird);
  
  btnScan.addEventListener("click", ()=>{
    if(state.pendingPart) startPreScanGuide(state.pendingPart);
  });
  
  btnStopScan.addEventListener("click", closeScan);
  btnStopScan2.addEventListener("click", closeScan);

  btnStartScanFromGuide.addEventListener("click", openScan);
  closeGuide.addEventListener("click", closeGuideModal);

  btnQuiz.addEventListener("click", openQuiz);

  btnReset.addEventListener("click", ()=>{
    resetState();
    loadState();
    renderBird(0);
    renderChips();
    renderCounters();
    showToast("已重置本鳥進度");
  });


  // [B2] 題目（鳥種）選擇
  btnChooseBird.addEventListener("click", openBirdPicker);
  closeBird.addEventListener("click", closeBirdPicker);
  birdModal.addEventListener("click", (e)=>{ if(e.target === birdModal) closeBirdPicker(); });

  // [B2] 匯出本次互動紀錄（JSON）
  btnExport.addEventListener("click", ()=>{
    logEvent("manual_export", {});
    exportLog();
  });

  // [B2] ML ready 狀態提示
  window.addEventListener("ml-ready", ()=>{
    const ms = document.getElementById("mlStatus");
    if(ms) ms.textContent = "（ML 就緒）";
    showToast("ML 語意診斷模型已就緒");
    logEvent("ml_ready", { info: window.__ML_MODEL_INFO__ || null });
  });

  closeQuiz.addEventListener("click", closeQuizModal);
  btnCloseQuiz2.addEventListener("click", closeQuizModal);

  btnHintQuiz.addEventListener("click", startAiDialogue);
  closeAi.addEventListener("click", closeAiModal);
  aiOk.addEventListener("click", closeAiModal);

  closeAssemble.addEventListener("click", closeAssembleModal);
  btnAssembleNext.addEventListener("click", assembleNext);

  closeReveal.addEventListener("click", closeRevealModal);
  btnReplay.addEventListener("click", ()=>{
    closeRevealModal();
    resetState();
    loadState();
    renderBird(0);
    renderChips();
    renderCounters();
  });
  btnCopyLink.addEventListener("click", copyLink);

  showToast(`已載入：${MYSTERY_NAME}（餵鳥→掃描線索卡）`);
}

init();
</script>
</body>
</html>