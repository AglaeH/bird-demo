<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Bird Builder AR Demo</title>

  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

  <style>
    :root{
      --bg:#0b1220;
      --panel:#f4ecd8;
      --panel2:#efe3c6;
      --ink:#2b2b2b;
      --muted:#6b6256;
      --accent:#f0c14b;
      --good:#2e7d32;
      --bad:#c62828;
      --shadow: 0 18px 40px rgba(0,0,0,.35);
      --radius:18px;
      --line: rgba(0,0,0,.08);
    }
    *{box-sizing:border-box;font-family: ui-sans-serif, system-ui, -apple-system, "PingFang TC", "Noto Sans TC", "Microsoft JhengHei", sans-serif;}
    body{margin:0;background:var(--bg);color:#fff;overflow:hidden;}
    #app{position:relative;height:100dvh;width:100vw;background:#000;}
    video#camera{
      position:absolute;inset:0;width:100%;height:100%;object-fit:cover;
      filter:saturate(1.05) contrast(1.05);
      background:#000;
    }
    #overlay{position:absolute;inset:0;display:flex;flex-direction:column;justify-content:space-between;padding:14px;pointer-events:none;}
    .topbar{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;}
    .pill{
      pointer-events:auto;
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;border-radius:999px;
      background:rgba(20,20,20,.55);backdrop-filter: blur(8px);
      border:1px solid rgba(255,255,255,.12);
      font-size:14px;
    }
    .pill strong{font-weight:800;}
    .stage{
      pointer-events:none;
      display:flex;align-items:center;justify-content:center;
      min-height:44vh;
    }
    .birdCard{
      pointer-events:none;
      width:min(520px,92vw);
      background:rgba(20,20,20,.28);
      border:1px solid rgba(255,255,255,.14);
      border-radius:26px;
      padding:14px;
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:10px;
    }
    .birdCanvas{width:100%;display:flex;align-items:center;justify-content:center;}
    .birdCanvas svg{width:min(420px,86vw);height:auto;}
    .hintRow{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
    .chip{
      pointer-events:none;
      background:rgba(255,255,255,.14);
      border:1px solid rgba(255,255,255,.14);
      padding:6px 10px;border-radius:999px;
      font-size:12px;
    }

    .bottom{
      pointer-events:auto;
      display:flex;gap:10px;flex-wrap:wrap;justify-content:center;
      padding-bottom: calc(8px + env(safe-area-inset-bottom));
    }
    button{
      border:0;border-radius:16px;
      padding:12px 14px;font-size:15px;
      background:#ffffff; color:#111;
      box-shadow: 0 10px 18px rgba(0,0,0,.25);
      cursor:pointer;
    }
    button.dark{
      background:rgba(255,255,255,.16);color:#fff;border:1px solid rgba(255,255,255,.18);
      backdrop-filter: blur(8px);
    }
    button:disabled{opacity:.45;cursor:not-allowed;}

    .toast{
      pointer-events:none;
      position:absolute;left:50%;transform:translateX(-50%);
      bottom:118px;
      background:rgba(0,0,0,.70);color:#fff;
      padding:10px 14px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      backdrop-filter: blur(8px);
      font-size:14px;
      opacity:0;transition:opacity .2s;
      max-width:min(92vw,640px);
      text-align:center;
      line-height:1.3;
    }
    .toast.show{opacity:1;}

    /* New Feed Overlay Style */
    .feedOverlay{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      z-index:100;
      background: rgba(0,0,0,.35);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
    }
    .feedOverlay.show{ display:flex; }
    .feedCard{
      width: min(340px, calc(100% - 40px));
      background: rgba(255,255,255,.95);
      border-radius: 24px;
      border: 1px solid var(--line);
      box-shadow: var(--shadow);
      padding: 20px;
      text-align:center;
      color: #111;
    }
    .feedTitle{ font-weight:900; font-size:18px; margin-bottom:12px; }
    .feedSub{ color: rgba(0,0,0,.6); font-size:14px; margin-top:14px; font-weight:500; }

    .feedAnimBox{
      position:relative;
      height: 120px;
      margin: 10px auto 0;
      width: 180px;
    }
    .bowl{
      position:absolute;
      left:50%;
      bottom: 5px;
      width: 120px;
      height: 40px;
      transform: translateX(-50%);
      border-radius: 0 0 50px 50px;
      border: 3px solid rgba(163,58,42,.65);
      border-top: 0;
      background: rgba(163,58,42,.1);
    }
    .seed{
      position:absolute;
      width: 10px; height: 10px;
      border-radius: 999px;
      background: rgba(163,58,42,.9);
      top: 0px;
      left: 50%;
      transform: translateX(-50%);
      animation: fall 0.8s ease-in infinite;
      opacity: 0;
    }
    .seed.s1{ left: 35%; animation-delay: .00s; }
    .seed.s2{ left: 50%; animation-delay: .12s; }
    .seed.s3{ left: 62%; animation-delay: .22s; }
    .seed.s4{ left: 45%; animation-delay: .32s; }
    @keyframes fall{
      0%{ transform: translate(-50%, 0) scale(.9); opacity: 0; }
      15%{ opacity: 1; }
      70%{ transform: translate(-50%, 85px) scale(1); opacity: 1; }
      100%{ transform: translate(-50%, 85px) scale(.4); opacity: 0; }
    }

    /* Modals */
    .modal{
      position:absolute;inset:0;
      background:rgba(0,0,0,.55);
      display:flex;align-items:center;justify-content:center;
      padding:14px;
      z-index:50;
    }
    .hidden{display:none;}
    .box{
      width:min(780px,96vw);
      background:var(--panel);
      color:var(--ink);
      border-radius:22px;
      box-shadow: var(--shadow);
      border:1px solid rgba(0,0,0,.08);
      overflow:hidden;
    }
    .boxHeader{
      display:flex;align-items:center;justify-content:space-between;
      padding:14px;
      background:linear-gradient(180deg, var(--panel), var(--panel2));
      border-bottom:1px solid rgba(0,0,0,.08);
    }
    .title{font-size:18px;font-weight:900;}
    .xbtn{
      width:38px;height:38px;border-radius:12px;border:0;
      background:rgba(0,0,0,.08);cursor:pointer;
      font-size:18px;line-height:1;
    }
    .stepDots{ display:flex;gap:8px;padding:10px 14px; }
    .dot{
      width:34px;height:34px;border-radius:999px;
      display:flex;align-items:center;justify-content:center;
      background:rgba(0,0,0,.06); border:1px solid rgba(0,0,0,.1);
      font-weight:900;
    }
    .dot.active{background:var(--accent);border-color:rgba(0,0,0,.14);}
    .dot.done{background:rgba(46,125,50,.18);border-color:rgba(46,125,50,.25);color:var(--good);}

    .content{padding:12px 14px 14px;display:flex;flex-direction:column;gap:10px;}
    .clueBox{
      background:rgba(255,255,255,.72); border:1px solid rgba(0,0,0,.08);
      border-radius:16px; padding:12px; line-height:1.35; white-space:pre-wrap;
    }
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;}
    .opt{
      background:#fff; border:2px solid rgba(0,0,0,.1); border-radius:18px;
      padding:12px; cursor:pointer; display:flex; gap:10px; align-items:center; min-height:88px;
    }
    .opt.correct{border-color:rgba(46,125,50,.55);background:rgba(46,125,50,.08);}
    .opt.wrong{border-color:rgba(198,40,40,.55);background:rgba(198,40,40,.08);}

    .footer{
      padding:14px; display:flex; gap:10px; justify-content:space-between; align-items:center;
      background:linear-gradient(180deg, var(--panel2), var(--panel)); border-top:1px solid rgba(0,0,0,.08);
    }
    .kpi{font-size:13px;color:var(--muted);}

    /* Scan preview */
    .scanWrap{width:100%;display:flex;flex-direction:column;gap:10px;}
    .scanPreviewBox{ width:100%; border-radius:18px; overflow:hidden; background:#000; position:relative; }
    canvas#scanPreview{width:100%;height:auto;display:block;}
    .scanBadge{ position:absolute; left:12px; top:12px; background:rgba(0,0,0,.55); color:#fff; padding:6px 10px; border-radius:999px; font-size:12px; }

    .bob{animation:bob 1.8s ease-in-out infinite;transform-origin:center;}
    @keyframes bob{0%,100%{transform:translateY(0px);}50%{transform:translateY(-6px);}}
  </style>
</head>

<body>
<div id="app">
  <video id="camera" autoplay playsinline muted></video>

  <div id="overlay">
    <div class="topbar">
      <div class="pill"><strong id="birdName">é³¥</strong> <span id="birdSub" style="opacity:.85"></span></div>
      <div class="pill">
        ç·šç´¢ <strong id="clueCount">0</strong>/5
        <span style="opacity:.6">|</span>
        å¾…æƒ <strong id="pendingText">â€”</strong>
        <span style="opacity:.6">|</span>
        AI æç¤º <strong id="hintLeft">2</strong>/2
      </div>
    </div>

    <div class="stage">
      <div class="birdCard">
        <div class="birdCanvas" id="birdCanvas"></div>
        <div class="hintRow" id="clueChips"></div>
        <div style="font-size:12px;opacity:.92;text-align:center;line-height:1.35">
          è«‹æŒ‰ <strong>é¤µé³¥</strong> ç²å¾—éš¨æ©Ÿéƒ¨ä½ç·šç´¢å¡ï¼Œå†é€²è¡Œæƒæã€‚
        </div>
      </div>
      <div class="toast" id="toast"></div>
    </div>

    <div class="bottom">
      <button class="dark" id="btnCamera">å•Ÿå‹•ç›¸æ©Ÿ</button>
      <button id="btnFeed">é¤µé³¥ï¼ˆæ‰è½ç·šç´¢ï¼‰</button>
      <button class="dark" id="btnScan" disabled>æƒæç·šç´¢å¡</button>
      <button class="btnPrimary" id="btnQuiz" disabled>é–‹å§‹è¾¨èªï¼ˆ1/5ï¼‰</button>
      <button class="dark" id="btnReset">é‡ç½®é€²åº¦</button>
    </div>
  </div>

  <div class="feedOverlay" id="feedOverlay" aria-hidden="true">
    <div class="feedCard">
      <div class="feedTitle">é¤µé£Ÿä¸­...</div>
      <div class="feedAnimBox">
        <div class="seed s1"></div>
        <div class="seed s2"></div>
        <div class="seed s3"></div>
        <div class="seed s4"></div>
        <div class="bowl"></div>
      </div>
      <div class="feedSub" id="feedSubText">æ­£åœ¨å°‹æ‰¾åˆé©çš„ç·šç´¢å¡...</div>
    </div>
  </div>

  <div class="modal hidden" id="quizModal">
    <div class="box">
      <div class="boxHeader">
        <div class="title" id="quizTitle">è¾¨èªé³¥é¡</div>
        <button class="xbtn" id="closeQuiz">Ã—</button>
      </div>
      <div class="stepDots" id="stepDots"></div>
      <div class="content">
        <div class="clueBox" id="clueBox"></div>
        <div class="grid" id="optionsGrid"></div>
      </div>
      <div class="footer">
        <div class="left"><button class="btnSmall" id="btnHintQuiz" style="padding:10px; border-radius:12px; background:white; border:1px solid #ddd;">AI æç¤º</button></div>
        <button class="dark" id="btnCloseQuiz2" style="background:#eee; color:#333; padding:10px 16px; border-radius:12px;">é—œé–‰</button>
      </div>
    </div>
  </div>

  <div class="modal hidden" id="scanOverlay">
    <div class="box" style="max-width:720px;">
      <div class="boxHeader">
        <div class="title">æƒæç·šç´¢å¡</div>
        <button class="xbtn" id="btnStopScan">Ã—</button>
      </div>
      <div class="content">
        <div class="scanWrap">
          <div class="scanPreviewBox">
            <div class="scanBadge">æƒæä¸­â€¦</div>
            <canvas id="scanPreview" width="960" height="540"></canvas>
          </div>
          <div class="clueBox" id="scanHintText"></div>
          <div style="font-size:13px;color:var(--muted);">ç›®å‰éœ€è¦ï¼š<strong id="scanNeedText">â€”</strong></div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal hidden" id="assembleModal">
    <div class="box">
      <div class="boxHeader"><div class="title">å·²æ‹¼ä¸Šéƒ¨ä½</div><button class="xbtn" id="closeAssemble">Ã—</button></div>
      <div style="padding:20px; text-align:center;">
        <div id="assembleBird"></div>
        <div id="assembleSummary" style="margin:15px 0; color:var(--muted);"></div>
        <button class="btnPrimary" id="btnAssembleNext" style="width:100%; padding:14px; border-radius:14px;">ä¸‹ä¸€æ­¥</button>
      </div>
    </div>
  </div>

  <div class="modal hidden" id="revealModal">
    <div class="box">
      <div class="boxHeader"><div class="title">å®Œæˆï¼</div><button class="xbtn" id="closeReveal">Ã—</button></div>
      <div style="padding:20px; text-align:center;">
        <h2 id="revealName">é³¥å</h2>
        <div id="revealBird"></div>
        <p id="revealSummary" style="margin:15px 0;"></p>
        <button class="btnPrimary" id="btnReplay" style="padding:12px 24px; border-radius:12px;">å†ç©ä¸€æ¬¡</button>
      </div>
    </div>
  </div>
</div>

<script>
/** ===========================
 * Data & Config
 * =========================== */
const STEPS = [
  { key:"legs", label:"è…³" },
  { key:"body", label:"èº«é«”" },
  { key:"wing", label:"ç¿…è†€" },
  { key:"tail", label:"å°¾å·´" },
  { key:"head", label:"é ­/è¨˜è™Ÿ" },
];

const BIRDS = {
  sparrow: {
    name:"éº»é›€", sub:"demo",
    summary:"éº»é›€å¸¸è¦‹æ–¼äººé¡å±…ä½ç’°å¢ƒï¼Œèº«é«”è¤è‰²å¸¶ç´‹ï¼Œç¿…çŸ­åœ“ã€‚è§€å¯Ÿé‡é»ï¼šèƒŒéƒ¨æ¢ç´‹èˆ‡å°¾ç«¯å½¢ç‹€ã€‚",
    palette:{ body:"#b07a45", belly:"#e6d3b2", wing:"#6a4529", tail:"#7a5637", head:"#b07a45", legs:"#6b4a2f", beak:"#c89c4a" },
    cluePool:{
      legs:["è…³çŸ­çŸ­ã€åè¤è‰²ï¼Œèµ°è·³å¾ˆéˆæ´»ã€‚"],
      body:["èº«é«”è¤è‰²ï¼ŒèƒŒä¸Šæœ‰æ·±è‰²æ¢ç´‹æ„Ÿã€‚"],
      wing:["ç¿…è†€çŸ­åœ“ï¼Œå¸¸è¦‹æ·¡è‰²ç¿¼å¸¶ã€‚"],
      tail:["å°¾å·´ä¸­ç­‰é•·åº¦ï¼Œæœ«ç«¯åå¹³ã€‚"],
      head:["é ­éƒ¨ç´ è‰²æ£•ï¼Œæ²’æœ‰ç™½çœ¼åœˆæˆ–é …éŠæ–‘ã€‚"],
    },
    quiz:{
      legs:{ prompt:"æ­¥é©Ÿ 1ï¼ˆè…³ï¼‰ï¼šé¸å‡ºæ­£ç¢ºè…³å‹", options:["pink","brown","black","long"], correct:"brown" },
      body:{ prompt:"æ­¥é©Ÿ 2ï¼ˆèº«é«”ï¼‰ï¼šé¸å‡ºæ­£ç¢ºèº«é«”", options:["sparrow","dove","bulbul","whiteeye"], correct:"sparrow" },
      wing:{ prompt:"æ­¥é©Ÿ 3ï¼ˆç¿…è†€ï¼‰ï¼šé¸å‡ºæ­£ç¢ºç¿…è†€", options:["roundBar","shortRound","greenSmall","longPoint"], correct:"roundBar" },
      tail:{ prompt:"æ­¥é©Ÿ 4ï¼ˆå°¾å·´ï¼‰ï¼šé¸å‡ºæ­£ç¢ºå°¾å·´", options:["square","shortRound","fork","longRound"], correct:"square" },
      head:{ prompt:"æ­¥é©Ÿ 5ï¼ˆé ­ï¼‰ï¼šé¸å‡ºæ­£ç¢ºé ­éƒ¨", options:["plainBrown","whiteEyeRing","whiteHead","spottedNeck"], correct:"plainBrown" },
    }
  }
};

const birdKey = new URLSearchParams(location.search).get("bird") || "sparrow";
const bird = BIRDS[birdKey] || BIRDS.sparrow;

let state = {
  clues: {},
  solved: {},
  currentStep: 0,
  assembledCount: 0,
  pendingPart: null,
  cameraOn: false,
  hintLeft: 2
};

const $ = (id)=>document.getElementById(id);

/** ===========================
 * UI Functions
 * =========================== */
function showToast(msg){
  const t = $("toast");
  t.textContent = msg;
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"), 2500);
}

function renderCounters(){
  $("clueCount").textContent = Object.keys(state.clues).length;
  $("pendingText").textContent = state.pendingPart ? STEPS.find(s=>s.key===state.pendingPart).label : "â€”";
  $("btnScan").disabled = !state.pendingPart;
  $("btnQuiz").disabled = Object.keys(state.clues).length < 5 || !!state.pendingPart;
  $("hintLeft").textContent = state.hintLeft;

  const nextIdx = STEPS.findIndex(s=>!state.solved[s.key]);
  $("btnQuiz").textContent = `é–‹å§‹è¾¨èªï¼ˆ${(nextIdx===-1?5:nextIdx+1)}/5ï¼‰`;
}

function renderChips(){
  const container = $("clueChips");
  container.innerHTML = "";
  STEPS.forEach(s=>{
    const div = document.createElement("div");
    div.className = "chip";
    div.textContent = state.clues[s.key] ? `âœ… ${s.label}` : (state.pendingPart === s.key ? `ğŸ”¶ å¾…æƒ` : `â¬š ${s.label}`);
    container.appendChild(div);
  });
}

/** ===========================
 * Feed Animation (The Modified Part)
 * =========================== */
function feedBird(){
  if(state.pendingPart){
    showFeedOverlay(state.pendingPart);
    return;
  }
  const missing = STEPS.map(s=>s.key).filter(k=>!state.clues[k]);
  if(missing.length === 0){
    showToast("ç·šç´¢å·²é›†æ»¿ï¼");
    return;
  }
  const part = missing[Math.floor(Math.random()*missing.length)];
  state.pendingPart = part;
  showFeedOverlay(part);
}

function showFeedOverlay(partKey){
  const label = STEPS.find(s=>s.key===partKey).label;
  const overlay = $("feedOverlay");
  const subText = $("feedSubText");
  
  subText.textContent = `æ‰è½ä¸€å¼µç·šç´¢å¡ï¼š${bird.name}ï½œ${label}`;
  overlay.classList.add("show");
  overlay.setAttribute("aria-hidden","false");

  setTimeout(() => {
    overlay.classList.remove("show");
    overlay.setAttribute("aria-hidden","true");
    renderCounters();
    renderChips();
    openScan(); // å‹•ç•«å®Œç•¢ç›´æ¥é–‹å•Ÿæƒæ
  }, 1100);
}

/** ===========================
 * Camera & Scan
 * =========================== */
async function startCamera(){
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
    $("camera").srcObject = stream;
    state.cameraOn = true;
    $("btnCamera").textContent = "ç›¸æ©Ÿå·²å•Ÿå‹•";
    $("btnCamera").disabled = true;
  } catch(e) { showToast("ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿ"); }
}

function openScan(){
  if(!state.cameraOn) { startCamera(); return; }
  $("scanOverlay").classList.remove("hidden");
  $("scanNeedText").textContent = `${bird.name}ï½œ${STEPS.find(s=>s.key===state.pendingPart).label}`;
  $("scanHintText").textContent = bird.cluePool[state.pendingPart][0];
  // é€™è£¡æ‡‰æœ‰ jsQR æƒæè¿´åœˆï¼Œç°¡åŒ–ç‚ºé»æ“Š canvas æ¨¡æ“¬æˆåŠŸ (æˆ–ä½¿ç”¨åŸæœ¬ index.html çš„ scanLoop)
  // æ­¤è™•ä¿ç•™åŸæœ¬ scanLoop çš„èª¿ç”¨é‚è¼¯å³å¯
}

// æ¨¡æ“¬ç²å¾—ç·šç´¢ (çµ¦é–‹ç™¼æ¸¬è©¦ç”¨ï¼Œå¯¦éš›æ‡‰ç”± jsQR è§¸ç™¼)
function grantClue(part){
  state.clues[part] = { text: bird.cluePool[part][0] };
  state.pendingPart = null;
  renderCounters();
  renderChips();
  $("scanOverlay").classList.add("hidden");
  showToast("ç²å¾—ç·šç´¢ï¼");
}

/** ===========================
 * Init & Basic Events
 * =========================== */
$("btnCamera").onclick = startCamera;
$("btnFeed").onclick = feedBird;
$("btnStopScan").onclick = ()=> $("scanOverlay").classList.add("hidden");
$("btnReset").onclick = ()=> location.reload();

// é»æ“Šæƒæç•«é¢æ¨¡æ“¬æƒåˆ°æ­£ç¢ºçš„å¡ç‰‡ (ä¾›æ¸¬è©¦)
$("scanPreview").onclick = ()=> {
  if(state.pendingPart) grantClue(state.pendingPart);
};

// åˆå§‹ç•«é¢è¼‰å…¥
$("birdName").textContent = bird.name;
$("birdSub").textContent = bird.sub;
renderCounters();
renderChips();
// æ­¤è™•çœç•¥äº†ç¹ªè£½ SVG çš„å‡½æ•¸ renderBirdï¼Œå»ºè­°ä¿ç•™ä½ åŸæœ¬æª”æ¡ˆä¸­çš„ renderBird, tailShape, headShape ç­‰ç¹ªåœ–å‡½å¼

</script>
</body>
</html>
