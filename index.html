<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Bird Builder AR Demo</title>

  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

  <style>
    :root{
      --bg:#0b1220;
      --panel:#f4ecd8;
      --panel2:#efe3c6;
      --ink:#2b2b2b;
      --muted:#6b6256;
      --accent:#f0c14b;
      --good:#2e7d32;
      --bad:#c62828;
      --shadow: 0 18px 40px rgba(0,0,0,.35);
      --radius:18px;
    }
    *{box-sizing:border-box;font-family: ui-sans-serif, system-ui, -apple-system, "PingFang TC", "Noto Sans TC", "Microsoft JhengHei", sans-serif;}
    body{margin:0;background:var(--bg);color:#fff;overflow:hidden;}
    #app{position:relative;height:100dvh;width:100vw;background:#000;}
    video#camera{
      position:absolute;inset:0;width:100%;height:100%;object-fit:cover;
      filter:saturate(1.05) contrast(1.05);
      background:#000; z-index: 1;
    }
    #overlay{position:absolute;inset:0;display:flex;flex-direction:column;justify-content:space-between;padding:14px;pointer-events:none; z-index: 10;}
    
    .topbar{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;}
    .pill{
      pointer-events:auto;
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;border-radius:999px;
      background:rgba(20,20,20,.55);backdrop-filter: blur(8px);
      border:1px solid rgba(255,255,255,.12);
      font-size:14px;
    }
    .pill strong{font-weight:800;}

    .stage{ pointer-events:none; display:flex; align-items:center; justify-content:center; min-height:44vh; }
    .birdCard{
      pointer-events:none; width:min(520px,92vw); background:rgba(20,20,20,.28);
      border:1px solid rgba(255,255,255,.14); border-radius:26px; padding:14px;
      backdrop-filter: blur(10px); box-shadow: var(--shadow); display:flex; flex-direction:column; align-items:center; gap:10px;
    }
    .birdCanvas svg{width:min(420px,86vw);height:auto;}
    .hintRow{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
    .chip{ background:rgba(255,255,255,.14); padding:6px 10px; border-radius:999px; font-size:12px; }

    .bottom{
      pointer-events:auto; display:flex; gap:10px; flex-wrap:wrap; justify-content:center;
      padding-bottom: calc(8px + env(safe-area-inset-bottom));
    }
    button{
      border:0; border-radius:16px; padding:12px 14px; font-size:15px;
      background:#ffffff; color:#111; box-shadow: 0 10px 18px rgba(0,0,0,.25); cursor:pointer;
    }
    button.dark{ background:rgba(255,255,255,.16);color:#fff; border:1px solid rgba(255,255,255,.18); backdrop-filter: blur(8px); }
    button:disabled{opacity:.45;cursor:not-allowed;}

    /* 餵食動畫 Overlay */
    .feedOverlay{
      position:fixed; inset:0; display:none; align-items:center; justify-content:center;
      z-index:100; background: rgba(0,0,0,.35); backdrop-filter: blur(4px);
    }
    .feedOverlay.show{ display:flex; }
    .feedCard{
      width: min(340px, 90vw); background: rgba(255,255,255,.95); border-radius: 24px;
      padding: 20px; text-align:center; color: #111; box-shadow: var(--shadow);
    }
    .feedAnimBox{ position:relative; height: 120px; margin: 10px auto; width: 180px; }
    .bowl{
      position:absolute; left:50%; bottom: 5px; width: 120px; height: 40px; transform: translateX(-50%);
      border-radius: 0 0 50px 50px; border: 3px solid rgba(163,58,42,.65); border-top: 0; background: rgba(163,58,42,.1);
    }
    .seed{
      position:absolute; width: 10px; height: 10px; border-radius: 999px; background: rgba(163,58,42,.9);
      top: 0px; left: 50%; transform: translateX(-50%); animation: fall 0.8s ease-in infinite; opacity:0;
    }
    .seed.s1{ left: 35%; animation-delay: .00s; }
    .seed.s2{ left: 50%; animation-delay: .12s; }
    .seed.s3{ left: 62%; animation-delay: .22s; }
    @keyframes fall{
      0%{ transform: translate(-50%, 0); opacity: 0; }
      15%{ opacity: 1; }
      70%{ transform: translate(-50%, 85px); opacity: 1; }
      100%{ transform: translate(-50%, 85px) scale(0.5); opacity: 0; }
    }

    /* AI 引導 Modal */
    .guidanceModal {
      position:fixed; inset:0; z-index:200; display:none; align-items:center; justify-content:center;
      background:rgba(0,0,0,0.6); backdrop-filter:blur(5px);
    }
    .guidanceModal.show { display:flex; }
    .guidanceBox {
      width:min(400px, 90vw); background:var(--panel); color:#111; border-radius:24px;
      padding:24px; box-shadow:var(--shadow); display:flex; flex-direction:column; gap:20px;
    }
    .aiText { font-size:17px; line-height:1.5; font-weight:600; min-height:60px; color: var(--ink); }
    .optionGroup { display:none; gap:10px; }
    .optionGroup.show { display:flex; }
    .optBtn {
      flex:1; padding:12px; border-radius:12px; border:2px solid #ddd;
      background:#fff; cursor:pointer; font-weight:bold;
    }

    /* 掃描 Modal */
    .modal{ position:fixed; inset:0; background:rgba(0,0,0,.55); display:flex; align-items:center; justify-content:center; padding:14px; z-index:150; }
    .hidden{ display:none !important; }
    .box{ width:min(780px,96vw); background:var(--panel); border-radius:22px; overflow:hidden; color: #111; }
    .boxHeader{ display:flex; align-items:center; justify-content:space-between; padding:14px; border-bottom:1px solid rgba(0,0,0,.08); }
    .scanPreviewBox { width:100%; border-radius:18px; overflow:hidden; position:relative; background:#000; }
    canvas#scanPreview { width:100%; height:auto; display:block; }
    #scanFeedback { position:absolute; inset:0; border:6px solid transparent; pointer-events:none; transition:0.3s; z-index: 5; }

    .toast{
      position:absolute; left:50%; transform:translateX(-50%); bottom:118px;
      background:rgba(0,0,0,.70); color:#fff; padding:10px 14px; border-radius:999px;
      opacity:0; transition:opacity .2s; z-index: 1000;
    }
    .toast.show{ opacity:1; }
  </style>
</head>

<body>
<div id="app">
  <video id="camera" autoplay playsinline muted></video>

  <div id="overlay">
    <div class="topbar">
      <div class="pill"><strong id="birdName">鳥</strong> <span id="birdSub">demo</span></div>
      <div class="pill">
        線索 <strong id="clueCount">0</strong>/5
        <span style="opacity:.6">|</span>
        待掃 <strong id="pendingText">—</strong>
        <span style="opacity:.6">|</span>
        AI 提示 <strong id="hintLeft">2</strong>/2
      </div>
    </div>

    <div class="stage">
      <div class="birdCard">
        <div class="birdCanvas" id="birdCanvas"></div>
        <div class="hintRow" id="clueChips"></div>
      </div>
      <div class="toast" id="toast"></div>
    </div>

    <div class="bottom">
      <button class="dark" id="btnCamera">啟動相機</button>
      <button id="btnFeed">餵鳥（掉落線索）</button>
      <button class="dark" id="btnScan" disabled>掃描線索卡</button>
      <button class="btnPrimary" id="btnQuiz" disabled>開始辨認</button>
      <button class="dark" id="btnReset">重置進度</button>
    </div>
  </div>

  <div class="feedOverlay" id="feedOverlay">
    <div class="feedCard">
      <div style="font-weight:900; font-size:18px;">餵食中...</div>
      <div class="feedAnimBox">
        <div class="seed s1"></div><div class="seed s2"></div><div class="seed s3"></div>
        <div class="bowl"></div>
      </div>
      <div style="color:rgba(0,0,0,0.6); font-size:14px;">掉落一張線索卡...</div>
    </div>
  </div>

  <div class="guidanceModal" id="guidanceModal">
    <div class="guidanceBox">
      <div style="font-size:13px; color:#7a5200; font-weight:bold;">✨ AI 助教引導</div>
      <div class="aiText" id="aiText"></div>
      <div class="optionGroup" id="optionGroup">
        <button class="optBtn" id="optA"></button>
        <button class="optBtn" id="optB"></button>
      </div>
      <button id="guidanceNext" class="hidden" style="padding:12px; background:#111; color:#fff; border-radius:12px; border:none;">知道了，去掃描！</button>
    </div>
  </div>

  <div class="modal hidden" id="scanOverlay">
    <div class="box">
      <div class="boxHeader">
        <div style="font-weight:900;">掃描線索卡</div>
        <button onclick="closeScan()" style="background:none; border:none; font-size:24px;">×</button>
      </div>
      <div style="padding:14px; display:flex; flex-direction:column; gap:10px;">
        <div class="scanPreviewBox">
          <canvas id="scanPreview" width="640" height="480"></canvas>
          <div id="scanFeedback"></div>
        </div>
        <div id="scanHintText" style="background:#f9f9f9; padding:12px; border-radius:12px; font-size:14px;"></div>
        <div style="font-size:12px; color:#666;">目前需要：<strong id="scanNeedText"></strong></div>
      </div>
    </div>
  </div>

</div>

<script>
/** ===========================
 * 資料結構 (JSON)
 * =========================== */
const BIRDS = {
  sparrow: {
    name: "麻雀",
    palette: { body:"#b07a45", belly:"#e6d3b2", wing:"#6a4529", tail:"#7a5637", head:"#b07a45", legs:"#6b4a2f", beak:"#c89c4a" },
    guidance: {
      legs: {
        question: "這隻鳥要掉落『腳』的線索了！你覺得觀察鳥類的腳，『顏色』還是『長短』比較容易分辨出它？",
        options: [
          { text: "顏色", correct: true, feedback: "沒錯！顏色是關鍵。這隻鳥的腳是褐色的，快去找這張線索卡！" },
          { text: "長短", correct: false, feedback: "觀察長短也不錯！但這隻鳥的顏色更有特色。它是褐色的，去找找看吧！" }
        ]
      },
      body: {
        question: "『身體』要出現了！你覺得應該注意『羽毛的條紋』還是『鳥的胖瘦』？",
        options: [
          { text: "羽毛條紋", correct: true, feedback: "正確！麻雀背部有明顯的黑色條紋。去找這張卡吧！" },
          { text: "胖瘦", correct: false, feedback: "胖瘦會隨季節改變喔～看背部的黑色條紋會更準確！" }
        ]
      },
      wing: {
        question: "這張是『翅膀』線索！你覺得看『有沒有白點斑紋』還是『羽毛長度』更專業？",
        options: [
          { text: "斑紋", correct: true, feedback: "太棒了！翅膀上有淡色的翼帶，是麻雀的重要特徵！" },
          { text: "羽毛長度", correct: false, feedback: "長度很難用肉眼量啦～看翅膀上的兩條淡色翼帶會更明顯喔！" }
        ]
      },
      tail: {
        question: "找『尾巴』時，你覺得要看『末端平不平』還是『會不會翹起來』？",
        options: [
          { text: "末端形狀", correct: true, feedback: "沒錯！麻雀的尾巴末端比較平，像方尾。去找找看！" },
          { text: "會不會翹", correct: false, feedback: "翹不翹是動作，看它末端平平的「方尾」特徵才科學喔！" }
        ]
      },
      head: {
        question: "最後是『頭部』，你覺得『有沒有白眼圈』還是『嘴巴長短』比較好認？",
        options: [
          { text: "有沒有眼圈", correct: true, feedback: "專業！麻雀沒有白眼圈，但臉頰有黑斑。快去確認！" },
          { text: "嘴巴長短", correct: false, feedback: "嘴巴大家都差不多～看它沒有白眼圈且臉頰有黑斑才是重點！" }
        ]
      }
    }
  }
};

const STEPS = ["legs", "body", "wing", "tail", "head"];
const labels = { legs:"腳", body:"身體", wing:"翅膀", tail:"尾巴", head:"頭/記號" };

let state = {
  clues: {},
  pendingPart: null,
  currentBird: BIRDS.sparrow,
  cameraOn: false
};

const $ = (id) => document.getElementById(id);

/** ===========================
 * 鏡頭邏輯 (修正黑畫面)
 * =========================== */
async function startCamera() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
    $("camera").srcObject = stream;
    state.cameraOn = true;
    $("btnCamera").innerText = "相機已啟動";
    $("btnCamera").disabled = true;
  } catch(e) { showToast("無法啟動相機"); }
}

function scanLoop() {
  if (!$("scanOverlay").classList.contains("hidden")) {
    const video = $("camera");
    const canvas = $("scanPreview");
    const ctx = canvas.getContext("2d");

    if (video.readyState === video.HAVE_ENOUGH_DATA) {
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const code = jsQR(imageData.data, imageData.width, imageData.height);

      if (code) {
        $("scanFeedback").style.borderColor = "#2e7d32";
        // 模擬掃描成功
        if (code.data.includes(state.pendingPart) || code.data.length > 0) {
            setTimeout(() => grantClue(state.pendingPart), 500);
        }
      } else {
        $("scanFeedback").style.borderColor = "transparent";
      }
    }
    requestAnimationFrame(scanLoop);
  }
}

/** ===========================
 * UI 流程 (餵食 -> 引導 -> 掃描)
 * =========================== */
function showToast(msg) {
  const t = $("toast"); t.innerText = msg; t.classList.add("show");
  setTimeout(() => t.classList.remove("show"), 2500);
}

$("btnFeed").onclick = () => {
  const missing = STEPS.filter(s => !state.clues[s]);
  if (missing.length === 0) return showToast("線索已集滿！");
  
  state.pendingPart = missing[0];
  $("feedOverlay").classList.add("show");
  setTimeout(() => {
    $("feedOverlay").classList.remove("show");
    showAiGuidance(state.pendingPart);
  }, 1200);
};

function typeWriter(el, text, callback) {
  el.innerText = ""; let i = 0;
  const timer = setInterval(() => {
    if (i < text.length) { el.innerText += text[i++]; }
    else { clearInterval(timer); if(callback) callback(); }
  }, 40);
}

function showAiGuidance(part) {
  const data = state.currentBird.guidance[part];
  $("guidanceModal").classList.add("show");
  $("optionGroup").classList.remove("show");
  $("guidanceNext").classList.add("hidden");

  typeWriter($("aiText"), data.question, () => {
    $("optionGroup").classList.add("show");
    $("optA").innerText = data.options[0].text;
    $("optB").innerText = data.options[1].text;
    
    $("optA").onclick = () => handleChoice(0, data);
    $("optB").onclick = () => handleChoice(1, data);
  });
}

function handleChoice(idx, data) {
  $("optionGroup").classList.remove("show");
  typeWriter($("aiText"), data.options[idx].feedback, () => {
    $("guidanceNext").classList.remove("hidden");
    $("guidanceNext").onclick = () => {
      $("guidanceModal").classList.remove("show");
      openScan();
    };
  });
}

function openScan() {
  if (!state.cameraOn) return showToast("請先啟動相機");
  $("scanOverlay").classList.remove("hidden");
  $("scanNeedText").innerText = labels[state.pendingPart];
  $("scanHintText").innerText = "請根據 AI 的引導，找出對應特徵的鳥類線索卡進行掃描。";
  requestAnimationFrame(scanLoop);
}

function closeScan() { $("scanOverlay").classList.add("hidden"); }

function grantClue(part) {
  state.clues[part] = true;
  state.pendingPart = null;
  closeScan();
  showToast("獲取線索成功！");
  renderUI();
}

function renderUI() {
  $("clueCount").innerText = Object.keys(state.clues).length;
  $("pendingText").innerText = state.pendingPart ? labels[state.pendingPart] : "—";
  $("btnScan").disabled = !state.pendingPart;
  $("btnQuiz").disabled = Object.keys(state.clues).length < 5;
  
  const chipContainer = $("clueChips");
  chipContainer.innerHTML = "";
  STEPS.forEach(s => {
    const div = document.createElement("div");
    div.className = "chip";
    div.innerText = state.clues[s] ? `✅ ${labels[s]}` : `⬚ ${labels[s]}`;
    chipContainer.appendChild(div);
  });
}

// 初始化
$("btnCamera").onclick = startCamera;
$("btnReset").onclick = () => location.reload();
renderUI();
</script>
</body>
</html>
