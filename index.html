<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Bird Builder AR Demo</title>

  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

  <style>
    :root{
      --bg:#0b1220;
      --panel:#f4ecd8;
      --panel2:#efe3c6;
      --ink:#2b2b2b;
      --muted:#6b6256;
      --accent:#f0c14b;
      --good:#2e7d32;
      --bad:#c62828;
      --shadow: 0 18px 40px rgba(0,0,0,.35);
      --radius:18px;
    }
    *{box-sizing:border-box;font-family: ui-sans-serif, system-ui, -apple-system, "PingFang TC", "Noto Sans TC", "Microsoft JhengHei", sans-serif;}
    body{margin:0;background:var(--bg);color:#fff;overflow:hidden;}
    #app{position:relative;height:100dvh;width:100vw;background:#000;}
    video#camera{
      position:absolute;inset:0;width:100%;height:100%;object-fit:cover;
      filter:saturate(1.05) contrast(1.05);
      background:#000;
    }
    #overlay{position:absolute;inset:0;display:flex;flex-direction:column;justify-content:space-between;padding:14px;pointer-events:none;}
    .topbar{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;}
    .pill{
      pointer-events:auto;
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;border-radius:999px;
      background:rgba(20,20,20,.55);backdrop-filter: blur(8px);
      border:1px solid rgba(255,255,255,.12);
      font-size:14px;
    }
    .pill strong{font-weight:800;}
    .stage{
      pointer-events:none;
      display:flex;align-items:center;justify-content:center;
      min-height:44vh;
    }
    .birdCard{
      pointer-events:none;
      width:min(520px,92vw);
      background:rgba(20,20,20,.28);
      border:1px solid rgba(255,255,255,.14);
      border-radius:26px;
      padding:14px;
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:10px;
    }
    .birdCanvas{width:100%;display:flex;align-items:center;justify-content:center;}
    .birdCanvas svg{width:min(420px,86vw);height:auto;}
    .hintRow{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
    .chip{
      pointer-events:none;
      background:rgba(255,255,255,.14);
      border:1px solid rgba(255,255,255,.14);
      padding:6px 10px;border-radius:999px;
      font-size:12px;
    }

    .bottom{
      pointer-events:auto;
      display:flex;gap:10px;flex-wrap:wrap;justify-content:center;
      padding-bottom: calc(8px + env(safe-area-inset-bottom));
    }
    button{
      border:0;border-radius:16px;
      padding:12px 14px;font-size:15px;
      background:#ffffff; color:#111;
      box-shadow: 0 10px 18px rgba(0,0,0,.25);
      cursor:pointer;
    }
    button.dark{
      background:rgba(255,255,255,.16);color:#fff;border:1px solid rgba(255,255,255,.18);
      backdrop-filter: blur(8px);
    }
    button:disabled{opacity:.45;cursor:not-allowed;}

    .toast{
      pointer-events:none;
      position:absolute;left:50%;transform:translateX(-50%);
      bottom:118px;
      background:rgba(0,0,0,.70);color:#fff;
      padding:10px 14px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      backdrop-filter: blur(8px);
      font-size:14px;
      opacity:0;transition:opacity .2s;
      max-width:min(92vw,640px);
      text-align:center;
      line-height:1.3;
      z-index: 100;
    }
    .toast.show{opacity:1;}

    /* Modal - Default Z-index is 50 */
    .modal{
      position:absolute;inset:0;
      background:rgba(0,0,0,.55);
      display:flex;align-items:center;justify-content:center;
      padding:14px;
      z-index:50;
    }
    
    /* Guide needs to be higher than scan overlay */
    #guideModal { z-index: 60; }

    .hidden{display:none !important;}
    .box{
      width:min(780px,96vw);
      background:var(--panel);
      color:var(--ink);
      border-radius:22px;
      box-shadow: var(--shadow);
      border:1px solid rgba(0,0,0,.08);
      overflow:hidden;
      display:flex; flex-direction:column;
    }
    .boxHeader{
      display:flex;align-items:center;justify-content:space-between;
      padding:14px 14px 10px 14px;
      background:linear-gradient(180deg, var(--panel), var(--panel2));
      border-bottom:1px solid rgba(0,0,0,.08);
    }
    .title{font-size:18px;font-weight:900;}
    .xbtn{
      width:38px;height:38px;border-radius:12px;border:0;
      background:rgba(0,0,0,.08);cursor:pointer;
      font-size:18px;line-height:1;
    }
    .stepDots{
      display:flex;gap:8px;align-items:center;flex-wrap:wrap;
      padding:10px 14px 0 14px;
    }
    .dot{
      width:34px;height:34px;border-radius:999px;
      display:flex;align-items:center;justify-content:center;
      background:rgba(0,0,0,.06);
      border:1px solid rgba(0,0,0,.10);
      font-weight:900;
      user-select:none;
    }
    .dot.active{background:var(--accent);border-color:rgba(0,0,0,.14);}
    .dot.done{background:rgba(46,125,50,.18);border-color:rgba(46,125,50,.25);color:var(--good);}

    .content{padding:12px 14px 14px 14px;display:flex;flex-direction:column;gap:10px;}
    .clueBox{
      background:rgba(255,255,255,.72);
      border:1px solid rgba(0,0,0,.08);
      border-radius:16px;
      padding:12px;
      line-height:1.35;
      white-space:pre-wrap;
    }
    .clueBox small{color:var(--muted);display:block;margin-top:6px;}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;}
    .opt{
      background:#fff;
      border:2px solid rgba(0,0,0,.10);
      border-radius:18px;
      padding:12px;
      cursor:pointer;
      display:flex;gap:10px;align-items:center;
      min-height:88px;
      transition:transform .06s ease, border-color .06s ease;
    }
    .opt:hover{transform:translateY(-1px);}
    .opt svg{width:56px;height:56px;flex:0 0 auto;}
    .opt .lbl{font-weight:900;}
    .opt .desc{font-size:12px;color:var(--muted);margin-top:3px;line-height:1.25;}
    .opt.correct{border-color:rgba(46,125,50,.55);background:rgba(46,125,50,.08);}
    .opt.wrong{border-color:rgba(198,40,40,.55);background:rgba(198,40,40,.08);}

    .footer{
      padding:12px 14px 14px 14px;
      display:flex;gap:10px;justify-content:space-between;align-items:center;
      background:linear-gradient(180deg, var(--panel2), var(--panel));
      border-top:1px solid rgba(0,0,0,.08);
      flex-wrap:wrap;
    }
    .footer .left{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
    .footer .right{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
    .kpi{font-size:13px;color:var(--muted);}

    .btnSmall{padding:10px 12px;border-radius:14px;font-size:14px;}
    .btnPrimary{background:#1b1b1b;color:#fff;}
    .btnGhost{background:#fff;color:#111;border:1px solid rgba(0,0,0,.12);box-shadow:none;}
    .btnWarn{background:#9c1d1d;color:#fff;}

    /* Reveal / Assemble */
    .revealBody{padding:14px;display:flex;flex-direction:column;gap:10px;align-items:center;}
    .revealTag{
      display:inline-flex;align-items:center;gap:8px;
      background:rgba(240,193,75,.25);
      border:1px solid rgba(0,0,0,.10);
      padding:8px 12px;border-radius:999px;
      font-weight:900;
    }
    .summary{
      width:100%;
      background:#fff;border:1px solid rgba(0,0,0,.10);
      border-radius:18px;padding:12px;line-height:1.4;
    }
    .bob{animation:bob 1.8s ease-in-out infinite;transform-origin:center;}
    @keyframes bob{0%,100%{transform:translateY(0px);}50%{transform:translateY(-6px);}}

    /* Scan preview */
    .scanWrap{width:100%;display:flex;flex-direction:column;gap:10px;}
    .scanPreviewBox{
      width:100%;
      border-radius:18px;
      overflow:hidden;
      border:1px solid rgba(0,0,0,.10);
      background:#000;
      position:relative;
      transition: border-color 0.2s;
    }
    .scanPreviewBox.error{
      border:2px solid #c62828; /* Red border on error */
    }
    canvas#scanPreview{width:100%;height:auto;display:block;}
    .scanBadge{
      position:absolute;
      left:12px;top:12px;
      background:rgba(0,0,0,.55);
      color:#fff;
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      border:1px solid rgba(255,255,255,.16);
      backdrop-filter: blur(8px);
    }
    .scanBadge.error{
      background: rgba(198,40,40,.85);
    }

    /* Feed animation */
    #feedAnim{
      position:fixed; inset:0; display:none; align-items:center; justify-content:center;
      z-index:45; background: rgba(0,0,0,.18); backdrop-filter: blur(3px); pointer-events:none;
    }
    #feedAnim.show{ display:flex; }
    #feedAnim .feedCard{
      width: min(360px, calc(100% - 32px));
      background: rgba(255,255,255,.92); border-radius: 22px;
      border: 1px solid rgba(0,0,0,.12); box-shadow: var(--shadow);
      padding: 14px 14px 16px; text-align:center;
    }
    #feedAnim .feedTitle{ font-weight:900; font-size:16px; margin-bottom:10px; }
    #feedAnim .feedSub{ color: rgba(0,0,0,.64); font-size:13px; margin-top:10px; }
    #feedAnim .feedAnim{ position:relative; height:140px; margin: 6px auto 0; width:220px; }
    #feedAnim .bowl{
      position:absolute; left:50%; bottom: 10px; width: 140px; height: 44px;
      transform: translateX(-50%); border-radius: 0 0 50px 50px;
      border: 3px solid rgba(163,58,42,.65); border-top: 0; background: rgba(163,58,42,.08);
    }
    #feedAnim .seed{
      position:absolute; width: 10px; height: 10px; border-radius: 999px;
      background: rgba(163,58,42,.9); top: 0px; left: 50%;
      transform: translateX(-50%); animation: fall 0.8s ease-in infinite;
    }
    #feedAnim .seed.s1{ left: 35%; animation-delay: .00s; }
    #feedAnim .seed.s2{ left: 50%; animation-delay: .12s; }
    #feedAnim .seed.s3{ left: 62%; animation-delay: .22s; }
    #feedAnim .seed.s4{ left: 45%; animation-delay: .32s; }
    @keyframes fall{
      0%{ transform: translate(-50%, 0) scale(.9); opacity: .0; }
      15%{ opacity: .95; }
      70%{ transform: translate(-50%, 106px) scale(1); opacity: .95; }
      100%{ transform: translate(-50%, 106px) scale(.4); opacity: 0; }
    }

    /* AI hint modal typing */
    .aiBox{
      background:#fff; border:1px solid rgba(0,0,0,.10); border-radius:18px;
      padding:12px; line-height:1.45; width:100%; min-height:100px; white-space:pre-wrap;
    }
    /* AI Options Area */
    .aiOptions{ display:grid; grid-template-columns: 1fr; gap:10px; margin-top:12px; }
    .aiOptBtn{
      background:#fff; border:2px solid rgba(0,0,0,.12); border-radius:16px;
      padding:14px; font-weight:900; font-size:15px; color: var(--ink);
      cursor:pointer; text-align:left; transition:transform .1s, background .1s;
      box-shadow: 0 4px 10px rgba(0,0,0,.05);
    }
    .aiOptBtn:active{transform:scale(0.98);}
    .aiOptBtn:hover{background:var(--panel2);}

    /* Guide / Pre-scan Modal Styles */
    .guideBtns{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px; }
    .guideBtn{
      background:#fff; border:2px solid rgba(0,0,0,.10); border-radius:16px;
      padding:16px 12px; font-weight:900; font-size:16px; color: var(--ink);
      cursor:pointer; text-align:center;
    }
    .guideBtn:active{ transform:scale(0.98); }
    .guideBtn.correct{ background:rgba(46,125,50,.1); border-color:var(--good); color:var(--good); }
    .guideBtn.wrong{ opacity:0.5; text-decoration:line-through; }

    /* Confetti Animation */
    #confettiOverlay{
      position:fixed; inset:0; pointer-events:none; z-index:200; overflow:hidden; display:none;
    }
    .confetti{
      position:absolute; width:10px; height:10px; background:#ffd700;
      top:-20px; opacity:0;
    }
    @keyframes drop-confetti{
      0%{ transform:translateY(0) rotate(0deg); opacity:1; }
      100%{ transform:translateY(110vh) rotate(720deg); opacity:0; }
    }
  </style>
</head>

<body>
<div id="app">
  <video id="camera" autoplay playsinline muted></video>

  <div id="confettiOverlay"></div>

  <div id="overlay">
    <div class="topbar">
      <div class="pill"><strong id="birdName">é³¥</strong> <span id="birdSub" style="opacity:.85"></span></div>
      <div class="pill">
        ç·šç´¢ <strong id="clueCount">0</strong>/5
        <span style="opacity:.6">|</span>
        å¾…æƒ <strong id="pendingText">â€”</strong>
        <span style="opacity:.6">|</span>
        AI æç¤º <strong id="hintLeft">âˆ</strong>
      </div>
    </div>

    <div class="stage">
      <div class="birdCard">
        <div class="birdCanvas" id="birdCanvas"></div>
        <div class="hintRow" id="clueChips"></div>
        <div style="font-size:12px;opacity:.92;text-align:center;line-height:1.35">
          æµç¨‹ï¼š<strong>é¤µé³¥</strong> â†’ ç³»çµ±æŒ‡å®šéƒ¨ä½ â†’ <strong>AI å¼•å°æå•</strong> â†’ æƒæç·šç´¢å¡ â†’ é›†æ»¿ 5 å¼µç·šç´¢ â†’ <strong>é–‹å§‹è¾¨èª</strong><br/>
          ç­”å°ä¸€é¡Œï¼šæœƒå…ˆçœ‹åˆ°<strong>æ‹¼è£çµæœ</strong>ï¼Œå†æŒ‰ã€Œä¸‹ä¸€æ­¥ã€é€²å…¥ä¸‹ä¸€é¡Œã€‚
        </div>
      </div>

      <div class="toast" id="toast"></div>

      <div id="feedAnim" aria-hidden="true">
        <div class="feedCard">
          <div class="feedTitle">é¤µé£Ÿä¸­â€¦</div>
          <div class="feedAnim" aria-hidden="true">
            <div class="seed s1"></div>
            <div class="seed s2"></div>
            <div class="seed s3"></div>
            <div class="seed s4"></div>
            <div class="bowl"></div>
          </div>
          <div class="feedSub" id="feedSubText">æ‰è½ä¸€å¼µç·šç´¢å¡</div>
          <div class="feedSub" id="feedAnimPart" style="margin-top:6px;">ç·šç´¢ï¼šâ€”</div>
        </div>
      </div>
    </div>

    <div class="bottom">
      <button class="dark" id="btnCamera">å•Ÿå‹•ç›¸æ©Ÿ</button>
      <button id="btnFeed">é¤µé³¥ï¼ˆæ‰è½ç·šç´¢ï¼‰</button>
      <button class="dark" id="btnScan" disabled>æƒæç·šç´¢å¡</button>
      <button class="btnPrimary" id="btnQuiz" disabled>é–‹å§‹è¾¨èªï¼ˆ1/5ï¼‰</button>
      <button class="dark" id="btnReset">é‡ç½®æœ¬é³¥</button>
    </div>
  </div>

  <div class="modal hidden" id="guideModal">
    <div class="box" style="max-width:600px;">
      <div class="boxHeader">
        <div class="title" id="guideTitle">AI è§€å¯Ÿå¼•å°</div>
        <button class="xbtn" id="closeGuide">Ã—</button>
      </div>
      <div class="content">
        <div class="aiBox" id="guideAiText" style="min-height:80px;">AI æ­£åœ¨åˆ†æç·šç´¢é‡é»...</div>
        <div id="guideActions">
          <div style="text-align:center;font-size:14px;color:var(--muted);margin-bottom:6px;">ä½ è¦ºå¾—å“ªå€‹è§€å¯Ÿç¶­åº¦æ›´é—œéµï¼Ÿ</div>
          <div class="guideBtns" id="guideBtns"></div>
        </div>
        <div id="guideResult" class="hidden" style="display:flex;flex-direction:column;gap:10px;align-items:center;">
          <div class="clueBox" id="guideRealClue" style="width:100%;text-align:center;font-weight:bold;"></div>
          <button class="btnPrimary" id="btnStartScanFromGuide" style="width:100%;">é–‹å•Ÿç›¸æ©Ÿæƒæ</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal hidden" id="quizModal">
    <div class="box">
      <div class="boxHeader">
        <div class="title" id="quizTitle">è¾¨èªé³¥é¡</div>
        <button class="xbtn" id="closeQuiz">Ã—</button>
      </div>
      <div class="stepDots" id="stepDots"></div>
      <div class="content">
        <div class="clueBox" id="clueBox"></div>
        <div class="grid" id="optionsGrid"></div>
      </div>
      <div class="footer">
        <div class="left">
          <div class="kpi" id="kpiText">ä¸çŸ¥é“é¸å“ªå€‹ï¼Ÿå•å• AI åŠ©æ•™</div>
          <button class="btnSmall btnGhost" id="btnHintQuiz">AI æç¤º</button>
        </div>
        <div class="right">
          <button class="btnSmall btnGhost" id="btnCloseQuiz2">é—œé–‰</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal hidden" id="aiModal">
    <div class="box" style="max-width:720px;">
      <div class="boxHeader">
        <div class="title">AI åŠ©æ•™ - è§€é»äº¤æµ</div>
        <button class="xbtn" id="closeAi">Ã—</button>
      </div>
      <div class="content">
        <div class="aiBox" id="aiText"></div>
        <div class="aiOptions" id="aiOptions" style="display:none"></div>
        <div style="display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap;margin-top:10px;">
          <button class="btnSmall btnGhost" id="aiOk">é—œé–‰</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal hidden" id="assembleModal">
    <div class="box">
      <div class="boxHeader">
        <div class="title" id="assembleTitle">å·²æ‹¼ä¸Šéƒ¨ä½</div>
        <button class="xbtn" id="closeAssemble">Ã—</button>
      </div>
      <div class="revealBody">
        <div class="revealTag" id="assembleTag">â€”</div>
        <div id="assembleBird"></div>
        <div class="summary" id="assembleSummary"></div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:center">
          <button class="btnPrimary" id="btnAssembleNext">ä¸‹ä¸€æ­¥</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal hidden" id="revealModal">
    <div class="box">
      <div class="boxHeader">
        <div class="title">å®Œæˆï¼</div>
        <button class="xbtn" id="closeReveal">Ã—</button>
      </div>
      <div class="revealBody">
        <div class="revealTag" id="revealName">é³¥å</div>
        <div id="revealBird"></div>
        <div class="summary" id="revealSummary"></div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:center">
          <button class="btnPrimary" id="btnReplay">å†ç©ä¸€æ¬¡</button>
          <button class="btnGhost" id="btnCopyLink">è¤‡è£½æ­¤é³¥é€£çµ</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal hidden" id="startOverlay">
    <div class="box" style="max-width:560px;">
      <div class="boxHeader">
        <div class="title">éœ€è¦å•Ÿç”¨ç›¸æ©Ÿ</div>
        <button class="xbtn" id="closeStartOverlay">Ã—</button>
      </div>
      <div class="content">
        <div style="font-weight:900;font-size:16px">iPhone/Safari è¦å‰‡ï¼šç›¸æ©Ÿå¿…é ˆç”±é»æ“Šè§¸ç™¼</div>
        <div style="color:var(--muted);line-height:1.45">
          è«‹é»ä¸‹æ–¹æŒ‰éˆ•å•Ÿå‹•ä¸€æ¬¡ç›¸æ©Ÿã€‚ä¹‹å¾Œä½ å°±ä¸éœ€è¦å†æŒ‰ã€Œå•Ÿå‹•ç›¸æ©Ÿã€äº†ã€‚
        </div>
        <button class="btnSmall btnPrimary" id="btnStartCameraNow">é»ä¸€ä¸‹é–‹å•Ÿç›¸æ©Ÿ</button>
      </div>
    </div>
  </div>

  <div class="modal hidden" id="scanOverlay">
    <div class="box" style="max-width:720px;">
      <div class="boxHeader">
        <div class="title">æƒæç·šç´¢å¡</div>
        <button class="xbtn" id="btnStopScan">Ã—</button>
      </div>
      <div class="content">
        <div class="scanWrap">
          <div class="scanPreviewBox" id="scanPreviewBox">
            <div class="scanBadge" id="scanBadge">æƒæä¸­â€¦</div>
            <canvas id="scanPreview" width="960" height="540"></canvas>
          </div>
          <div class="clueBox" id="scanHintText"></div>
          <div style="font-size:13px;color:var(--muted);line-height:1.45">
            ç›®å‰éœ€è¦æƒæï¼š<strong id="scanNeedText">â€”</strong><br/>
            å»ºè­°ï¼šQR ä½”ç•«é¢ 1/4 ä»¥ä¸Šã€ä¿æŒç©©å®š 1 ç§’ã€é¿å…åå…‰ã€‚
          </div>
          <div style="display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap">
            <button class="btnSmall btnGhost" id="btnStopScan2">å–æ¶ˆæƒæ</button>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>

<script>
const qs = new URLSearchParams(location.search);
const CLAIM = qs.get("claim");
const START = qs.get("start") === "1";
const BIRD_PARAM = qs.get("bird") || localStorage.getItem("bbdemo:lastBird") || "sparrow";
localStorage.setItem("bbdemo:lastBird", BIRD_PARAM);

const MYSTERY_NAME = "ç¥ç§˜é³¥";
const STORAGE_KEY = (birdKey)=>`bbdemo:state:${birdKey}`;
const deepClone = (o)=>JSON.parse(JSON.stringify(o));

const STEPS = [
  { key:"legs", label:"è…³" },
  { key:"body", label:"èº«é«”" },
  { key:"wing", label:"ç¿…è†€" },
  { key:"tail", label:"å°¾å·´" },
  { key:"head", label:"é ­/è¨˜è™Ÿ" },
];

function svgWrap(inner){ return `<svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">${inner}</svg>`; }

const OPTION_LIB = {
  legs: {
    pink:  { label:"ç²‰ç´…è…³", desc:"åç²‰ç´…ã€çŸ­è…¿", svg: svgWrap(`<path d="M24 12c3 8 1 14-4 20" stroke="#e17b86" stroke-width="4" fill="none" stroke-linecap="round"/><path d="M40 12c-3 8-1 14 4 20" stroke="#e17b86" stroke-width="4" fill="none" stroke-linecap="round"/><path d="M18 34h10" stroke="#e17b86" stroke-width="4" stroke-linecap="round"/><path d="M36 34h10" stroke="#e17b86" stroke-width="4" stroke-linecap="round"/>`) },
    black: { label:"é»‘è‰²è…³", desc:"åé»‘ã€æŠ“æç©©", svg: svgWrap(`<path d="M24 12c3 10 1 16-4 24" stroke="#1d2330" stroke-width="4" fill="none" stroke-linecap="round"/><path d="M40 12c-3 10-1 16 4 24" stroke="#1d2330" stroke-width="4" fill="none" stroke-linecap="round"/><path d="M16 40h14" stroke="#1d2330" stroke-width="4" stroke-linecap="round"/><path d="M34 40h14" stroke="#1d2330" stroke-width="4" stroke-linecap="round"/>`) },
    brown: { label:"è¤è‰²è…³", desc:"åè¤ã€çŸ­è€Œç´°", svg: svgWrap(`<path d="M24 12c3 9 1 15-4 22" stroke="#6b4a2f" stroke-width="4" fill="none" stroke-linecap="round"/><path d="M40 12c-3 9-1 15 4 22" stroke="#6b4a2f" stroke-width="4" fill="none" stroke-linecap="round"/><path d="M16 38h14" stroke="#6b4a2f" stroke-width="4" stroke-linecap="round"/><path d="M34 38h14" stroke="#6b4a2f" stroke-width="4" stroke-linecap="round"/>`) },
    long:  { label:"é•·è…¿", desc:"è…¿æ˜é¡¯è¼ƒé•·", svg: svgWrap(`<path d="M24 8c2 14 0 22-4 34" stroke="#303a4a" stroke-width="4" fill="none" stroke-linecap="round"/><path d="M40 8c-2 14 0 22 4 34" stroke="#303a4a" stroke-width="4" fill="none" stroke-linecap="round"/><path d="M14 44h18" stroke="#303a4a" stroke-width="4" stroke-linecap="round"/><path d="M32 44h18" stroke="#303a4a" stroke-width="4" stroke-linecap="round"/>`) },
  },
  body: {
    sparrow: { label:"è¤è‰²å¸¶ç´‹", desc:"èƒŒéƒ¨æœ‰æ·±è‰²æ¢ç´‹æ„Ÿ", svg: svgWrap(`<ellipse cx="32" cy="34" rx="20" ry="14" fill="#b07a45"/><path d="M18 28c6 2 12 2 20 0" stroke="#6a4529" stroke-width="3" opacity=".8"/><path d="M18 34c6 2 12 2 20 0" stroke="#6a4529" stroke-width="3" opacity=".8"/><path d="M18 40c6 2 12 2 20 0" stroke="#6a4529" stroke-width="3" opacity=".8"/>`) },
    bulbul:  { label:"ç°è¤èº«é«”", desc:"ç°è¤ã€è…¹éƒ¨è¼ƒæ·¡", svg: svgWrap(`<ellipse cx="32" cy="34" rx="20" ry="14" fill="#9d8f86"/><ellipse cx="34" cy="38" rx="16" ry="10" fill="#c6bbb4" opacity=".9"/>`) },
    dove:    { label:"åœŸè¤åç²‰", desc:"æ¨¸ç´ æº«å’Œçš„åœŸè¤è‰²", svg: svgWrap(`<ellipse cx="32" cy="34" rx="20" ry="14" fill="#c08e78"/><ellipse cx="35" cy="38" rx="15" ry="9" fill="#d8b1a1" opacity=".85"/>`) },
    drongo:  { label:"äº®é»‘èº«é«”", desc:"åé»‘ã€ç•¥æœ‰é‡‘å±¬æ„Ÿ", svg: svgWrap(`<ellipse cx="32" cy="34" rx="20" ry="14" fill="#1b1f27"/><path d="M18 30c6-4 24-4 30 0" stroke="#4a5a78" stroke-width="3" opacity=".35"/>`) },
    whiteeye:{ label:"ç¶ é»ƒèº«é«”", desc:"ç¶ é»ƒã€è…¹éƒ¨è¼ƒæ·¡", svg: svgWrap(`<ellipse cx="32" cy="34" rx="20" ry="14" fill="#8dbb3e"/><ellipse cx="34" cy="38" rx="16" ry="10" fill="#d8e58b" opacity=".9"/>`) },
  },
  wing: {
    roundBar:{ label:"åœ“ç¿¼ï¼‹æ·¡ç¿¼å¸¶", desc:"çŸ­åœ“ã€å¸¸è¦‹æ·¡è‰²ç¿¼å¸¶", svg: svgWrap(`<path d="M14 44c10-22 28-28 36-10-4 14-18 24-36 10z" fill="#6a4a2f" opacity=".85"/><path d="M18 38c10-8 18-9 26-2" stroke="#f3e7c8" stroke-width="4" stroke-linecap="round" opacity=".9"/>`) },
    shortRound:{ label:"çŸ­åœ“ç¿¼", desc:"æ•´é«”åœ“éˆã€ä¸å°–", svg: svgWrap(`<path d="M14 44c10-22 28-28 36-10-4 14-18 24-36 10z" fill="#a87956"/><path d="M18 38c10-8 18-9 26-2" stroke="#7b5a45" stroke-width="3" stroke-linecap="round" opacity=".7"/>`) },
    longPoint:{ label:"é•·å°–ç¿¼", desc:"è¼ƒé•·ã€ç¿¼ç«¯å°–", svg: svgWrap(`<path d="M12 46c18-30 34-30 40-14-8 18-24 26-40 14z" fill="#1b1f27"/><path d="M18 40c12-10 22-10 30-2" stroke="#4a5a78" stroke-width="3" stroke-linecap="round" opacity=".45"/>`) },
    greenSmall:{ label:"å°å·§ç¶ ç¿¼", desc:"åå°ã€èˆ‡èº«é«”åŒè‰²ç³»", svg: svgWrap(`<path d="M16 46c10-18 26-22 34-8-6 12-18 18-34 8z" fill="#7aa62f"/><path d="M20 40c8-6 14-6 20-1" stroke="#d8e58b" stroke-width="3" stroke-linecap="round" opacity=".8"/>`) },
  },
  tail: {
    shortRound:{ label:"çŸ­åœ“å°¾", desc:"å°¾çŸ­ã€æœ«ç«¯åœ“", svg: svgWrap(`<path d="M18 40c8-8 20-8 28 0-10 12-18 12-28 0z" fill="#8dbb3e"/>`) },
    square:   { label:"ä¸­é•·æ–¹å°¾", desc:"æœ«ç«¯åå¹³", svg: svgWrap(`<path d="M18 42h28v10c-10 4-18 4-28 0z" fill="#9d8f86"/>`) },
    longRound:{ label:"é•·åœ“å°¾", desc:"å°¾è¼ƒé•·ã€æœ«ç«¯åœ“", svg: svgWrap(`<path d="M20 34c8-10 16-10 24 0v22c-10 6-14 6-24 0z" fill="#c08e78"/>`) },
    fork:     { label:"æ·±å‰å°¾", desc:"åƒå‰ªåˆ€ï¼Œå°¾ç«¯åˆ†å‰", svg: svgWrap(`<path d="M32 22c-6 10-10 22-10 34 6-6 10-10 10-10s4 4 10 10c0-12-4-24-10-34z" fill="#1b1f27"/><path d="M32 46l-10 10" stroke="#4a5a78" stroke-width="3" opacity=".35"/><path d="M32 46l10 10" stroke="#4a5a78" stroke-width="3" opacity=".35"/>`) },
  },
  head: {
    plainBrown:{ label:"ç´ è‰²æ£•é ­", desc:"æ²’æœ‰ç™½çœ¼åœˆ/ç™½é ­/é …éŠæ–‘", svg: svgWrap(`<circle cx="28" cy="30" r="10" fill="#b07a45"/><path d="M36 30l14-6-14 0z" fill="#c89c4a"/>`) },
    whiteHead:{ label:"ç™½é ­é»‘è‡‰", desc:"é ­é ‚åç™½ã€è‡‰å´è¼ƒæ·±", svg: svgWrap(`<circle cx="28" cy="30" r="10" fill="#e9e3d8"/><path d="M22 26c6 0 12 8 12 12-10 2-14-2-18-8z" fill="#2a2f3a" opacity=".85"/><path d="M36 30l14-6-14 0z" fill="#c89c4a"/>`) },
    spottedNeck:{ label:"ç é ¸æ–‘é»", desc:"é ¸å´é»‘ç™½æ–‘åƒé …éŠ", svg: svgWrap(`<circle cx="28" cy="28" r="10" fill="#c08e78"/><path d="M24 38c6-2 12-2 18 2" stroke="#1b1f27" stroke-width="3" stroke-dasharray="2 4" opacity=".85"/><path d="M36 28l14-6-14 0z" fill="#c89c4a"/>`) },
    blackHead:{ label:"å…¨é»‘é ­", desc:"é ­éƒ¨ä¹Ÿåé»‘", svg: svgWrap(`<circle cx="28" cy="30" r="10" fill="#1b1f27"/><path d="M36 30l14-6-14 0z" fill="#303a4a"/>`) },
    whiteEyeRing:{ label:"ç™½è‰²çœ¼åœˆ", desc:"çœ¼å‘¨æœ‰æ˜é¡¯ç™½åœˆ", svg: svgWrap(`<circle cx="28" cy="30" r="10" fill="#8dbb3e"/><circle cx="28" cy="30" r="5.5" fill="none" stroke="#ffffff" stroke-width="3"/><path d="M36 30l14-6-14 0z" fill="#1b1f27"/>`) },
  }
};

const BIRDS = {
  sparrow: {
    name:"éº»é›€", sub:"demo",
    summary:"éº»é›€å¸¸è¦‹æ–¼äººé¡å±…ä½ç’°å¢ƒï¼Œèº«é«”è¤è‰²å¸¶ç´‹ï¼Œç¿…çŸ­åœ“ï¼Œæ•´é«”å°å·§ã€‚è§€å¯Ÿé‡é»ï¼šèƒŒéƒ¨æ¢ç´‹ã€ç¿¼å¸¶ã€å°¾ç«¯å½¢ç‹€ã€‚",
    palette:{ body:"#b07a45", belly:"#e6d3b2", wing:"#6a4529", tail:"#7a5637", head:"#b07a45", legs:"#6b4a2f", beak:"#c89c4a" },
    cluePool:{
      legs:["è…³çŸ­çŸ­ã€åè¤è‰²ï¼Œèµ°è·³å¾ˆéˆæ´»ã€‚","è…³ä¸ç²‰ç´…ä¹Ÿä¸ç‰¹åˆ¥é•·ï¼Œåè¤è‰²ã€‚"],
      body:["èº«é«”è¤è‰²ï¼ŒèƒŒä¸Šæœ‰æ·±è‰²æ¢ç´‹æ„Ÿã€‚","æ•´é«”æ˜¯æ¨¸ç´ çš„è¤è‰²èª¿ï¼Œæ–‘ç´‹æ˜é¡¯ã€‚"],
      wing:["ç¿…è†€çŸ­åœ“ï¼Œå¸¸è¦‹æ·¡è‰²ç¿¼å¸¶ã€‚","ç¿¼å‹ä¸å°–ï¼Œå¸¶ä¸€æ¢æ·¡è‰²ç·šã€‚"],
      tail:["å°¾å·´ä¸­ç­‰é•·åº¦ï¼Œæœ«ç«¯åå¹³ã€‚","å°¾ç«¯ä¸æ·±å‰ï¼Œè¼ƒåƒæ–¹å°¾ã€‚"],
      head:["é ­éƒ¨ç´ è‰²æ£•ï¼Œæ²’æœ‰ç™½çœ¼åœˆæˆ–ç™½é ­ã€‚","é ­é ¸æ²’æœ‰é …éŠæ–‘é»ï¼Œæ•´é«”å¾ˆæ¨¸ç´ ã€‚"],
    },
    quiz:{
      legs:{ prompt:"æ­¥é©Ÿ 1ï¼ˆè…³ï¼‰ï¼šé¸æœ€ç¬¦åˆæ•˜è¿°çš„è…³å‹ã€‚", options:["pink","brown","black","long"], correct:"brown" },
      body:{ prompt:"æ­¥é©Ÿ 2ï¼ˆèº«é«”ï¼‰ï¼šé¸æœ€ç¬¦åˆæ•˜è¿°çš„èº«é«”ã€‚", options:["sparrow","dove","bulbul","whiteeye"], correct:"sparrow" },
      wing:{ prompt:"æ­¥é©Ÿ 3ï¼ˆç¿…è†€ï¼‰ï¼šé¸æœ€ç¬¦åˆæ•˜è¿°çš„ç¿…è†€ã€‚", options:["roundBar","shortRound","greenSmall","longPoint"], correct:"roundBar" },
      tail:{ prompt:"æ­¥é©Ÿ 4ï¼ˆå°¾å·´ï¼‰ï¼šé¸æœ€ç¬¦åˆæ•˜è¿°çš„å°¾å·´ã€‚", options:["square","shortRound","fork","longRound"], correct:"square" },
      head:{ prompt:"æ­¥é©Ÿ 5ï¼ˆé ­/è¨˜è™Ÿï¼‰ï¼šé¸æœ€ç¬¦åˆæ•˜è¿°çš„é ­éƒ¨/è¨˜è™Ÿã€‚", options:["plainBrown","whiteEyeRing","whiteHead","spottedNeck"], correct:"plainBrown" },
    },
    ai:{
      legs:["å…ˆçœ‹é¡è‰²ï¼šåè¤ä¸æ˜¯ç²‰ç´…ã€‚","å†çœ‹æ¯”ä¾‹ï¼šè…¿ä¸é•·ï¼Œç·šæ¢çŸ­è€Œç´°ã€‚"],
      body:["å…ˆæŠ“ã€è¤è‰²ã€ä¸»è‰²ï¼Œå†æ‰¾ã€æ·±è‰²æ¢ç´‹æ„Ÿã€ã€‚","å¦‚æœçœ‹èµ·ä¾†åç¶ æˆ–åç°ï¼Œå°±å…ˆæ’é™¤ã€‚"],
      wing:["å…ˆçœ‹ç¿¼å‹ï¼šçŸ­åœ“ä¸æ˜¯å°–é•·ã€‚","å†æ‰¾ã€æ·¡è‰²ç¿¼å¸¶ã€é‚£æ¢ç·šã€‚"],
      tail:["å…ˆæ’é™¤æ·±å‰å°¾ï¼ˆåƒå‰ªåˆ€ï¼‰ã€‚","æœ«ç«¯åå¹³ã€è¼ƒåƒæ–¹å°¾ã€‚"],
      head:["å…ˆæ’é™¤ç™½çœ¼åœˆã€ç™½é ­ã€é …éŠæ–‘ã€‚","é¸æœ€ã€æ¨¸ç´ çš„æ£•é ­ã€ã€‚"],
    }
  },
  bulbul: {
    name:"ç™½é ­ç¿", sub:"demo",
    summary:"ç™½é ­ç¿é ­é ‚åç™½ã€è‡‰å´è¼ƒæ·±ï¼Œèº«é«”ç°è¤ã€è…¹éƒ¨è¼ƒæ·¡ã€‚è§€å¯Ÿé‡é»ï¼šç™½é ­èˆ‡è‡‰éƒ¨å°æ¯”ã€å°¾å½¢ä¸­é•·ã€‚",
    palette:{ body:"#9d8f86", belly:"#c6bbb4", wing:"#6b6256", tail:"#6b6256", head:"#e9e3d8", legs:"#1d2330", beak:"#c89c4a" },
    cluePool:{
      legs:["è…³åé»‘ï¼ŒæŠ“æå¾ˆç©©ã€‚","è…³è‰²è¼ƒæ·±ï¼Œä¸¦ä¸ç²‰ç´…ã€‚"],
      body:["èº«é«”ç°è¤ï¼Œè…¹éƒ¨è¼ƒæ·¡ã€‚","æ•´é«”ç°è¤ï¼Œä¸æ˜¯ç¶ é»ƒæˆ–äº®é»‘ã€‚"],
      wing:["ç¿…è†€æ·±è‰²ã€é‚Šç·£å¸¶æ·¡è‰²ã€‚","ç¿¼é¢åæ·±ï¼Œç·šæ¢ä¿è½ã€‚"],
      tail:["å°¾å·´ä¸­é•·ï¼Œæœ«ç«¯åæ–¹ã€‚","å°¾ä¸æ·±å‰ï¼Œé•·åº¦ä¸­ç­‰ã€‚"],
      head:["é ­é ‚åç™½ï¼Œè‡‰å´è¼ƒæ·±ã€‚","ç™½é ­æ˜¯æœ€é†’ç›®çš„ç·šç´¢ã€‚"],
    },
    quiz:{
      legs:{ prompt:"æ­¥é©Ÿ 1ï¼ˆè…³ï¼‰ï¼šé¸æœ€ç¬¦åˆæ•˜è¿°çš„è…³å‹ã€‚", options:["black","brown","pink","long"], correct:"black" },
      body:{ prompt:"æ­¥é©Ÿ 2ï¼ˆèº«é«”ï¼‰ï¼šé¸æœ€ç¬¦åˆæ•˜è¿°çš„èº«é«”ã€‚", options:["bulbul","sparrow","whiteeye","drongo"], correct:"bulbul" },
      wing:{ prompt:"æ­¥é©Ÿ 3ï¼ˆç¿…è†€ï¼‰ï¼šé¸æœ€ç¬¦åˆæ•˜è¿°çš„ç¿…è†€ã€‚", options:["roundBar","shortRound","longPoint","greenSmall"], correct:"roundBar" },
      tail:{ prompt:"æ­¥é©Ÿ 4ï¼ˆå°¾å·´ï¼‰ï¼šé¸æœ€ç¬¦åˆæ•˜è¿°çš„å°¾å·´ã€‚", options:["square","fork","longRound","shortRound"], correct:"square" },
      head:{ prompt:"æ­¥é©Ÿ 5ï¼ˆé ­/è¨˜è™Ÿï¼‰ï¼šé¸æœ€ç¬¦åˆæ•˜è¿°çš„é ­éƒ¨/è¨˜è™Ÿã€‚", options:["whiteHead","plainBrown","whiteEyeRing","blackHead"], correct:"whiteHead" },
    },
    ai:{
      legs:["å…ˆæ’é™¤ç²‰ç´…è…³ã€‚","æ·±è‰²è…³é€šå¸¸åé»‘ã€‚"],
      body:["æŠ“ã€ç°è¤ã€ä¸»è‰²ï¼‹ã€è…¹éƒ¨è¼ƒæ·¡ã€ã€‚","å…¨é»‘èˆ‡ç¶ é»ƒå…ˆæ’é™¤ã€‚"],
      wing:["ç¿¼é¢åæ·±ã€å¸¶æ·¡è‰²é‚Šç·£ã€‚","ä¸æ˜¯å°–é•·ç¿¼å‹ã€‚"],
      tail:["æ·±å‰å°¾å…ˆæ’é™¤ã€‚","æœ«ç«¯åå¹³ï¼Œåƒæ–¹å°¾ã€‚"],
      head:["æ‰¾ã€ç™½é ­ã€ï¼‹è‡‰å´è¼ƒæ·±ã€‚","ç™½çœ¼åœˆä¸æ˜¯ç™½é ­ã€‚"],
    }
  },
  dove: {
    name:"ç é ¸æ–‘é³©", sub:"demo",
    summary:"ç é ¸æ–‘é³©èº«é«”åœŸè¤åç²‰ï¼Œè…³åç²‰ç´…ï¼Œé ¸å´æœ‰é»‘ç™½æ–‘é»åƒé …éŠã€‚è§€å¯Ÿé‡é»ï¼šç é ¸æ–‘é»èˆ‡é•·åœ“å°¾ã€‚",
    palette:{ body:"#c08e78", belly:"#d8b1a1", wing:"#a87956", tail:"#c08e78", head:"#c08e78", legs:"#e17b86", beak:"#c89c4a" },
    cluePool:{
      legs:["è…³åç²‰ç´…ï¼Œä¸é•·ã€‚","ç²‰ç´…è…³æ˜¯å¾ˆæ˜é¡¯çš„ç·šç´¢ã€‚"],
      body:["èº«é«”åœŸè¤åç²‰ï¼Œæ•´é«”æ¨¸ç´ ã€‚","é¡è‰²æº«å’Œï¼Œä¸æ˜¯ç°è¤ä¹Ÿä¸æ˜¯äº®é»‘ã€‚"],
      wing:["ç¿…è†€åŒè‰²ç³»ï¼Œæ²’æœ‰é®®è±”è‰²å¡Šã€‚","ç¿¼å‹ååœ“ï¼Œä¸å°–ã€‚"],
      tail:["å°¾å·´è¼ƒé•·ï¼Œæœ«ç«¯åœ“ã€‚","å°¾ä¸æ·±å‰ï¼Œç·šæ¢æŸ”å’Œã€‚"],
      head:["é ¸å´æœ‰é»‘ç™½æ–‘é»åƒé …éŠã€‚","ç é ¸æ–‘é»æ˜¯è¾¨è­˜é‡é»ã€‚"],
    },
    quiz:{
      legs:{ prompt:"æ­¥é©Ÿ 1ï¼ˆè…³ï¼‰ï¼šé¸æœ€ç¬¦åˆæ•˜è¿°çš„è…³å‹ã€‚", options:["pink","brown","black","long"], correct:"pink" },
      body:{ prompt:"æ­¥é©Ÿ 2ï¼ˆèº«é«”ï¼‰ï¼šé¸æœ€ç¬¦åˆæ•˜è¿°çš„èº«é«”ã€‚", options:["dove","sparrow","bulbul","whiteeye"], correct:"dove" },
      wing:{ prompt:"æ­¥é©Ÿ 3ï¼ˆç¿…è†€ï¼‰ï¼šé¸æœ€ç¬¦åˆæ•˜è¿°çš„ç¿…è†€ã€‚", options:["shortRound","roundBar","longPoint","greenSmall"], correct:"shortRound" },
      tail:{ prompt:"æ­¥é©Ÿ 4ï¼ˆå°¾å·´ï¼‰ï¼šé¸æœ€ç¬¦åˆæ•˜è¿°çš„å°¾å·´ã€‚", options:["longRound","square","fork","shortRound"], correct:"longRound" },
      head:{ prompt:"æ­¥é©Ÿ 5ï¼ˆé ­/è¨˜è™Ÿï¼‰ï¼šé¸æœ€ç¬¦åˆæ•˜è¿°çš„é ­éƒ¨/è¨˜è™Ÿã€‚", options:["spottedNeck","plainBrown","whiteHead","whiteEyeRing"], correct:"spottedNeck" },
    },
    ai:{
      legs:["ç²‰ç´…è…³å¾ˆé—œéµï¼Œå…ˆçœ‹é¡è‰²ã€‚","å¦‚æœåƒé»‘è‰²æˆ–è¤è‰²ï¼Œå°±æ’é™¤ã€‚"],
      body:["åœŸè¤åç²‰ï¼Œè‰²èª¿æº«å’Œã€‚","ä¸æ˜¯ç°è¤ä¹Ÿä¸æ˜¯ç¶ é»ƒã€‚"],
      wing:["ç¿¼å‹ååœ“ï¼Œä¸å°–é•·ã€‚","åŒè‰²ç³»ã€ä¸é®®è±”ã€‚"],
      tail:["å°¾è¼ƒé•·ã€æœ«ç«¯åœ“ã€‚","æ·±å‰å°¾å…ˆæ’é™¤ã€‚"],
      head:["æ‰¾ã€é ¸å´é»‘ç™½æ–‘é»ã€åƒé …éŠã€‚","ç™½é ­/ç™½çœ¼åœˆéƒ½ä¸æ˜¯ã€‚"],
    }
  },
  drongo: {
    name:"å¤§å·å°¾", sub:"demo",
    summary:"å¤§å·å°¾å…¨èº«åé»‘å¸¶é‡‘å±¬å…‰æ¾¤ï¼Œå°¾å·´æ·±å‰åƒå‰ªåˆ€ã€‚è§€å¯Ÿé‡é»ï¼šæ·±å‰å°¾èˆ‡é•·å°–ç¿¼ã€‚",
    palette:{ body:"#1b1f27", belly:"#2a3342", wing:"#1b1f27", tail:"#1b1f27", head:"#1b1f27", legs:"#1d2330", beak:"#303a4a" },
    cluePool:{
      legs:["è…³é»‘è‰²ï¼Œç«™ç«‹å¾ˆéˆæ´»ã€‚","æ·±è‰²è…³ã€æŠ“æç©©ã€‚"],
      body:["å…¨èº«åé»‘ï¼Œå¸¶ä¸€é»é‡‘å±¬å…‰æ¾¤ã€‚","èº«é«”é¡è‰²å¾ˆæ·±ï¼Œå¹¾ä¹å…¨é»‘ã€‚"],
      wing:["ç¿…è†€é•·è€Œå°–ï¼Œé£›èµ·ä¾†å¾ˆä¿è½ã€‚","ç¿¼å‹åå°–é•·ã€‚"],
      tail:["å°¾å·´æ·±å‰ï¼Œåƒå‰ªåˆ€ã€‚","æ·±å‰å°¾æ˜¯æœ€é—œéµçš„è¾¨è­˜ç·šç´¢ã€‚"],
      head:["é ­éƒ¨ä¹Ÿåé»‘ï¼Œæ²’æœ‰ç™½æ–‘ã€‚","æ•´é«”æ²’æœ‰ç™½çœ¼åœˆæˆ–ç™½é ­ã€‚"],
    },
    quiz:{
      legs:{ prompt:"æ­¥é©Ÿ 1ï¼ˆè…³ï¼‰ï¼šé¸æœ€ç¬¦åˆæ•˜è¿°çš„è…³å‹ã€‚", options:["black","brown","pink","long"], correct:"black" },
      body:{ prompt:"æ­¥é©Ÿ 2ï¼ˆèº«é«”ï¼‰ï¼šé¸æœ€ç¬¦åˆæ•˜è¿°çš„èº«é«”ã€‚", options:["drongo","bulbul","sparrow","whiteeye"], correct:"drongo" },
      wing:{ prompt:"æ­¥é©Ÿ 3ï¼ˆç¿…è†€ï¼‰ï¼šé¸æœ€ç¬¦åˆæ•˜è¿°çš„ç¿…è†€ã€‚", options:["longPoint","roundBar","shortRound","greenSmall"], correct:"longPoint" },
      tail:{ prompt:"æ­¥é©Ÿ 4ï¼ˆå°¾å·´ï¼‰ï¼šé¸æœ€ç¬¦åˆæ•˜è¿°çš„å°¾å·´ã€‚", options:["fork","square","longRound","shortRound"], correct:"fork" },
      head:{ prompt:"æ­¥é©Ÿ 5ï¼ˆé ­/è¨˜è™Ÿï¼‰ï¼šé¸æœ€ç¬¦åˆæ•˜è¿°çš„é ­éƒ¨/è¨˜è™Ÿã€‚", options:["blackHead","plainBrown","whiteHead","whiteEyeRing"], correct:"blackHead" },
    },
    ai:{
      legs:["ç²‰ç´…è…³å…ˆæ’é™¤ã€‚","æ·±è‰²è…³é€šå¸¸é¸é»‘ã€‚"],
      body:["å…ˆæŠ“ã€å…¨é»‘ã€ï¼Œä¸è¦è¢«èƒŒæ™¯å½±éŸ¿ã€‚","ç°è¤/ç¶ é»ƒå…ˆæ’é™¤ã€‚"],
      wing:["å°–é•·ç¿¼ vs åœ“ç¿¼è¦åˆ†æ¸…æ¥šã€‚","ç¿¼ç«¯æ˜é¡¯è¼ƒå°–ã€‚"],
      tail:["å…ˆæ‰¾æ·±å‰å°¾ï¼ˆå‰ªåˆ€å°¾ï¼‰ã€‚","åªè¦ä¸æ˜¯æ·±å‰ï¼Œå¹¾ä¹éƒ½éŒ¯ã€‚"],
      head:["ç™½é ­/ç™½çœ¼åœˆéƒ½ä¸æ˜¯ã€‚","é¸æœ€ä¹¾æ·¨çš„é»‘é ­ã€‚"],
    }
  },
  whiteeye: {
    name:"ç¶ ç¹¡çœ¼", sub:"demo",
    summary:"ç¶ ç¹¡çœ¼é«”è‰²ç¶ é»ƒï¼Œæœ€é†’ç›®æ˜¯çœ¼å‘¨ç™½è‰²çœ¼åœˆã€‚è§€å¯Ÿé‡é»ï¼šç™½çœ¼åœˆèˆ‡ç¶ é»ƒèº«é«”ã€å°¾çŸ­ã€‚",
    palette:{ body:"#8dbb3e", belly:"#d8e58b", wing:"#7aa62f", tail:"#7aa62f", head:"#8dbb3e", legs:"#1d2330", beak:"#1b1f27" },
    cluePool:{
      legs:["è…³ç´°å°åé»‘ã€‚","æ·±è‰²ç´°è…³ï¼Œä¸æ˜¯ç²‰ç´…ã€‚"],
      body:["èº«é«”ç¶ é»ƒï¼Œè…¹éƒ¨åæ·¡ã€‚","æ•´é«”åç¶ ï¼Œä¸æ˜¯è¤æˆ–ç°ã€‚"],
      wing:["ç¿…è†€å°å·§ã€èˆ‡èº«é«”åŒè‰²ç³»ã€‚","ç¿¼ä¸å°–é•·ï¼Œè‰²åç¶ ã€‚"],
      tail:["å°¾å·´çŸ­ã€‚","å°¾ç«¯ä¸é•·ï¼Œä¹Ÿä¸æ·±å‰ã€‚"],
      head:["çœ¼ç›å‘¨åœæœ‰æ˜é¡¯ç™½è‰²çœ¼åœˆã€‚","ç™½çœ¼åœˆæ˜¯æœ€é—œéµçš„ç·šç´¢ã€‚"],
    },
    quiz:{
      legs:{ prompt:"æ­¥é©Ÿ 1ï¼ˆè…³ï¼‰ï¼šé¸æœ€ç¬¦åˆæ•˜è¿°çš„è…³å‹ã€‚", options:["black","brown","pink","long"], correct:"black" },
      body:{ prompt:"æ­¥é©Ÿ 2ï¼ˆèº«é«”ï¼‰ï¼šé¸æœ€ç¬¦åˆæ•˜è¿°çš„èº«é«”ã€‚", options:["whiteeye","bulbul","sparrow","drongo"], correct:"whiteeye" },
      wing:{ prompt:"æ­¥é©Ÿ 3ï¼ˆç¿…è†€ï¼‰ï¼šé¸æœ€ç¬¦åˆæ•˜è¿°çš„ç¿…è†€ã€‚", options:["greenSmall","roundBar","shortRound","longPoint"], correct:"greenSmall" },
      tail:{ prompt:"æ­¥é©Ÿ 4ï¼ˆå°¾å·´ï¼‰ï¼šé¸æœ€ç¬¦åˆæ•˜è¿°çš„å°¾å·´ã€‚", options:["shortRound","square","fork","longRound"], correct:"shortRound" },
      head:{ prompt:"æ­¥é©Ÿ 5ï¼ˆé ­/è¨˜è™Ÿï¼‰ï¼šé¸æœ€ç¬¦åˆæ•˜è¿°çš„é ­éƒ¨/è¨˜è™Ÿã€‚", options:["whiteEyeRing","plainBrown","whiteHead","blackHead"], correct:"whiteEyeRing" },
    },
    ai:{
      legs:["ç²‰ç´…è…³å…ˆæ’é™¤ã€‚","æ·±è‰²ç´°è…³é€šå¸¸åé»‘ã€‚"],
      body:["ç¶ é»ƒæ˜¯æœ€å¤§ç‰¹å¾µã€‚","ç°è¤èˆ‡å…¨é»‘éƒ½ä¸æ˜¯ã€‚"],
      wing:["æŒ‘æœ€å°å·§ã€åç¶ çš„ç¿…è†€ã€‚","ä¸è¦é¸å°–é•·ç¿¼ã€‚"],
      tail:["å°¾çŸ­ï¼Œæ·±å‰å°¾å…ˆæ’é™¤ã€‚","æ–¹å°¾æ¯”çŸ­åœ“å°¾æ›´ç›´ã€‚"],
      head:["çœ‹åˆ°ç™½çœ¼åœˆå°±é¸å®ƒã€‚","ç™½é ­ä¸æ˜¯ç™½çœ¼åœˆã€‚"],
    }
  }
};

function getBirdByKey(key){ return BIRDS[key] || BIRDS.sparrow; }
const birdKey = BIRD_PARAM;
const bird = getBirdByKey(birdKey);

const DEFAULT_STATE = {
  clues: {},
  solved: {},
  currentStep: 0,
  assembledCount: 0,
  hintLeft: 2,
  usedHints: {},
  pendingPart: null,
  cameraOn: false,
};

let state = deepClone(DEFAULT_STATE);

function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY(birdKey));
    if(!raw) return;
    const parsed = JSON.parse(raw);
    state = { ...deepClone(DEFAULT_STATE), ...parsed };
  }catch(e){}
}
function saveState(){
  try{ localStorage.setItem(STORAGE_KEY(birdKey), JSON.stringify(state)); }catch(e){}
}
function resetState(){
  state = deepClone(DEFAULT_STATE);
  saveState();
}

const $ = (id)=>document.getElementById(id);

const elBirdName = $("birdName");
const elBirdSub = $("birdSub");
const elClueCount = $("clueCount");
const elPendingText = $("pendingText");
const elHintLeft = $("hintLeft");
const elBirdCanvas = $("birdCanvas");
const elClueChips = $("clueChips");
const toast = $("toast");
const feedAnim = $("feedAnim");

const btnCamera = $("btnCamera");
const btnFeed = $("btnFeed");
const btnScan = $("btnScan");
const btnQuiz = $("btnQuiz");
const btnReset = $("btnReset");

const quizModal = $("quizModal");
const stepDots = $("stepDots");
const clueBox = $("clueBox");
const optionsGrid = $("optionsGrid");
const closeQuiz = $("closeQuiz");
const btnCloseQuiz2 = $("btnCloseQuiz2");
const quizTitle = $("quizTitle");
const btnHintQuiz = $("btnHintQuiz");

const aiModal = $("aiModal");
const aiText = $("aiText");
const closeAi = $("closeAi");
const aiOk = $("aiOk");
const aiOptions = $("aiOptions");

const guideModal = $("guideModal");
const guideTitle = $("guideTitle");
const guideAiText = $("guideAiText");
const guideBtns = $("guideBtns");
const guideResult = $("guideResult");
const guideRealClue = $("guideRealClue");
const btnStartScanFromGuide = $("btnStartScanFromGuide");
const closeGuide = $("closeGuide");
const guideActions = $("guideActions"); 

const assembleModal = $("assembleModal");
const assembleTitle = $("assembleTitle");
const assembleTag = $("assembleTag");
const assembleBird = $("assembleBird");
const assembleSummary = $("assembleSummary");
const closeAssemble = $("closeAssemble");
const btnAssembleNext = $("btnAssembleNext");

const revealModal = $("revealModal");
const revealName = $("revealName");
const revealBird = $("revealBird");
const revealSummary = $("revealSummary");
const closeReveal = $("closeReveal");
const btnReplay = $("btnReplay");
const btnCopyLink = $("btnCopyLink");

const startOverlay = $("startOverlay");
const btnStartCameraNow = $("btnStartCameraNow");
const closeStartOverlay = $("closeStartOverlay");

const scanOverlay = $("scanOverlay");
const scanPreviewBox = $("scanPreviewBox");
const scanHintText = $("scanHintText");
const scanNeedText = $("scanNeedText");
const scanBadge = $("scanBadge");
const btnStopScan = $("btnStopScan");
const btnStopScan2 = $("btnStopScan2");
const scanPreview = $("scanPreview");
const scanPctx = scanPreview.getContext("2d", { willReadFrequently:true });

let toastTimer = 0;
function showToast(msg, ms=2600){
  toast.textContent = msg;
  toast.classList.add("show");
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=>toast.classList.remove("show"), ms);
}

async function startCamera(silent=false){
  try{
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { ideal:"environment" } },
      audio:false
    });
    $("camera").srcObject = stream;
    state.cameraOn = true;
    saveState();
    if(!silent) showToast("ç›¸æ©Ÿå·²å•Ÿå‹•");
    btnCamera.textContent = "ç›¸æ©Ÿå·²å•Ÿå‹•";
    btnCamera.disabled = true;
    return true;
  }catch(e){
    if(!silent) showToast("ç›¸æ©Ÿéœ€è¦é»æ“Šæˆæ¬Šï¼šè«‹é»ä¸€ä¸‹ã€é»ä¸€ä¸‹é–‹å•Ÿç›¸æ©Ÿã€");
    return false;
  }
}

function renderChips(){
  elClueChips.innerHTML = "";
  STEPS.forEach(s=>{
    const has = !!state.clues[s.key];
    const pending = (state.pendingPart === s.key);
    const chip = document.createElement("div");
    chip.className = "chip";
    chip.textContent = has ? `âœ… ${s.label}` : (pending ? `ğŸ”¶ ${s.label}ï¼ˆå¾…æƒï¼‰` : `â¬š ${s.label}`);
    elClueChips.appendChild(chip);
  });
}

function renderCounters(){
  const count = Object.keys(state.clues).length;
  elClueCount.textContent = String(count);
  elHintLeft.textContent = "âˆ"; 
  elPendingText.textContent = state.pendingPart ? STEPS.find(s=>s.key===state.pendingPart).label : "â€”";

  btnQuiz.disabled = (count < 5) || !!state.pendingPart;
  btnScan.disabled = !state.pendingPart; 

  const nextIdx = Math.max(0, STEPS.findIndex(s=>!state.solved[s.key]));
  btnQuiz.textContent = `é–‹å§‹è¾¨èªï¼ˆ${Math.min(nextIdx+1,5)}/5ï¼‰`;
}

function renderBird(assembled){
  const pal = bird.palette;
  const showLegs = assembled >= 1;
  const showBody = assembled >= 2;
  const showWing = assembled >= 3;
  const showTail = assembled >= 4;
  const showHead = assembled >= 5;

  const svg = `
  <svg viewBox="0 0 520 260" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="bird">
    <defs>
      <filter id="soft" x="-20%" y="-20%" width="140%" height="140%">
        <feGaussianBlur stdDeviation="1.2"/>
      </filter>
    </defs>
    <ellipse cx="260" cy="210" rx="120" ry="18" fill="rgba(0,0,0,.22)" filter="url(#soft)"/>

    <g class="${assembled===5 ? "bob" : ""}">
      ${showTail ? tailShape(pal.tail) : ""}

      ${showBody ? `
        <ellipse cx="270" cy="135" rx="120" ry="70" fill="${pal.body}"/>
        <ellipse cx="290" cy="155" rx="95" ry="52" fill="${pal.belly}" opacity=".92"/>
      ` : ""}

      ${showWing ? `
        <path d="M210 165c35-78 124-98 165-40-20 70-86 110-165 40z"
              fill="${pal.wing}" opacity=".95"/>
        <path d="M230 150c60-40 105-35 130 5"
              stroke="rgba(255,255,255,.35)" stroke-width="7" stroke-linecap="round" opacity=".45"/>
      ` : ""}

      ${showLegs ? `
        <path d="M250 185c8 18 2 30-8 44" stroke="${pal.legs}" stroke-width="8" stroke-linecap="round"/>
        <path d="M290 185c-8 18-2 30 8 44" stroke="${pal.legs}" stroke-width="8" stroke-linecap="round"/>
        <path d="M222 232h40" stroke="${pal.legs}" stroke-width="8" stroke-linecap="round"/>
        <path d="M278 232h40" stroke="${pal.legs}" stroke-width="8" stroke-linecap="round"/>
      ` : ""}

      ${showHead ? headShape(pal) : ""}
    </g>
  </svg>`;
  elBirdCanvas.innerHTML = svg;
}

function animateAssemble(from, to){
  if(to <= from){
    renderBird(to);
    return;
  }
  let cur = from;
  const tick = () => {
    cur += 1;
    renderBird(cur);
    if(cur < to) setTimeout(tick, 260);
  };
  setTimeout(tick, 120);
}

function tailShape(color){
  const isFork = (bird.name === "å¤§å·å°¾");
  const isLong = (bird.name === "ç é ¸æ–‘é³©");
  const isShort = (bird.name === "ç¶ ç¹¡çœ¼");
  if(isFork){
    return `<path d="M156 108c30 26 60 52 82 78-24 4-46-2-66-18 6 22 18 42 36 60-30-8-56-28-76-58-10 30-30 54-58 70 18-24 28-50 32-78-18 18-38 26-60 24 22-24 46-48 70-78z" fill="${color}" opacity=".96"/>`;
  }
  if(isLong){
    return `<path d="M150 120c55-55 88-55 130 0v110c-55 28-75 28-130 0z" fill="${color}" opacity=".96"/>`;
  }
  if(isShort){
    return `<path d="M160 150c40-36 92-36 132 0-48 58-84 58-132 0z" fill="${color}" opacity=".96"/>`;
  }
  return `<path d="M160 145h150v65c-54 24-96 24-150 0z" fill="${color}" opacity=".96"/>`;
}

function headShape(pal){
  let mark = "";
  if(bird.name === "ç¶ ç¹¡çœ¼"){
    mark = `<circle cx="360" cy="104" r="18" fill="none" stroke="#ffffff" stroke-width="8" opacity=".95"/>`;
  }else if(bird.name === "ç™½é ­ç¿"){
    mark = `
      <ellipse cx="352" cy="96" rx="34" ry="28" fill="#e9e3d8" opacity=".95"/>
      <path d="M330 94c22 0 40 22 38 40-30 6-46-8-58-26z" fill="rgba(0,0,0,.55)" opacity=".75"/>`;
  }else if(bird.name === "ç é ¸æ–‘é³©"){
    mark = `<path d="M330 132c30-10 60-6 82 10" stroke="rgba(0,0,0,.65)" stroke-width="8" stroke-dasharray="6 10" opacity=".7"/>`;
  }
  const beak = `<path d="M392 104l54-20-54 4z" fill="${pal.beak}" opacity=".98"/>`;
  return `
    <circle cx="352" cy="104" r="34" fill="${pal.head}" opacity=".98"/>
    ${mark}
    ${beak}
    <circle cx="350" cy="104" r="6" fill="rgba(0,0,0,.7)"/>
  `;
}

function playFeedAnim(partKey){
  const step = STEPS.find(s=>s.key===partKey);
  const partLabel = step ? step.label : "â€”";
  $("feedAnimPart").textContent = `ç·šç´¢ï¼š${partLabel}`;
  
  feedAnim.classList.remove("show");
  void feedAnim.offsetWidth;
  feedAnim.classList.add("show");
  
  setTimeout(()=>{
    feedAnim.classList.remove("show");
  }, 950);
}

function getGuideText(partKey){
  const pool = bird.cluePool[partKey] || [];
  return pool[0] || "è«‹ä¾ç·šç´¢è§€å¯Ÿåœ–å¡ç‰¹å¾µã€‚";
}

function grantClue(part){
  const pool = bird.cluePool[part];
  const clue = pool[Math.floor(Math.random()*pool.length)];
  state.clues[part] = { text: clue };
  state.pendingPart = null;
  saveState();
  renderChips();
  renderCounters();
}

function feedBird(){
  if(state.pendingPart){
    playFeedAnim(state.pendingPart);
    setTimeout(()=>startPreScanGuide(state.pendingPart), 980);
    return;
  }

  const missing = STEPS.map(s=>s.key).filter(k=>!state.clues[k]);
  if(missing.length === 0){
    showToast("ç·šç´¢å·²é›†æ»¿ï¼Œå¯é–‹å§‹è¾¨èª");
    return;
  }

  const part = missing[Math.floor(Math.random()*missing.length)];
  state.pendingPart = part;
  saveState();
  renderChips();
  renderCounters();

  playFeedAnim(part);

  const targetLabel = STEPS.find(s=>s.key===part).label;
  showToast(`æ‰è½ç·šç´¢ï¼šè«‹æ‰¾ã€Œ${MYSTERY_NAME}ï½œ${targetLabel}ã€ç·šç´¢å¡`);

  setTimeout(()=>{
    startPreScanGuide(part);
  }, 980);
}

function analyzeDimension(clueText) {
  const colors = ["ç´…","ç²‰","é»‘","ç¶ ","è¤","ç™½","è‰²","äº®"];
  const shapes = ["åœ“","å°–","å‰","æ–¹","é•·","çŸ­","ç´°","ç²—","å½¢","ç‹€"];
  let cCount = 0;
  let sCount = 0;
  colors.forEach(k => { if(clueText.includes(k)) cCount++; });
  shapes.forEach(k => { if(clueText.includes(k)) sCount++; });
  if (cCount > sCount) return { type: "color", label: "é¡è‰²", wrong: "å½¢ç‹€" };
  if (sCount > cCount) return { type: "shape", label: "å½¢ç‹€", wrong: "é¡è‰²" };
  return { type: "shape", label: "å½¢ç‹€", wrong: "é¡è‰²" };
}

function startPreScanGuide(partKey) {
  const step = STEPS.find(s=>s.key===partKey);
  const label = step.label;
  const clue = getGuideText(partKey);
  
  guideTitle.textContent = `AI è§€å¯Ÿå¼•å°ï¼š${label}`;
  guideAiText.textContent = `æº–å‚™å°‹æ‰¾ã€Œ${MYSTERY_NAME}ã€çš„${label}å›‰ï¼`;
  guideBtns.innerHTML = "";
  guideResult.classList.add("hidden");
  guideRealClue.textContent = "";
  guideModal.classList.remove("hidden");
  guideActions.classList.remove("hidden");

  const dim = analyzeDimension(clue);
  
  setTimeout(() => {
    typeText(guideAiText, `è¦æ‰¾${label}äº†ï¼ä½ è¦ºå¾—è§€å¯Ÿã€Œ${dim.label}ã€é‚„æ˜¯ã€Œ${dim.wrong}ã€æ›´æœ‰åˆ©æ–¼è¾¨èªï¼Ÿ`, 20);
    
    const btnCorrect = document.createElement("div");
    btnCorrect.className = "guideBtn";
    btnCorrect.textContent = dim.label;
    btnCorrect.onclick = () => handleGuideAnswer(true, dim, clue);

    const btnWrong = document.createElement("div");
    btnWrong.className = "guideBtn";
    btnWrong.textContent = dim.wrong; 
    btnWrong.onclick = () => handleGuideAnswer(false, dim, clue);

    const btns = Math.random() > 0.5 ? [btnCorrect, btnWrong] : [btnWrong, btnCorrect];
    btns.forEach(b => guideBtns.appendChild(b));
  }, 600);
}

function handleGuideAnswer(isCorrect, dim, clueText) {
  [...guideBtns.children].forEach(btn => btn.style.pointerEvents = "none");
  
  if(isCorrect) {
    [...guideBtns.children].forEach(btn => {
      if(btn.textContent === dim.label) btn.classList.add("correct");
    });
    typeText(guideAiText, `æ²’éŒ¯ï¼è§€å¯Ÿã€Œ${dim.label}ã€æ˜¯é—œéµï¼\né€™æ˜¯é€™éš»é³¥çš„ç‰¹å¾µç·šç´¢ï¼Œè«‹è¨˜ä½å®ƒä¸¦æƒæåœ–å¡ï¼š`, 15);
  } else {
    [...guideBtns.children].forEach(btn => {
      if(btn.textContent === dim.wrong) btn.classList.add("wrong");
      if(btn.textContent === dim.label) btn.classList.add("correct");
    });
    typeText(guideAiText, `å…¶å¯¦ã€Œ${dim.wrong}ã€ä¹Ÿé‡è¦ï¼Œä½†é€™éš»é³¥çš„ã€Œ${dim.label}ã€ç‰¹å¾µæ›´æ˜é¡¯å–”ï¼\nè«‹çœ‹é€™å€‹ç·šç´¢ï¼Œä¸¦æ‰¾å‡ºå°æ‡‰çš„åœ–å¡ï¼š`, 15);
  }

  setTimeout(() => {
    guideResult.classList.remove("hidden");
    guideRealClue.textContent = `ã€Œ${clueText}ã€`;
  }, 1500);
}

function closeGuideModal() {
  guideModal.classList.add("hidden");
}

let scanning = false;
let scanRaf = 0;
let scanCooldownUntil = 0;
let lastScanMsgAt = 0;
let scanErrorPause = false;

const offCanvas = document.createElement("canvas");
const offCtx = offCanvas.getContext("2d", { willReadFrequently: true });

function setScanMessage(text, type="info"){
  const color = (type==="ok") ? "rgba(46,125,50,.10)" : (type==="bad") ? "rgba(198,40,40,.10)" : "rgba(255,255,255,.72)";
  scanHintText.style.background = color;
  scanHintText.textContent = text;
  lastScanMsgAt = Date.now();
}

function openScan(){
  if(!state.cameraOn){
    startOverlay.classList.remove("hidden");
    showToast("è«‹å…ˆé»ä¸€ä¸‹é–‹å•Ÿç›¸æ©Ÿ");
    return;
  }
  if(!state.pendingPart){
    showToast("ç›®å‰æ²’æœ‰å¾…æƒéƒ¨ä½ï¼šè«‹å…ˆé¤µé³¥");
    return;
  }
  
  closeGuideModal();

  if(typeof jsQR !== "function"){
    showToast("æƒæåŠŸèƒ½è¼‰å…¥å¤±æ•—ï¼šè«‹é‡æ–°æ•´ç†");
    return;
  }

  const targetLabel = STEPS.find(s=>s.key===state.pendingPart).label;
  scanNeedText.textContent = `${MYSTERY_NAME}ï½œ${targetLabel}`;
  scanBadge.textContent = "æƒæä¸­â€¦";
  scanBadge.classList.remove("error");
  scanPreviewBox.classList.remove("error");

  const guide = getGuideText(state.pendingPart);
  setScanMessage(`è«‹æ‰¾ç·šç´¢å¡ä¸­ç¬¦åˆã€Œ${guide}ã€çš„å°é³¥ï¼Œä¸¦æƒèƒŒé¢ QRã€‚`, "info");

  scanOverlay.classList.remove("hidden");
  scanning = true;
  scanErrorPause = false;
  scanCooldownUntil = 0;
  scanLoop();
}

function closeScan(){
  scanning = false;
  scanOverlay.classList.add("hidden");
  if(scanRaf) cancelAnimationFrame(scanRaf);
}

function drawReticle(ctx, w, h, color="rgba(240,193,75,.9)"){
  const boxW = Math.round(w * 0.62);
  const boxH = Math.round(h * 0.52);
  const x = Math.round((w - boxW)/2);
  const y = Math.round((h - boxH)/2);
  const r = 16;

  ctx.save();
  ctx.strokeStyle = color;
  ctx.lineWidth = 4;

  function corner(x1,y1,dirX,dirY){
    ctx.beginPath();
    ctx.moveTo(x1, y1 + dirY*r);
    ctx.lineTo(x1, y1);
    ctx.lineTo(x1 + dirX*r, y1);
    ctx.stroke();
  }
  corner(x, y, 1, 1);
  corner(x+boxW, y, -1, 1);
  corner(x, y+boxH, 1, -1);
  corner(x+boxW, y+boxH, -1, -1);

  const t = (Date.now()%1200)/1200;
  const lineY = y + Math.round(t * boxH);

  ctx.beginPath();
  ctx.rect(x, y, boxW, boxH);
  ctx.clip();

  ctx.fillStyle = color === "#c62828" ? "rgba(198,40,40,.25)" : "rgba(240,193,75,.45)";
  ctx.fillRect(x, lineY, boxW, 3);

  ctx.restore();
}

function drawQrBox(ctx, loc, color="rgba(46,125,50,.95)"){
  if(!loc) return;
  ctx.save();
  ctx.strokeStyle = color;
  ctx.lineWidth = 5;
  ctx.beginPath();
  ctx.moveTo(loc.topLeftCorner.x, loc.topLeftCorner.y);
  ctx.lineTo(loc.topRightCorner.x, loc.topRightCorner.y);
  ctx.lineTo(loc.bottomRightCorner.x, loc.bottomRightCorner.y);
  ctx.lineTo(loc.bottomLeftCorner.x, loc.bottomLeftCorner.y);
  ctx.closePath();
  ctx.stroke();
  ctx.restore();
}

function scanLoop(){
  if(!scanning) return;
  if(scanErrorPause) {
     scanRaf = requestAnimationFrame(scanLoop);
     return;
  }

  const video = $("camera");
  const vw = video.videoWidth || 0;
  const vh = video.videoHeight || 0;

  if(video.readyState >= 2 && vw > 0 && vh > 0){
    const outW = 960;
    const outH = 540;

    const srcAspect = vw / vh;
    const dstAspect = outW / outH;
    let sx=0, sy=0, sw=vw, sh=vh;
    if(srcAspect > dstAspect){
      sh = vh;
      sw = Math.round(vh * dstAspect);
      sx = Math.round((vw - sw)/2);
      sy = 0;
    }else{
      sw = vw;
      sh = Math.round(vw / dstAspect);
      sx = 0;
      sy = Math.round((vh - sh)/2);
    }

    scanPctx.drawImage(video, sx, sy, sw, sh, 0, 0, outW, outH);

    offCanvas.width = outW;
    offCanvas.height = outH;
    offCtx.drawImage(scanPreview, 0, 0);

    drawReticle(scanPctx, outW, outH);

    const now = Date.now();
    if(now >= scanCooldownUntil){
      const img = offCtx.getImageData(0, 0, outW, outH);
      const code = jsQR(img.data, outW, outH, { inversionAttempts: "dontInvert" });

      if(code && code.data){
        const result = handleScannedText(code.data);
        if(result === "success"){
          drawQrBox(scanPctx, code.location, "rgba(46,125,50,.95)");
          scanBadge.textContent = "è®€å–æˆåŠŸ";
          scanBadge.classList.remove("error");
          setTimeout(()=>closeScan(), 500);
          return;
        }else if(result === "wrong"){
          drawQrBox(scanPctx, code.location, "#c62828");
          drawReticle(scanPctx, outW, outH, "#c62828");
          scanBadge.textContent = "æƒæåˆ°ä½†éŒ¯èª¤";
          scanBadge.classList.add("error");
          scanPreviewBox.classList.add("error");
          scanCooldownUntil = now + 2000; 
        } else {
           drawQrBox(scanPctx, code.location, "rgba(46,125,50,.95)");
        }
      }else{
        scanBadge.textContent = "æƒæä¸­â€¦";
        scanBadge.classList.remove("error");
        scanPreviewBox.classList.remove("error");
      }
    }
  }

  if(state.pendingPart && Date.now() - lastScanMsgAt > 5200){
    const guide = getGuideText(state.pendingPart);
    setScanMessage(`è«‹æ‰¾ç·šç´¢å¡ä¸­ç¬¦åˆã€Œ${guide}ã€çš„å°é³¥ï¼Œä¸¦æƒèƒŒé¢ QRã€‚`, "info");
  }

  scanRaf = requestAnimationFrame(scanLoop);
}

function showScanErrorModal(scannedBirdKey, scannedPartKey) {
  scanErrorPause = true;
  
  guideTitle.textContent = "AI ç‰¹å¾µæ¯”å°ï¼ˆæƒéŒ¯å›‰ï¼‰";
  guideBtns.innerHTML = "";
  guideResult.classList.remove("hidden");
  guideRealClue.textContent = "";
  guideModal.classList.remove("hidden");
  
  guideActions.classList.add("hidden");
  
  const targetPart = state.pendingPart;
  const targetGuide = getGuideText(targetPart);
  const targetLabel = STEPS.find(s=>s.key===targetPart)?.label || "æœªçŸ¥éƒ¨ä½";
  
  const scannedBird = BIRDS[scannedBirdKey] || {};
  const scannedPool = scannedBird.cluePool?.[scannedPartKey] || [];
  const scannedText = scannedPool[0] || "ä¸æ˜ç‰¹å¾µ";
  const scannedBirdName = scannedBird.name || "é€™å¼µå¡";
  const scannedPartLabel = STEPS.find(s=>s.key===scannedPartKey)?.label || "ä¸æ˜éƒ¨ä½";

  let msg = "";

  if (scannedBirdKey === birdKey && scannedPartKey !== targetPart) {
     msg = `ä½ æƒåˆ°äº†ã€Œ${scannedPartLabel}ã€ï¼\nä½†æˆ‘å€‘ç¾åœ¨ç³»çµ±æŒ‡å®šè¦æ‰¾çš„æ˜¯ï¼šã€Œ${targetLabel}ã€å–”ï¼\n\né€™å¼µå¡é¡¯ç¤ºï¼š${scannedText}`;
  } 
  else {
     msg = `é€™å¼µå¡ç‰‡ä¸æ˜¯æˆ‘å€‘è¦æ‰¾çš„å–”ï¼\nä½†æˆ‘å€‘è¦æ‰¾çš„æ˜¯ã€Œ${MYSTERY_NAME}ã€ï¼\n\né€™å¼µå¡ç‰¹å¾µï¼š${scannedText}`;
  }
  
  msg += `\n\nè«‹å†æ‰¾æ‰¾ç¬¦åˆä»¥ä¸‹æè¿°çš„å¡ç‰‡ï¼š\nã€${targetGuide}ã€`;
  
  typeText(guideAiText, msg, 10);
  
  btnStartScanFromGuide.textContent = "çŸ¥é“äº†ï¼Œç¹¼çºŒæƒæ";
  btnStartScanFromGuide.onclick = () => {
    guideModal.classList.add("hidden");
    scanErrorPause = false;
    scanPreviewBox.classList.remove("error");
    scanCooldownUntil = Date.now() + 1000;
  };
}

function handleScannedText(text){
  if(!state.pendingPart) return "success";

  let url;
  try{ url = new URL(text); }catch(e){ return "ignore"; }

  const b = url.searchParams.get("bird");
  const claim = url.searchParams.get("claim");

  if(!claim){
    return "ignore"; 
  }

  const targetPart = state.pendingPart;
  
  if((b && b !== birdKey) || (claim !== targetPart)){
     showScanErrorModal(b, claim);
     return "wrong";
  }

  const targetLabel = STEPS.find(s=>s.key===targetPart).label;
  grantClue(claim);
  setScanMessage(`âœ… ç²å¾—ç·šç´¢ï¼šã€Œ${MYSTERY_NAME}ï½œ${targetLabel}ã€`, "ok");
  showToast(`ç²å¾—ç·šç´¢ï¼š${targetLabel}`);
  return "success";
}

function handleClaimFromURLIfAny(){
  if(!CLAIM) return false;
  if(!state.pendingPart){
    showToast("å°šæœªæ‰è½ç·šç´¢ï¼šè«‹å…ˆæŒ‰é¤µé³¥å†æƒå¡", 3000);
    setTimeout(()=>location.replace(`${location.pathname}?bird=${encodeURIComponent(birdKey)}`), 900);
    return true;
  }
  if(CLAIM !== state.pendingPart){
    const targetLabel = STEPS.find(s=>s.key===state.pendingPart).label;
    showToast(`ä¸æ˜¯ã€Œ${MYSTERY_NAME}ã€çš„ã€Œ${targetLabel}ã€ï¼Œå†è§€å¯Ÿçœ‹çœ‹`, 3000);
    setTimeout(()=>location.replace(`${location.pathname}?bird=${encodeURIComponent(birdKey)}`), 900);
    return true;
  }
  grantClue(CLAIM);
  showToast(`ç²å¾—ç·šç´¢ï¼š${STEPS.find(s=>s.key===CLAIM).label}`);
  setTimeout(()=>location.replace(`${location.pathname}?bird=${encodeURIComponent(birdKey)}`), 900);
  return true;
}

function openQuiz(){
  if(Object.keys(state.clues).length < 5){
    showToast("è«‹å…ˆæ”¶é›†æ»¿ 5 å¼µç·šç´¢");
    return;
  }
  if(state.pendingPart){
    showToast("å°šæœ‰å¾…æƒç·šç´¢å¡ï¼šè«‹å…ˆæƒå¡å®Œæˆæ”¶é›†", 3200);
    return;
  }
  quizModal.classList.remove("hidden");
  quizTitle.textContent = `è¾¨èªé³¥é¡ï¼š${MYSTERY_NAME}`;
  buildStepDots();

  const idx = STEPS.findIndex(s=>!state.solved[s.key]);
  state.currentStep = (idx>=0)?idx:0;
  saveState();
  renderStep();
}

function closeQuizModal(){ quizModal.classList.add("hidden"); }

function buildStepDots(){
  stepDots.innerHTML = "";
  STEPS.forEach((s, idx)=>{
    const d = document.createElement("div");
    d.className = "dot";
    d.textContent = String(idx+1);
    stepDots.appendChild(d);
  });
}

function renderStep(){
  const part = STEPS[state.currentStep].key;

  [...stepDots.children].forEach((el, idx)=>{
    el.classList.remove("active","done");
    const k = STEPS[idx].key;
    if(state.solved[k]) el.classList.add("done");
    if(idx === state.currentStep) el.classList.add("active");
  });

  const q = bird.quiz[part];
  const collected = state.clues[part]?.text || "ï¼ˆå°šæœªæ”¶é›†åˆ°æ­¤éƒ¨ä½ç·šç´¢ï¼‰";

  clueBox.innerHTML = `
    <div style="font-weight:900;font-size:16px;margin-bottom:6px">${q.prompt}</div>
    <div>ä½ æ”¶é›†åˆ°çš„ç·šç´¢ï¼š<strong>${escapeHtml(collected)}</strong></div>
  `;

  optionsGrid.innerHTML = "";
  q.options.forEach(optKey=>{
    const opt = OPTION_LIB[part][optKey];
    const card = document.createElement("div");
    card.className = "opt";
    card.innerHTML = `
      ${opt.svg}
      <div>
        <div class="lbl">${opt.label}</div>
        <div class="desc">${opt.desc}</div>
      </div>
    `;
    card.addEventListener("click", ()=> chooseOption(part, optKey, card));
    optionsGrid.appendChild(card);
  });

  btnHintQuiz.disabled = false; 
}

function chooseOption(part, optKey, cardEl){
  if(state.solved[part]) return;

  const correct = bird.quiz[part].correct;
  [...optionsGrid.children].forEach(el=>el.style.pointerEvents="none");

  if(optKey === correct){
    cardEl.classList.add("correct");
    state.solved[part] = true;

    const prev = state.assembledCount;
    state.assembledCount = Math.min(5, Object.keys(state.solved).length);
    saveState();

    animateAssemble(prev, state.assembledCount);

    setTimeout(()=>{
      closeQuizModal();
      openAssembleModal(part);
    }, 250);

  }else{
    cardEl.classList.add("wrong");
    showToast("ç­”éŒ¯ï¼šå·²é‡ç½®ï¼Œè«‹é‡æ–°æ”¶é›† 5 å¼µç·šç´¢", 3600);

    setTimeout(()=>{
      closeQuizModal();
      resetState();
      loadState();
      renderBird(0);
      renderChips();
      renderCounters();
    }, 550);
  }
}

function openAssembleModal(partJustSolved){
  const label = STEPS.find(s=>s.key===partJustSolved).label;
  assembleTitle.textContent = "ç­”å°ï¼å·²æ‹¼ä¸Šéƒ¨ä½";
  assembleTag.textContent = `${MYSTERY_NAME}ï½œ${label}`;
  assembleBird.innerHTML = `<div style="width:min(520px,92vw)">${renderAssembleBirdSVG()}</div>`;
  assembleSummary.textContent = `ä½ å®Œæˆäº†ã€Œ${label}ã€ã€‚è§€å¯Ÿé‡é»ï¼š${getGuideText(partJustSolved)}`;

  const doneCount = Object.keys(state.solved).length;
  btnAssembleNext.textContent = (doneCount >= 5) ? "å®Œæˆ" : "ä¸‹ä¸€æ­¥";
  btnAssembleNext.style.display = ""; 
  assembleModal.classList.remove("hidden");
}

function closeAssembleModal(){ assembleModal.classList.add("hidden"); }

function triggerCelebration(callback) {
  const container = document.getElementById("confettiOverlay");
  container.style.display = "block";
  container.innerHTML = "";

  const colors = ["#ffd700", "#ff6b6b", "#4ecdc4", "#45b7d1", "#ffffff"];
  for(let i=0; i<60; i++){
    const p = document.createElement("div");
    p.className = "confetti";
    p.style.left = Math.random() * 100 + "%";
    p.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
    p.style.animation = `drop-confetti ${2 + Math.random()}s linear forwards`;
    p.style.animationDelay = Math.random() * 1 + "s";
    container.appendChild(p);
  }

  setTimeout(() => {
    container.style.display = "none";
    container.innerHTML = "";
    if(callback) callback();
  }, 2500);
}

function assembleNext(){
  const doneCount = Object.keys(state.solved).length;
  
  if(doneCount >= 5){
    btnAssembleNext.style.display = "none";
    triggerCelebration(() => {
       closeAssembleModal(); 
       openReveal();
       btnAssembleNext.style.display = "";
    });
    return;
  }

  closeAssembleModal();
  const nextIdx = STEPS.findIndex(s=>!state.solved[s.key]);
  state.currentStep = (nextIdx>=0)?nextIdx:0;
  saveState();
  openQuiz();
}

function renderAssembleBirdSVG(){
  const pal = bird.palette;
  const assembled = state.assembledCount;
  const showLegs = assembled >= 1;
  const showBody = assembled >= 2;
  const showWing = assembled >= 3;
  const showTail = assembled >= 4;
  const showHead = assembled >= 5;

  return `
  <svg class="${assembled===5 ? "bob" : ""}" viewBox="0 0 520 260" xmlns="http://www.w3.org/2000/svg" aria-label="assemble bird">
    <ellipse cx="260" cy="210" rx="120" ry="18" fill="rgba(0,0,0,.12)"/>
    ${showTail ? tailShape(pal.tail) : ""}
    ${showBody ? `<ellipse cx="270" cy="135" rx="120" ry="70" fill="${pal.body}"/>
      <ellipse cx="290" cy="155" rx="95" ry="52" fill="${pal.belly}" opacity=".92"/>` : ""}
    ${showWing ? `<path d="M210 165c35-78 124-98 165-40-20 70-86 110-165 40z"
          fill="${pal.wing}" opacity=".95"/>
      <path d="M230 150c60-40 105-35 130 5"
          stroke="rgba(255,255,255,.35)" stroke-width="7" stroke-linecap="round" opacity=".45"/>` : ""}
    ${showLegs ? `<path d="M250 185c8 18 2 30-8 44" stroke="${pal.legs}" stroke-width="8" stroke-linecap="round"/>
      <path d="M290 185c-8 18-2 30 8 44" stroke="${pal.legs}" stroke-width="8" stroke-linecap="round"/>
      <path d="M222 232h40" stroke="${pal.legs}" stroke-width="8" stroke-linecap="round"/>
      <path d="M278 232h40" stroke="${pal.legs}" stroke-width="8" stroke-linecap="round"/>` : ""}
    ${showHead ? headShape(pal) : ""}
  </svg>`;
}

let typingTimer = 0;

function startAiDialogue(){
  const partKey = STEPS[state.currentStep].key;
  const label = STEPS[state.currentStep].label;
  const collected = Object.keys(state.clues).length;

  const hintData = getInteractiveHintData(partKey);

  aiModal.classList.remove("hidden");
  aiOptions.style.display = "none";
  aiOptions.innerHTML = "";
  aiOk.textContent = "å–æ¶ˆ";

  const greeting = `æˆ‘å€‘æ”¶é›†åˆ° ${collected} å€‹ç·šç´¢äº†ï¼é—œæ–¼ã€${label}ã€çš„ç‰¹å¾µï¼Œä½ å‰›æ‰è§€å¯Ÿåˆ°çš„ç´°ç¯€æ˜¯ä»€éº¼ï¼Ÿ`;
  typeText(aiText, greeting, 15);

  setTimeout(() => {
    aiOptions.style.display = "grid";
    hintData.options.sort(() => Math.random() - 0.5);
    
    hintData.options.forEach(opt => {
      const btn = document.createElement("div");
      btn.className = "aiOptBtn";
      btn.textContent = opt.text;
      btn.onclick = () => handleAiChoice(opt, hintData.strategy, partKey);
      aiOptions.appendChild(btn);
    });
  }, 1000);
}

function handleAiChoice(option, strategyLines, partKey){
  aiOptions.style.display = "none";
  
  let msg = "";
  const strategies = strategyLines.join("\n");
  const ecology = getEcologyText(partKey, option.isCorrect);

  if(option.isCorrect){
    msg = `å°ï¼ã€Œ${option.coreFeature}ã€æ˜¯é—œéµï¼Œ${ecology}\n\nâ˜… ç§‘å­¸å®¶å»ºè­°ç¯©é¸ç­–ç•¥ï¼š\n${strategies}`;
  } else if(option.isGuide){
    msg = `æ²’é—œä¿‚ï¼Œæˆ‘å€‘ä¸€èµ·ä¾†çœ‹ã€‚\né€™éš»é³¥çš„ç‰¹å¾µå…¶å¯¦åå‘ã€Œ${option.correctFeature}ã€ã€‚\n\nâ˜… ç§‘å­¸å®¶å»ºè­°ç¯©é¸ç­–ç•¥ï¼š\n${strategies}`;
  } else {
    msg = `é‚£å¯èƒ½æ˜¯å¦ä¸€ç¨®é³¥å–”ï¼Œæˆ‘å€‘å†çœ‹ä¸€æ¬¡ç·šç´¢å¡...\n${MYSTERY_NAME}å…¶å¯¦æ˜¯ã€Œ${option.correctFeature}ã€çš„ã€‚\n\nâ˜… ç§‘å­¸å®¶å»ºè­°ç¯©é¸ç­–ç•¥ï¼š\n${strategies}`;
  }

  typeText(aiText, msg, 10);
  aiOk.textContent = "çŸ¥é“äº†ï¼Œå›å»ç­”é¡Œ";
}

function getEcologyText(part, isCorrect){
  if(!isCorrect) return "";
  if(part === "legs") return "é€™æ¨£çš„é¡è‰²åœ¨æ¨¹æé–“å¾ˆé¡¯çœ¼ï¼Œæˆ–è€…æ˜¯å¾ˆå¥½çš„ä¿è­·è‰²ã€‚";
  if(part === "wing") return "é€™èƒ½å¹«åŠ©ç‰ åœ¨é£›è¡Œæ™‚æ›´æµæš¢ï¼Œæˆ–è€…åœ¨æ—é–“ç©¿æ¢­ã€‚";
  if(part === "tail") return "é€™èƒ½æ§åˆ¶é£›è¡Œæ–¹å‘ï¼Œæˆ–è€…åœ¨æ±‚å¶æ™‚å±•ç¤ºã€‚";
  if(part === "head") return "é€™è®“åŒä¼´å®¹æ˜“è¾¨è­˜ï¼Œæˆ–è€…èƒ½èå…¥èƒŒæ™¯ç’°å¢ƒã€‚";
  if(part === "body") return "é€™æ˜¯æœ€ä¸»è¦çš„è¾¨è­˜å€å¡Šï¼Œé€šå¸¸èˆ‡æ£²æ¯ç’°å¢ƒæœ‰é—œã€‚";
  return "é€™æ˜¯å¾ˆé‡è¦çš„ç‰¹å¾µå–”ã€‚";
}

function getInteractiveHintData(partKey) {
  const correctKey = bird.quiz[partKey].correct;
  const correctLabel = OPTION_LIB[partKey][correctKey].label; 
  
  const allOpts = bird.quiz[partKey].options;
  const wrongKey = allOpts.find(k => k !== correctKey) || allOpts[0];
  const wrongLabel = OPTION_LIB[partKey][wrongKey].label;

  return {
    options: [
      { text: `æˆ‘è¨˜å¾—æ˜¯ã€Œ${correctLabel}ã€`, isCorrect: true, coreFeature: correctLabel },
      { text: `æˆ‘è¨˜å¾—æ˜¯ã€Œ${wrongLabel}ã€`, isCorrect: false, correctFeature: correctLabel },
      { text: "æˆ‘éœ€è¦ä½ å¼•å°æˆ‘è§€å¯Ÿ", isGuide: true, isCorrect: false, correctFeature: correctLabel }
    ],
    strategy: bird.ai[partKey] || ["1. å…ˆçœ‹ä¸»è‰²", "2. æ¯”å°å½¢ç‹€", "3. æ’é™¤å·®ç•°å¤ªå¤§çš„"]
  };
}

btnHintQuiz.addEventListener("click", startAiDialogue);
closeAi.addEventListener("click", closeAiModal);
aiOk.addEventListener("click", closeAiModal);

function closeAiModal(){
  aiModal.classList.add("hidden");
  clearInterval(typingTimer);
  aiText.textContent = "";
}

function typeText(el, text, speedMs=14){
  clearInterval(typingTimer);
  el.textContent = "";
  let i = 0;
  typingTimer = setInterval(()=>{
    el.textContent += text[i] || "";
    i++;
    if(i >= text.length){
      clearInterval(typingTimer);
    }
  }, speedMs);
}

function openReveal(){
  revealModal.classList.remove("hidden");
  revealName.textContent = bird.name;
  revealBird.innerHTML = `<div style="width:min(520px,92vw)">${renderFinalBirdSVG()}</div>`;
  revealSummary.textContent = bird.summary;
}
function closeRevealModal(){ revealModal.classList.add("hidden"); }

function renderFinalBirdSVG(){
  const pal = bird.palette;
  return `
  <svg class="bob" viewBox="0 0 520 260" xmlns="http://www.w3.org/2000/svg" aria-label="reveal bird">
    <ellipse cx="260" cy="210" rx="120" ry="18" fill="rgba(0,0,0,.12)"/>
    ${tailShape(pal.tail)}
    <ellipse cx="270" cy="135" rx="120" ry="70" fill="${pal.body}"/>
    <ellipse cx="290" cy="155" rx="95" ry="52" fill="${pal.belly}" opacity=".92"/>
    <path d="M210 165c35-78 124-98 165-40-20 70-86 110-165 40z"
          fill="${pal.wing}" opacity=".95"/>
    <path d="M230 150c60-40 105-35 130 5"
          stroke="rgba(255,255,255,.35)" stroke-width="7" stroke-linecap="round" opacity=".45"/>
    <path d="M250 185c8 18 2 30-8 44" stroke="${pal.legs}" stroke-width="8" stroke-linecap="round"/>
    <path d="M290 185c-8 18-2 30 8 44" stroke="${pal.legs}" stroke-width="8" stroke-linecap="round"/>
    <path d="M222 232h40" stroke="${pal.legs}" stroke-width="8" stroke-linecap="round"/>
    <path d="M278 232h40" stroke="${pal.legs}" stroke-width="8" stroke-linecap="round"/>
    ${headShape(pal)}
  </svg>`;
}

function escapeHtml(s){
  return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
}
function copyLink(){
  const url = location.origin + location.pathname + `?bird=${encodeURIComponent(birdKey)}`;
  navigator.clipboard?.writeText(url)
    .then(()=>showToast("å·²è¤‡è£½é€£çµ"))
    .catch(()=>showToast("è¤‡è£½å¤±æ•—ï¼šè«‹æ‰‹å‹•è¤‡è£½ç¶²å€åˆ—"));
}

function init(){
  loadState();

  if(START){
    resetState();
    loadState();
    setTimeout(()=>location.replace(`${location.pathname}?bird=${encodeURIComponent(birdKey)}`), 50);
    return;
  }

  elBirdName.textContent = MYSTERY_NAME; 
  elBirdSub.textContent = bird.sub;

  renderBird(state.assembledCount);
  renderChips();
  renderCounters();

  if(handleClaimFromURLIfAny()) return;

  startCamera(true).then(ok=>{
    if(!ok) startOverlay.classList.remove("hidden");
  });

  btnCamera.addEventListener("click", async ()=>{
    const ok = await startCamera(false);
    if(ok) startOverlay.classList.add("hidden");
  });
  btnStartCameraNow.addEventListener("click", async ()=>{
    const ok = await startCamera(false);
    if(ok) startOverlay.classList.add("hidden");
  });
  closeStartOverlay.addEventListener("click", ()=> startOverlay.classList.add("hidden"));

  btnFeed.addEventListener("click", feedBird);
  
  btnScan.addEventListener("click", ()=>{
    if(state.pendingPart) startPreScanGuide(state.pendingPart);
  });
  
  btnStopScan.addEventListener("click", closeScan);
  btnStopScan2.addEventListener("click", closeScan);

  btnStartScanFromGuide.addEventListener("click", openScan);
  closeGuide.addEventListener("click", closeGuideModal);

  btnQuiz.addEventListener("click", openQuiz);

  btnReset.addEventListener("click", ()=>{
    resetState();
    loadState();
    renderBird(0);
    renderChips();
    renderCounters();
    showToast("å·²é‡ç½®æœ¬é³¥é€²åº¦");
  });

  closeQuiz.addEventListener("click", closeQuizModal);
  btnCloseQuiz2.addEventListener("click", closeQuizModal);

  btnHintQuiz.addEventListener("click", startAiDialogue);
  closeAi.addEventListener("click", closeAiModal);
  aiOk.addEventListener("click", closeAiModal);

  closeAssemble.addEventListener("click", closeAssembleModal);
  btnAssembleNext.addEventListener("click", assembleNext);

  closeReveal.addEventListener("click", closeRevealModal);
  btnReplay.addEventListener("click", ()=>{
    closeRevealModal();
    resetState();
    loadState();
    renderBird(0);
    renderChips();
    renderCounters();
  });
  btnCopyLink.addEventListener("click", copyLink);

  showToast(`å·²è¼‰å…¥ï¼š${MYSTERY_NAME}ï¼ˆé¤µé³¥â†’æƒæç·šç´¢å¡ï¼‰`);
}

init();
</script>
</body>
</html>
